var Ha=Object.defineProperty;var zr=r=>{throw TypeError(r)};var Wa=(r,t,e)=>t in r?Ha(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var z=(r,t,e)=>Wa(r,typeof t!="symbol"?t+"":t,e),Ns=(r,t,e)=>t.has(r)||zr("Cannot "+e);var Zi=(r,t,e)=>(Ns(r,t,"read from private field"),e?e.call(r):t.get(r)),$i=(r,t,e)=>t.has(r)?zr("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),Gs=(r,t,e,i)=>(Ns(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e),Ur=(r,t,e)=>(Ns(r,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Oa={851:(r,t,e)=>{e.d(t,{A:()=>h});var i=e(1),s=e.n(i),n=e(935),o=e.n(n),a=o()(s());a.push([r.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const h=a},296:(r,t,e)=>{e.d(t,{A:()=>h});var i=e(1),s=e.n(i),n=e(935),o=e.n(n),a=o()(s());a.push([r.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const h=a},935:r=>{r.exports=function(t){var e=[];return e.toString=function(){return this.map(function(s){var n="",o=typeof s[5]<"u";return s[4]&&(n+="@supports (".concat(s[4],") {")),s[2]&&(n+="@media ".concat(s[2]," {")),o&&(n+="@layer".concat(s[5].length>0?" ".concat(s[5]):""," {")),n+=t(s),o&&(n+="}"),s[2]&&(n+="}"),s[4]&&(n+="}"),n}).join("")},e.i=function(s,n,o,a,h){typeof s=="string"&&(s=[[null,s,void 0]]);var l={};if(o)for(var c=0;c<this.length;c++){var d=this[c][0];d!=null&&(l[d]=!0)}for(var f=0;f<s.length;f++){var _=[].concat(s[f]);o&&l[_[0]]||(typeof h<"u"&&(typeof _[5]>"u"||(_[1]="@layer".concat(_[5].length>0?" ".concat(_[5]):""," {").concat(_[1],"}")),_[5]=h),n&&(_[2]&&(_[1]="@media ".concat(_[2]," {").concat(_[1],"}")),_[2]=n),a&&(_[4]?(_[1]="@supports (".concat(_[4],") {").concat(_[1],"}"),_[4]=a):_[4]="".concat(a)),e.push(_))}},e}},1:r=>{r.exports=function(t){var e=t[1],i=t[3];if(!i)return e;if(typeof btoa=="function"){var s=btoa(unescape(encodeURIComponent(JSON.stringify(i)))),n="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),o="/*# ".concat(n," */");return[e].concat([o]).join(`
`)}return[e].join(`
`)}}},Hr={};function Ct(r){var t=Hr[r];if(t!==void 0)return t.exports;var e=Hr[r]={id:r,exports:{}};return Oa[r](e,e.exports,Ct),e.exports}Ct.n=r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return Ct.d(t,{a:t}),t};Ct.d=(r,t)=>{for(var e in t)Ct.o(t,e)&&!Ct.o(r,e)&&Object.defineProperty(r,e,{enumerable:!0,get:t[e]})};Ct.o=(r,t)=>Object.prototype.hasOwnProperty.call(r,t);Ct.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})};var u={};Ct.d(u,{eKr:()=>$n,yVm:()=>Yi,a7j:()=>go,U_w:()=>vr,JF2:()=>Zn,htg:()=>si,HXL:()=>ur,mcg:()=>Gn,Agj:()=>Ut,J3_:()=>Qh,Wgv:()=>Qn,u6S:()=>Th,x7M:()=>_t,X55:()=>te,m3M:()=>Pi,aE5:()=>yh,YJU:()=>Kt,eZi:()=>an,GNv:()=>Si,Y56:()=>cn,_0v:()=>vs,vhs:()=>hs,vrQ:()=>qi,Z8b:()=>Uo,Yfw:()=>V,IcQ:()=>B,kgJ:()=>un,GTT:()=>va,ypY:()=>Fi,i7d:()=>ta,fQ3:()=>tl,HlI:()=>Ts,jlt:()=>Es,VQc:()=>Mt,zD7:()=>gr,AUF:()=>ue,JoF:()=>Le,MlA:()=>pt,PZh:()=>Oe,qA:()=>Ti,CrD:()=>Ae,dQK:()=>de,D3r:()=>se,Qpo:()=>ps,D9n:()=>_s,b6v:()=>Ai,mvh:()=>Ds,Bpo:()=>H,Q1f:()=>E,IKv:()=>ga,fcV:()=>qe,Glf:()=>pa,uAl:()=>Qt,ElT:()=>yt,Z8r:()=>Cn,QSL:()=>aa,sPV:()=>fs,nAn:()=>Te,zCU:()=>us,QrV:()=>Et,fF9:()=>Bl,Jqv:()=>Xo,d_u:()=>Go,xI8:()=>Xn,yar:()=>bt,SP7:()=>ma,oRy:()=>Rs,f5X:()=>lr,V1c:()=>Pn,Mlx:()=>wa,ZiM:()=>fn,ZCo:()=>Ei,J5p:()=>xa,mL_:()=>Ot,Guw:()=>Wo,N5j:()=>_o,pgY:()=>Oo,OP3:()=>cs,rl5:()=>Pa,eod:()=>ll,q5Z:()=>xt,YUC:()=>er,saR:()=>ms,hvr:()=>_n,Qol:()=>zo,Wf4:()=>Lo,JCs:()=>tt,gJV:()=>Xt,fWD:()=>Qo,Va_:()=>Me,N$8:()=>Wt,_jQ:()=>cl,rxj:()=>Yn,rhv:()=>qn,wCu:()=>Bt,HAp:()=>Rh,Zy1:()=>ia,bkB:()=>nt,wfL:()=>ds,sVA:()=>bn,$Gs:()=>Jn,CJ0:()=>gs,NWh:()=>ye,tWi:()=>jn,xAj:()=>Vn,zWh:()=>Ho,i_4:()=>Fl,iIx:()=>Tt,Hxo:()=>No,c9e:()=>rn,KQV:()=>Ze,weH:()=>Q,jXp:()=>Ml,zzY:()=>ls,yRQ:()=>os,MtE:()=>ba,rPj:()=>ki,KLc:()=>Zt,Fir:()=>N,V5f:()=>In,Xj7:()=>Rn,Wud:()=>es,FVg:()=>Wn,g5Y:()=>Hn,YQB:()=>zn,KPb:()=>Un,nHK:()=>Bs,Jrb:()=>Sa,TX_:()=>Il,Olt:()=>Ra,r3n:()=>hi,Fvk:()=>_l,gpR:()=>ws,vYh:()=>ht,hnk:()=>lt,D2R:()=>oi,n1o:()=>hr,h9O:()=>ha,X5j:()=>le,p3P:()=>cr,RLG:()=>Nn,fBU:()=>sr,Adb:()=>gt,bEs:()=>ce,wCy:()=>Y,CbD:()=>it,x_C:()=>wi,pGf:()=>pr,ibQ:()=>ca,shR:()=>Di,Yjk:()=>fr,_u1:()=>pl,OBI:()=>Ea,klh:()=>yi,s3S:()=>ua,D$R:()=>Bi,xth:()=>Ps,JU7:()=>dl,h9x:()=>Jo,N1A:()=>wr,e_k:()=>ut,aHM:()=>Ke,tlv:()=>Wh,Vi9:()=>$o,ieR:()=>Zo,$bb:()=>mt,VyI:()=>k,imn:()=>ao,uqu:()=>Gt,QnL:()=>Ys,vnc:()=>tr,wk_:()=>on,GH0:()=>Z,_1r:()=>Ms,l0X:()=>sn,bT:()=>Co,HHX:()=>nn,jtW:()=>Ao,tjk:()=>Ee,rWe:()=>We,j9l:()=>uo,l0$:()=>br,sGJ:()=>we,NVp:()=>nr,cPK:()=>Lt,XoL:()=>_r,RmF:()=>zt,DXI:()=>Is,tCD:()=>gl,J3D:()=>As,vCJ:()=>ul,e6k:()=>lo,f9l:()=>oe,v9m:()=>Ls,yRJ:()=>la,EU6:()=>dn,m3O:()=>me,Ryz:()=>De,OxP:()=>Ci,LEs:()=>ks,Ec:()=>je,Pi5:()=>Fs,gmH:()=>ve,tS:()=>xr,XxX:()=>St,bCz:()=>Cs,nYS:()=>Qe,yiT:()=>Bn,NHl:()=>vi,mO8:()=>Ln,PXI:()=>En,bn5:()=>Dn,Ywr:()=>ke,cMd:()=>$e,Bs6:()=>Fn,G0k:()=>mi,pyn:()=>kn,QeM:()=>Sn,aPX:()=>rl,ITP:()=>Mn,BY0:()=>Be,MFw:()=>Gi,sBn:()=>Oi,S3L:()=>ei,XKQ:()=>Ri,ESI:()=>sa,uxz:()=>Ko,o8N:()=>fi,u_r:()=>gi,RlV:()=>Ne,gVA:()=>hn,M_G:()=>Xi,BpG:()=>Kn,GRB:()=>Eh,kM6:()=>mo,dO8:()=>vo,jgM:()=>Ks,FWq:()=>Hi,s3j:()=>Za,hlw:()=>Io,L0q:()=>Eo,B7e:()=>So,PGN:()=>To,H_X:()=>at,S_d:()=>ko,_Tq:()=>Bo,U7E:()=>Do,IOH:()=>Mo,Z58:()=>Yt,yh2:()=>ol,ff$:()=>Js,cWi:()=>Qr,NBt:()=>or,oNz:()=>Lh,QlU:()=>_a,Xey:()=>Re,jft:()=>Hl,_r8:()=>ft,bTC:()=>po,Mtr:()=>Nt,ypk:()=>Dt,mnM:()=>K,q7S:()=>kl,bAZ:()=>Ii,ABN:()=>fo,VK6:()=>Hh,Hj2:()=>dr,Df8:()=>ln,oOx:()=>ai,kxk:()=>ie,DT1:()=>ys,FLG:()=>Ge,qN_:()=>mr,Z37:()=>Ss,FtL:()=>jo,Z6X:()=>Ia,iQT:()=>$t,ziO:()=>ra,OEF:()=>ge,uuE:()=>qt,tiv:()=>Mi,T$Y:()=>ya,EYj:()=>Ni,nOB:()=>as,Tap:()=>ot,FAs:()=>Yo,B_P:()=>qo,aA5:()=>Jh,J3s:()=>yr,Y0Q:()=>Wi,M4G:()=>Ve,l$l:()=>Ca,dLy:()=>Pe,WZP:()=>D,eB6:()=>zs,nFK:()=>en,l9z:()=>ea,YOF:()=>el,yhB:()=>vt,J0N:()=>yn,Miz:()=>p,Bj4:()=>Zs,Rcs:()=>_e,vJ4:()=>Se,TqC:()=>ir,nM0:()=>On,X1u:()=>Xe,SpZ:()=>co,DX8:()=>ni,Yx$:()=>fa,HK4:()=>oa,yt5:()=>Zr,vAR:()=>fl,SE$:()=>be,qE8:()=>X,Pz7:()=>Ma,sX_:()=>Ye,JuI:()=>Na,pxT:()=>Ce,Nl$:()=>Tn,zDr:()=>Al,OwT:()=>xl,P$G:()=>Pl,mHV:()=>yl,kEA:()=>Tl,Fx_:()=>El,WFC:()=>Sl,vKu:()=>vl,aDq:()=>ml,jIg:()=>Cl,UH3:()=>bl,AJO:()=>wl,U4:()=>xo,xAc:()=>bo,_3Y:()=>$h,K6X:()=>Sh,C1Y:()=>ho,Aw1:()=>tn,tm8:()=>yo,LBV:()=>Po,A8$:()=>Ih,F5e:()=>Zh,ran:()=>jh,c8L:()=>Fo,o6M:()=>Ro,hsx:()=>ae,l9E:()=>Vo,aSf:()=>na,CcK:()=>wo,nU8:()=>rr,td6:()=>Vi,Zex:()=>Da,bkJ:()=>J,mXP:()=>zl,vt$:()=>pi,hCA:()=>re,pjR:()=>O,U43:()=>he,pSZ:()=>Va,y17:()=>Xa,Ew7:()=>pe,hG1:()=>Yh,jVr:()=>Ll,_SZ:()=>et,xWn:()=>$r,ehJ:()=>Ga,t6s:()=>b,Eyn:()=>wn});var wn={};Ct.r(wn);Ct.d(wn,{getAttributeComponentSize:()=>ro,getAttributePointerType:()=>oo,getGLTypeFromSource:()=>no,getGlTypeSizeBytes:()=>js,getMaxShaderComplexity:()=>An,isAttributeInSource:()=>so});var xn={};Ct.r(xn);Ct.d(xn,{circle:()=>Ah,line:()=>$s,point:()=>Ch,roundRect:()=>Qs,vector:()=>Ph});var bn={};Ct.r(bn);Ct.d(bn,{ActionCompleteEvent:()=>$n,ActionStartEvent:()=>Zn,ActivateEvent:()=>Gn,AddEvent:()=>Qn,CollisionEndEvent:()=>Ti,CollisionPostSolveEvent:()=>ps,CollisionPreSolveEvent:()=>_s,CollisionStartEvent:()=>Ai,ContactEndEvent:()=>fs,ContactStartEvent:()=>us,DeactivateEvent:()=>Xn,EnterTriggerEvent:()=>Yn,EnterViewPortEvent:()=>qn,EventTypes:()=>ds,ExitTriggerEvent:()=>jn,ExitViewPortEvent:()=>Vn,GameEvent:()=>N,GameStartEvent:()=>In,GameStopEvent:()=>Rn,GamepadAxisEvent:()=>Wn,GamepadButtonEvent:()=>Hn,GamepadConnectEvent:()=>zn,GamepadDisconnectEvent:()=>Un,HiddenEvent:()=>Nn,InitializeEvent:()=>wi,KillEvent:()=>Ps,PostCollisionEvent:()=>Qe,PostDebugDrawEvent:()=>Bn,PostDrawEvent:()=>vi,PostFrameEvent:()=>Ln,PostKillEvent:()=>En,PostTransformDrawEvent:()=>Dn,PostUpdateEvent:()=>ke,PreCollisionEvent:()=>$e,PreDebugDrawEvent:()=>Fn,PreDrawEvent:()=>mi,PreFrameEvent:()=>kn,PreKillEvent:()=>Sn,PreTransformDrawEvent:()=>Mn,PreUpdateEvent:()=>Be,RemoveEvent:()=>Kn,VisibleEvent:()=>On});var yn={};Ct.r(yn);Ct.d(yn,{ConsoleAppender:()=>Cn,DrawUtil:()=>xn,EasingFunctions:()=>tt,LogLevel:()=>mt,Logger:()=>k,Observable:()=>Lt,ScreenAppender:()=>Qr,addItemToArray:()=>qa,contains:()=>Kr,delay:()=>ns,fail:()=>Jr,getPosition:()=>bi,isObject:()=>ts,mergeDeep:()=>rs,omit:()=>to,removeItemFromArray:()=>_i});function jr(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(r){window.setInterval(r,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(e){return new Promise((i,s)=>{t.call(this,e,i,s)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(r){const t=Date.now();return setTimeout(function(){r({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(r){clearTimeout(r)})}class Tt{static useCanvasGraphicsContext(){Tt.enable("use-canvas-context")}static useLegacyImageRenderer(){Tt.enable("use-legacy-image-renderer")}static freeze(){Tt._FROZEN=!0}static _reset(){Tt._FROZEN=!1,Tt._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Tt._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Tt._FLAGS[t]=!1}static isEnabled(t){return!!Tt._FLAGS[t]}static show(){return Object.keys(Tt._FLAGS)}}Tt._FROZEN=!1;Tt._FLAGS={};function Ye(r,t){return{type:r,value:t}}class Zt{constructor(){this._isCompleted=!1,this.promise=new Promise((t,e)=>{this._resolver=t,this._rejecter=e})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class nt{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,e){var i;return this._empty=!1,this._listeners[t]=(i=this._listeners[t])!==null&&i!==void 0?i:[],this._listeners[t].push(e),{close:()=>this.off(t,e)}}once(t,e){var i;return this._empty=!1,this._listenersOnce[t]=(i=this._listenersOnce[t])!==null&&i!==void 0?i:[],this._listenersOnce[t].push(e),{close:()=>this.off(t,e)}}off(t,e){var i,s;if(e){const n=(i=this._listeners[t])===null||i===void 0?void 0:i.filter(a=>a!==e);this._listeners[t]=n;const o=(s=this._listenersOnce[t])===null||s===void 0?void 0:s.filter(a=>a!==e);this._listenersOnce[t]=o}else delete this._listeners[t]}emit(t,e){if(this._empty||this._paused)return;const i=this._listeners[t];if(i)for(let n=0;n<i.length;n++)i[n](e);const s=this._listenersOnce[t];if(this._listenersOnce[t]=[],s)for(let n=0;n<s.length;n++)s[n](e);for(let n=0;n<this._pipes.length;n++)this._pipes[n].emit(t,e)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}}}unpipe(t){const e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var je;(function(r){r.Canvas="Canvas",r.Document="Document"})(je||(je={}));var at;(function(r){r.ShortestPath="shortest-path",r.LongestPath="longest-path",r.Clockwise="clockwise",r.CounterClockwise="counter-clockwise"})(at||(at={}));const Xs=4294967295;class fi{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let e=1;e<this._n;e++){const i=this._mt[e-1]^this._mt[e-1]>>>this._w-2;this._mt[e]=(this._f*((i&4294901760)>>>16)<<16)+this._f*(i&65535)+e>>>0}this._index=this._n}_twist(){const t=[0,this._a];let e=0,i=0;for(;i<this._n-this._m;i++)e=this._mt[i]&this._upperMask|this._mt[i+1]&this._lowerMask,this._mt[i]=this._mt[i+this._m]^e>>>1^t[e&1]&Xs;for(;i<this._n-1;i++)e=this._mt[i]&this._upperMask|this._mt[i+1]&this._lowerMask,this._mt[i]=this._mt[i+(this._m-this._n)]^e>>>1^t[e&1]&Xs;e=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^e>>>1^t[e&1]&Xs,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,e){return(e-t)*this.next()+t}integer(t,e){return Math.floor((e-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,e,i=!1){return i?this._pickSetWithDuplicates(t,e):this._pickSetWithoutDuplicates(t,e)}_pickSetWithoutDuplicates(t,e){if(e>t.length||e<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(e===t.length)return t;const i=new Array(e);let s=0;const n=t.slice(0);for(;s<e;){const o=this.integer(0,n.length-1);i[s++]=n[o],n.splice(o,1)}return i}_pickSetWithDuplicates(t,e){if(e<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const i=new Array(e);for(let s=0;s<e;s++)i[s]=this.pickOne(t);return i}shuffle(t){const e=t.slice(0);let i;for(let s=0;s<e.length-2;s++){const n=this.integer(s,e.length-1);i=e[s],e[s]=e[n],e[n]=i}return e}range(t,e,i){const s=new Array(t);for(let n=0;n<t;n++)s[n]=this.integer(e,i);return s}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const vt=Math.PI*2;function Na(r){return r>=0?r-Math.floor(r):r-Math.ceil(r)}function et(r){return r===0?0:r<0?-1:1}function X(r,t,e){return Math.min(Math.max(t,r),e)}function Zr(r,t,e){return Math.abs(r-t)<e}function be(r){let t=r;if(r>=vt)for(;t>=vt;)t-=vt;if(r<0)for(;t<0;)t+=vt;return t}function $r(r){return 180/Math.PI*r}function Ga(r){return r/180*Math.PI}const Xa=(r,t)=>Array.from(new Array(t-r+1),(e,i)=>i+r);function he(r,t,e=new fi){return e?e.floating(r,t):r+Math.random()*(t-r)}function Va(r,t,e=new fi){return e?e.integer(r,t):Math.round(he(r,t))}class p{static get Zero(){return new p(0,0)}static get One(){return new p(1,1)}static get Half(){return new p(.5,.5)}static get Up(){return new p(0,-1)}static get Down(){return new p(0,1)}static get Left(){return new p(-1,0)}static get Right(){return new p(1,0)}static fromAngle(t){return new p(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}static min(t,e){return new p(Math.min(t.x,e.x),Math.min(t.y,e.y))}static max(t,e){return new p(Math.max(t.x,e.x),Math.max(t.y,e.y))}constructor(t,e){this._x=0,this._y=0,this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,e){this.x=t,this.y=e}equals(t,e=p.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}squareDistance(t){t||(t=p.Zero);const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}clampMagnitude(t){const e=this.magnitude,i=X(e,0,t);return this.magnitude=i,this}get size(){return this.distance()}set size(t){const e=this.normalize().scale(t);this.setTo(e.x,e.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?p.Zero:new p(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,e){const i=e||new p(0,0);return t instanceof p?(i.x=this.x*t.x,i.y=this.y*t.y):(i.x=this.x*t,i.y=this.y*t),i}add(t,e){return e?(e.x=this.x+t.x,e.y=this.y+t.y,e):new p(this.x+t.x,this.y+t.y)}sub(t,e){const i=e||new p(0,0),s=this.x-t.x,n=this.y-t.y;return i.x=s,i.y=n,i}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof p)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new p(t*this.y,-t*this.x)}static cross(t,e){return new p(-t*e.y,t*e.x)}perpendicular(){return new p(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return be(Math.atan2(this.y,this.x))}angleBetween(t,e){const i=this.toAngle(),s=be(t);let n=0,o=0;switch(s>i?n=s-i:n=(vt-i+s)%vt,o=(n-vt)%vt,e){case at.ShortestPath:return Math.abs(n)<Math.abs(o)?n:o;case at.LongestPath:return Math.abs(n)>Math.abs(o)?n:o;case at.Clockwise:return n;case at.CounterClockwise:return o}}rotate(t,e,i){const s=i||new p(0,0);e||(e=new p(0,0));const n=Math.sin(t),o=Math.cos(t),a=o*(this.x-e.x)-n*(this.y-e.y)+e.x,h=n*(this.x-e.x)+o*(this.y-e.y)+e.y;return s.x=a,s.y=h,s}clone(t){const e=t??new p(0,0);return e.x=this.x,e.y=this.y,e}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}p.EQUALS_EPSILON=.001;function b(r,t){return new p(r,t)}class E{constructor(t,e,i,s){this.r=t,this.g=e,this.b=i,this.a=s??1}static fromRGB(t,e,i,s){return new E(t,e,i,s)}static fromRGBString(t){const e=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let i=null;if(i=t.match(e)){const s=parseInt(i[1],10),n=parseInt(i[2],10),o=parseInt(i[3],10);let a=1;return i[4]&&(a=parseFloat(i[4])),new E(s,n,o,a)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const e=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let i=null;if(i=t.match(e)){const s=parseInt(i[1],16),n=parseInt(i[2],16),o=parseInt(i[3],16);let a=1;return i[4]&&(a=parseInt(i[4],16)/255),new E(s,n,o,a)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,e,i,s=1){return new Jt(t,e,i,s).toRGBA()}lighten(t=.1){const e=Jt.fromRGBA(this.r,this.g,this.b,this.a);return e.l+=(1-e.l)*t,e.toRGBA()}darken(t=.1){const e=Jt.fromRGBA(this.r,this.g,this.b,this.a);return e.l-=e.l*t,e.toRGBA()}saturate(t=.1){const e=Jt.fromRGBA(this.r,this.g,this.b,this.a);return e.s+=e.s*t,e.toRGBA()}desaturate(t=.1){const e=Jt.fromRGBA(this.r,this.g,this.b,this.a);return e.s-=e.s*t,e.toRGBA()}multiply(t){const e=t.r/255*this.r/255*255,i=t.g/255*this.g/255*255,s=t.b/255*this.b/255*255,n=t.a*this.a;return new E(e,i,s,n)}screen(t){const e=t.invert(),i=t.invert();return e.multiply(i).invert()}invert(){return new E(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const e=(t.r+this.r)/2,i=(t.g+this.g)/2,s=(t.b+this.b)/2,n=(t.a+this.a)/2;return new E(e,i,s,n)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const e=Math.max(Math.round(t),0).toString(16);return e.length===1?"0"+e:e}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Jt.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const e=t||new E(this.r,this.g,this.b,this.a);return e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a,e}static get Black(){return E.fromHex("#000000")}static get White(){return E.fromHex("#FFFFFF")}static get Gray(){return E.fromHex("#808080")}static get LightGray(){return E.fromHex("#D3D3D3")}static get DarkGray(){return E.fromHex("#A9A9A9")}static get Yellow(){return E.fromHex("#FFFF00")}static get Orange(){return E.fromHex("#FFA500")}static get Red(){return E.fromHex("#FF0000")}static get Vermilion(){return E.fromHex("#FF5B31")}static get Rose(){return E.fromHex("#FF007F")}static get Pink(){return E.fromHex("#FFC0CB")}static get Magenta(){return E.fromHex("#FF00FF")}static get Violet(){return E.fromHex("#7F00FF")}static get Purple(){return E.fromHex("#800080")}static get Blue(){return E.fromHex("#0000FF")}static get Azure(){return E.fromHex("#007FFF")}static get Cyan(){return E.fromHex("#00FFFF")}static get Viridian(){return E.fromHex("#59978F")}static get Teal(){return E.fromHex("#008080")}static get Green(){return E.fromHex("#00FF00")}static get Chartreuse(){return E.fromHex("#7FFF00")}static get Transparent(){return E.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return E.fromHex("#176BAA")}static get Brown(){return E.fromHex("#964B00")}}class Jt{constructor(t,e,i,s){this.h=t,this.s=e,this.l=i,this.a=s}static hue2rgb(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+(e-t)*6*i:i<1/2?e:i<2/3?t+(e-t)*(2/3-i)*6:t}static fromRGBA(t,e,i,s){t/=255,e/=255,i/=255;const n=Math.max(t,e,i),o=Math.min(t,e,i);let a,h;const l=(n+o)/2;if(n===o)a=h=0;else{const c=n-o;switch(h=l>.5?c/(2-n-o):c/(n+o),n){case t:a=(e-i)/c+(e<i?6:0);break;case e:a=(i-t)/c+2;break;case i:a=(t-e)/c+4;break}a/=6}return new Jt(a,h,l,s)}toRGBA(){let t,e,i;if(this.s===0)t=e=i=this.l;else{const s=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,n=2*this.l-s;t=Jt.hue2rgb(n,s,this.h+1/3),e=Jt.hue2rgb(n,s,this.h),i=Jt.hue2rgb(n,s,this.h-1/3)}return new E(t*255,e*255,i*255,this.a)}toString(){const t=this.h.toFixed(0),e=this.s.toFixed(0),i=this.l.toFixed(0),s=this.a.toFixed(0);return`hsla(${t}, ${e}, ${i}, ${s})`}}var mt;(function(r){r[r.Debug=0]="Debug",r[r.Info=1]="Info",r[r.Warn=2]="Warn",r[r.Error=3]="Error",r[r.Fatal=4]="Fatal"})(mt||(mt={}));class k{constructor(){if(this._appenders=[],this.defaultLevel=mt.Info,this._logOnceSet=new Set,k._INSTANCE)throw new Error("Logger is a singleton");return k._INSTANCE=this,k._INSTANCE.addAppender(new Cn),k._INSTANCE}static getInstance(){return k._INSTANCE==null&&(k._INSTANCE=new k),k._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,e){t==null&&(t=this.defaultLevel);const i=this._appenders.length;for(let s=0;s<i;s++)t>=this.defaultLevel&&this._appenders[s].log(t,e)}_logOnce(t,e){const i=t+e.join("+");this._logOnceSet.has(i)||(this._logOnceSet.add(i),this._log(t,e))}debug(...t){this._log(mt.Debug,t)}debugOnce(...t){this._logOnce(mt.Debug,t)}info(...t){this._log(mt.Info,t)}infoOnce(...t){this._logOnce(mt.Info,t)}warn(...t){this._log(mt.Warn,t)}warnOnce(...t){this._logOnce(mt.Warn,t)}error(...t){this._log(mt.Error,t)}errorOnce(...t){this._logOnce(mt.Error,t)}fatal(...t){this._log(mt.Fatal,t)}fatalOnce(...t){this._logOnce(mt.Fatal,t)}}k._INSTANCE=null;class Cn{log(t,e){if(!console&&!console.log&&console.warn&&console.error)return;const i=[];i.unshift.apply(i,e),i.unshift("["+mt[t]+"] : "),t<mt.Warn?console.log.apply?console.log.apply(console,i):console.log(i.join(" ")):t<mt.Error?console.warn.apply?console.warn.apply(console,i):console.warn(i.join(" ")):console.error.apply?console.error.apply(console,i):console.error(i.join(" "))}}class Qr{constructor(t){var e,i;this._messages=[],this._pos=10,this._color=E.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(i=(e=t.zIndex)===null||e===void 0?void 0:e.toString())!==null&&i!==void 0?i:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,e,i,s;const n=this._options;this.canvas.width=(t=n.width)!==null&&t!==void 0?t:n.engine.screen.resolution.width,this.canvas.height=(e=n.height)!==null&&e!==void 0?e:n.engine.screen.resolution.height,this.canvas.style.position="absolute";const o=n.engine.screen.screenToPageCoordinates(b(0,0));this.canvas.style.left=o.x+"px",this.canvas.style.top=o.y+"px",this._pos=(i=n.xPos)!==null&&i!==void 0?i:this._pos,this._color=(s=n.color)!==null&&s!==void 0?s:this._color}log(t,e){const i=e.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+mt[t]+"] : "+i);let s=10;this._messages=this._messages.slice(0,1e3);for(let n=0;n<this._messages.length;n++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[n],this._pos,s),s+=10}}var K;(function(r){r.None="None",r.Top="Top",r.Bottom="Bottom",r.Left="Left",r.Right="Right"})(K||(K={}));(function(r){function t(i){return i===r.Top?r.Bottom:i===r.Bottom?r.Top:i===r.Left?r.Right:i===r.Right?r.Left:r.None}r.getOpposite=t;function e(i){return Math.abs(i.x)>=Math.abs(i.y)?i.x<=0?r.Left:r.Right:i.y<=0?r.Top:r.Bottom}r.fromDirection=e})(K||(K={}));class B{constructor(t=0,e=0,i=0,s=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=e,this.right=i,this.bottom=s)}clone(t){const e=t||new B(0,0,0,0);return e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?K.Right:K.Left:t.y<0?K.Bottom:K.Top:K.None}static fromPoints(t){let e=1/0,i=1/0,s=-1/0,n=-1/0;for(let o=0;o<t.length;o++)t[o].x<e&&(e=t[o].x),t[o].x>s&&(s=t[o].x),t[o].y<i&&(i=t[o].y),t[o].y>n&&(n=t[o].y);return new B(e,i,s,n)}static fromDimension(t,e,i=p.Half,s=p.Zero){return new B(-t*i.x+s.x,-e*i.y+s.y,t-t*i.x+s.x,e-e*i.y+s.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new p((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new p(this.left,this.top)}get bottomRight(){return new p(this.right,this.bottom)}get topRight(){return new p(this.right,this.top)}get bottomLeft(){return new p(this.left,this.bottom)}translate(t){return new B(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,e=p.Zero){const i=this.getPoints().map(s=>s.rotate(t,e));return B.fromPoints(i)}scale(t,e=p.Zero){const i=this.translate(e);return new B(i.left*t.x,i.top*t.y,i.right*t.x,i.bottom*t.y)}transform(t){const e=t.data[0]*this.left,i=t.data[1]*this.left,s=t.data[0]*this.right,n=t.data[1]*this.right,o=t.data[2]*this.top,a=t.data[3]*this.top,h=t.data[2]*this.bottom,l=t.data[3]*this.bottom,c=t.getPosition(),d=Math.min(e,s)+Math.min(o,h)+c.x,f=Math.min(i,n)+Math.min(a,l)+c.y,_=Math.max(e,s)+Math.max(o,h)+c.x,g=Math.max(i,n)+Math.max(a,l)+c.y;return new B({left:d,top:f,right:_,bottom:g})}getPerimeter(){const t=this.width,e=this.height;return 2*(t+e)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new p(this.left,this.top)),this._points.push(new p(this.right,this.top)),this._points.push(new p(this.right,this.bottom)),this._points.push(new p(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,e=1/0){let i=-1/0,s=1/0;const n=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,o=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,a=(this.left-t.pos.x)*n,h=(this.right-t.pos.x)*n;i=Math.min(a,h),s=Math.max(a,h);const l=(this.top-t.pos.y)*o,c=(this.bottom-t.pos.y)*o;return i=Math.max(i,Math.min(l,c)),s=Math.min(s,Math.max(l,c)),s>=Math.max(0,i)&&i<e}rayCastTime(t,e=1/0){let i=-1/0,s=1/0;const n=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,o=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,a=(this.left-t.pos.x)*n,h=(this.right-t.pos.x)*n;i=Math.min(a,h),s=Math.max(a,h);const l=(this.top-t.pos.y)*o,c=(this.bottom-t.pos.y)*o;return i=Math.max(i,Math.min(l,c)),s=Math.min(s,Math.max(l,c)),s>=Math.max(0,i)&&i<e?i:-1}contains(t){return t instanceof p?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof B?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,e){const i=e||new B(0,0,0,0),s=Math.min(this.left,t.left),n=Math.min(this.top,t.top),o=Math.max(this.right,t.right),a=Math.max(this.bottom,t.bottom);return i.left=s,i.top=n,i.right=o,i.bottom=a,i}get dimensions(){return new p(this.width,this.height)}overlaps(t,e){const i=e||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const s=this.combine(t);return s.width+i<t.width+this.width&&s.height+i<t.height+this.height}intersect(t){const e=this.combine(t);if(e.width<t.width+this.width&&e.height<t.height+this.height&&!e.dimensions.equals(t.dimensions)&&!e.dimensions.equals(this.dimensions)){let i=0;this.right>=t.left&&this.right<=t.right?i=t.left-this.right:i=t.right-this.left;let s=0;return this.top<=t.bottom&&this.top>=t.top?s=t.bottom-this.top:s=t.top-this.bottom,Math.abs(i)<Math.abs(s)?new p(i,0):new p(0,s)}else if(e.dimensions.equals(t.dimensions)||e.dimensions.equals(this.dimensions)){let i=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?i=t.left-this.right:i=t.right-this.left:t.right-this.right<=this.left-t.left?i=this.left-t.right:i=this.right-t.left;let s=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?s=t.top-this.bottom:s=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?s=this.top-t.bottom:s=this.bottom-t.top,Math.abs(i)<Math.abs(s)?new p(i,0):new p(0,s)}else return null}intersectWithSide(t){const e=this.intersect(t);return B.getSideFromIntersection(e)}draw(t,e=E.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:e})}}function bi(r){if(r&&r.getBoundingClientRect){const t=r.getBoundingClientRect();return b(t.x+window.scrollX,t.y+window.scrollY)}return p.Zero}function qa(r,t){return t.indexOf(r)===-1?(t.push(r),!0):!1}function _i(r,t){let e=-1;return(e=t.indexOf(r))>-1?(t.splice(e,1),!0):!1}function Kr(r,t){for(let e=0;e<r.length;e++)if(r[e]===t)return!0;return!1}function Jr(r){throw new Error(r)}function ns(r,t){var e;const i=new Zt;return((e=t==null?void 0:t.schedule.bind(t))!==null&&e!==void 0?e:setTimeout)(()=>{i.resolve()},r),i.promise}function to(r,t){const e={};for(const i in r)t.includes(i)||(e[i]=r[i]);return e}function ts(r){return r&&typeof r=="object"&&!Array.isArray(r)}function rs(r,...t){if(!t.length)return r;const e=t.shift();if(ts(r)&&ts(e))for(const i in e)ts(e[i])?(r[i]||Object.assign(r,{[i]:{}}),rs(r[i],e[i])):Object.assign(r,{[i]:e[i]});return rs(r,...t)}var Ys;(function(r){r[r.X=12]="X",r[r.Y=13]="Y"})(Ys||(Ys={}));class Gt{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,e,i,s,n,o){const a=new Gt;return a.data[0]=2/(e-t),a.data[1]=0,a.data[2]=0,a.data[3]=0,a.data[4]=0,a.data[5]=2/(s-i),a.data[6]=0,a.data[7]=0,a.data[8]=0,a.data[9]=0,a.data[10]=-2/(o-n),a.data[11]=0,a.data[12]=-(e+t)/(e-t),a.data[13]=-(s+i)/(s-i),a.data[14]=-(o+n)/(o-n),a.data[15]=1,a}clone(t){const e=t||new Gt;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e.data[6]=this.data[6],e.data[7]=this.data[7],e.data[8]=this.data[8],e.data[9]=this.data[9],e.data[10]=this.data[10],e.data[11]=this.data[11],e.data[12]=this.data[12],e.data[13]=this.data[13],e.data[14]=this.data[14],e.data[15]=this.data[15],e}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const e=new Gt;return e.data=t,e}static identity(){const t=new Gt;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,e){const i=Gt.identity();return i.data[12]=t,i.data[13]=e,i}static scale(t,e){const i=Gt.identity();return i.data[0]=t,i.data[5]=e,i.data[10]=1,i.data[15]=1,i}static rotation(t){const e=Gt.identity();return e.data[0]=Math.cos(t),e.data[4]=-Math.sin(t),e.data[1]=Math.sin(t),e.data[5]=Math.cos(t),e}multiply(t,e){if(t instanceof p){const i=e||new p(0,0),s=t,n=s.x*this.data[0]+s.y*this.data[4]+this.data[12],o=s.x*this.data[1]+s.y*this.data[5]+this.data[13];return i.x=n,i.y=o,i}else{const i=e||new Gt,s=t,n=this.data[0],o=this.data[1],a=this.data[2],h=this.data[3],l=this.data[4],c=this.data[5],d=this.data[6],f=this.data[7],_=this.data[8],g=this.data[9],v=this.data[10],C=this.data[11],m=this.data[12],w=this.data[13],T=this.data[14],P=this.data[15],S=s.data[0],F=s.data[1],A=s.data[2],L=s.data[3],W=s.data[4],U=s.data[5],q=s.data[6],wt=s.data[7],rt=s.data[8],$=s.data[9],Rt=s.data[10],At=s.data[11],M=s.data[12],ze=s.data[13],Ue=s.data[14],He=s.data[15];i.data[0]=n*S+l*F+_*A+m*L,i.data[1]=o*S+c*F+g*A+w*L,i.data[2]=a*S+d*F+v*A+T*L,i.data[3]=h*S+f*F+C*A+P*L,i.data[4]=n*W+l*U+_*q+m*wt,i.data[5]=o*W+c*U+g*q+w*wt,i.data[6]=a*W+d*U+v*q+T*wt,i.data[7]=h*W+f*U+C*q+P*wt,i.data[8]=n*rt+l*$+_*Rt+m*At,i.data[9]=o*rt+c*$+g*Rt+w*At,i.data[10]=a*rt+d*$+v*Rt+T*At,i.data[11]=h*rt+f*$+C*Rt+P*At,i.data[12]=n*M+l*ze+_*Ue+m*He,i.data[13]=o*M+c*ze+g*Ue+w*He,i.data[14]=a*M+d*ze+v*Ue+T*He,i.data[15]=h*M+f*ze+C*Ue+P*He;const ti=this.getScale();return i._scaleSignX=et(ti.x)*et(i._scaleSignX),i._scaleSignY=et(ti.y)*et(i._scaleSignY),i}}translate(t,e){const i=this.data[0],s=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=this.data[6],c=this.data[7],d=this.data[8],f=this.data[9],_=this.data[10],g=this.data[11],v=this.data[12],C=this.data[13],m=this.data[14],w=this.data[15],T=0,P=1;return this.data[12]=i*t+a*e+d*T+v*P,this.data[13]=s*t+h*e+f*T+C*P,this.data[14]=n*t+l*e+_*T+m*P,this.data[15]=o*t+c*e+g*T+w*P,this}setPosition(t,e){this.data[12]=t,this.data[13]=e}getPosition(){return b(this.data[12],this.data[13])}rotate(t){const e=this.data[0],i=this.data[1],s=this.data[2],n=this.data[3],o=this.data[4],a=this.data[5],h=this.data[6],l=this.data[7],c=Math.sin(t),d=Math.cos(t);return this.data[0]=d*e+c*o,this.data[1]=d*i+c*a,this.data[2]=d*s+c*h,this.data[3]=d*n+c*l,this.data[4]=d*o-c*e,this.data[5]=d*a-c*i,this.data[6]=d*h-c*s,this.data[7]=d*l-c*n,this}scale(t,e){const i=this.data[0],s=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=this.data[6],c=this.data[7];return this.data[0]=i*t,this.data[1]=s*t,this.data[2]=n*t,this.data[3]=o*t,this.data[4]=a*e,this.data[5]=h*e,this.data[6]=l*e,this.data[7]=c*e,this}setRotation(t){const e=this.getScale(),i=Math.sin(t),s=Math.cos(t);this.data[0]=s*e.x,this.data[1]=i*e.y,this.data[4]=-i*e.x,this.data[5]=s*e.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return be(t)}getScaleX(){const t=b(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=b(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return b(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=et(t);const e=b(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[4]=e.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=et(t);const e=b(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[5]=e.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const i=1/this.getBasisDeterminant(),s=this.data[0],n=this.data[4],o=this.data[1],a=this.data[5],h=t||Gt.identity();h.data[0]=a*i,h.data[1]=-o*i,h.data[4]=-n*i,h.data[5]=s*i;const l=this.data[12],c=this.data[13];return h.data[12]=-(l*h.data[0]+c*h.data[4]),h.data[13]=-(l*h.data[1]+c*h.data[5]),h}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class _t{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new _t;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,e){const i=_t.identity();return i.data[4]=t,i.data[5]=e,i}static scale(t,e){const i=_t.identity();return i.data[0]=t,i.data[3]=e,i._scale[0]=t,i._scale[1]=e,i}static rotation(t){const e=_t.identity();return e.data[0]=Math.cos(t),e.data[1]=Math.sin(t),e.data[2]=-Math.sin(t),e.data[3]=Math.cos(t),e}setPosition(t,e){this.data[4]=t,this.data[5]=e}getPosition(){return b(this.data[4],this.data[5])}rotate(t){const e=this.data[0],i=this.data[1],s=this.data[2],n=this.data[3],o=Math.sin(t),a=Math.cos(t);return this.data[0]=a*e+o*s,this.data[1]=a*i+o*n,this.data[2]=a*s-o*e,this.data[3]=a*n-o*i,this}translate(t,e){const i=this.data[0],s=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5];return this.data[4]=i*t+n*e+a,this.data[5]=s*t+o*e+h,this}scale(t,e){const i=this.data[0],s=this.data[1],n=this.data[2],o=this.data[3];return this.data[0]=i*t,this.data[1]=s*t,this.data[2]=n*e,this.data[3]=o*e,this._scale[0]=t,this._scale[1]=e,this._scaleSignX=et(t),this._scaleSignY=et(e),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const e=this.determinant();let i=e;e!==0&&(i=1/e);const s=this.data[0],n=this.data[2],o=this.data[1],a=this.data[3],h=t||_t.identity();h.data[0]=a*i,h.data[1]=-o*i,h.data[2]=-n*i,h.data[3]=s*i;const l=this.data[4],c=this.data[5];return h.data[4]=-(l*h.data[0]+c*h.data[2]),h.data[5]=-(l*h.data[1]+c*h.data[3]),h}multiply(t,e){if(t instanceof p){const i=e||new p(0,0),s=t,n=s.x*this.data[0]+s.y*this.data[2]+this.data[4],o=s.x*this.data[1]+s.y*this.data[3]+this.data[5];return i.x=n,i.y=o,i}else{const i=e||new _t,s=t,n=this.data[0],o=this.data[1],a=this.data[2],h=this.data[3],l=this.data[4],c=this.data[5],d=s.data[0],f=s.data[1],_=s.data[2],g=s.data[3],v=s.data[4],C=s.data[5];i.data[0]=n*d+a*f,i.data[1]=o*d+h*f,i.data[2]=n*_+a*g,i.data[3]=o*_+h*g,i.data[4]=n*v+a*C+l,i.data[5]=o*v+h*C+c;const m=this._scaleSignX,w=this._scaleSignY;return i._scaleSignX=m*et(i._scaleSignX),i._scaleSignY=w*et(i._scaleSignY),i}}multiplyQuadInPlace(t){const e=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],i=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=e,t[1]=i;const s=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],n=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=s,t[3]=n;const o=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],a=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=o,t[5]=a;const h=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],l=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=h,t[7]=l}to4x4(){const t=new Gt;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const e=this.getScale(),i=Math.sin(t),s=Math.cos(t);this.data[0]=s*e.x,this.data[1]=i*e.y,this.data[2]=-i*e.x,this.data[3]=s*e.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return be(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return b(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=et(t);const e=b(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[2]=e.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=et(t);const e=b(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[3]=e.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const e=t||new _t;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e._scaleSignX=this._scaleSignX,e._scaleSignY=this._scaleSignY,e}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class Ui{constructor(t,e,i=1){this.builder=t,this.cleaner=e,this._pool=[],this._size=0,this.grow(i)}grow(t){if(t>0){this._size+=t;for(let e=0;e<t;e++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}class Ya{constructor(){this._pool=new Ui(()=>_t.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,e){return this._currentTransform.translate(t,e)}rotate(t){return this._currentTransform.rotate(t)}scale(t,e){return this._currentTransform.scale(t,e)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class ja{constructor(){this.opacity=1,this.z=0,this.tint=E.White,this.material=null}}class eo{constructor(){this._pool=new Ui(()=>new ja,t=>(t.opacity=1,t.z=0,t.tint=E.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var e;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(e=this.current.tint)===null||e===void 0?void 0:e.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Za={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Hi{constructor(t,e,i=!1){this.path=t,this.responseType=e,this.bustCache=i,this.data=null,this.logger=k.getInstance(),this.events=new nt}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,e)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const i=new XMLHttpRequest;i.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),i.responseType=this.responseType,i.addEventListener("loadstart",s=>this.events.emit("loadstart",s)),i.addEventListener("progress",s=>this.events.emit("progress",s)),i.addEventListener("error",s=>this.events.emit("error",s)),i.addEventListener("load",s=>this.events.emit("load",s)),i.addEventListener("load",()=>{if(i.status!==0&&i.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",i.status),this.events.emit("error",i.response),e(new Error(i.statusText));return}if(i.response instanceof Blob&&i.response.type==="text/html"){const s=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",i.response),e(new Error(s));return}this.data=i.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),i.send()})}}function ee(r,t){return r&&(r.__isProxy===void 0?new Proxy(r,{set:(e,i,s)=>(e[i]!==s&&(e[i]=s,typeof i=="string"&&i[0]!=="_"&&t(e)),!0),get:(e,i)=>i!=="__isProxy"?e[i]:!0}):r)}const io=(r=[],t,e)=>({get:(i,s)=>s==="__isProxy"?!0:typeof i[s]=="object"&&i[s]!=null?new Proxy(i[s],io([...r,s],t,e)):i[s],set:(i,s,n)=>(typeof s=="string"&&s[0]!=="_"&&t(e),i[s]=n,!0)});function $a(r,t){return r&&(r.__isProxy===void 0?new Proxy(r,io([],t,r)):r)}class ht{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=ee(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=ee(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var e,i,s,n,o,a,h;this.id=ht._ID++,this.transform=_t.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=p.One,this._width=0,this._height=0,t&&(this.origin=(e=t.origin)!==null&&e!==void 0?e:this.origin,this.flipHorizontal=(i=t.flipHorizontal)!==null&&i!==void 0?i:this.flipHorizontal,this.flipVertical=(s=t.flipVertical)!==null&&s!==void 0?s:this.flipVertical,this.rotation=(n=t.rotation)!==null&&n!==void 0?n:this.rotation,this.opacity=(o=t.opacity)!==null&&o!==void 0?o:this.opacity,this.scale=(a=t.scale)!==null&&a!==void 0?a:this.scale,this.tint=(h=t.tint)!==null&&h!==void 0?h:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return B.fromDimension(this.width,this.height,p.Zero)}draw(t,e,i){this._preDraw(t,e,i),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,e,i){t.save(),t.translate(e,i),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var e;const i=this.scale.x>0?1:-1,s=this.scale.y>0?1:-1,n=(e=this.origin)!==null&&e!==void 0?e:b(this.width/2,this.height/2);t.translate(n.x,n.y),t.rotate(this.rotation),t.scale(i,s),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}ht._ID=0;class ie extends ht{static from(t,e){return new ie({image:t,...e})}constructor(t){var e,i;super(t),this._logger=k.getInstance(),this._dirty=!0,this.image=t.image;const{width:s,height:n}=t;this.sourceView=(e=t.sourceView)!==null&&e!==void 0?e:{x:0,y:0,width:s??0,height:n??0},this.destSize=(i=t.destSize)!==null&&i!==void 0?i:{width:s??0,height:n??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,e,i,s,n,o;const{width:a,height:h}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||a,this.sourceView.height=((e=this.sourceView)===null||e===void 0?void 0:e.height)||h,this.destSize.width=((i=this.destSize)===null||i===void 0?void 0:i.width)||((s=this.sourceView)===null||s===void 0?void 0:s.width)||a,this.destSize.height=((n=this.destSize)===null||n===void 0?void 0:n.height)||((o=this.sourceView)===null||o===void 0?void 0:o.height)||h,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,e,i){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,e,i)}_drawImage(t,e,i){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,e,i,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new ie({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var gt;(function(r){r.Pixel="Pixel",r.Blended="Blended"})(gt||(gt={}));function pi(r){switch(r){case gt.Pixel:return gt.Pixel;case gt.Blended:return gt.Blended;default:return}}var it;(function(r){r.Clamp="Clamp",r.Repeat="Repeat",r.Mirror="Mirror"})(it||(it={}));function re(r){switch(r){case it.Clamp:return it.Clamp;case it.Repeat:return it.Repeat;case it.Mirror:return it.Mirror;default:return it.Clamp}}class ot{constructor(t,e){var i;this._garbageCollector=e,this._textureMap=new Map,this._collect=s=>{var n;if(this._gl){const o=(n=s.dataset.originalSrc)!==null&&n!==void 0?n:s.constructor.name;return ot._LOGGER.debug(`WebGL Texture for ${o} collected`),this.delete(s),!0}return!1},this._gl=t,ot._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(ot._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(i=this._garbageCollector.garbageCollector)===null||i===void 0||i.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,e,i=!1){var s,n;const o=this._gl;if(!o)return null;const{filtering:a,wrapping:h}={...e};let l=null;if(this.has(t)&&(l=this.get(t)),l)return i&&(o.bindTexture(o.TEXTURE_2D,l),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t)),(s=this._garbageCollector)===null||s===void 0||s.garbageCollector.touch(t),l;l=o.createTexture(),ot.checkImageSizeSupportedAndLog(t),o.bindTexture(o.TEXTURE_2D,l),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let c;h&&(typeof h=="string"?c={x:h,y:h}:c={x:h.x,y:h.y});const{x:d,y:f}=c??ot.wrapping;switch(d){case it.Clamp:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);break;case it.Repeat:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.REPEAT);break;case it.Mirror:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.MIRRORED_REPEAT);break;default:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE)}switch(f){case it.Clamp:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);break;case it.Repeat:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.REPEAT);break;case it.Mirror:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.MIRRORED_REPEAT);break;default:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)}const _=a??ot.filtering;return o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,_===gt.Pixel?o.NEAREST:o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,_===gt.Pixel?o.NEAREST:o.LINEAR),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),this._textureMap.set(t,l),(n=this._garbageCollector)===null||n===void 0||n.garbageCollector.addCollectableResource("texture",t),l}delete(t){const e=this._gl;if(e&&this.has(t)){const i=this.get(t);i&&(this._textureMap.delete(t),e.deleteTexture(i))}}static checkImageSizeSupportedAndLog(t){var e;const i=(e=t.dataset.originalSrc)!==null&&e!==void 0?e:"internal canvas bitmap";return t.width>ot._MAX_TEXTURE_SIZE||t.height>ot._MAX_TEXTURE_SIZE?(ot._LOGGER.error(`The image [${i}] provided to Excalibur is too large for the device's maximum texture size of (${ot._MAX_TEXTURE_SIZE}x${ot._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&ot._LOGGER.warn(`The image [${i}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}ot._LOGGER=k.getInstance();ot.filtering=gt.Blended;ot.wrapping={x:it.Clamp,y:it.Clamp};ot._MAX_TEXTURE_SIZE=4096;const Y={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class ce{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,e,i){this._logger=k.getInstance(),this.data=new Image,this._readyFuture=new Zt,this.ready=this._readyFuture.promise,this.path=t;let s=!1,n;typeof e=="boolean"?s=e:{filtering:i,wrapping:n,bustCache:s}={...e},this._resource=new Hi(t,"blob",s),this.filtering=i??this.filtering,typeof n=="string"?this.wrapping={x:n,y:n}:this.wrapping=n??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,e){const i=new ce("");if(i._src="image-element",i.data=t,i.data.setAttribute("data-original-src","image-element"),e!=null&&e.filtering?i.data.setAttribute(Y.Filtering,e==null?void 0:e.filtering):i.data.setAttribute(Y.Filtering,gt.Blended),e!=null&&e.wrapping){let s;typeof e.wrapping=="string"?s={x:e.wrapping,y:e.wrapping}:s={x:e.wrapping.x,y:e.wrapping.y},i.data.setAttribute(Y.WrappingX,s.x),i.data.setAttribute(Y.WrappingY,s.y)}else i.data.setAttribute(Y.WrappingX,it.Clamp),i.data.setAttribute(Y.WrappingY,it.Clamp);return ot.checkImageSizeSupportedAndLog(t),i._readyFuture.resolve(t),i}static fromHtmlCanvasElement(t,e){const i=new ce("");if(i._src="canvas-element-blob",i.data.setAttribute("data-original-src","canvas-element-blob"),e!=null&&e.filtering?i.data.setAttribute(Y.Filtering,e==null?void 0:e.filtering):i.data.setAttribute(Y.Filtering,gt.Blended),e!=null&&e.wrapping){let s;typeof e.wrapping=="string"?s={x:e.wrapping,y:e.wrapping}:s={x:e.wrapping.x,y:e.wrapping.y},i.data.setAttribute(Y.WrappingX,s.x),i.data.setAttribute(Y.WrappingY,s.y)}else i.data.setAttribute(Y.WrappingX,it.Clamp),i.data.setAttribute(Y.WrappingY,it.Clamp);return ot.checkImageSizeSupportedAndLog(t),t.toBlob(s=>{const n=URL.createObjectURL(s);i.image.onload=()=>{URL.revokeObjectURL(n),i.data=i.image,i._readyFuture.resolve(i.image)},i.image.src=n}),i}static fromSvgString(t,e){const i=new Blob([t],{type:"image/svg+xml"}),s=URL.createObjectURL(i);return new ce(s,e)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,e,i,s;if(this.isLoaded())return this.data;try{let n;if(this.path.includes("data:image/"))n=this.path;else{const h=await this._resource.load();n=URL.createObjectURL(h)}const o=new Image,a=new Zt;o.onload=()=>a.resolve(),o.src=n,o.setAttribute("data-original-src",this.path),await a.promise,this.data=o,ot.checkImageSizeSupportedAndLog(this.data)}catch(n){throw`Error loading ImageSource from path '${this.path}' with error [${n.message}]`}return this.data.setAttribute(Y.Filtering,this.filtering),this.data.setAttribute(Y.WrappingX,(e=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&e!==void 0?e:it.Clamp),this.data.setAttribute(Y.WrappingY,(s=(i=this.wrapping)===null||i===void 0?void 0:i.y)!==null&&s!==void 0?s:it.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return ie.from(this,t)}unload(){this.data=new Image}}class ys extends ht{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=k.getInstance();const{alphabet:e,spriteSheet:i,caseInsensitive:s,spacing:n,shadow:o,lineHeight:a}=t;this.alphabet=e,this.spriteSheet=i,this.caseInsensitive=s??this.caseInsensitive,this.spacing=n??this.spacing,this.shadow=o??this.shadow,this.lineHeight=a??this.lineHeight}_getCharacterSprites(t){const e=[],i=this.caseInsensitive?t.toLocaleLowerCase():t,s=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let n=0;n<i.length;n++){const o=i[n];let a=s.indexOf(o);a===-1&&(a=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${o}' in configured alphabet '${s}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const h=this.spriteSheet.sprites[a];h?e.push(h):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${o}' at index '${a}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return e}measureText(t,e){const i=this._getLinesFromText(t,e),s=i.reduce((h,l)=>h.length>l.length?h:l),n=this._getCharacterSprites(s);let o=0,a=0;for(const h of n)o+=h.width+this.spacing,a=Math.max(a,h.height);return B.fromDimension(o*this.scale.x,a*i.length*this.scale.y,p.Zero)}_drawImage(t,e,i,s){var n;let o=0,a=0,h=0;const l=this._getLinesFromText(this._text,s);for(const c of l){for(const d of this._getCharacterSprites(c))d.draw(t,e+o,i+a),o+=d.width+this.spacing,h=Math.max(h,d.height);o=0,a+=(n=this.lineHeight)!==null&&n!==void 0?n:h}}render(t,e,i,s,n,o){this._text=e;const a=this.measureText(e,o);this.width=a.width,this.height=a.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,s,n),this._drawImage(t,0,0,o),this._postDraw(t),t.restore()),this._preDraw(t,s,n),this._drawImage(t,0,0,o),this._postDraw(t)}clone(){return new ys({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,e){var i;if(this._cachedText===t&&this._cachedRenderWidth===e&&(!((i=this._cachedLines)===null||i===void 0)&&i.length))return this._cachedLines;const s=t.split(`
`);if(e==null)return s;for(let n=0;n<s.length;n++){let o=s[n],a="";if(this.measureText(o).width>e){for(;this.measureText(o).width>e;)a=o[o.length-1]+a,o=o.slice(0,-1);s[n]=o,s[n+1]=a}}return this._cachedText=t,this._cachedLines=s,this._cachedRenderWidth=e,s}}class Wi extends ie{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new Zt,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,e){return new Wi({sourceView:{...t.sourceView},width:t.width,height:t.height,...e,image:t.image})}_applyTiling(){const{width:t,height:e,filtering:i,wrapping:s}={...this._options},n=document.createElement("canvas");n.width=this.sourceView.width,n.height=this.sourceView.height,n.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const a=ce.fromHtmlCanvasElement(n,{wrapping:s??it.Repeat,filtering:i});t&&(this.destSize.width=t,this.sourceView.width=t),e&&(this.destSize.height=e,this.sourceView.height=e),this.sourceView.x=0,this.sourceView.y=0,this.image=a,this.image.ready.then(()=>this._ready.resolve())}}class Ge{constructor(t){this.sprites=[];const{sprites:e,rows:i,columns:s}=t;this.sprites=e,this.rows=i??1,this.columns=s??this.sprites.length}getSprite(t,e,i){var s,n,o,a,h,l,c,d,f;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(e>=this.rows||e<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), y: ${e} should be between 0 and ${this.rows-1} rows`);const _=t+e*this.columns,g=this.sprites[_];if(g){if(i){const v=g.clone();return v.flipHorizontal=(s=i.flipHorizontal)!==null&&s!==void 0?s:v.flipHorizontal,v.flipVertical=(n=i.flipVertical)!==null&&n!==void 0?n:v.flipVertical,v.width=(o=i.width)!==null&&o!==void 0?o:v.width,v.height=(a=i.height)!==null&&a!==void 0?a:v.height,v.rotation=(h=i.rotation)!==null&&h!==void 0?h:v.rotation,v.scale=(l=i.scale)!==null&&l!==void 0?l:v.scale,v.opacity=(c=i.opacity)!==null&&c!==void 0?c:v.opacity,v.tint=(d=i.tint)!==null&&d!==void 0?d:v.tint,v.origin=(f=i.origin)!==null&&f!==void 0?f:v.origin,v}return g}throw Error(`Invalid sprite coordinates (${t}, ${e})`)}getTiledSprite(t,e,i){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(e>=this.rows||e<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), y: ${e} should be between 0 and ${this.rows-1} rows`);const s=t+e*this.columns,n=this.sprites[s];if(n)return Wi.fromSprite(n,i);throw Error(`Invalid sprite coordinates (${t}, ${e})`)}static fromImageSourceWithSourceViews(t){const e=t.sourceViews.map(i=>new ie({image:t.image,sourceView:i}));return new Ge({sprites:e})}static fromImageSource(t){var e;const i=[];t.spacing=(e=t.spacing)!==null&&e!==void 0?e:{};const{image:s,grid:{rows:n,columns:o,spriteWidth:a,spriteHeight:h},spacing:{originOffset:l,margin:c}}=t,d={x:0,y:0,...l},f={x:0,y:0,...c};for(let _=0;_<o;_++)for(let g=0;g<n;g++)i[_+g*o]=new ie({image:s,sourceView:{x:_*a+f.x*_+d.x,y:g*h+f.y*g+d.y,width:a,height:h},destSize:{height:h,width:a}});return new Ge({sprites:i,rows:n,columns:o})}clone(){return new Ge({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Qa="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Pn{constructor(){this.fontSheet=Qa,this.size=16,this.load()}load(){return this._imageSource=new ce(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=Ge.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new ys({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,e,i){this._imageSource.isLoaded()&&this._spriteFont.render(t,e,null,i.x,i.y)}}class Ka{constructor(t,e){this._gl=t,this._texture=e}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class Qi{constructor(t){var e,i;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(e=t.antialias)!==null&&e!==void 0?e:this.antialias,this.samples=(i=t.samples)!==null&&i!==void 0?i:this._gl.getParameter(this._gl.MAX_SAMPLES);const s=this._gl;s.drawingBufferFormat?this.bufferFormat=s.drawingBufferFormat:this.transparency?this.bufferFormat=s.RGBA8:this.bufferFormat=s.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,e){const i=this._gl;this.width=t,this.height=e,i.bindTexture(i.TEXTURE_2D,this._frameTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.UNSIGNED_BYTE,null),this._renderBuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,this._renderBuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,Math.min(this.samples,i.getParameter(i.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const e=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Ka(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const e=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.bindTexture(e.TEXTURE_2D,t),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const Ja=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,th=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function js(r,t){switch(t){case r.INT:case r.UNSIGNED_INT:case r.FLOAT:return 4;case r.SHORT:return 2;case r.UNSIGNED_SHORT:return 2;case r.BYTE:return 1;case r.UNSIGNED_BYTE:return 1;default:return 1}}function so(r,t){const e=`(?<type>[a-z0-9]+)\\s+${t};`,s=new RegExp(e,"g").exec(r);return(s==null?void 0:s.length)>0}function no(r,t,e){var i;const s=`(?<type>[a-z0-9]+)\\s+${e};`,o=new RegExp(s,"g").exec(t);switch((i=o==null?void 0:o.groups)===null||i===void 0?void 0:i.type){case"float":case"vec2":case"vec3":case"vec4":return r.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return r.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return r.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return r.BOOL;case"short":return r.SHORT;case"ushort":return r.UNSIGNED_SHORT;case"ubyte":return r.UNSIGNED_BYTE;case"byte":return r.BYTE;default:return r.FLOAT}}function ro(r,t){switch(t){case r.LOW_FLOAT:case r.HIGH_FLOAT:case r.FLOAT:return 1;case r.FLOAT_VEC2:return 2;case r.FLOAT_VEC3:return 3;case r.FLOAT_VEC4:return 4;case r.BYTE:return 1;case r.UNSIGNED_BYTE:return 1;case r.UNSIGNED_SHORT:case r.SHORT:return 1;default:return 1}}function oo(r,t){switch(t){case r.LOW_FLOAT:case r.HIGH_FLOAT:case r.FLOAT:case r.FLOAT_VEC2:case r.FLOAT_VEC3:case r.FLOAT_VEC4:return r.FLOAT;case r.BYTE:return r.BYTE;case r.UNSIGNED_BYTE:return r.UNSIGNED_BYTE;case r.SHORT:return r.SHORT;case r.UNSIGNED_SHORT:return r.UNSIGNED_SHORT;default:return r.FLOAT}}function An(r,t){const e=s=>{const n=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let o="";for(let a=0;a<s;a++)a===0?o+=`if (index <= ${a}.5) {
`:o+=`   else if (index <= ${a}.5) {
`,o+=`      fragColor = vec4(1.0);
`,o+=`   }
`;return n.replace("%%complexity%%",o)};let i=!1;do{const s=e(t),n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,s),r.compileShader(n),i=r.getShaderParameter(n,r.COMPILE_STATUS),i||(t=t/2|0)}while(!i);return t}class Nt{get compiled(){return this._compiled}constructor(t){this._logger=k.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:e,vertexSource:i,fragmentSource:s,onPreLink:n,onPostCompile:o}=t;this._gl=e,this.vertexSource=i,this.fragmentSource=s,this._onPreLink=n,this._onPostCompile=o}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),Nt._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return Nt._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,e=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),i=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,e,i);const s=this.getAttributes();for(const o of s)this.attributes[o.name]=o;const n=this.getUniforms();for(const o of n)this.uniforms[o.name]=o;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),i=[];for(let s=0;s<e;s++){const n=t.getActiveUniform(this.program,s),o=t.getUniformLocation(this.program,n.name);i.push({name:n.name,glType:n.type,location:o})}return i}getAttributes(){const t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),i=[];for(let s=0;s<e;s++){const n=t.getActiveAttrib(this.program,s),o=t.getAttribLocation(this.program,n.name);i.push({name:n.name,glType:oo(t,n.type),size:ro(t,n.type),location:o,normalized:!1})}return i}setTexture(t,e){const i=this._gl;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e)}setUniformInt(t,e){this.setUniform("uniform1i",t,~~e)}trySetUniformInt(t,e){return this.trySetUniform("uniform1i",t,~~e)}setUniformIntArray(t,e){this.setUniform("uniform1iv",t,e)}trySetUniformIntArray(t,e){return this.trySetUniform("uniform1iv",t,e)}setUniformBoolean(t,e){this.setUniform("uniform1i",t,e?1:0)}trySetUniformBoolean(t,e){return this.trySetUniform("uniform1i",t,e?1:0)}setUniformFloat(t,e){this.setUniform("uniform1f",t,e)}trySetUniformFloat(t,e){return this.trySetUniform("uniform1f",t,e)}setUniformFloatArray(t,e){this.setUniform("uniform1fv",t,e)}trySetUniformFloatArray(t,e){return this.trySetUniform("uniform1fv",t,e)}setUniformFloatVector(t,e){this.setUniform("uniform2f",t,e.x,e.y)}trySetUniformFloatVector(t,e){return this.trySetUniform("uniform2f",t,e.x,e.y)}setUniformFloatColor(t,e){this.setUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}trySetUniformFloatColor(t,e){return this.trySetUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}setUniformMatrix(t,e){this.setUniform("uniformMatrix4fv",t,!1,e.data)}setUniformAffineMatrix(t,e){this.setUniform("uniformMatrix4fv",t,!1,[e.data[0],e.data[1],0,0,e.data[2],e.data[3],0,0,0,0,1,0,e.data[4],e.data[5],0,1])}trySetUniformMatrix(t,e){return this.trySetUniform("uniformMatrix4fv",t,!1,e.data)}setUniform(t,e,...i){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${e}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const n=this._gl.getUniformLocation(this.program,e);if(n){const o=[n,...i];this._gl[t].apply(this._gl,o)}else throw Error(`Uniform ${t}:${e} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,e,...i){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${e}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const n=this._gl.getUniformLocation(this.program,e);if(n){const o=[n,...i];this._gl[t].apply(this._gl,o)}else return!1;return!0}_createProgram(t,e,i){const s=t.createProgram();if(s===null)throw Error("Could not create graphics shader program");if(t.attachShader(s,e),t.attachShader(s,i),this._onPreLink&&this._onPreLink(s),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(s)}]`);return s}_compileShader(t,e,i){const s=t.VERTEX_SHADER===i?"vertex":"fragment",n=t.createShader(i);if(n===null)throw Error(`Could not build shader: [${e}]`);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const a=t.getShaderInfoLog(n);throw Error(`Could not compile ${s} shader:

${a}${this._processSourceForError(e,a)}`)}return n}_processSourceForError(t,e){if(!t)return e;const i=t.split(`
`),s=e.search(/\d:\d/),n=e.indexOf(" ",s),[o,a]=e.slice(s,n).split(":").map(h=>Number(h));for(let h=0;h<i.length;h++)i[h]=`${h+1}: ${i[h]}${a===h+1?" <----- ERROR!":""}`;return`

Source:
`+i.join(`
`)}}Nt._ACTIVE_SHADER_INSTANCE=null;class _e{constructor(t){this.type="dynamic";const{gl:e,size:i,type:s,data:n}=t;if(this._gl=e,this.buffer=this._gl.createBuffer(),!n&&!i)throw Error("Must either provide data or a size to the VertexBuffer");n?this.bufferData=n:this.bufferData=new Float32Array(i),this.type=s??this.type,e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.bufferData,this.type==="static"?e.STATIC_DRAW:e.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),t?e.bufferSubData(e.ARRAY_BUFFER,0,this.bufferData,0,t):e.bufferData(e.ARRAY_BUFFER,this.bufferData,this.type==="static"?e.STATIC_DRAW:e.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Se{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=k.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:e,shader:i,vertexBuffer:s,attributes:n,suppressWarnings:o}=t;this._gl=e,this._vertexBuffer=s,this._attributes=n,this._shader=i,this._suppressWarnings=o,i&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const n of this._attributes){const o=t[n[0]];if(!o){if(!so(this._shader.vertexSource,n[0]))throw Error(`The attribute named: ${n[0]} size ${n[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${n[0]} size ${n[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${n[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${n[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const a=no(this._gl,this._shader.vertexSource,n[0]);this._layout.push({name:n[0],glType:a,size:n[1],location:-1,normalized:!1})}if(o){if(o.size!==n[1])throw Error(`VertexLayout size definition for attribute: [${n[0]}, ${n[1]}], doesn't match shader source size ${o.size}:
 ${this._shader.vertexSource}`);this._layout.push(o)}}let e=0;for(const n of this._layout){const o=js(this._gl,n.glType);this._vertexTotalSizeBytes+=o*n.size,e+=n.size}this._vertexBuffer.bufferData.length%e!==0&&this._logger.warn(`The vertex component size (${e})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const i=this._gl;this._vao=i.createVertexArray(),i.bindVertexArray(this._vao),this._vertexBuffer.bind();let s=0;for(const n of this._layout)n.location!==-1&&(n.glType===i.INT?i.vertexAttribIPointer(n.location,n.size,n.glType,this.totalVertexSizeBytes,s):i.vertexAttribPointer(n.location,n.size,n.glType,n.normalized,this.totalVertexSizeBytes,s),i.enableVertexAttribArray(n.location)),s+=js(i,n.glType)*n.size;i.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,e){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const i=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(e),i.bindVertexArray(this._vao)}}class st{static clear(){st.DrawCallCount=0,st.DrawnImagesCount=0}}st.DrawCallCount=0;st.DrawnImagesCount=0;class eh{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=b(0,0),this._endScratch=b(0,0)}initialize(t,e){this._gl=t,this._context=e,this._shader=new Nt({gl:t,vertexSource:Ja,fragmentSource:th}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new _e({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Se({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,e,i){this._isFull()&&this.flush(),this._lineCount++;const s=this._context.getTransform(),n=s.multiply(t,this._startScratch),o=s.multiply(e,this._endScratch),a=this._vertexBuffer.bufferData;a[this._vertexIndex++]=n.x,a[this._vertexIndex++]=n.y,a[this._vertexIndex++]=i.r/255,a[this._vertexIndex++]=i.g/255,a[this._vertexIndex++]=i.b/255,a[this._vertexIndex++]=i.a,a[this._vertexIndex++]=o.x,a[this._vertexIndex++]=o.y,a[this._vertexIndex++]=i.r/255,a[this._vertexIndex++]=i.g/255,a[this._vertexIndex++]=i.b/255,a[this._vertexIndex++]=i.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),st.DrawnImagesCount+=this._lineCount,st.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const ih=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,sh=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class nh{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new Nt({gl:t,vertexSource:ih,fragmentSource:sh}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new _e({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,e,i){this._isFull()&&this.flush(),this._pointCount++;const s=this._context.getTransform(),n=this._context.opacity,o=this._context.snapToPixel,a=s.multiply(t);o&&(a.x=~~(a.x+O),a.y=~~(a.y+O));const h=this._buffer.bufferData;h[this._vertexIndex++]=a.x,h[this._vertexIndex++]=a.y,h[this._vertexIndex++]=e.r/255,h[this._vertexIndex++]=e.g/255,h[this._vertexIndex++]=e.b/255,h[this._vertexIndex++]=e.a*n,h[this._vertexIndex++]=i*Math.max(s.getScaleX(),s.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),st.DrawnImagesCount+=this._pointCount,st.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const rh=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,oh=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class ah{constructor(t){this._gl=t,this._shader=new Nt({gl:t,vertexSource:rh,fragmentSource:oh}),this._shader.compile(),this._buffer=new _e({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const e=this._gl,i=t.getShader();i.use(),t.getLayout().use(),e.activeTexture(e.TEXTURE0),i.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),e.drawArrays(e.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class Oi{constructor(t,e,i){this._logger=k.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const s=e*6;if(!i)this.bufferData=new Uint32Array(s);else{const a=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(s),e>a&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${a}) requested quads(${e})`)}let n=0;for(let o=0;o<s;o+=6)this.bufferData[o+0]=n+0,this.bufferData[o+1]=n+1,this.bufferData[o+2]=n+2,this.bufferData[o+3]=n+2,this.bufferData[o+4]=n+1,this.bufferData[o+5]=n+3,n+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const hh=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,lh=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class ch{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=E.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,e){this._gl=t,this._context=e;const i=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),s=An(t,i);this._maxTextures=Math.min(i,s);const n=this._transformFragmentSource(hh,this._maxTextures);this._shader=new Nt({gl:t,fragmentSource:n,vertexSource:lh}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((o,a)=>a)),this._buffer=new _e({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Oi(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,e){let i=t.replace("%%count%%",e.toString()),s="";for(let n=0;n<e;n++)n===0?s+=`if (v_textureIndex <= ${n}.5) {
`:s+=`   else if (v_textureIndex <= ${n}.5) {
`,s+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,s+=`      color = texture(u_textures[${n}], uv);
`,s+=`   }
`;return i=i.replace("%%texture_picker%%",s),i}_addImageAsTexture(t){if(this._images.has(t))return;const e=t.getAttribute(Y.Filtering),i=e?pi(e):void 0,s=re(t.getAttribute(Y.WrappingX)),n=re(t.getAttribute(Y.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:i,wrapping:{x:s,y:n}},o);t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&(this._textures.push(a),this._textureToIndex.set(a,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let e=0;e<this._maxTextures;e++)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textures[e]||this._textures[0])}_getTextureIdForImage(t){var e;if(t){const i=this._context.textureLoader.get(t);return(e=this._textureToIndex.get(i))!==null&&e!==void 0?e:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}draw(t,e,i,s,n,o,a,h,l){var c,d,f,_;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const g=this._getImageWidth(t),v=this._getImageHeight(t);let C=g||s||0,m=v||n||0;this._view[0]=0,this._view[1]=0,this._view[2]=(c=s??g)!==null&&c!==void 0?c:0,this._view[3]=(d=n??v)!==null&&d!==void 0?d:0,this._dest[0]=e??1,this._dest[1]=i??1,o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(this._view[0]=e??1,this._view[1]=i??1,this._view[2]=(f=s??g)!==null&&f!==void 0?f:0,this._view[3]=(_=n??v)!==null&&_!==void 0?_:0,this._dest[0]=o,this._dest[1]=a,C=h,m=l),e=this._view[0],i=this._view[1];const w=this._view[2],T=this._view[3],P=this._context.getTransform(),S=this._context.opacity,F=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+C,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+m,this._quad[6]=this._dest[0]+C,this._quad[7]=this._dest[1]+m,P.multiplyQuadInPlace(this._quad),F&&(this._quad[0]=~~(this._quad[0]+et(this._quad[0])*O),this._quad[1]=~~(this._quad[1]+et(this._quad[1])*O),this._quad[2]=~~(this._quad[2]+et(this._quad[2])*O),this._quad[3]=~~(this._quad[3]+et(this._quad[3])*O),this._quad[4]=~~(this._quad[4]+et(this._quad[4])*O),this._quad[5]=~~(this._quad[5]+et(this._quad[5])*O),this._quad[6]=~~(this._quad[6]+et(this._quad[6])*O),this._quad[7]=~~(this._quad[7]+et(this._quad[7])*O));const A=this._context.tint||this._defaultTint,L=this._getTextureIdForImage(t),W=g||C,U=v||m,q=(e+this.uvPadding)/W,wt=(i+this.uvPadding)/U,rt=(e+w-this.uvPadding)/W,$=(i+T-this.uvPadding)/U,Rt=g,At=v,M=this._layout.vertexBuffer.bufferData;M[this._vertexIndex++]=this._quad[0],M[this._vertexIndex++]=this._quad[1],M[this._vertexIndex++]=S,M[this._vertexIndex++]=Rt,M[this._vertexIndex++]=At,M[this._vertexIndex++]=q,M[this._vertexIndex++]=wt,M[this._vertexIndex++]=L,M[this._vertexIndex++]=A.r/255,M[this._vertexIndex++]=A.g/255,M[this._vertexIndex++]=A.b/255,M[this._vertexIndex++]=A.a,M[this._vertexIndex++]=this._quad[4],M[this._vertexIndex++]=this._quad[5],M[this._vertexIndex++]=S,M[this._vertexIndex++]=Rt,M[this._vertexIndex++]=At,M[this._vertexIndex++]=q,M[this._vertexIndex++]=$,M[this._vertexIndex++]=L,M[this._vertexIndex++]=A.r/255,M[this._vertexIndex++]=A.g/255,M[this._vertexIndex++]=A.b/255,M[this._vertexIndex++]=A.a,M[this._vertexIndex++]=this._quad[2],M[this._vertexIndex++]=this._quad[3],M[this._vertexIndex++]=S,M[this._vertexIndex++]=Rt,M[this._vertexIndex++]=At,M[this._vertexIndex++]=rt,M[this._vertexIndex++]=wt,M[this._vertexIndex++]=L,M[this._vertexIndex++]=A.r/255,M[this._vertexIndex++]=A.g/255,M[this._vertexIndex++]=A.b/255,M[this._vertexIndex++]=A.a,M[this._vertexIndex++]=this._quad[6],M[this._vertexIndex++]=this._quad[7],M[this._vertexIndex++]=S,M[this._vertexIndex++]=Rt,M[this._vertexIndex++]=At,M[this._vertexIndex++]=rt,M[this._vertexIndex++]=$,M[this._vertexIndex++]=L,M[this._vertexIndex++]=A.r/255,M[this._vertexIndex++]=A.g/255,M[this._vertexIndex++]=A.b/255,M[this._vertexIndex++]=A.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),st.DrawnImagesCount+=this._imageCount,st.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const dh=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,uh=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class fh{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=E.Transparent,this._scratch1=b(0,0),this._scratch2=b(0,0),this._scratch3=b(0,0),this._scratch4=b(0,0)}initialize(t,e){this._gl=t,this._context=e,this._shader=new Nt({gl:t,fragmentSource:dh,vertexSource:uh}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new _e({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Oi(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof p&&t[1]instanceof p?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,e,i,s=1){this._isFull()&&this.flush(),this._rectangleCount++;const n=this._context.getTransform(),o=this._context.opacity,a=this._context.snapToPixel,h=e.sub(t),l=h.magnitude,c=h.normalize().perpendicular(),d=s/2,f=n.multiply(c.scale(d,this._scratch1).add(t,this._scratch1),this._scratch1),_=n.multiply(c.scale(-d,this._scratch2).add(t,this._scratch2),this._scratch2),g=n.multiply(c.scale(d,this._scratch3).add(e,this._scratch3),this._scratch3),v=n.multiply(c.scale(-d,this._scratch4).add(e,this._scratch4),this._scratch4);a&&(f.x=~~(f.x+O),f.y=~~(f.y+O),g.x=~~(g.x+O),g.y=~~(g.y+O),_.x=~~(_.x+O),_.y=~~(_.y+O),v.x=~~(v.x+O),v.y=~~(v.y+O));const C=0,m=0,w=1,T=1,P=this._transparent,S=0,F=1,A=this._layout.vertexBuffer.bufferData;A[this._vertexIndex++]=f.x,A[this._vertexIndex++]=f.y,A[this._vertexIndex++]=C,A[this._vertexIndex++]=m,A[this._vertexIndex++]=l,A[this._vertexIndex++]=s,A[this._vertexIndex++]=o,A[this._vertexIndex++]=i.r/255,A[this._vertexIndex++]=i.g/255,A[this._vertexIndex++]=i.b/255,A[this._vertexIndex++]=i.a,A[this._vertexIndex++]=P.r/255,A[this._vertexIndex++]=P.g/255,A[this._vertexIndex++]=P.b/255,A[this._vertexIndex++]=P.a,A[this._vertexIndex++]=S/F,A[this._vertexIndex++]=_.x,A[this._vertexIndex++]=_.y,A[this._vertexIndex++]=C,A[this._vertexIndex++]=T,A[this._vertexIndex++]=l,A[this._vertexIndex++]=s,A[this._vertexIndex++]=o,A[this._vertexIndex++]=i.r/255,A[this._vertexIndex++]=i.g/255,A[this._vertexIndex++]=i.b/255,A[this._vertexIndex++]=i.a,A[this._vertexIndex++]=P.r/255,A[this._vertexIndex++]=P.g/255,A[this._vertexIndex++]=P.b/255,A[this._vertexIndex++]=P.a,A[this._vertexIndex++]=S/F,A[this._vertexIndex++]=g.x,A[this._vertexIndex++]=g.y,A[this._vertexIndex++]=w,A[this._vertexIndex++]=m,A[this._vertexIndex++]=l,A[this._vertexIndex++]=s,A[this._vertexIndex++]=o,A[this._vertexIndex++]=i.r/255,A[this._vertexIndex++]=i.g/255,A[this._vertexIndex++]=i.b/255,A[this._vertexIndex++]=i.a,A[this._vertexIndex++]=P.r/255,A[this._vertexIndex++]=P.g/255,A[this._vertexIndex++]=P.b/255,A[this._vertexIndex++]=P.a,A[this._vertexIndex++]=S/F,A[this._vertexIndex++]=v.x,A[this._vertexIndex++]=v.y,A[this._vertexIndex++]=w,A[this._vertexIndex++]=T,A[this._vertexIndex++]=l,A[this._vertexIndex++]=s,A[this._vertexIndex++]=o,A[this._vertexIndex++]=i.r/255,A[this._vertexIndex++]=i.g/255,A[this._vertexIndex++]=i.b/255,A[this._vertexIndex++]=i.a,A[this._vertexIndex++]=P.r/255,A[this._vertexIndex++]=P.g/255,A[this._vertexIndex++]=P.b/255,A[this._vertexIndex++]=P.a,A[this._vertexIndex++]=S/F}drawRectangle(t,e,i,s,n=E.Transparent,o=0){this._isFull()&&this.flush(),this._rectangleCount++;const a=this._context.getTransform(),h=this._context.opacity,l=this._context.snapToPixel,c=a.multiply(t.add(b(0,0))),d=a.multiply(t.add(b(e,0))),f=a.multiply(t.add(b(e,i))),_=a.multiply(t.add(b(0,i)));l&&(c.x=~~(c.x+O),c.y=~~(c.y+O),d.x=~~(d.x+O),d.y=~~(d.y+O),_.x=~~(_.x+O),_.y=~~(_.y+O),f.x=~~(f.x+O),f.y=~~(f.y+O));const g=0,v=0,C=1,m=1,w=this._layout.vertexBuffer.bufferData;w[this._vertexIndex++]=c.x,w[this._vertexIndex++]=c.y,w[this._vertexIndex++]=g,w[this._vertexIndex++]=v,w[this._vertexIndex++]=e,w[this._vertexIndex++]=i,w[this._vertexIndex++]=h,w[this._vertexIndex++]=s.r/255,w[this._vertexIndex++]=s.g/255,w[this._vertexIndex++]=s.b/255,w[this._vertexIndex++]=s.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=_.x,w[this._vertexIndex++]=_.y,w[this._vertexIndex++]=g,w[this._vertexIndex++]=m,w[this._vertexIndex++]=e,w[this._vertexIndex++]=i,w[this._vertexIndex++]=h,w[this._vertexIndex++]=s.r/255,w[this._vertexIndex++]=s.g/255,w[this._vertexIndex++]=s.b/255,w[this._vertexIndex++]=s.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=d.x,w[this._vertexIndex++]=d.y,w[this._vertexIndex++]=C,w[this._vertexIndex++]=v,w[this._vertexIndex++]=e,w[this._vertexIndex++]=i,w[this._vertexIndex++]=h,w[this._vertexIndex++]=s.r/255,w[this._vertexIndex++]=s.g/255,w[this._vertexIndex++]=s.b/255,w[this._vertexIndex++]=s.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=f.x,w[this._vertexIndex++]=f.y,w[this._vertexIndex++]=C,w[this._vertexIndex++]=m,w[this._vertexIndex++]=e,w[this._vertexIndex++]=i,w[this._vertexIndex++]=h,w[this._vertexIndex++]=s.r/255,w[this._vertexIndex++]=s.g/255,w[this._vertexIndex++]=s.b/255,w[this._vertexIndex++]=s.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),st.DrawnImagesCount+=this._rectangleCount,st.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const _h=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,ph=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class gh{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new Nt({gl:t,fragmentSource:_h,vertexSource:ph}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new _e({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Oi(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,e,i,s=E.Transparent,n=0){this._isFull()&&this.flush(),this._circleCount++;const o=this._context.getTransform(),a=this._context.opacity,h=this._context.snapToPixel,l=o.multiply(t.add(b(-e,-e))),c=o.multiply(t.add(b(e,-e))),d=o.multiply(t.add(b(e,e))),f=o.multiply(t.add(b(-e,e)));h&&(l.x=~~(l.x+O),l.y=~~(l.y+O),c.x=~~(c.x+O),c.y=~~(c.y+O),f.x=~~(f.x+O),f.y=~~(f.y+O),d.x=~~(d.x+O),d.y=~~(d.y+O));const _=0,g=0,v=1,C=1,m=this._layout.vertexBuffer.bufferData;m[this._vertexIndex++]=l.x,m[this._vertexIndex++]=l.y,m[this._vertexIndex++]=_,m[this._vertexIndex++]=g,m[this._vertexIndex++]=a,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a,m[this._vertexIndex++]=n/e,m[this._vertexIndex++]=f.x,m[this._vertexIndex++]=f.y,m[this._vertexIndex++]=_,m[this._vertexIndex++]=C,m[this._vertexIndex++]=a,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a,m[this._vertexIndex++]=n/e,m[this._vertexIndex++]=c.x,m[this._vertexIndex++]=c.y,m[this._vertexIndex++]=v,m[this._vertexIndex++]=g,m[this._vertexIndex++]=a,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a,m[this._vertexIndex++]=n/e,m[this._vertexIndex++]=d.x,m[this._vertexIndex++]=d.y,m[this._vertexIndex++]=v,m[this._vertexIndex++]=C,m[this._vertexIndex++]=a,m[this._vertexIndex++]=i.r/255,m[this._vertexIndex++]=i.g/255,m[this._vertexIndex++]=i.b/255,m[this._vertexIndex++]=i.a,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a,m[this._vertexIndex++]=n/e}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),st.DrawnImagesCount+=this._circleCount,st.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Cs{constructor(t,e,i=100){this.builder=t,this.recycler=e,this.maxObjects=i,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=k.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const e=t(this);return e?this.done(...e):this.done()}borrow(t){const e=this.get();t(e),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const e of t){const i=this.objects.indexOf(e);this.objects[i]=this.builder(),this.totalAllocations++}return t}}class mh{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=_t.identity(),this.state={z:0,opacity:1,tint:E.White,material:null},this.args=new Array(10)}}const vh=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class ao{constructor(t){this._logger=k.getInstance(),this._color=E.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:e,name:i,vertexSource:s,fragmentSource:n,graphicsContext:o,images:a}=t;if(this._name=i??"anonymous material",this._vertexSource=s??vh,this._fragmentSource=n,this._color=e??this._color,!o)throw Error(`Material ${i} must be provided an excalibur webgl graphics context`);if(o instanceof ye?(this._graphicsContext=o,this._initialize(o)):this._logger.warn(`Material ${i} was created in 2D Canvas mode, currently only WebGL is supported`),a)for(const h in a)this.addImageSource(h,a[h])}_initialize(t){if(this._initialized)return;const e=t.__gl;this._maxTextureSlots=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,e){this._images.size<this._maxTextureSlots?this._images.set(t,e):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const e=this._images.get(t);this._graphicsContext.textureLoader.delete(e.image),this._images.delete(t)}_loadImageSource(t){const e=t.image,i=e.getAttribute(Y.Filtering),s=i?pi(i):void 0,n=re(e.getAttribute(Y.WrappingX)),o=re(e.getAttribute(Y.WrappingY)),a=e.getAttribute("forceUpload")==="true",h=this._graphicsContext.textureLoader.load(e,{filtering:s,wrapping:{x:n,y:o}},a);return e.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,h),h}uploadAndBind(t,e=2){let i=e;for(const[s,n]of this._images.entries()){if(!n.isLoaded()){this._logger.warnOnce(`Image named ${s} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const o=this._loadImageSource(n);t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,o),this._shader.trySetUniformInt(s,i),i++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Wr{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,e){this._gl=t,this._context=e,this._buffer=new _e({gl:t,size:6*4,type:"dynamic"}),this._layout=new Se({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Oi(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,e,i,s,n,o,a,h,l){var c,d,f,_;const g=this._gl,v=this._context.material;if(!v)return;const C=this._context.getTransform(),m=this._context.opacity,w=v.getShader(),T=this._layout.vertexBuffer.bufferData;let P=0,S=(t==null?void 0:t.width)||s||0,F=(t==null?void 0:t.height)||n||0,A=[0,0,(c=s??(t==null?void 0:t.width))!==null&&c!==void 0?c:0,(d=n??(t==null?void 0:t.height))!==null&&d!==void 0?d:0],L=[e??1,i??1];o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(A=[e??1,i??1,(f=s??(t==null?void 0:t.width))!==null&&f!==void 0?f:0,(_=n??(t==null?void 0:t.height))!==null&&_!==void 0?_:0],L=[o,a],S=h,F=l),e=A[0],i=A[1];const W=A[2],U=A[3],q=b(L[0],L[1]),wt=b(L[0]+S,L[1]),rt=b(L[0],L[1]+F),$=b(L[0]+S,L[1]+F),Rt=t.width||S,At=t.height||F,M=e/Rt,ze=i/At,Ue=(e+W-.01)/Rt,He=(i+U-.01)/At,ti=C.getPosition(),Dr=ti.add($),Fr=ti.x/this._context.width,Br=ti.y/this._context.height,kr=Dr.x/this._context.width,Lr=Dr.y/this._context.height;T[P++]=q.x,T[P++]=q.y,T[P++]=M,T[P++]=ze,T[P++]=Fr,T[P++]=Br,T[P++]=rt.x,T[P++]=rt.y,T[P++]=M,T[P++]=He,T[P++]=Fr,T[P++]=Lr,T[P++]=wt.x,T[P++]=wt.y,T[P++]=Ue,T[P++]=ze,T[P++]=kr,T[P++]=Br,T[P++]=$.x,T[P++]=$.y,T[P++]=Ue,T[P++]=He,T[P++]=kr,T[P++]=Lr;const Ua=this._addImageAsTexture(t);v.use(),this._layout.shader=w,this._layout.use(!0),w.trySetUniformFloat("u_time_ms",performance.now()),w.trySetUniformFloat("u_opacity",m),w.trySetUniformFloatVector("u_resolution",b(this._context.width,this._context.height)),w.trySetUniformFloatVector("u_graphic_resolution",b(Rt,At)),w.trySetUniformFloatVector("u_size",b(W,U)),w.trySetUniformMatrix("u_matrix",this._context.ortho),w.trySetUniformMatrix("u_transform",C.to4x4()),g.activeTexture(g.TEXTURE0+0),g.bindTexture(g.TEXTURE_2D,Ua),w.trySetUniformInt("u_graphic",0),g.activeTexture(g.TEXTURE0+1),g.bindTexture(g.TEXTURE_2D,this._context.materialScreenTexture),w.trySetUniformInt("u_screen_texture",1),v.uploadAndBind(g),this._quads.bind(),g.drawElements(g.TRIANGLES,6,this._quads.bufferGlType,0),st.DrawnImagesCount++,st.DrawCallCount++}_addImageAsTexture(t){const e=t.getAttribute(Y.Filtering),i=e?pi(e):void 0,s=re(t.getAttribute(Y.WrappingX)),n=re(t.getAttribute(Y.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:i,wrapping:{x:s,y:n}},o);return t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&this._textures.push(a),a}hasPendingDraws(){return!1}flush(){}}const wh=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,xh=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Et;(function(r){r.World="world",r.Screen="screen"})(Et||(Et={}));class Zs extends p{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Ie extends p{constructor(t,e){super(t.x,t.y),this.original=t,this.change=e}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,e){this.x=t,this.y=e}}class Pe{constructor(){this._parent=null,this._children=[],this._pos=new Ie(b(0,0),()=>{this.flagDirty()}),this._globalPos=new Zs({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:e}=this.parent.inverse.multiply(b(t,this.pos.y));this.pos.x=e}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:e}=this.parent.inverse.multiply(b(this.pos.x,t));this.pos.y=e}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Ie(b(1,1),()=>{this.flagDirty()}),this._globalScale=new Zs({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const e=this.parent.globalScale.x;this.scale.x=t/e}else this.scale.x=t},setY:t=>{if(this.parent){const e=this.parent.globalScale.y;this.scale.y=t/e}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=_t.identity(),this._inverse=_t.identity(),this._scratch=_t.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const e=this._parent._children.indexOf(this);e>-1&&this._parent._children.splice(e,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let e=t.clone();this.parent&&(e=this.parent.inverse.multiply(t)),e.equals(this._pos)||(this._pos=e,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const e=be(t);e!==this._rotation&&this.flagDirty(),this._rotation=e}get rotation(){return this._rotation}set globalRotation(t){let e=0;this.parent&&(e=this.parent.globalRotation);const i=be(t+e);i!==this._rotation&&this.flagDirty(),this._rotation=i}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let e=b(1,1);this.parent&&(e=this.parent.globalScale),this.scale=t.scale(b(1/e.x,1/e.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,e,i){this._pos.x=t.x,this._pos.y=t.y,this._rotation=be(e),this._scale.x=i.x,this._scale.y=i.y,this.flagDirty()}isMirrored(){const t=et(this.scale.x)>>>31,e=et(this.scale.y)>>>31;return!!(t^e)}clone(t){const e=t??new Pe;return this._pos.clone(e._pos),e._z=this._z,e._rotation=this._rotation,this._scale.clone(e._scale),e.flagDirty(),e}cloneWithParent(t){const e=t??new Pe;return this._pos.clone(e._pos),e._z=this._z,e._rotation=this._rotation,this._scale.clone(e._scale),e.parent=this.parent,e.flagDirty(),e}toString(){return this.matrix.toString()}}function ho(r){return!!r&&!!r.prototype&&!!r.prototype.constructor}function bh(r){return!!(r!=null&&r.clone)}class Qt{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const e in this)if(this.hasOwnProperty(e)){const i=this[e];bh(i)&&e!=="owner"&&e!=="clone"?t[e]=i.clone():t[e]=i}return t}}class Lt{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const e=this.observers.indexOf(t);e!==-1&&this.observers.splice(e,1)}unsubscribe(t){const e=this.subscriptions.indexOf(t);e!==-1&&this.subscriptions.splice(e,1)}notifyAll(t){const e=this.observers.length;for(let s=0;s<e;s++)this.observers[s].notify(t);const i=this.subscriptions.length;for(let s=0;s<i;s++)this.subscriptions[s](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class D extends Qt{constructor(){super(...arguments),this._logger=k.getInstance(),this._parentComponent=null,this._transform=new Pe,this._addChildTransform=t=>{const e=t.get(D);e&&(e._transform.parent=this._transform,e._parentComponent=this)},this.zIndexChanged$=new Lt,this._coordPlane=Et.World}get(){return this._transform}onAdd(t){for(const e of t.children)this._addChildTransform(e);t.childrenAdded$.subscribe(e=>this._addChildTransform(e)),t.childrenRemoved$.subscribe(e=>{const i=e.get(D);i&&(i._transform.parent=null,i._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const e=this._transform.z;this._transform.z=t,e!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var e;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(e=this.owner)===null||e===void 0?void 0:e.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new D;return t._transform=this._transform.clone(),t}}var Pi;(function(r){r.Forward="forward",r.Backward="backward"})(Pi||(Pi={}));var Kt;(function(r){r.End="end",r.Loop="loop",r.PingPong="pingpong",r.Freeze="freeze"})(Kt||(Kt={}));const yh={Frame:"frame",Loop:"loop",End:"end"};class te extends ht{constructor(t){var e,i,s;super(t),this.events=new nt,this.frames=[],this.strategy=Kt.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(e=t.speed)!==null&&e!==void 0?e:this.speed,this.strategy=(i=t.strategy)!==null&&i!==void 0?i:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(s=t.frameDuration)!==null&&s!==void 0?s:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new te({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,e,i,s=Kt.Loop){const n=t.sprites.length-1,o=e.filter(a=>a<0||a>n);return o.length&&te._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${o.join(",")} no frame will be shown`),new te({frames:t.sprites.filter((a,h)=>e.indexOf(h)>-1).map(a=>({graphic:a,duration:i})),strategy:s})}static fromSpriteSheetCoordinates(t){var e;const{spriteSheet:i,frameCoordinates:s,durationPerFrame:n,durationPerFrameMs:o,speed:a,strategy:h,reverse:l}=t,c=(e=n??o)!==null&&e!==void 0?e:100,d=[];for(const f of s){const{x:_,y:g,duration:v,options:C}=f,m=i.getSprite(_,g,C);m?d.push({graphic:m,duration:v??c}):te._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${_}, ${g}), please check your SpriteSheet to confirm that sprite exists`)}return new te({frames:d,strategy:h,speed:a,reverse:l})}get speed(){return this._speed}set speed(t){this._speed=X(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?Pi.Backward:Pi.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=(t==null?void 0:t.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case Kt.End:case Kt.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,e){this._currentFrame=t,this._timeLeftInFrame=e??this.frameDuration;const i=this.frames[this._currentFrame];i&&!this._done&&(this._timeLeftInFrame=e??((i==null?void 0:i.duration)||this.frameDuration),this.events.emit("frame",{...i,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let e=-1;switch(this.strategy){case Kt.Loop:{e=(t+1)%this.frames.length,e===0&&this.events.emit("loop",this);break}case Kt.End:{e=t+1,e>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Kt.Freeze:{e=X(t+1,0,this.frames.length-1),e>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Kt.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),e=t+this._pingPongDirection%this.frames.length;break}}return e}tick(t,e=0){this._idempotencyToken!==e&&(this._idempotencyToken=e,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,e,i){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,e,i)}}te._LOGGER=k.getInstance();class oi extends ht{constructor(t){var e;super(t),this._logger=k.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(e=t.useAnchor)!==null&&e!==void 0?e:this.useAnchor,this._updateDimensions()}clone(){return new oi({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new B;for(const e of this.members)if(e instanceof ht)e.localBounds.combine(t,t);else{const{graphic:i,offset:s,useBounds:n}=e;i?(n===void 0?!0:n)&&i.localBounds.translate(s).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(e)}.`)}return t}_isAnimationOrGroup(t){return t instanceof te||t instanceof oi}tick(t,e){for(const i of this.members){let s;i instanceof ht?s=i:s=i.graphic,this._isAnimationOrGroup(s)&&s.tick(t,e)}}reset(){for(const t of this.members){let e;t instanceof ht?e=t:e=t.graphic,this._isAnimationOrGroup(e)&&e.reset()}}_preDraw(t,e,i){this._updateDimensions(),super._preDraw(t,this.useAnchor?e:0,this.useAnchor?i:0)}_drawImage(t,e,i){const s=p.Zero;for(const n of this.members){let o;n instanceof ht?o=n:(o=n.graphic,n.offset.clone(s)),o&&(t.save(),t.translate(e,i),o.draw(t,s.x,s.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class gi extends ht{constructor(t){var e,i,s,n,o,a,h,l,c,d;super(to({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=ee(E.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(e=t.quality)!==null&&e!==void 0?e:this.quality,this.color=(i=t.color)!==null&&i!==void 0?i:E.Black,this.strokeColor=t==null?void 0:t.strokeColor,this.smoothing=(s=t.smoothing)!==null&&s!==void 0?s:this.smoothing,this.lineWidth=(n=t.lineWidth)!==null&&n!==void 0?n:this.lineWidth,this.lineDash=(o=t.lineDash)!==null&&o!==void 0?o:this.lineDash,this.lineCap=(a=t.lineCap)!==null&&a!==void 0?a:this.lineCap,this.padding=(h=t.padding)!==null&&h!==void 0?h:this.padding,this.filtering=(l=t.filtering)!==null&&l!==void 0?l:this.filtering),this._bitmap=document.createElement("canvas");const f=(c=t==null?void 0:t.width)!==null&&c!==void 0?c:this._bitmap.width,_=(d=t==null?void 0:t.height)!==null&&d!==void 0?d:this._bitmap.height;this.width=f,this.height=_;const g=this._bitmap.getContext("2d");if(g)this._ctx=g;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return B.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,p.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=ee(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=ee(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var e,i,s,n;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((e=this.lineDash)!==null&&e!==void 0?e:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(s=(i=this.strokeColor)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:"",t.fillStyle=(n=this.color)===null||n===void 0?void 0:n.toString()}_drawImage(t,e,i){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,e,i)}}var os;(function(r){r.Em="em",r.Rem="rem",r.Px="px",r.Pt="pt",r.Percent="%"})(os||(os={}));var as;(function(r){r.Left="left",r.Right="right",r.Center="center",r.Start="start",r.End="end"})(as||(as={}));var hs;(function(r){r.Top="top",r.Hanging="hanging",r.Middle="middle",r.Alphabetic="alphabetic",r.Ideographic="ideographic",r.Bottom="bottom"})(hs||(hs={}));var ls;(function(r){r.Normal="normal",r.Italic="italic",r.Oblique="oblique"})(ls||(ls={}));var cs;(function(r){r.LeftToRight="ltr",r.RightToLeft="rtl"})(cs||(cs={}));function $s(r,t=E.Red,e,i,s,n,o=1,a="butt"){r.save(),r.beginPath(),r.lineWidth=o,r.lineCap=a,r.strokeStyle=t.toString(),r.moveTo(e,i),r.lineTo(s,n),r.closePath(),r.stroke(),r.restore()}function Ch(r,t=E.Red,e){r.beginPath(),r.strokeStyle=t.toString(),r.arc(e.x,e.y,5,0,Math.PI*2),r.closePath(),r.stroke()}function Ph(r,t,e,i,s=1){const n=t?t.toString():"blue",o=i.scale(s);r.beginPath(),r.strokeStyle=n,r.moveTo(e.x,e.y),r.lineTo(e.x+o.x,e.y+o.y),r.closePath(),r.stroke()}function Qs(r,t,e,i,s,n=5,o=E.White,a=null){let h;if(typeof n=="number")h={tl:n,tr:n,br:n,bl:n};else{const l={tl:0,tr:0,br:0,bl:0};for(const c in l)if(l.hasOwnProperty(c)){const d=c;h[d]=n[d]||l[d]}}r.beginPath(),r.moveTo(t+h.tl,e),r.lineTo(t+i-h.tr,e),r.quadraticCurveTo(t+i,e,t+i,e+h.tr),r.lineTo(t+i,e+s-h.br),r.quadraticCurveTo(t+i,e+s,t+i-h.br,e+s),r.lineTo(t+h.bl,e+s),r.quadraticCurveTo(t,e+s,t,e+s-h.bl),r.lineTo(t,e+h.tl),r.quadraticCurveTo(t,e,t+h.tl,e),r.closePath(),a&&(r.fillStyle=a.toString(),r.fill()),o&&(r.strokeStyle=o.toString(),r.stroke())}function Ah(r,t,e,i,s=E.White,n=null){r.beginPath(),r.arc(t,e,i,0,Math.PI*2),r.closePath(),n&&(r.fillStyle=n.toString(),r.fill()),s&&(r.strokeStyle=s.toString(),r.stroke())}class ii{constructor(t,e,i,s){this.font=t,this.text=e,this.color=i,this.maxWidth=s,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const n=this.canvas.getContext("2d");if(!n)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=n,this.dimensions=this.measureText(e),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,e){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let i=null;e!=null?i=this._getLinesFromText(t,e):i=t.split(`
`);const s=i.reduce((f,_)=>f.length>_.length?f:_);this._applyFont(this.ctx);const n=this.ctx.measureText(s);let o=Math.abs(n.actualBoundingBoxAscent)+Math.abs(n.actualBoundingBoxDescent);const a=o*i.length;o=a;const h=a-Math.abs(n.actualBoundingBoxAscent),l=0,c=0;return new B({left:l-Math.abs(n.actualBoundingBoxLeft)-this.font.padding,top:c-Math.abs(n.actualBoundingBoxAscent)-this.font.padding,bottom:c+h+this.font.padding,right:l+Math.abs(n.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,e){let i=1;this.font.lineHeight&&(i=this.font.lineHeight/this.font.size),e.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,e.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*i}static getHashCode(t,e,i){var s;return e+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((s=t.strokeColor)===null||s===void 0?void 0:s.toString())+(i?i.toString():t.color.toString()))}getHashCode(t=!0){return ii.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var e,i,s;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((e=this.font.lineDash)!==null&&e!==void 0?e:t.getLineDash()),t.strokeStyle=(s=(i=this.font.strokeColor)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,e,i){this._applyRasterProperties(t),this._applyFont(t);for(let s=0;s<e.length;s++){const n=e[s];this.color&&t.fillText(n,0,s*i),this.font.strokeColor&&t.strokeText(n,0,s*i)}this.font.showDebug&&($s(t,E.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),$s(t,E.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const e=[];let i=0,s=0;const n=Math.min(4096,t.canvas.width),o=Math.min(4096,t.canvas.height);for(;i<t.canvas.width;){for(;s<t.canvas.height;){const a=document.createElement("canvas");a.width=n,a.height=o;const h=a.getContext("2d");if(!h)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");h.drawImage(t.canvas,i,s,n,o,0,0,n,o),e.push({x:i,y:s,canvas:a}),s+=o}i+=n,s=0}return e}flagDirty(){this._dirty=!0}render(t,e,i,s){var n;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const o=this.getHashCode();if(this._lastHashCode!==o&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,s),this._setDimension(this.dimensions,this.ctx);const a=this._getLinesFromText(this.text,s),h=(n=this.font.lineHeight)!==null&&n!==void 0?n:this.dimensions.height/a.length;if(this._drawText(this.ctx,a,h),t instanceof ye)for(const l of this._textFragments)t.textureLoader.delete(l.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof ye)for(const l of this._textFragments)t.textureLoader.load(l.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=o,this._dirty=!1}for(const a of this._textFragments)t.drawImage(a.canvas,0,0,a.canvas.width,a.canvas.height,a.x/this.font.quality+e-this.ctx.canvas.width/this.font.quality/2,a.y/this.font.quality+i-this.ctx.canvas.height/this.font.quality/2,a.canvas.width/this.font.quality,a.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ye)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,e){var i;if(this._cachedText===t&&this._cachedRenderWidth===e&&(!((i=this._cachedLines)===null||i===void 0)&&i.length))return this._cachedLines;const s=t.split(`
`);if(e==null)return s;for(let n=0;n<s.length;n++){let o=s[n],a="";if(this.measureText(o).width>e){for(;this.measureText(o).width>e;)a=o[o.length-1]+a,o=o.slice(0,-1);s[n]=o,s[n+1]=a}}return this._cachedText=t,this._cachedLines=s,this._cachedRenderWidth=e,s}}class Q{static measureText(t,e,i){const s=ii.getHashCode(e,t);if(Q._MEASURE_CACHE.has(s))return Q._MEASURE_CACHE.get(s);Q._LOGGER.debug("Font text measurement cache miss");const n=e.measureTextWithoutCache(t,i);return Q._MEASURE_CACHE.set(s,n),n}static getTextInstance(t,e,i){const s=ii.getHashCode(e,t,i);let n=Q._TEXT_CACHE.get(s);return n||(n=new ii(e,t,i),Q._TEXT_CACHE.set(s,n),Q._LOGGER.debug("Font text instance cache miss")),Q._TEXT_USAGE.set(n,performance.now()),n}static checkAndClearCache(){const t=[],e=new Set;for(const[s,n]of Q._TEXT_USAGE.entries())if(n+Q.FONT_TIMEOUT<performance.now())Q._LOGGER.debug(`Text cache entry timed out ${s.text}`),t.push(s),s.dispose();else{const o=s.getHashCode(!1);e.add(o)}t.forEach(s=>{Q._TEXT_USAGE.delete(s)}),this._TEXT_CACHE.clear();for(const[s]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(s.getHashCode(),s);const i=new Map;for(const s of e)Q._MEASURE_CACHE.has(s)&&i.set(s,Q._MEASURE_CACHE.get(s));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=i}static get cacheSize(){return Q._TEXT_USAGE.size}static clearCache(){for(const[t]of Q._TEXT_USAGE.entries())t.dispose();Q._TEXT_USAGE.clear(),Q._TEXT_CACHE.clear(),Q._MEASURE_CACHE.clear()}}Q.FONT_TIMEOUT=500;Q._LOGGER=k.getInstance();Q._TEXT_USAGE=new Map;Q._TEXT_CACHE=new Map;Q._MEASURE_CACHE=new Map;class Ze extends ht{constructor(t={}){var e,i,s,n,o,a,h,l,c,d,f,_,g,v,C,m,w,T,P,S;super(t),this.filtering=gt.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=E.Black,this.family="sans-serif",this.style=ls.Normal,this.bold=!1,this.unit=os.Px,this.textAlign=as.Left,this.baseAlign=hs.Top,this.direction=cs.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new B,this._textMeasurement=new ii(this,"",E.Black),this.smoothing=(e=t==null?void 0:t.smoothing)!==null&&e!==void 0?e:this.smoothing,this.padding=(i=t==null?void 0:t.padding)!==null&&i!==void 0?i:this.padding,this.color=(s=t==null?void 0:t.color)!==null&&s!==void 0?s:this.color,this.strokeColor=(n=t==null?void 0:t.strokeColor)!==null&&n!==void 0?n:this.strokeColor,this.lineDash=(o=t==null?void 0:t.lineDash)!==null&&o!==void 0?o:this.lineDash,this.lineWidth=(a=t==null?void 0:t.lineWidth)!==null&&a!==void 0?a:this.lineWidth,this.filtering=(h=t==null?void 0:t.filtering)!==null&&h!==void 0?h:this.filtering,this.family=(l=t==null?void 0:t.family)!==null&&l!==void 0?l:this.family,this.style=(c=t==null?void 0:t.style)!==null&&c!==void 0?c:this.style,this.bold=(d=t==null?void 0:t.bold)!==null&&d!==void 0?d:this.bold,this.size=(f=t==null?void 0:t.size)!==null&&f!==void 0?f:this.size,this.unit=(_=t==null?void 0:t.unit)!==null&&_!==void 0?_:this.unit,this.textAlign=(g=t==null?void 0:t.textAlign)!==null&&g!==void 0?g:this.textAlign,this.baseAlign=(v=t==null?void 0:t.baseAlign)!==null&&v!==void 0?v:this.baseAlign,this.direction=(C=t==null?void 0:t.direction)!==null&&C!==void 0?C:this.direction,this.lineHeight=(m=t==null?void 0:t.lineHeight)!==null&&m!==void 0?m:this.lineHeight,this.quality=(w=t==null?void 0:t.quality)!==null&&w!==void 0?w:this.quality,t!=null&&t.shadow&&(this.shadow={},this.shadow.blur=(T=t.shadow.blur)!==null&&T!==void 0?T:this.shadow.blur,this.shadow.offset=(P=t.shadow.offset)!==null&&P!==void 0?P:this.shadow.offset,this.shadow.color=(S=t.shadow.color)!==null&&S!==void 0?S:this.shadow.color)}clone(){return new Ze({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,e,i){}_rotate(t){var e;const i=(e=this.origin)!==null&&e!==void 0?e:this._textBounds.center;t.translate(i.x,i.y),t.rotate(this.rotation),t.translate(-i.x,-i.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,e){return this._textMeasurement.measureText(t,e)}measureText(t,e){return Q.measureText(t,this,e)}_postDraw(t){t.restore()}render(t,e,i,s,n,o){const a=Q.getTextInstance(e,this,i);this._textBounds=a.dimensions,this._preDraw(t,s,n),a.render(t,s,n,o),this._postDraw(t)}}class Ni extends ht{constructor(t){var e,i;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(e=t.font)!==null&&e!==void 0?e:new Ze,this.color=(i=t.color)!==null&&i!==void 0?i:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,e;return new Ni({text:this.text.slice(),color:(e=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&e!==void 0?e:E.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:e}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=e}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,e,i){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,e,i)}_drawImage(t,e,i){var s;let n=E.Black;this.font instanceof Ze&&(n=(s=this.color)!==null&&s!==void 0?s:this.font.color);const{width:o,height:a}=this.font.measureText(this._text,this.maxWidth);this._textWidth=o,this._textHeight=a,this.font.render(t,this._text,n,e,i,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(e-o,i-a,o*2,a*2),this.maxWidth!=null&&t.debug.drawRect(e,i,this.maxWidth,this.height,{color:E.Yellow}))}}function Tn(r){return!!r.tick}class lt extends Qt{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Ie(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Ie(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const e=this.graphics.current;(e instanceof gi||e instanceof Ni)&&(e.color=this._color)}}constructor(t){super(),this._logger=k.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Ie(p.Zero,()=>this.recalculateBounds()),this._anchor=new Ie(p.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:e,anchor:i,color:s,opacity:n,visible:o,graphics:a,offset:h,copyGraphics:l,onPreDraw:c,onPostDraw:d,onPreTransformDraw:f,onPostTransformDraw:_}=t;for(const[g,v]of Object.entries(a))v instanceof ht?this._graphics[g]=v:(this._graphics[g]=v.graphic,this._options[g]=v.options);this.offset=h??this.offset,this.opacity=n??this.opacity,this.anchor=i??this.anchor,this.color=s??this.color,this.copyGraphics=l??this.copyGraphics,this.onPreDraw=c??this.onPreDraw,this.onPostDraw=d??this.onPostDraw,this.onPreDraw=f??this.onPreTransformDraw,this.onPostTransformDraw=_??this.onPostTransformDraw,this.isVisible=!!o,this._current=e??this._current,e&&this._graphics[e]&&this.use(e)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,e,i){let s="default",n=null,o;if(typeof t=="string"&&e instanceof ht&&(s=t,n=e,o=i),t instanceof ht&&!(e instanceof ht)&&(n=t,o=e),!n)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[s]=this.copyGraphics?n.clone():n,this._options[s]=this.copyGraphics?{...o}:o,s==="default"&&this.use("default"),n}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,e){var i;if(t instanceof ht){let s=t;this.copyGraphics&&(s=t.clone()),this._current="default",this._graphics[this._current]=s,this._options[this._current]=e}else this._current=t,this._options[this._current]=e,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(i=this.owner)===null||i===void 0?void 0:i.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new B;const e=this._graphics[this._current],i=this._options[this._current];if(!e){this._localBounds=t;return}let s=this.anchor,n=this.offset;i!=null&&i.anchor&&(s=i.anchor),i!=null&&i.offset&&(n=i.offset);const o=e.localBounds,a=-o.width*s.x+n.x,h=-o.height*s.y+n.y;e instanceof oi&&!e.useAnchor?t=e==null?void 0:e.localBounds.combine(t):t=e==null?void 0:e.localBounds.translate(b(a,h)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const e=this.owner.get(D);e&&(t=t.transform(e.get().matrix))}return t}update(t,e=0){const i=this.current;i&&Tn(i)&&i.tick(t,e)}clone(){const t=new lt;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var ds;(function(r){r.Kill="kill",r.PreKill="prekill",r.PostKill="postkill",r.PreDraw="predraw",r.PostDraw="postdraw",r.PreDebugDraw="predebugdraw",r.PostDebugDraw="postdebugdraw",r.PreUpdate="preupdate",r.PostUpdate="postupdate",r.PreFrame="preframe",r.PostFrame="postframe",r.PreCollision="precollision",r.CollisionStart="collisionstart",r.CollisionEnd="collisionend",r.PostCollision="postcollision",r.Initialize="initialize",r.Activate="activate",r.Deactivate="deactivate",r.ExitViewport="exitviewport",r.EnterViewport="enterviewport",r.ExitTrigger="exit",r.EnterTrigger="enter",r.Connect="connect",r.Disconnect="disconnect",r.Button="button",r.Axis="axis",r.Visible="visible",r.Hidden="hidden",r.Start="start",r.Stop="stop",r.PointerUp="pointerup",r.PointerDown="pointerdown",r.PointerMove="pointermove",r.PointerEnter="pointerenter",r.PointerLeave="pointerleave",r.PointerCancel="pointercancel",r.PointerWheel="pointerwheel",r.Up="up",r.Down="down",r.Move="move",r.Enter="enter",r.Leave="leave",r.Cancel="cancel",r.Wheel="wheel",r.Press="press",r.Release="release",r.Hold="hold",r.PointerDragStart="pointerdragstart",r.PointerDragEnd="pointerdragend",r.PointerDragEnter="pointerdragenter",r.PointerDragLeave="pointerdragleave",r.PointerDragMove="pointerdragmove",r.ActionStart="actionstart",r.ActionComplete="actioncomplete",r.Add="add",r.Remove="remove"})(ds||(ds={}));class N{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class Ps extends N{constructor(t){super(),this.self=t,this.target=t}}class Sn extends N{constructor(t){super(),this.self=t,this.target=t}}class En extends N{constructor(t){super(),this.self=t,this.target=t}}class In extends N{constructor(t){super(),this.self=t,this.target=t}}class Rn extends N{constructor(t){super(),this.self=t,this.target=t}}class mi extends N{constructor(t,e,i){super(),this.ctx=t,this.elapsed=e,this.self=i,this.target=i}}class vi extends N{constructor(t,e,i){super(),this.ctx=t,this.elapsed=e,this.self=i,this.target=i}}class Mn extends N{constructor(t,e,i){super(),this.ctx=t,this.elapsed=e,this.self=i,this.target=i}}class Dn extends N{constructor(t,e,i){super(),this.ctx=t,this.elapsed=e,this.self=i,this.target=i}}class Fn extends N{constructor(t,e){super(),this.ctx=t,this.self=e,this.target=e}}class Bn extends N{constructor(t,e){super(),this.ctx=t,this.self=e,this.target=e}}class Be extends N{constructor(t,e,i){super(),this.engine=t,this.elapsed=e,this.self=i,this.target=i}}class ke extends N{constructor(t,e,i){super(),this.engine=t,this.elapsed=e,this.self=i,this.target=i}}class kn extends N{constructor(t,e){super(),this.engine=t,this.prevStats=e,this.target=t}}class Ln extends N{constructor(t,e){super(),this.engine=t,this.stats=e,this.target=t}}class zn extends N{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class Un extends N{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class Hn extends N{constructor(t,e,i,s){super(),this.button=t,this.index=e,this.value=i,this.self=s,this.target=s}}class Wn extends N{constructor(t,e,i){super(),this.axis=t,this.value=e,this.self=i,this.target=i}}class On extends N{constructor(t){super(),this.self=t,this.target=t}}class Nn extends N{constructor(t){super(),this.self=t,this.target=t}}class $e extends N{constructor(t,e,i,s,n){super(),this.self=t,this.other=e,this.side=i,this.intersection=s,this.contact=n,this.target=t}}class Qe extends N{constructor(t,e,i,s,n){super(),this.self=t,this.other=e,this.side=i,this.intersection=s,this.contact=n,this.target=t}}class us{constructor(t,e,i,s){this.self=t,this.other=e,this.side=i,this.contact=s}}class fs{constructor(t,e,i,s){this.self=t,this.other=e,this.side=i,this.lastContact=s}}class _s{constructor(t,e,i,s,n){this.self=t,this.other=e,this.side=i,this.intersection=s,this.contact=n}}class ps{constructor(t,e,i,s,n){this.self=t,this.other=e,this.side=i,this.intersection=s,this.contact=n}}class Ai extends N{constructor(t,e,i,s){super(),this.self=t,this.other=e,this.side=i,this.contact=s,this.target=t}}class Ti extends N{constructor(t,e,i,s){super(),this.self=t,this.other=e,this.side=i,this.lastContact=s,this.target=t}}class wi extends N{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class Gn extends N{constructor(t,e){super(),this.context=t,this.self=e,this.target=e}}class Xn extends N{constructor(t,e){super(),this.context=t,this.self=e,this.target=e}}class Vn extends N{constructor(t){super(),this.self=t,this.target=t}}class qn extends N{constructor(t){super(),this.self=t,this.target=t}}class Yn extends N{constructor(t,e){super(),this.self=t,this.entity=e,this.target=t}}class jn extends N{constructor(t,e){super(),this.self=t,this.entity=e,this.target=t}}class Zn extends N{constructor(t,e){super(),this.action=t,this.self=e,this.target=e}}class $n extends N{constructor(t,e){super(),this.action=t,this.self=e,this.target=e}}class Qn extends N{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class Kn extends N{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class Th{constructor(t){this.data=t,this.type="Component Added"}}function Sh(r){return!!r&&r.type==="Component Added"}class Eh{constructor(t){this.data=t,this.type="Component Removed"}}function Ih(r){return!!r&&r.type==="Component Removed"}const Rh={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Bt{constructor(t,e){this.id=Bt._ID++,this.name=`Entity#${this.id}`,this.events=new nt,this._tags=new Set,this.componentAdded$=new Lt,this.componentRemoved$=new Lt,this.tagAdded$=new Lt,this.tagRemoved$=new Lt,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Lt,this.childrenRemoved$=new Lt,this._children=[],this._isInitialized=!1,this._isAdded=!1;let i,s;if(Array.isArray(t))i=t,s=e;else if(t&&typeof t=="object"){const{components:n,name:o,silenceWarnings:a}=t;i=n??[],s=o}if(s&&(this.name=s),i)for(const n of i)this.addComponent(n)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Ps(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let e=0;e<t.length;e++)if(!this.components.has(t[e]))return!1;return!0}hasAllTags(t){for(let e=0;e<t.length;e++)if(!this.tags.has(t[e]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(_i(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let e=this.parent;for(;e;)t.push(e),e=e.parent;return t.reverse()}getDescendants(){let t=[this],e=[this];for(;e.length>0;){const i=e.pop();i&&(e=e.concat(i.children),t=t.concat(i.children))}return t}clone(){const t=new Bt;for(const e of this.types){const i=this.get(e);i&&t.addComponent(i.clone())}for(const e of this.children)t.addChild(e.clone());return t}addTemplate(t,e=!1){for(const i of t.getComponents())this.addComponent(i.clone(),e);for(const i of t.children)this.addChild(i.clone().addTemplate(i));return this}_getClassHierarchyRoot(t){var e,i;let s=t,n=(e=Object.getPrototypeOf(s.prototype))===null||e===void 0?void 0:e.constructor;for(;n&&n!==Object&&n!==Qt;)s=n,n=(i=Object.getPrototypeOf(s.prototype))===null||i===void 0?void 0:i.constructor;return s}addComponent(t,e=!1){if(this.has(t.constructor))if(e)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const s of t.dependencies)this.addComponent(new s);t.owner=this;const i=this._getClassHierarchyRoot(t.constructor);return this.components.set(i,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,e=!1){let i;if(ho(t)?i=t:i=t.constructor,e){const s=this.components.get(i);if(s){this.componentRemoved$.notifyAll(s),s.owner=void 0,s.onRemove&&s.onRemove(this);const o=this.componentValues.indexOf(s);o>-1&&this.componentValues.splice(o,1)}const n=this._getClassHierarchyRoot(i);this.components.delete(n),this.components.delete(i)}else this._componentsToRemove.push(i);return this}clearComponents(){const t=this.types;for(const e of t)this.removeComponent(e)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new wi(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new Qn(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Kn(t,this)),this._isAdded=!1)}_preupdate(t,e){this.events.emit("preupdate",new Be(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new ke(t,e,this)),this.onPostUpdate(t,e)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}update(t,e){this._initialize(t),this._add(t),this._preupdate(t,e);for(const i of this.children)i.update(t,e);this._postupdate(t,e),this._remove(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){e?this.events.off(t,e):this.events.off(t)}}Bt._ID=0;class Z extends Qt{constructor(){super(...arguments),this.vel=p.Zero,this.acc=p.Zero,this.scaleFactor=p.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class kt{static integrate(t,e,i,s){const n=s/1e3;e.vel.addEqual(i.scale(n,kt._ACC)),t.pos.add(e.vel.scale(n,kt._VEL),kt._POS).addEqual(i.scale(.5*n*n,kt._VEL_ACC)),e.angularVelocity+=e.torque*(1/e.inertia)*n;const o=t.rotation+e.angularVelocity*n;t.scale.add(e.scaleFactor.scale(n,this._SCALE_FACTOR),kt._SCALE),t.get().setTransform(kt._POS,o,kt._SCALE)}}kt._POS=new p(0,0);kt._SCALE=new p(1,1);kt._ACC=new p(0,0);kt._VEL=new p(0,0);kt._VEL_ACC=new p(0,0);kt._SCALE_FACTOR=new p(0,0);class As extends Bt{constructor(t){super({silenceWarnings:!0}),this.beginColor=E.White,this.endColor=E.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=E.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=oe.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new D),this.addComponent(this.motion=new Z),this.addComponent(this.graphics=new lt),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===oe.Global){const e=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(e),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var e,i,s,n,o,a,h,l,c,d,f,_,g,v;this.particleTransform=(e=t.transform)!==null&&e!==void 0?e:this.particleTransform,this.life=(i=t.life)!==null&&i!==void 0?i:this.life,this.fade=(s=t.fade)!==null&&s!==void 0?s:this.fade,this.size=(n=t.size)!==null&&n!==void 0?n:this.size,this.endColor=(o=t.endColor)!==null&&o!==void 0?o:this.endColor.clone(),this.beginColor=(a=t.beginColor)!==null&&a!==void 0?a:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(h=t.opacity)!==null&&h!==void 0?h:this.graphics.opacity,this.transform.pos=(l=t.pos)!==null&&l!==void 0?l:this.transform.pos,this.transform.rotation=(c=t.rotation)!==null&&c!==void 0?c:0,this.transform.scale=b(1,1),this.motion.vel=(d=t.vel)!==null&&d!==void 0?d:this.motion.vel,this.motion.angularVelocity=(f=t.angularVelocity)!==null&&f!==void 0?f:0,this.motion.acc=(_=t.acc)!==null&&_!==void 0?_:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(g=t.startSize)!==null&&g!==void 0?g:0,this.endSize=(v=t.endSize)!==null&&v!==void 0?v:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=B.fromDimension(this.size,this.size,p.Half),this.graphics.onPostDraw=C=>{C.save(),C.debug.drawPoint(b(0,0),{color:this._currentColor,size:this.size}),C.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,e){this.life=this.life-e,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=X(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=X(this.sizeRate*e+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=X(this._currentColor.r+this._rRate*e,0,255),this._currentColor.g=X(this._currentColor.g+this._gRate*e,0,255),this._currentColor.b=X(this._currentColor.b+this._bRate*e,0,255),this._currentColor.a=this.graphics.opacity;let i=this.motion.acc;this.focus&&(i=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(e/1e3)),kt.integrate(this.transform,this.motion,i,e)}}As.DefaultConfig={beginColor:E.White,endColor:E.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var oe;(function(r){r.Global="global",r.Local="local"})(oe||(oe={}));class lo{constructor(){this.type="ex.particle",this.priority=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new Nt({gl:t,vertexSource:wh,fragmentSource:xh,onPreLink:i=>{t.transformFeedbackVaryings(i,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const e=t.getAttribute(Y.Filtering),i=e?pi(e):void 0,s=re(t.getAttribute(Y.WrappingX)),n=re(t.getAttribute(Y.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:i,wrapping:{x:s,y:n}},o);return t.removeAttribute("forceUpload"),a}draw(t,e){var i,s,n,o,a,h,l,c,d;const f=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const _=t.particle.transform===oe.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",_),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(i=t.particle.life)!==null&&i!==void 0?i:2e3),this._shader.setUniformFloat("deltaMs",e),this._shader.setUniformFloatVector("gravity",(s=t.particle.acc)!==null&&s!==void 0?s:b(0,0)),this._shader.setUniformFloatColor("beginColor",(n=t.particle.beginColor)!==null&&n!==void 0?n:E.Transparent),this._shader.setUniformFloatColor("endColor",(o=t.particle.endColor)!==null&&o!==void 0?o:E.Transparent);let g=(a=t.particle.startSize)!==null&&a!==void 0?a:0,v=(h=t.particle.endSize)!==null&&h!==void 0?h:0;const C=(l=t.particle.size)!==null&&l!==void 0?l:0;if(C>0&&(g=C,v=C),this._shader.setUniformFloat("startSize",g??10),this._shader.setUniformFloat("endSize",v??10),this._shader.setUniformFloat("startOpacity",(c=t.particle.opacity)!==null&&c!==void 0?c:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(d=t.particle.focusAccel)!==null&&d!==void 0?d:0)),t.particle.graphic){const m=t.particle.graphic,w=this._getTexture(m.image.image);f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,w),this._shader.setUniformInt("graphic",0)}t.draw(f)}hasPendingDraws(){return!1}flush(){}dispose(){}}const Mh=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,Dh=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Fh{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=E.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,e){this._gl=t,this._context=e;const i=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),s=An(t,i);this._maxTextures=Math.min(i,s);const n=this._transformFragmentSource(Mh,this._maxTextures);this._shader=new Nt({gl:t,fragmentSource:n,vertexSource:Dh}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((d,f)=>f)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const o=this._components;this._transformData=new _e({gl:t,size:o*this._maxImages,type:"dynamic"}),this._transformData.bind();let a=0,h=2;const l=4,c=o*4;t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(2),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(3),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(4),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(5),a+=2*l,t.vertexAttribPointer(h++,1,t.FLOAT,!1,c,a),t.enableVertexAttribArray(6),a+=1*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(7),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(8),a+=2*l,t.vertexAttribPointer(h++,1,t.FLOAT,!1,c,a),t.enableVertexAttribArray(9),a+=1*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(10),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(11),a+=2*l,t.vertexAttribPointer(h++,4,t.FLOAT,!1,c,a),t.enableVertexAttribArray(12),a+=4*l,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const e=this._components;this._transformData.bind(),this._transformData.upload(e*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,e){let i=t.replace("%%count%%",e.toString()),s="";for(let n=0;n<e;n++)n===0?s+=`if (v_texture_index <= ${n}.5) {
`:s+=`   else if (v_texture_index <= ${n}.5) {
`,s+=`      color = texture(u_textures[${n}], uv);
`,s+=`   }
`;return i=i.replace("%%texture_picker%%",s),i}_addImageAsTexture(t){if(this._images.has(t))return;const e=t.getAttribute(Y.Filtering),i=e?pi(e):void 0,s=re(t.getAttribute(Y.WrappingX)),n=re(t.getAttribute(Y.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:i,wrapping:{x:s,y:n}},o);t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&(this._textures.push(a),this._textureToIndex.set(a,this._textureIndex++),this._images.add(t))}_bindTextures(t){const e=Math.min(this._textureIndex,this._maxTextures);for(let i=0;i<e;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var e;if(t){const i=this._context.textureLoader.get(t);return(e=this._textureToIndex.get(i))!==null&&e!==void 0?e:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}draw(t,e,i,s,n,o,a,h,l){var c,d,f,_;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const g=this._getImageWidth(t),v=this._getImageHeight(t);let C=g||s||0,m=v||n||0;this._view[0]=0,this._view[1]=0,this._view[2]=(c=s??g)!==null&&c!==void 0?c:0,this._view[3]=(d=n??v)!==null&&d!==void 0?d:0,this._dest[0]=e??1,this._dest[1]=i??1,o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(this._view[0]=e??1,this._view[1]=i??1,this._view[2]=(f=s??g)!==null&&f!==void 0?f:0,this._view[3]=(_=n??v)!==null&&_!==void 0?_:0,this._dest[0]=o,this._dest[1]=a,C=h,m=l),e=this._view[0],i=this._view[1];const w=this._view[2],T=this._view[3],P=this._context.getTransform(),S=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+O),this._dest[1]=~~(this._dest[1]+O));const A=this._context.tint||this._defaultTint,L=this._getTextureIdForImage(t),W=g||C,U=v||m,q=(e+this.uvPadding)/W,wt=(i+this.uvPadding)/U,rt=(e+w-this.uvPadding)/W,$=(i+T-this.uvPadding)/U,Rt=g,At=v,M=this._transformData.bufferData;M[this._vertexIndex++]=this._dest[0],M[this._vertexIndex++]=this._dest[1],M[this._vertexIndex++]=P.data[0],M[this._vertexIndex++]=P.data[1],M[this._vertexIndex++]=P.data[2],M[this._vertexIndex++]=P.data[3],M[this._vertexIndex++]=P.data[4],M[this._vertexIndex++]=P.data[5],M[this._vertexIndex++]=S,M[this._vertexIndex++]=C,M[this._vertexIndex++]=m,M[this._vertexIndex++]=Rt,M[this._vertexIndex++]=At,M[this._vertexIndex++]=L,M[this._vertexIndex++]=q,M[this._vertexIndex++]=wt,M[this._vertexIndex++]=rt,M[this._vertexIndex++]=$,M[this._vertexIndex++]=A.r/255,M[this._vertexIndex++]=A.g/255,M[this._vertexIndex++]=A.b/255,M[this._vertexIndex++]=A.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),st.DrawnImagesCount+=this._imageCount,st.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const O=1e-4;class Bh{constructor(t){this._webglCtx=t,this._debugText=new Pn}drawRect(t,e,i,s,n={color:E.Black}){this.drawLine(b(t,e),b(t+i,e),{...n}),this.drawLine(b(t+i,e),b(t+i,e+s),{...n}),this.drawLine(b(t+i,e+s),b(t,e+s),{...n}),this.drawLine(b(t,e+s),b(t,e),{...n})}drawLine(t,e,i){var s;this._webglCtx.draw("ex.line",t,e,(s=i==null?void 0:i.color)!==null&&s!==void 0?s:E.Black)}drawPoint(t,e={color:E.Black,size:5}){this._webglCtx.draw("ex.point",t,e.color,e.size)}drawText(t,e){this._debugText.write(this._webglCtx,t,e)}}class ye{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let e=!0;return(t.width>4096||t.height>4096)&&(e=!1),e}constructor(t){this._logger=k.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Tt.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Cs(()=>new mh,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Ya,this._state=new eo,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=E.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Bh(this),this._totalPostProcessorTime=0;const{canvasElement:e,context:i,enableTransparency:s,antialiasing:n,uvPadding:o,multiSampleAntialiasing:a,pixelArtSampler:h,powerPreference:l,snapToPixel:c,backgroundColor:d,useDrawSorting:f,garbageCollector:_,handleContextLost:g,handleContextRestored:v}=t;if(this.__gl=i??e.getContext("webgl2",{antialias:n??this.smoothing,premultipliedAlpha:!1,alpha:s??this.transparency,depth:!1,powerPreference:l??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");g&&this.__gl.canvas.addEventListener("webglcontextlost",g,!1),v&&this.__gl.canvas.addEventListener("webglcontextrestored",v,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new ot(this.__gl,_),this.snapToPixel=c??this.snapToPixel,this.smoothing=n??this.smoothing,this.transparency=s??this.transparency,this.pixelArtSampler=h??this.pixelArtSampler,this.uvPadding=o??this.uvPadding,this.multiSampleAntialiasing=typeof a=="boolean"?a:this.multiSampleAntialiasing,this.samples=typeof a=="object"?a.samples:void 0,this.backgroundColor=d??this.backgroundColor,this.useDrawSorting=f??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=Gt.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new ch({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Wr),this.register(new fh),this.register(new gh),this.register(new nh),this.register(new eh),this.lazyRegister("ex.particle",()=>new lo),this.register(new Fh({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new ah(t),this._renderTarget=new Qi({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new Qi({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new Qi({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new Qi({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,e){this._lazyRenderersFactory.set(t,e)}get(t){let e=this._renderers.get(t);if(!e){const i=this._lazyRenderersFactory.get(t);i&&(this._logger.debug("lazy init renderer:",t),e=i(),this.register(e))}return e}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...e){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const i=this.get(t);if(i)if(this.useDrawSorting){const s=this._drawCallPool.get();s.z=this._state.current.z,s.priority=i.priority,s.renderer=t,this.getTransform().clone(s.transform),s.state.z=this._state.current.z,s.state.opacity=this._state.current.opacity,s.state.tint=this._state.current.tint,s.state.material=this._state.current.material,s.args[0]=e[0],s.args[1]=e[1],s.args[2]=e[2],s.args[3]=e[3],s.args[4]=e[4],s.args[5]=e[5],s.args[6]=e[6],s.args[7]=e[7],s.args[8]=e[8],s.args[9]=e[9],this._drawCalls[this._drawCallIndex++]=s}else this._currentRenderer||(this._currentRenderer=i),this._isCurrentRenderer(i)||this._currentRenderer.flush(),i.draw(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]),this._currentRenderer=i;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const e=this.__gl;this._ortho=this._ortho=Gt.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(e.canvas.width,e.canvas.height),this._msaaTarget.setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[0].setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[1].setResolution(e.canvas.width,e.canvas.height)}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}drawImage(t,e,i,s,n,o,a,h,l){if(!(s===0||n===0)){{if(h===0||l===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){k.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,e,i,s,n,o,a,h,l):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,e,i,s,n,o,a,h,l):this.draw(this.imageRenderer,t,e,i,s,n,o,a,h,l)}}drawLine(t,e,i,s=1){this.draw("ex.rectangle",t,e,i,s)}drawRectangle(t,e,i,s,n,o){this.draw("ex.rectangle",t,e,i,s,n,o)}drawCircle(t,e,i,s,n){this.draw("ex.circle",t,e,i,s,n)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,e){this._transform.translate(this.snapToPixel?~~(t+O):t,this.snapToPixel?~~(e+O):e)}rotate(t){this._transform.rotate(t)}scale(t,e){this._transform.scale(t,e)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const e=this._postprocessors.indexOf(t);e!==-1&&this._postprocessors.splice(e,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const e of this._postprocessors){const i=e.getShader();i.use();const s=i.getUniforms();this._totalPostProcessorTime+=t,s.find(n=>n.name==="u_time_ms")&&i.setUniformFloat("u_time_ms",this._totalPostProcessorTime),s.find(n=>n.name==="u_elapsed_ms")&&i.setUniformFloat("u_elapsed_ms",t),s.find(n=>n.name==="u_resolution")&&i.setUniformFloatVector("u_resolution",b(this.width,this.height)),e.onUpdate&&e.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new ao({...t,graphicsContext:this})}createShader(t){const e=this.__gl,{vertexSource:i,fragmentSource:s}=t,n=new Nt({gl:e,vertexSource:i,fragmentSource:s});return n.compile(),n}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let e=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(e.use(),this.useDrawSorting){for(let o=this._drawCallIndex;o<this._drawCalls.length;o++)this._drawCalls[o]=null;const i=new Map;for(const[o]of this._renderers){let a=0;for(a=0;a<this._drawCallIndex&&this._drawCalls[a].renderer!==o;a++);i.set(o,a)}this._drawCalls.sort((o,a)=>{if(o===null||a===null)return 0;const h=o.z-a.z,l=i.get(o.renderer)-i.get(a.renderer),c=o.priority-a.priority;return h===0?c===0?l:c:h});const s=this._transform.current,n=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let o=this._drawCalls[0].renderer,a=this.get(o);for(let h=0;h<this._drawCallIndex;h++)this._transform.current=this._drawCalls[h].transform,this._state.current=this._drawCalls[h].state,this._drawCalls[h].renderer!==o&&(a.flush(),o=this._drawCalls[h].renderer,a=this.get(o)),a instanceof Wr&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(e.copyToTexture(this.materialScreenTexture),e.use()),a.draw(...this._drawCalls[h].args);a.hasPendingDraws()&&a.flush()}this._transform.current=s,this._state.current=n,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const i of this._renderers.values())i.hasPendingDraws()&&i.flush();e.disable(),this._postprocessors.length>0&&e.toRenderSource().use();for(let i=0;i<this._postprocessors.length;i++)e=this._postProcessTargets[i%2],this._postProcessTargets[i%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[i]),this._postProcessTargets[i%2].toRenderSource().use();e.blitToScreen()}}const ct=1e-4;class kh{constructor(t){this._ex=t,this._debugText=new Pn}drawRect(t,e,i,s){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+ct):t,this._ex.snapToPixel?~~(e+ct):e,this._ex.snapToPixel?~~(i+ct):i,this._ex.snapToPixel?~~(s+ct):s),this._ex.__ctx.restore()}drawLine(t,e,i={color:E.Black}){var s,n;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(n=(s=i.color)===null||s===void 0?void 0:s.toString())!==null&&n!==void 0?n:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+ct):t.x,this._ex.snapToPixel?~~(t.y+ct):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(e.x+ct):e.x,this._ex.snapToPixel?~~(e.y+ct):e.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,e={color:E.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=e.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+ct):t.x,this._ex.snapToPixel?~~(t.y+ct):t.y,e.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,e){this._debugText.write(this._ex,t,e)}}class gs{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=E.ExcaliburBlue,this._state=new eo,this.snapToPixel=!1,this.debug=new kh(this);const{canvasElement:e,context:i,enableTransparency:s,snapToPixel:n,antialiasing:o,backgroundColor:a}=t;if(this.__ctx=i??e.getContext("2d",{alpha:s??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=a??this.backgroundColor,this.snapToPixel=n??this.snapToPixel,this.smoothing=o??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,e,i,s,n,o,a,h,l){if(s===0||n===0)return;if(h===0||l===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const c=[t,e,i,s,n,o,a,h,l].filter(d=>d!==void 0).map(d=>typeof d=="number"&&this.snapToPixel?~~d:d);this.__ctx.drawImage.apply(this.__ctx,c),st.DrawCallCount++,st.DrawnImagesCount=1}drawLine(t,e,i,s=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=i.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+ct):t.x,this.snapToPixel?~~(t.y+ct):t.y),this.__ctx.lineTo(this.snapToPixel?~~(e.x+ct):e.x,this.snapToPixel?~~(e.y+ct):e.y),this.__ctx.lineWidth=s,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,e,i,s){this.__ctx.save(),this.__ctx.fillStyle=s.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+ct):t.x,this.snapToPixel?~~(t.y+ct):t.y,this.snapToPixel?~~(e+ct):e,this.snapToPixel?~~(i+ct):i),this.__ctx.restore()}drawCircle(t,e,i,s,n){this.__ctx.save(),this.__ctx.beginPath(),s&&(this.__ctx.strokeStyle=s.toString()),n&&(this.__ctx.lineWidth=n),this.__ctx.fillStyle=i.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+ct):t.x,this.snapToPixel?~~(t.y+ct):t.y,e,0,Math.PI*2),this.__ctx.fill(),s&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,e){this.__ctx.translate(this.snapToPixel?~~(t+ct):t,this.snapToPixel?~~(e+ct):e)}rotate(t){this.__ctx.rotate(t)}scale(t,e){this.__ctx.scale(t,e)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),st.clear()}flush(){}dispose(){this.__ctx=void 0}}var xt;(function(r){r.Fixed="Fixed",r.FitContainerAndFill="FitContainerAndFill",r.FitScreenAndFill="FitScreenAndFill",r.FitContainerAndZoom="FitContainerAndZoom",r.FitScreenAndZoom="FitScreenAndZoom",r.FitScreen="FitScreen",r.FillScreen="FillScreen",r.FitContainer="FitContainer",r.FillContainer="FillContainer"})(xt||(xt={}));class Ks{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Lh={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Js{constructor(t){var e,i,s,n;this.events=new nt,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=k.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const o=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(o),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new B,this._unsafeArea=new B,this.viewport=t.viewport,this.resolution=(e=t.resolution)!==null&&e!==void 0?e:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(i=t.displayMode)!==null&&i!==void 0?i:xt.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(s=t.antialiasing)!==null&&s!==void 0?s:this._antialiasing,this._canvasImageRendering=(n=t.canvasImageRendering)!==null&&n!==void 0?n:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(p.Zero);return this.worldToPageCoordinates(b(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case xt.FillContainer:case xt.FitContainer:case xt.FitContainerAndFill:case xt.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ye&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let s=Math.max(1,this.pixelRatio-.5),n=!1;for(;s>1&&!n;){s=Math.max(1,s-.5);const o=this._resolution.width*s,a=this._resolution.height*s;n=this.graphicsContext.checkIfResolutionSupported({width:o,height:a})}this.pixelRatioOverride=s,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",e=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+e,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof gs&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var e,i,s,n,o,a;if(t){const h=document.getElementById(t);if(h!=null&&h.requestFullscreen||h!=null&&h.webkitRequestFullscreen){if(h.getAttribute("ex-fullscreen-listener")||(h.setAttribute("ex-fullscreen-listener","true"),h.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),h.requestFullscreen)return(e=h.requestFullscreen())!==null&&e!==void 0?e:Promise.resolve();if(h.webkitRequestFullscreen)return(i=h.webkitRequestFullscreen())!==null&&i!==void 0?i:Promise.resolve()}}return!((s=this._canvas)===null||s===void 0)&&s.requestFullscreen?(o=(n=this._canvas)===null||n===void 0?void 0:n.requestFullscreen())!==null&&o!==void 0?o:Promise.resolve():this._canvas.webkitRequestFullscreen?(a=this._canvas.webkitRequestFullscreen())!==null&&a!==void 0?a:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let e=t.x,i=t.y;this._isFullscreen||(e-=bi(this._canvas).x,i-=bi(this._canvas).y);const s=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const n=window.innerWidth/this.aspectRatio,o=(window.innerHeight-n)/2;i=(i-o)/n*s.height,e=e/window.innerWidth*s.width}else{const n=window.innerHeight*this.aspectRatio,o=(window.innerWidth-n)/2;e=(e-o)/n*s.width,i=i/window.innerHeight*s.height}return e=e/s.width*this.resolution.width,i=i/s.height*this.resolution.height,e=e-this.contentArea.left,i=i-this.contentArea.top,new p(e,i)}screenToPageCoordinates(t){let e=t.x,i=t.y;const s=this._viewportToPixels(this.viewport);if(e=e/this.resolution.width*s.width,i=i/this.resolution.height*s.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const n=window.innerWidth/this.aspectRatio,o=(window.innerHeight-n)/2;i=i/s.height*n+o,e=e/s.width*window.innerWidth}else{const n=window.innerHeight*this.aspectRatio,o=(window.innerWidth-n)/2;e=e/s.width*n+o,i=i/s.height*window.innerHeight}return this._isFullscreen||(e+=bi(this._canvas).x,i+=bi(this._canvas).y),new p(e,i)}screenToWorldCoordinates(t){return t=t.add(b(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(b(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(b(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const e=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(e)}worldToPageCoordinates(t){const e=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(e)}getWorldBounds(){return B.fromDimension(this.resolution.width,this.resolution.height,p.Half).scale(b(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return B.fromDimension(this.resolution.width,this.resolution.height,p.Zero,p.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return b(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let e=0,i=0;window.innerWidth/t<window.innerHeight?(e=window.innerWidth,i=window.innerWidth/t):(e=window.innerHeight*t,i=window.innerHeight),this.viewport={width:e,height:i},this._contentArea=B.fromDimension(this.resolution.width,this.resolution.height,p.Zero),this._unsafeArea=B.fromDimension(this.resolution.width,this.resolution.height,p.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,e=window.innerHeight;this._computeFitAndFill(t,e),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,e,i){if(this.viewport=i??{width:t,height:e},t/e<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*e/t};const s=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new B({top:s,left:0,right:this._contentResolution.width,bottom:this.resolution.height-s}),this._unsafeArea=new B({top:-s,left:0,right:this._contentResolution.width,bottom:this.resolution.height+s})}else{this.resolution={width:e*this._contentResolution.height/e*t/e,height:e*this._contentResolution.height/e};const s=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new B({top:0,left:s,right:this.resolution.width-s,bottom:this._contentResolution.height}),this._unsafeArea=new B({top:0,left:-s,right:this.resolution.width+s,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,e=window.innerHeight;this._computeFitAndZoom(t,e),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:e,offsetHeight:i}=this.canvas;this._computeFitAndZoom(e,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,e){const i=this.aspectRatio;let s=0,n=0;t/i<e?(s=t,n=t/i):(s=e*i,n=e);const o=t/s,a=e/n,h=Math.max(o,a),l=s*h,c=n*h;l>t?this.canvas.style.left=-(l-t)/2+"px":this.canvas.style.left="",c>e?this.canvas.style.top=-(c-e)/2+"px":this.canvas.style.top="",this.viewport={width:l,height:c};const d=B.fromDimension(this.viewport.width,this.viewport.height,p.Zero);if(this.viewport.width>t){const f=(this.viewport.width-t)/this.viewport.width*this.resolution.width;d.top=0,d.left=f/2,d.right=this.resolution.width-f/2,d.bottom=this.resolution.height}if(this.viewport.height>e){const f=(this.viewport.height-e)/this.viewport.height*this.resolution.height;d.top=f/2,d.left=0,d.bottom=this.resolution.height-f/2,d.right=this.resolution.width}this._contentArea=d}_computeFitContainer(){const t=this.aspectRatio;let e=0,i=0,s="pixel",n="pixel";const o=this.canvas.parentElement;o.clientWidth/t<o.clientHeight?(this.canvas.style.width="100%",e=100,s="percent",i=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",i=100,n="percent",e=this.canvas.offsetHeight*t),this.viewport={width:e,widthUnit:s,height:i,heightUnit:n},this._contentArea=B.fromDimension(this.resolution.width,this.resolution.height,p.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===xt.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===xt.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=B.fromDimension(this.resolution.width,this.resolution.height,p.Zero),this.displayMode===xt.FitScreen&&this._computeFit(),this.displayMode===xt.FitContainer&&this._computeFitContainer(),this.displayMode===xt.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===xt.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===xt.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===xt.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Si{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function zh(r){return!!r.playbackState}class Xe{static unlock(){return new Promise((e,i)=>{if(Xe._UNLOCKED||!Si.create())return e(!0);const s=setTimeout(()=>{k.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),e(!1)},200),n=Si.create();n.resume().then(()=>{const o=n.createBuffer(1,1,22050),a=n.createBufferSource();let h=!1;a.buffer=o,a.connect(n.destination),a.onended=()=>h=!0,a.start(0),setTimeout(()=>{zh(a)?(a.playbackState===a.PLAYING_STATE||a.playbackState===a.FINISHED_STATE)&&(Xe._UNLOCKED=!0):(n.currentTime>0||h)&&(Xe._UNLOCKED=!0)},0),clearTimeout(s),e(!0)},()=>{i()})})}static isUnlocked(){return this._UNLOCKED}}Xe._UNLOCKED=!1;class Ts extends gi{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Ts({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var e,i;!((e=this._options)===null||e===void 0)&&e.draw&&((i=this._options)===null||i===void 0||i.draw(t)),this._options.cache||this.flagDirty()}}class Jn{}Jn.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Ss{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,e){const i=new Ss;i.data=e;for(const s in t.states)i.states.set(s,{name:s,...t.states[s]});for(const s of i.states.values())for(const n of s.transitions)if(n!=="*"&&!i.states.has(n))throw Error(`Invalid state machine, state [${s.name}] has a transition to another state that doesn't exist [${n}]`);return i.currentState=i.startState=i.states.get(t.start),i}in(t){return this.currentState.name===t}go(t,e){var i,s;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const n=this.states.get(t);return this.currentState.onExit&&((i=this.currentState)===null||i===void 0?void 0:i.onExit({to:n.name,data:this.data}))===!1||n!=null&&n.onEnter&&(n==null?void 0:n.onEnter({from:this.currentState.name,eventData:e,data:this.data}))===!1?!1:(this.currentState=n,!((s=this.currentState)===null||s===void 0)&&s.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const e=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(e.currentState),this.data=e.data}}class co{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=X(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Si.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new Zt,this._stateMachine=Ss.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:e})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,e.pausedAt*this._playbackRate):this._instance.start(0,e.pausedAt*this._playbackRate,this.duration),e.startedAt=this._audioContext.currentTime-e.pausedAt,e.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:e})=>{e==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:e,data:i})=>{i.pausedAt=(e??0)/this._playbackRate,i.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:e})=>{e.pausedAt=0,e.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:e})=>{e.pausedAt=this._audioContext.currentTime-e.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:e}=this._stateMachine.data;return t?t*this._playbackRate:e?(this._audioContext.currentTime-e)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class tr extends N{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,e="MediaEvent"){super(),this.target=t,this._name=e}stopPropagation(){}action(){}propagate(){}layPath(t){}}class We extends tr{constructor(t,e){super(t,"NativeSoundEvent"),this.track=e}}class uo extends tr{constructor(t,e){super(t,"NativeSoundProcessedEvent"),this._processedData=e,this.data=this._processedData}}function Uh(r){try{const t=new Audio,e=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,i=r.match(e)[1];return!!t.canPlayType("audio/"+i)}catch(t){return k.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const Hh={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class fo{set loop(t){this._loop=t;for(const e of this._tracks)e.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const e of this._tracks)e.volume=this._volume;this.events.emit("volumechange",new We(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new nt,this.logger=k.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Si.create(),this._resource=new Hi("",Jn.type.arraybuffer);for(const e of t)if(Uh(e)){this.path=e;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,e;if(this.data)return this.data;const i=await this._resource.load(),s=await this.decodeAudio(i.slice(0));return this._duration=(e=(t=this._duration)!==null&&t!==void 0?t:s==null?void 0:s.duration)!==null&&e!==void 0?e:void 0,this.events.emit("processed",new uo(this,s)),this.data=s}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new We(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new We(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(e=>{e.playbackRate=this._playbackRate})}seek(t,e=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[e].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const e of this._tracks)t.push(e.play().then(()=>(this._tracks.splice(this.getTrackId(e),1),!0)));this.events.emit("resume",new We(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),e=await t.play(()=>{this.events.emit("playbackstart",new We(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new We(this,t));const i=this.getTrackId(t);return i!==-1&&this._tracks.splice(i,1),e}_getTrackInstance(t){var e;const i=new co(t);return i.loop=this.loop,i.volume=this.volume,i.duration=(e=this.duration)!==null&&e!==void 0?e:0,i.playbackRate=this._playbackRate,this._tracks.push(i),i}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}const Wh={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function tn(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class Ei{get resources(){return this._resources}constructor(t){var e;this.events=new nt,this.canvas=new Ts({filtering:gt.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new Zt,t&&(!((e=t.loadables)===null||e===void 0)&&e.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await ns(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let e=0;const i=t.length;for(e;e<i;e++)this.addResource(t[e])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?X(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,e){this._totalTimeMs+=e}onDraw(t){const e=this._totalTimeMs/1e3;t.fillStyle=E.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const i=e*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,i,i+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const s=(this.progress*100).toFixed(0)+"%",n=t.measureText(s),o=Math.abs(n.actualBoundingBoxLeft)+Math.abs(n.actualBoundingBoxRight),a=Math.abs(n.actualBoundingBoxAscent)+Math.abs(n.actualBoundingBoxDescent);t.fillText(s,-o/2,a/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof fo&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await Xe.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}const Oh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Nh=Ct(851);class Ke extends Ei{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const e=Array.isArray(t)?{loadables:t}:t;super(e),this._logger=k.getInstance(),this._originalOptions={loadables:[]},this.events=new nt,this._playButtonShown=!1,this.logo=Oh,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=E.White,this.backgroundColor="#176BAA",this._imageLoaded=new Zt,this.suppressPlayButton=!1,this._playButtonStyles=Nh.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let i=document.getElementById("excalibur-play");return i||(i=document.createElement("button")),i.id="excalibur-play",i.textContent=this.playButtonText,i.style.display="none",i},this._originalOptions={...Ke._DEFAULT_LOADER_OPTIONS,...e}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,e;if(this.suppressPlayButton)this.hidePlayButton(),await ns(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const i=()=>{try{this._positionPlayButton()}catch{}};return!((e=this.engine)===null||e===void 0)&&e.browser&&this.engine.browser.window.on("resize",i),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",n=>{n.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(n=>{const o=a=>{var h;if(a.stopPropagation(),this.hidePlayButton(),!((h=this.engine)===null||h===void 0)&&h.browser&&this.engine.browser.window.off("resize",i),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(l){this._logger.error("could not go fullscreen",l)}n()};this._playButton.addEventListener("click",o),this._playButton.addEventListener("touchend",o),this._playButton.addEventListener("pointerup",o),this.engine&&this.engine.input.gamepads.once("button",()=>o(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await ns(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await(t==null?void 0:t.decode())}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:e,width:i,height:s}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const n=this._playButton.clientWidth,o=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+i/2-n/2}px`,this._playButtonRootElement.style.top=`${e+s/2-o/2+100}px`)}}}onDraw(t){const e=this.engine.canvasHeight/this.engine.pixelRatio,i=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,i,e);let s=e/2;const n=Math.min(this.logoWidth,i*.75);let o=i/2-n/2;this.logoPosition&&(o=this.logoPosition.x,s=this.logoPosition.y);const a=Math.floor(n*(this.logoHeight/this.logoWidth)),h=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,o,s,n,a):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,o,s-a-20,n,a),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=h;return}let l=o,c=s;this.loadingBarPosition&&(l=this.loadingBarPosition.x,c=this.loadingBarPosition.y),t.lineWidth=2,Qs(t,l,c,n,20,10,this.loadingBarColor);const d=n*this.progress,f=5,_=d-f*2,g=20-f*2;Qs(t,l+f,c+f,_>10?_:10,g,5,null,this.loadingBarColor),this.engine.screen.antialiasing=h}}Ke._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Or={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class _o{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const e=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],i=this.getBrowserFeatures();for(const s of Object.keys(Or))i[s]?(t+="(%c%c)",e.push("font-weight: bold; color: green"),e.push("font-weight: normal; color: inherit")):(t+="(%c%c)",e.push("font-weight: bold; color: red"),e.push("font-weight: normal; color: inherit")),t+=" "+Or[s]+`
`;e.unshift(t),console.log.apply(console,e)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const e in this._criticalTests)this._criticalTests[e].call(this)||(this.failedTests.push(e),k.getInstance().error("Critical browser feature missing, Excalibur requires:",e),t=!0);if(t)return!1;for(const e in this._warningTest)this._warningTest[e]()||k.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",e);return!0}}var H;(function(r){r.PreventCollision="PreventCollision",r.Passive="Passive",r.Active="Active",r.Fixed="Fixed"})(H||(H={}));class de{static create(t,e){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const s=this._GROUPS.get(t);if(s.mask===e)return s;throw new Error(`Collision group ${t} already exists with a different mask!`)}const i=new Ae(t,this._CURRENT_BIT,e!==void 0?e:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,i),i}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}de._STARTING_BIT=1;de._MAX_GROUPS=32;de._CURRENT_GROUP=1;de._CURRENT_BIT=de._STARTING_BIT;de._GROUPS=new Map;class Ae{constructor(t,e,i){this._name=t,this._category=e,this._mask=i}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const e=this.category&t.mask,i=this.mask&t.category;return e!==0&&i!==0}invert(){const t=de.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const e=t.map(n=>n.name).join("+"),s=~t.reduce((n,o)=>o.category|n,0);return de.create(e,s)}static collidesWith(t){const e=`collidesWith(${t.map(s=>s.name).join("+")})`,i=t.reduce((s,n)=>n.category|s,0);return de.create(e,i)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}Ae.All=new Ae("Collide with all groups",-1,-1);class zt{constructor(t,e){this.colliderA=t,this.colliderB=e,this.id=null,this.id=zt.calculatePairHash(t.id,e.id)}static canCollide(t,e){var i,s;if(t.id===e.id||t.owner&&e.owner&&t.owner.id===e.owner.id||t.localBounds.hasZeroDimensions()||e.localBounds.hasZeroDimensions())return!1;const n=(i=t==null?void 0:t.owner)===null||i===void 0?void 0:i.get(V),o=(s=e==null?void 0:e.owner)===null||s===void 0?void 0:s.get(V);return!(!n||!o||!n.group.canCollide(o.group)||n.collisionType===H.Fixed&&o.collisionType===H.Fixed||o.collisionType===H.PreventCollision||n.collisionType===H.PreventCollision||!n.isActive||!o.isActive)}get canCollide(){const t=this.colliderA,e=this.colliderB;return zt.canCollide(t,e)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,e){return t.value<e.value?`#${t.value}+${e.value}`:`#${e.value}+${t.value}`}}class Gi{constructor(t,e){this.min=t,this.max=e}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class en{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new B,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class er{constructor(t,e=new B(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=e,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const e=t.bounds;let i=this.root;for(;!i.isLeaf();){const a=i.left,h=i.right,l=i.bounds.getPerimeter(),d=i.bounds.combine(e).getPerimeter(),f=2*d,_=2*(d-l);let g=0;const v=e.combine(a.bounds);let C,m;a.isLeaf()?g=v.getPerimeter()+_:(m=a.bounds.getPerimeter(),C=v.getPerimeter(),g=C-m+_);let w=0;const T=e.combine(h.bounds);if(h.isLeaf()?w=T.getPerimeter()+_:(m=h.bounds.getPerimeter(),C=T.getPerimeter(),w=C-m+_),f<g&&f<w)break;g<w?i=a:i=h}const s=i.parent,n=new en(s);n.bounds=e.combine(i.bounds),n.height=i.height+1,s!==null?(s.left===i?s.left=n:s.right=n,n.left=i,n.right=t,i.parent=n,t.parent=n):(n.left=i,n.right=t,i.parent=n,t.parent=n,this.root=n);let o=t.parent;for(;o;){if(o=this._balance(o),!o.left)throw new Error("Parent of current leaf cannot have a null left child"+o);if(!o.right)throw new Error("Parent of current leaf cannot have a null right child"+o);o.height=1+Math.max(o.left.height,o.right.height),o.bounds=o.left.bounds.combine(o.right.bounds),o=o.parent}}_remove(t){if(t===this.root){this.root=null;return}const e=t.parent,i=e.parent;let s;if(e.left===t?s=e.right:s=e.left,i){i.left===e?i.left=s:i.right=s,s.parent=i;let n=i;for(;n;)n=this._balance(n),n.bounds=n.left.bounds.combine(n.right.bounds),n.height=1+Math.max(n.left.height,n.right.height),n=n.parent}else this.root=s,s.parent=null}trackCollider(t){const e=new en;e.data=t,e.bounds=t.bounds,e.bounds.left-=2,e.bounds.top-=2,e.bounds.right+=2,e.bounds.bottom+=2,this.nodes[t.id.value]=e,this._insert(e)}updateCollider(t){var e;const i=this.nodes[t.id.value];if(!i)return!1;const s=t.bounds;if(!this.worldBounds.contains(s))return k.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(i.bounds.contains(s))return!1;if(this._remove(i),s.left-=this._config.boundsPadding,s.top-=this._config.boundsPadding,s.right+=this._config.boundsPadding,s.bottom+=this._config.boundsPadding,t.owner){const n=(e=t.owner)===null||e===void 0?void 0:e.get(V);if(n){const o=n.vel.x*32/1e3*this._config.velocityMultiplier,a=n.vel.y*32/1e3*this._config.velocityMultiplier;o<0?s.left+=o:s.right+=o,a<0?s.top+=a:s.bottom+=a}}return i.bounds=s,this._insert(i),!0}untrackCollider(t){const e=this.nodes[t.id.value];e&&(this._remove(e),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const e=t.left,i=t.right,s=t,n=e,o=i,a=e.left,h=e.right,l=i.left,c=i.right,d=o.height-n.height;if(d>1)return o.left=s,o.parent=s.parent,s.parent=o,o.parent?o.parent.left===s?o.parent.left=o:o.parent.right=o:this.root=o,l.height>c.height?(o.right=l,s.right=c,c.parent=s,s.bounds=n.bounds.combine(c.bounds),o.bounds=s.bounds.combine(l.bounds),s.height=1+Math.max(n.height,c.height),o.height=1+Math.max(s.height,l.height)):(o.right=c,s.right=l,l.parent=s,s.bounds=n.bounds.combine(l.bounds),o.bounds=s.bounds.combine(c.bounds),s.height=1+Math.max(n.height,l.height),o.height=1+Math.max(s.height,c.height)),o;if(d<-1){if(n.left=s,n.parent=s.parent,s.parent=n,n.parent)if(n.parent.left===s)n.parent.left=n;else{if(n.parent.right!==s)throw"Error rotating Dynamic Tree";n.parent.right=n}else this.root=n;return a.height>h.height?(n.right=a,s.left=h,h.parent=s,s.bounds=o.bounds.combine(h.bounds),n.bounds=s.bounds.combine(a.bounds),s.height=1+Math.max(o.height,h.height),n.height=1+Math.max(s.height,a.height)):(n.right=h,s.left=a,a.parent=s,s.bounds=o.bounds.combine(a.bounds),n.bounds=s.bounds.combine(h.bounds),s.height=1+Math.max(o.height,a.height),n.height=1+Math.max(s.height,h.height)),n}return t}getHeight(){return this.root===null?0:this.root.height}query(t,e){const i=t.bounds,s=n=>{if(n&&n.bounds.overlaps(i))if(n.isLeaf()&&n.data!==t){if(e.call(t,n.data))return!0}else return s(n.left)||s(n.right);return!1};s(this.root)}rayCastQuery(t,e=1/0,i){const s=n=>{if(n&&n.bounds.rayCast(t,e))if(n.isLeaf()){if(i.call(t,n.data))return!0}else return s(n.left)||s(n.right);return!1};s(this.root)}getNodes(){const t=e=>e?[e].concat(t(e.left),t(e.right)):[];return t(this.root)}debug(t){const e=i=>{i&&(i.isLeaf()?i.bounds.draw(t,E.Green):i.bounds.draw(t,E.White),i.left&&e(i.left),i.right&&e(i.right))};e(this.root)}}class Ne{constructor(t,e){this.pos=t,this.dir=e.normalize()}intersect(t){const e=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&e.cross(this.dir)!==0)return-1;const i=this.dir.cross(t.getSlope());if(i===0)return-1;const s=e.cross(t.getSlope())/i;if(s>=0){const n=e.cross(this.dir)/i/t.getLength();if(n>=0&&n<=1)return s}return-1}intersectPoint(t){const e=this.intersect(t);return e<0?null:this.getPoint(e)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class ms{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new er(t.dynamicTree)}getColliders(){return this._colliders}query(t){const e=[];return t instanceof B?this._dynamicCollisionTree.query({id:Ye("collider",-1),owner:null,bounds:t},i=>(e.push(i),!1)):this._dynamicCollisionTree.query({id:Ye("collider",-1),owner:null,bounds:new B(t.x,t.y,t.x,t.y)},i=>(e.push(i),!1)),e}rayCast(t,e){var i,s,n;const o=[],a=(i=e==null?void 0:e.maxDistance)!==null&&i!==void 0?i:1/0,h=e==null?void 0:e.collisionGroup,l=h?h.category:(s=e==null?void 0:e.collisionMask)!==null&&s!==void 0?s:Ae.All.category,c=(n=e==null?void 0:e.searchAllColliders)!==null&&n!==void 0?n:!1;return this._dynamicCollisionTree.rayCastQuery(t,a,d=>{const _=d.owner.get(V);if(e!=null&&e.ignoreCollisionGroupAll&&_.group===Ae.All)return!1;const g=(l&_.group.category)!==0;if(_!=null&&_.group&&!g)return!1;const v=d.rayCast(t,a);if(v){if(e!=null&&e.filter){if(e.filter(v)&&(o.push(v),!c))return!0}else if(o.push(v),!c)return!0}return!1}),o}track(t){if(!t){k.getInstance().warn("Cannot track null collider");return}if(t instanceof yt){const e=t.getColliders();for(const i of e)i.owner=t.owner,this._colliders.push(i),this._dynamicCollisionTree.trackCollider(i)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){k.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof yt){const e=t.getColliders();for(const i of e){const s=this._colliders.indexOf(i);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(i)}}else{const e=this._colliders.indexOf(t);e!==-1&&this._colliders.splice(e,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,e){const i=zt.calculatePairHash(t.id,e.id);return this._pairs.has(i)}broadphase(t,e,i){const s=e/1e3,n=t.filter(a=>{var h,l;const c=(h=a.owner)===null||h===void 0?void 0:h.get(V);return((l=a.owner)===null||l===void 0?void 0:l.isActive)&&c.collisionType!==H.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let o;for(let a=0,h=n.length;a<h;a++)o=n[a],this._dynamicCollisionTree.query(o,l=>{if(!this._pairExists(o,l)&&zt.canCollide(o,l)){const c=new zt(o,l);this._pairs.add(c.id),this._collisionPairCache.push(c)}return!1});if(i&&(i.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const a of n){const h=a.owner.get(V);if(h.collisionType!==H.Active)continue;const l=h.vel.magnitude*s+h.acc.magnitude*.5*s*s,c=Math.min(a.bounds.height,a.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||l>c/2){i&&i.physics.fastBodies++;const d=h.globalPos.sub(h.oldPos),f=a.center,_=a.getFurthestPoint(h.vel),g=_.sub(d),v=new Ne(g,h.vel);v.pos=v.pos.add(v.dir.scale(-2*this._config.continuous.surfaceEpsilon));let C,m=new p(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(v,l+this._config.continuous.surfaceEpsilon*2,w=>{if(!this._pairExists(a,w)&&zt.canCollide(a,w)){const T=w.rayCast(v,l+this._config.continuous.surfaceEpsilon*10);if(T){const P=T.point.sub(g);P.magnitude<m.magnitude&&(m=P,C=w)}}return!1}),C&&p.isValid(m)){const w=new zt(a,C);this._pairs.has(w.id)||(this._pairs.add(w.id),this._collisionPairCache.push(w));const T=f.sub(_);h.globalPos=g.add(T).add(m).add(v.dir.scale(10*this._config.continuous.surfaceEpsilon)),a.update(h.transform.get()),i&&i.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,e){let i=[];for(let s=0;s<t.length;s++){const n=t[s].collide();if(i=i.concat(n),e&&n.length>0)for(const o of n)e.physics.contacts.set(o.id,o)}return e&&(e.physics.collisions+=i.length),i}update(t){let e=0;const i=t.length;for(let s=0;s<i;s++)this._dynamicCollisionTree.updateCollider(t[s])&&e++;return e}debug(t){this._dynamicCollisionTree.debug(t)}}class Le{constructor(){this.id=Ye("collider",Le._ID++),this.composite=null,this.events=new nt,this.offset=p.Zero}touching(t){return!!this.collide(t)}}Le._ID=0;var Ii;(function(r){r.Arcade="arcade",r.Realistic="realistic"})(Ii||(Ii={}));var Te;(function(r){r.None="none",r.VerticalFirst="vertical-first",r.HorizontalFirst="horizontal-first"})(Te||(Te={}));const ir={vertical:1,horizontal:2},sr={horizontal:1,vertical:2},nr={horizontal:0,vertical:0};var ai;(function(r){r.DynamicTree="dynamic-tree",r.SparseHashGrid="sparse-hash-grid"})(ai||(ai={}));const Ce=()=>({enabled:!0,gravity:b(0,0).clone(),solver:Ii.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:ai.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:Te.None},realistic:{contactSolveBias:Te.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class yt extends Le{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new ms({...Ce()}),this._dynamicAABBTree=new er({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const e of t)this.addCollider(e)}clearColliders(){this._colliders=[]}addCollider(t){let e;t instanceof yt?(e=t.getColliders(),e.forEach(i=>i.offset.addEqual(t.offset))):e=[t];for(const i of e)i.events.pipe(this.events),i.composite=this,this._colliders.push(i),this._collisionProcessor.track(i),this._dynamicAABBTree.trackCollider(i)}removeCollider(t){t.events.pipe(this.events),t.composite=null,_i(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,e;return((e=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&e!==void 0?e:p.Zero).add(this.offset)}get center(){var t,e;return((e=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&e!==void 0?e:p.Zero).add(this.offset)}get bounds(){var t,e;const i=this.getColliders();return i.reduce((n,o)=>n.combine(o.bounds),(e=(t=i[0])===null||t===void 0?void 0:t.bounds)!==null&&e!==void 0?e:new B().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,e;const i=this.getColliders();return i.reduce((n,o)=>n.combine(o.localBounds),(e=(t=i[0])===null||t===void 0?void 0:t.localBounds)!==null&&e!==void 0?e:new B)}get axes(){const t=this.getColliders();let e=[];for(const i of t)e=e.concat(i.axes);return e}getFurthestPoint(t){const e=this.getColliders(),i=[];for(const o of e)i.push(o.getFurthestPoint(t));let s=i[0],n=-Number.MAX_VALUE;for(const o of i){const a=o.dot(t);a>n&&(s=o,n=a)}return s}getInertia(t){const e=this.getColliders();let i=0;for(const s of e)i+=s.getInertia(t);return i}collide(t){let e=[t];t instanceof yt&&(e=t.getColliders());const i=[];for(const n of e)this._dynamicAABBTree.query(n,o=>(i.push(new zt(n,o)),!1));let s=[];for(const n of i)s=s.concat(n.collide());return s}getClosestLineBetween(t){const e=this.getColliders(),i=[];if(t instanceof yt){const s=t.getColliders();for(const n of e)for(const o of s){const a=n.getClosestLineBetween(o);a&&i.push(a)}}else for(const s of e){const n=t.getClosestLineBetween(s);n&&i.push(n)}if(i.length){let s=i[0].getLength(),n=i[0];for(const o of i){const a=o.getLength();a<s&&(s=a,n=o)}return n}return null}contains(t){const e=this.getColliders();for(const i of e)if(i.contains(t))return!0;return!1}rayCast(t,e){const i=this.getColliders(),s=[];for(const n of i){const o=n.rayCast(t,e);o&&s.push(o)}if(s.length){let n=s[0],o=n.point.dot(t.dir);for(const a of s){const h=t.dir.dot(a.point);h<o&&(n=a,o=h)}return n}return null}project(t){const e=this.getColliders(),i=[];for(const s of e){const n=s.project(t);n&&i.push(n)}if(i.length){const s=new Gi(i[0].min,i[0].max);for(const n of i)s.min=Math.min(n.min,s.min),s.max=Math.max(n.max,s.max);return s}return null}update(t){if(t){const e=this.getColliders();for(const i of e)i.owner=this.owner,i.update(t)}}debug(t,e,i){const s=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const n of s)n.debug(t,e,i);t.restore()}clone(){const t=new yt(this._colliders.map(e=>e.clone()));return t.offset=this.offset.clone(),t}}class ut{constructor(t,e){this.begin=t,this.end=e}clone(t){const e=t||new ut(this.begin.clone(),this.end.clone());return e.begin=this.begin.clone(e.begin),e.end=this.end.clone(e.end),e}transform(t,e){const i=e||new ut(p.Zero,p.Zero);return i.begin=t.multiply(this.begin,i.begin),i.end=t.multiply(this.end,i.end),i}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,e=this.end,i=t.distance(e);return this._slope=e.sub(t).scale(1/i)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,e=this.end;return t.distance(e)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ut(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,e,i=!0){let s=t;i&&(s=s.normalize());const n=s.dot(this.begin)-e,o=s.dot(this.end)-e,a=[];if(n<=0&&a.push(this.begin),o<=0&&a.push(this.end),n*o<0){const h=n/(n-o);a.push(this.begin.add(this.end.sub(this.begin).scale(h)))}return a.length!==2?null:new ut(a[0],a[1])}distanceToPoint(t,e=!1){const i=t.x,s=t.y,n=this.getLength(),o=this.end.y-this.begin.y,a=this.end.x-this.begin.x,h=(o*i-a*s+this.end.x*this.begin.y-this.end.y*this.begin.x)/n;return e?h:Math.abs(h)}findVectorToPoint(t){const e=this.begin.sub(t),i=this.getSlope();return e.sub(i.scale(e.dot(i)))}findPoint(t=null,e=null){const i=this.slope,s=this.intercept;if(t!==null)return new p(t,i*t+s);if(e!==null)return new p((e-s)/i,e);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,e=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new p(arguments[0],arguments[1]),e=arguments[2]||0;else if(arguments[0]instanceof p)t=arguments[0],e=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const i=t.x-this.begin.x,s=t.y-this.begin.y,n=this.end.x-this.begin.x,o=this.end.y-this.begin.y,a=i*o-s*n;return Math.abs(a)>e?!1:Math.abs(n)>=Math.abs(o)?n>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:o>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function Vs(r,t){const i=r.dir(),s=t.dir(),n=i.dot(i),o=s.dot(s);if(n<1e-9&&o<1e-9)return new ut(r.begin,t.begin);if(n<1e-9){const C=X(s.dot(r.begin.sub(t.begin))/o,0,1),m=t.begin.add(s.scale(C));return new ut(r.begin,m)}if(o<1e-9){const C=X(i.dot(t.begin.sub(r.begin))/n,0,1),m=r.begin.add(i.scale(C));return new ut(m,t.begin)}const a=r.begin.sub(t.begin),h=n,l=o,c=s.dot(a),d=h*l-Math.pow(i.dot(s),2);let f=0,_=0;Math.abs(d)>1e-9?f=X((i.dot(s)*c-l*i.dot(a))/d,0,1):f=X(i.dot(a)/h,0,1),Math.abs(l)>1e-9?_=X((i.dot(s)*f+c)/l,0,1):_=0;const g=r.begin.add(i.scale(f)),v=t.begin.add(s.scale(_));return new ut(g,v)}const ue={PolygonPolygonClosestLine(r,t){const e=r.getSides(),i=t.getSides();let s=Number.MAX_VALUE,n=null;for(let o=0;o<e.length;o++)for(let a=0;a<i.length;a++){const h=Vs(e[o],i[a]),l=h.getLength();l<s&&(s=l,n=h)}return n},PolygonEdgeClosestLine(r,t){const i=t.worldPos.sub(r.worldPos),s=new Ne(r.worldPos,i),n=r.rayCast(s).point.add(s.dir.scale(.1)),o=r.getClosestFace(n),a=t.asLine();return Vs(o.face,a)},PolygonCircleClosestLine(r,t){const e=t.worldPos,i=e.sub(r.worldPos),s=new Ne(r.worldPos,i.normalize()),n=r.rayCast(s).point.add(s.dir.scale(.1)),o=r.getClosestFace(n),a=o.face.begin,h=o.face.getEdge();let l=(h.x*(e.x-a.x)+h.y*(e.y-a.y))/(h.x*h.x+h.y*h.y);l>1?l=1:l<0&&(l=0);const c=Math.sqrt(Math.pow(a.x+h.x*l-e.x,2)+Math.pow(a.y+h.y*l-e.y,2))-t.radius,d=(a.x+h.x*l-e.x)*t.radius/(t.radius+c),f=(a.y+h.y*l-e.y)*t.radius/(t.radius+c);return new ut(h.scale(l).add(a),new p(e.x+d,e.y+f))},CircleCircleClosestLine(r,t){const i=t.worldPos.sub(r.worldPos),n=r.worldPos.sub(t.worldPos),o=new Ne(r.worldPos,i),a=new Ne(t.worldPos,n),h=r.rayCast(o),l=t.rayCast(a);return new ut(h.point,l.point)},CircleEdgeClosestLine(r,t){const e=r.worldPos,i=t.asLine(),s=i.begin,n=i.getEdge(),o=s,a=n;let h=(a.x*(e.x-o.x)+a.y*(e.y-o.y))/(a.x*a.x+a.y*a.y);h>1?h=1:h<0&&(h=0);const l=Math.sqrt(Math.pow(o.x+a.x*h-e.x,2)+Math.pow(o.y+a.y*h-e.y,2))-r.radius,c=(o.x+a.x*h-e.x)*r.radius/(r.radius+l),d=(o.y+a.y*h-e.y)*r.radius/(r.radius+l);return new ut(a.scale(h).add(o),new p(e.x+c,e.y+d))},EdgeEdgeClosestLine(r,t){const e=r.asLine(),i=t.asLine();return Vs(e,i)}};class Mt extends Le{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const e=this._transform,i=(t=e==null?void 0:e.globalScale)!==null&&t!==void 0?t:p.One;return this._radius=this._naturalRadius*Math.min(i.x,i.y)}set radius(t){var e;const i=this._transform,s=(e=i==null?void 0:i.globalScale)!==null&&e!==void 0?e:p.One;this._naturalRadius=t/Math.min(s.x,s.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=p.Zero,this._globalMatrix=_t.identity(),this._localBoundsDirty=!0,this.offset=t.offset||p.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Mt({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var e,i;return((i=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&i!==void 0?i:this.offset).distance(t)<=this.radius}rayCast(t,e=1/0){var i,s;const n=this.center,o=t.dir,a=t.pos,h=n.sub(a),l=o.scale(h.dot(o)),d=h.sub(l).magnitude;if(d>this.radius)return null;{let f=0;if(Zr(d,this.radius,1e-4)){if(f=-o.dot(a.sub(n)),f>0&&f<e){const _=t.getPoint(f);return{point:_,normal:_.sub(n).normalize(),collider:this,body:(i=this.owner)===null||i===void 0?void 0:i.get(V),distance:f}}return null}else{const _=Math.sqrt(Math.pow(o.dot(a.sub(n)),2)-Math.pow(a.sub(n).distance(),2)+Math.pow(this.radius,2)),g=-o.dot(a.sub(n))+_,v=-o.dot(a.sub(n))-_,C=[];g>=0&&C.push(g),v>=0&&C.push(v);const m=Math.min(...C);if(m<=e){const w=t.getPoint(m);return{point:w,normal:w.sub(n).normalize(),collider:this,body:(s=this.owner)===null||s===void 0?void 0:s.get(V),distance:m}}return null}}}getClosestLineBetween(t){if(t instanceof Mt)return ue.CircleCircleClosestLine(this,t);if(t instanceof St)return ue.PolygonCircleClosestLine(t,this).flip();if(t instanceof Xt)return ue.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Mt)return se.CollideCircleCircle(this,t);if(t instanceof St)return se.CollideCirclePolygon(this,t);if(t instanceof Xt)return se.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new B(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var e;this._transform=t,((e=t.matrix)!==null&&e!==void 0?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const e=[],s=this.center.dot(t);return e.push(s),e.push(s+this.radius),e.push(s-this.radius),new Gi(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e,i){var s,n,o,a;const{lineWidth:h}={lineWidth:1,...i},l=this._transform,c=(s=l==null?void 0:l.globalScale)!==null&&s!==void 0?s:p.One,d=(n=l==null?void 0:l.globalRotation)!==null&&n!==void 0?n:0,f=(o=l==null?void 0:l.globalPos)!==null&&o!==void 0?o:p.Zero;t.save(),t.translate(f.x,f.y),t.rotate(d),t.scale(c.x,c.y),t.drawCircle((a=this.offset)!==null&&a!==void 0?a:p.Zero,this._naturalRadius,E.Transparent,e,h),t.restore()}}class Oe{constructor(t,e,i,s,n,o,a,h){var l,c,d,f,_,g;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=e,this.mtv=i,this.normal=s,this.tangent=n,this.points=o,this.localPoints=a,this.info=h,this.id=zt.calculatePairHash(t.id,e.id),t.composite||e.composite){const v=((l=t.composite)===null||l===void 0?void 0:l.compositeStrategy)==="separate"?t.id:(d=(c=t.composite)===null||c===void 0?void 0:c.id)!==null&&d!==void 0?d:t.id,C=((f=e.composite)===null||f===void 0?void 0:f.compositeStrategy)==="separate"?e.id:(g=(_=e.composite)===null||_===void 0?void 0:_.id)!==null&&g!==void 0?g:e.id;this.id+="|"+zt.calculatePairHash(v,C)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(V)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(V))}matchAwake(){const t=this.bodyA,e=this.bodyB;t&&e&&t.isSleeping!==e.isSleeping&&(t.isSleeping&&t.collisionType!==H.Fixed&&e.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),e.isSleeping&&e.collisionType!==H.Fixed&&t.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const e=this.colliderA,i=this.colliderB;return this.colliderB=e,this.colliderA=i,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class po{constructor(){this.axis=b(0,0),this.localAxis=b(0,0),this.side=new ut(b(0,0),b(0,0)),this.localSide=new ut(b(0,0),b(0,0)),this.point=b(0,0),this.localPoint=b(0,0)}}class ft{static findPolygonPolygonSeparation(t,e){if(e.transform.matrix.determinant()===0)return ft.findPolygonPolygonSeparationDegenerate(t,e);let i=-Number.MAX_VALUE,s=-1,n;const o=e.transform.inverse.multiply(t.transform.matrix,ft._SCRATCH_MATRIX),a=o.getRotation(),h=t.normals,l=t.points,c=e.points;for(let _=0;_<l.length;_++){const g=h[_].rotate(a,ft._ZERO,ft._SCRATCH_NORMAL),v=o.multiply(l[_],ft._SCRATCH_POINT);let C=Number.MAX_VALUE,m;for(let w=0;w<c.length;w++){const T=g.dot(c[w].sub(v,ft._SCRATCH_SUB_POINT));T<C&&(C=T,m=c[w])}C>i&&(i=C,s=_,n=m)}const d=(s+1)%l.length,f=ft.SeparationPool.get();return f.collider=t,f.separation=i,i>0||(h[s].clone(f.localAxis),h[s].rotate(t.transform.rotation,ft._ZERO,f.axis),t.transform.matrix.multiply(l[s],f.side.begin),t.transform.matrix.multiply(l[d],f.side.end),e.transform.matrix.multiply(n,f.point),f.sideId=s,n.clone(f.localPoint),l[s].clone(f.localSide.begin),l[d].clone(f.localSide.end)),f}static findCirclePolygonSeparation(t,e){const i=e.axes,n=e.center.sub(t.worldPos),o=e.getFurthestPoint(n.negate());i.push(o.sub(t.worldPos).normalize());let a=Number.MAX_VALUE,h=null,l=-1;for(let c=0;c<i.length;c++){const d=e.project(i[c]),f=t.project(i[c]),_=d.getOverlap(f);if(_<=0)return null;_<a&&(a=_,h=i[c],l=c)}return l<0?null:h.normalize().scale(a)}static findPolygonPolygonSeparationDegenerate(t,e){let i=-Number.MAX_VALUE,s=null,n=null,o=-1,a=null;const h=t.getSides(),l=t.getLocalSides();for(let c=0;c<h.length;c++){const d=h[c],f=d.normal(),_=e.getFurthestPoint(f.negate()),g=d.distanceToPoint(_,!0);g>i&&(i=g,s=d,n=f,o=c,a=_)}return{collider:t,separation:n?i:99,axis:n,side:s,localSide:l[o],sideId:o,point:a,localPoint:n?e.getFurthestLocalPoint(n.negate()):null}}}ft.SeparationPool=new Cs(()=>new po,r=>r,500);ft._ZERO=b(0,0);ft._SCRATCH_POINT=b(0,0);ft._SCRATCH_SUB_POINT=b(0,0);ft._SCRATCH_NORMAL=b(0,0);ft._SCRATCH_MATRIX=_t.identity();ft.SeparationPool.disableWarnings=!0;const Gh=p.Zero,Xh=p.Zero,Vh=_t.identity(),se={CollideCircleCircle(r,t){const e=r.worldPos,i=t.worldPos,s=r.radius+t.radius,n=e.distance(i);if(n>s)return[];const o=s-n,a=i.sub(e).normalize(),h=a.perpendicular(),l=a.scale(o),c=r.getFurthestPoint(a),d=r.getFurthestLocalPoint(a),f={collider:r,separation:o,axis:a,point:c};return[new Oe(r,t,l,a,h,[c],[d],f)]},CollideCirclePolygon(r,t){var e,i;let s=ft.findCirclePolygonSeparation(r,t);if(!s)return[];s=s.dot(t.center.sub(r.center))<0?s.negate():s;const o=r.getFurthestPoint(s),h=((i=(e=r.owner)===null||e===void 0?void 0:e.get(D))!==null&&i!==void 0?i:new D).applyInverse(o),l=s.normalize(),c={collider:r,separation:-s.magnitude,axis:l,point:o,localPoint:h,side:t.findSide(l.negate()),localSide:t.findLocalSide(l.negate())};return[new Oe(r,t,s,l,l.perpendicular(),[o],[h],c)]},CollideCircleEdge(r,t){const e=r.center,i=t.asLine(),s=i.end.sub(i.begin),n=s.dot(i.end.sub(e)),o=s.dot(e.sub(i.begin)),a=t.asLine(),h=t.asLocalLine();if(o<=0){const m=i.begin.sub(e),w=m.dot(m);if(w>r.radius*r.radius)return[];const T=m.normalize(),P=r.radius-Math.sqrt(w),S={collider:r,separation:P,axis:T,point:a.begin,side:a,localSide:h};return[new Oe(r,t,T.scale(P),T,T.perpendicular(),[a.begin],[h.begin],S)]}if(n<=0){const m=i.end.sub(e),w=m.dot(m);if(w>r.radius*r.radius)return[];const T=m.normalize(),P=r.radius-Math.sqrt(w),S={collider:r,separation:P,axis:T,point:a.end,side:a,localSide:h};return[new Oe(r,t,T.scale(P),T,T.perpendicular(),[a.end],[h.end],S)]}const l=s.dot(s),c=i.begin.scale(n).add(i.end.scale(o)).scale(1/l),d=e.sub(c),f=d.dot(d);if(f>r.radius*r.radius)return[];let _=s.perpendicular();_.dot(e.sub(i.begin))<0&&(_.x=-_.x,_.y=-_.y),_=_.normalize();const g=r.radius-Math.sqrt(f),v=_.scale(g),C={collider:r,separation:g,axis:_,point:c,side:a,localSide:h};return[new Oe(r,t,v,_.negate(),_.negate().perpendicular(),[c],[c.sub(t.worldPos)],C)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(r,t){var e;const i=r.center,n=t.center.sub(i).normalize(),o=new St({points:[t.begin,t.end,t.end.add(n.scale(100)),t.begin.add(n.scale(100))],offset:t.offset});o.owner=t.owner,((e=t.owner)===null||e===void 0?void 0:e.get(D))&&o.update(t.owner.get(D).get());const h=this.CollidePolygonPolygon(r,o);return h.length&&(h[0].colliderB=t,h[0].id=zt.calculatePairHash(r.id,t.id)),h},CollidePolygonPolygon(r,t){const e=ft.findPolygonPolygonSeparation(r,t);if(e.separation>0)return[];const i=ft.findPolygonPolygonSeparation(t,r);if(i.separation>0)return[];const s=e.separation>i.separation?e:i,n=s.collider===r?t:r,o=s.collider===r?r:t,a=n.transform.inverse.multiply(o.transform.matrix,Vh),h=a.getRotation(),l=o.normals[s.sideId].rotate(h,Gh,Xh);let c=Number.MAX_VALUE,d=0;for(let m=0;m<n.normals.length;m++){const w=l.dot(n.normals[m]);w<c&&(c=w,d=m)}if(!s.localSide||!s.localAxis||!s.axis)return[];const f=s.localSide.transform(a),_=s.localAxis.perpendicular().negate().rotate(h),v=new ut(n.points[d],n.points[(d+1)%n.points.length]).clip(_.negate(),-_.dot(f.begin),!1);let C=null;if(v&&(C=v.clip(_,_.dot(f.end),!1)),C){const m=[],w=[],T=C.getPoints();for(let F=0;F<T.length;F++){const A=T[F];f.below(A)&&(m.push(A),w.push(n.transform.apply(A)))}let P=s.axis,S=P.perpendicular();return t.center.sub(r.center).dot(P)<0&&(P=P.negate(),S=P.perpendicular()),[new Oe(r,t,P.scale(-s.separation),P,S,w,m,s)]}return[]},FindContactSeparation(r,t){var e,i,s,n;const o=r.colliderA,a=(i=(e=r.bodyA)===null||e===void 0?void 0:e.transform)!==null&&i!==void 0?i:new D,h=r.colliderB,l=(n=(s=r.bodyB)===null||s===void 0?void 0:s.transform)!==null&&n!==void 0?n:new D;if(o instanceof Mt&&h instanceof Mt){const c=o.radius+h.radius,d=a.pos.distance(l.pos);return-(c-d)}if(o instanceof St&&h instanceof St&&r.info.localSide){let c,d;return r.info.collider===o?(c=new ut(a.apply(r.info.localSide.begin).add(o.offset),a.apply(r.info.localSide.end).add(o.offset)),d=l.apply(t).add(h.offset)):(c=new ut(l.apply(r.info.localSide.begin).add(h.offset),l.apply(r.info.localSide.end).add(h.offset)),d=a.apply(t).add(o.offset)),c.distanceToPoint(d,!0)}if(o instanceof St&&h instanceof Mt||h instanceof St&&o instanceof Mt){const c=a.apply(t);if(r.info.side)return r.info.side.distanceToPoint(c,!0)}if(o instanceof Xt&&h instanceof St||h instanceof Xt&&o instanceof St){let c;if(r.info.collider===o?c=l.apply(t):c=a.apply(t),r.info.side)return r.info.side.distanceToPoint(c,!0)}if(o instanceof Mt&&h instanceof Xt||h instanceof Mt&&o instanceof Xt){const c=l.apply(t);let d;o instanceof Mt&&(d=o.getFurthestPoint(r.normal));const f=c.distance(d);if(r.info.side)return f>0?-f:0}return 0}};class Xt extends Le{constructor(t){var e;super(),this._globalMatrix=_t.identity(),this.begin=t.begin||p.Zero,this.end=t.end||p.Zero,this.offset=(e=t.offset)!==null&&e!==void 0?e:p.Zero}clone(){return new Xt({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const e=this._transform;return(t=e==null?void 0:e.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.average(e)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),e=this._getTransformedEnd(),i=t.distance(e);return e.sub(t).scale(1/i)}getLength(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.distance(e)}contains(){return!1}rayCast(t,e=1/0){var i;const s=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&s.cross(t.dir)!==0)return null;const n=t.dir.cross(this.getSlope());if(n===0)return null;const o=s.cross(this.getSlope())/n;if(o>=0&&o<=e){const a=s.cross(t.dir)/n/this.getLength();if(a>=0&&a<=1)return{distance:o,normal:this.asLine().normal(),collider:this,body:(i=this.owner)===null||i===void 0?void 0:i.get(V),point:t.getPoint(o)}}return null}getClosestLineBetween(t){if(t instanceof Mt)return ue.CircleEdgeClosestLine(t,this);if(t instanceof St)return ue.PolygonEdgeClosestLine(t,this).flip();if(t instanceof Xt)return ue.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Mt)return se.CollideCircleEdge(t,this);if(t instanceof St)return se.CollidePolygonEdge(t,this);if(t instanceof Xt)return se.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const e=this._getTransformedBegin(),i=this._getTransformedEnd();return t.dot(e)>0?e:i}_boundsFromBeginEnd(t,e,i=10){return new B(Math.min(t.x,e.x)-i,Math.min(t.y,e.y)-i,Math.max(t.x,e.x)+i,Math.max(t.y,e.y)+i)}get bounds(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return this._boundsFromBeginEnd(t,e)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ut(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ut(this.begin,this.end)}get axes(){const e=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),i=[];return i.push(e),i.push(e.negate()),i.push(e.normal()),i.push(e.normal().negate()),i}getInertia(t){const e=this.end.sub(this.begin).distance()/2;return t*e*e}update(t){var e;this._transform=t,((e=t.matrix)!==null&&e!==void 0?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const e=[],i=[this._getTransformedBegin(),this._getTransformedEnd()],s=i.length;for(let n=0;n<s;n++)e.push(i[n].dot(t));return new Gi(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e){const i=this._getTransformedBegin(),s=this._getTransformedEnd();t.drawLine(i,s,e,2),t.drawCircle(i,2,e),t.drawCircle(s,2,e)}}class bt{static registerGraphicsContext(t){bt._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,e){bt.draw(i=>{i.debug.drawPoint(t,e)})}static drawLine(t,e,i){bt.draw(s=>{s.debug.drawLine(t,e,i)})}static drawLines(t,e){t.length>1&&bt.draw(i=>{for(let s=0;s<t.length-1;s++)i.debug.drawLine(t[s],t[s+1],e)})}static drawText(t,e){bt.draw(i=>{i.debug.drawText(t,e)})}static drawPolygon(t,e){t.length>1&&bt.draw(i=>{const s=t[0],n=[...t,s];for(let o=0;o<n.length-1;o++)i.debug.drawLine(n[o],n[o+1],e)})}static drawCircle(t,e,i){const{color:s,strokeColor:n,width:o}={color:E.Black,strokeColor:void 0,width:void 0,...i};bt.draw(a=>{a.drawCircle(t,e,s,n,o)})}static drawBounds(t,e){bt.draw(i=>{i.debug.drawRect(t.left,t.top,t.width,t.height,e)})}static drawRay(t,e){const{distance:i,color:s}={color:E.Blue,distance:10,...e};bt.draw(n=>{const o=t.pos,a=t.pos.add(t.dir.scale(i));n.debug.drawLine(o,a,{color:s})})}static flush(t){t.save(),t.z=bt.z;for(const e of bt._drawCalls)e(t);t.restore(),bt.clear()}static clear(){bt._drawCalls.length=0}}bt._drawCalls=[];bt.z=1/0;class St extends Le{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let e=0;e<this._points.length;e++)t.push(this._points[(e+1)%this._points.length].sub(this._points[e]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var e;super(),this._logger=k.getInstance(),this._transform=new Pe,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(e=t.offset)!==null&&e!==void 0?e:p.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let e=0;for(let i=0;i<t.length;i++)e+=(t[(i+1)%t.length].x-t[i].x)*(t[(i+1)%t.length].y+t[i].y);return e<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],e=this.points[this.points.length-1],i=Math.atan2(e.y-t.y,e.x-t.x),s=0,n=0,o=0;for(const[a,h]of this.points.entries()){if(t=e,s=i,e=h,i=Math.atan2(e.y-t.y,e.x-t.x),t.equals(e))return!1;let l=i-s;if(l<=-Math.PI?l+=Math.PI*2:l>Math.PI&&(l-=Math.PI*2),a===0){if(l===0)return!1;n=l>0?1:-1}else if(n*l<=0)return!1;o+=l}return Math.abs(Math.round(o/(Math.PI*2)))===1}tessellate(){const t=[];for(let e=1;e<this.points.length-2;e++)t.push([this.points[0],this.points[e+1],this.points[e+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new yt(t.map(e=>Dt.Polygon(e)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],e=[...this.points].reverse();let i=e.length;function s(d){return d===0?i-1:d-1}function n(d){return d===i-1?0:d+1}function o(d){const f=s(d),_=n(d),g=e[f],v=e[d],C=e[_],m=g.sub(v),w=C.sub(v);return!(m.cross(w)<0)}const a=e.map((d,f)=>o(f));function h(d,f,_,g){const v=_.sub(f),C=g.sub(_),m=f.sub(g),w=d.sub(f),T=d.sub(_),P=d.sub(g),S=v.cross(w),F=C.cross(T),A=m.cross(P);return!(S>0||F>0||A>0)}function l(){for(let d=0;d<i;d++)if(a[d]){const f=s(d),_=n(d),g=e[f],v=e[d],C=e[_];let m=!0;for(let w=0;w<i;w++){if(w===d||w===f||w===_)continue;const T=e[w];if(h(T,g,v,C)){m=!1;break}}if(m)return d}for(let d=0;d<i;d++)if(a[d])return d;return 0}function c(d){const f=s(d),_=n(d),g=e[f],v=e[d],C=e[_];t.push([g,v,C]),e.splice(d,1),a.splice(d,1),i--}for(;i>3;){const d=l();c(d);for(let f=0;f<i;f++)a[f]=o(f)}return t.push([e[0],e[1],e[2]]),new yt(t.map(d=>Dt.Polygon(d,p.Zero,!0)))}clone(){return new St({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,e=t.length;this._transformedPoints.length=0;for(let i=0;i<e;i++)this._transformedPoints[i]=this._transform.apply(t[i].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],e=this.getTransformedPoints(),i=e.length;for(let s=0;s<i;s++)t.push(new ut(e[s],e[(s+1)%i]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],e=this.points,i=e.length;for(let s=0;s<i;s++)t.push(new ut(e[s],e[(s+1)%i]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const e=this.getSides();let i=e[0],s=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=e[n],h=o.normal().dot(t);h>s&&(i=o,s=h)}return i}findLocalSide(t){const e=this.getLocalSides();let i=e[0],s=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=e[n],h=o.normal().dot(t);h>s&&(i=o,s=h)}return i}get axes(){const t=[],e=this.getSides();for(let i=0;i<e.length;i++)t.push(e[i].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(e=>b(e.x*et(this._transform.scale.x),e.y*et(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const e=this._transform.applyInverse(t),i=new Ne(e,new p(1,0));let s=0;const n=this.getLocalSides();for(let o=0;o<n.length;o++){const a=n[o];i.intersect(a)>=0&&s++}return s%2!==0}getClosestLineBetween(t){if(t instanceof Mt)return ue.PolygonCircleClosestLine(this,t);if(t instanceof St)return ue.PolygonPolygonClosestLine(this,t);if(t instanceof Xt)return ue.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Mt)return se.CollideCirclePolygon(t,this);if(t instanceof St)return se.CollidePolygonPolygon(this,t);if(t instanceof Xt)return se.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const e=this.getTransformedPoints();let i=null,s=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=t.dot(e[n]);o>s&&(s=o,i=e[n])}return i}getFurthestLocalPoint(t){const e=this.points;let i=e[0],s=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=t.dot(e[n]);o>s&&(s=o,i=e[n])}return i}getClosestFace(t){const e=this.getSides();let i=Number.POSITIVE_INFINITY,s=-1,n=-1;for(let o=0;o<e.length;o++){const a=e[o].distanceToPoint(t);a<i&&(i=a,s=o,n=a)}return s!==-1?{distance:e[s].normal().scale(n),face:e[s]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=B.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let e=0,i=0;const s=this.points;for(let n=0;n<s.length;n++){const o=(n+1)%s.length,a=s[o].cross(s[n]);e+=a*(s[n].dot(s[n])+s[n].dot(s[o])+s[o].dot(s[o])),i+=a}return this._cachedMass=t,this._cachedInertia=t/6*(e/i)}rayCast(t,e=1/0){var i;const s=this.getSides(),n=s.length;let o=Number.MAX_VALUE,a,h=-1;for(let l=0;l<n;l++){const c=t.intersect(s[l]);c>=0&&c<o&&c<=e&&(o=c,a=s[l],h=l)}return h>=0?{collider:this,distance:o,body:(i=this.owner)===null||i===void 0?void 0:i.get(V),point:t.getPoint(o),normal:a.normal()}:null}project(t){const e=this.getTransformedPoints(),i=e.length;let s=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let o=0;o<i;o++){const a=e[o].dot(t);s=Math.min(s,a),n=Math.max(n,a)}return new Gi(s,n)}debug(t,e,i){const s=this.getTransformedPoints();bt.drawPolygon(s,{color:e})}}class Dt{static Box(t,e,i=p.Half,s=p.Zero){return new St({points:new B(-t*i.x,-e*i.y,t-t*i.x,e-e*i.y).getPoints(),offset:s})}static Polygon(t,e=p.Zero,i=!1){return new St({points:t,offset:e,suppressConvexWarning:i})}static Circle(t,e=p.Zero){return new Mt({radius:t,offset:e})}static Edge(t,e){return new Xt({begin:t,end:e})}static Capsule(t,e,i=p.Zero){const s=k.getInstance();return t===e&&s.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),e>=t?new yt([Dt.Circle(t/2,b(0,-e/2+t/2).add(i)),Dt.Box(t,e-t,p.Half,i),Dt.Circle(t/2,b(0,e/2-t/2).add(i))]):new yt([Dt.Circle(e/2,b(-t/2+e/2,0).add(i)),Dt.Box(t-e,e,p.Half,i),Dt.Circle(e/2,b(t/2-e/2,0).add(i))])}}class pt extends Qt{constructor(t){super(),this.events=new nt,this.$colliderAdded=new Lt,this.$colliderRemoved=new Lt,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new pt(this._collider.clone())}get bounds(){var t,e;return(e=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&e!==void 0?e:new B}get localBounds(){var t,e;return(e=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&e!==void 0?e:new B}update(){var t;const e=(t=this.owner)===null||t===void 0?void 0:t.get(D);this._collider&&(this._collider.owner=this.owner,e&&this._collider.update(e.get()))}collide(t){let e=this._collider,i=t._collider;if(!e||!i)return[];let s=!1;if(i instanceof yt&&(e=i,i=this._collider,s=!0),this._collider){const n=e.collide(i);return n?(s&&n.forEach(o=>{o.mtv=o.mtv.negate(),o.normal=o.normal.negate(),o.tangent=o.normal.perpendicular(),o.colliderA=this._collider,o.colliderB=t._collider}),n):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",e=>{const i=e;t.events.emit("precollision",new $e(i.self,i.other,i.side,i.intersection,i.contact)),t instanceof Ut&&t.onPreCollisionResolve(i.self,i.other,i.side,i.contact)}),this.events.on("postcollision",e=>{const i=e;t.events.emit("postcollision",new Qe(i.self,i.other,i.side,i.intersection,i.contact)),t instanceof Ut&&t.onPostCollisionResolve(i.self,i.other,i.side,i.contact)}),this.events.on("collisionstart",e=>{const i=e;t.events.emit("collisionstart",new Ai(i.self,i.other,i.side,i.contact)),t instanceof Ut&&t.onCollisionStart(i.self,i.other,i.side,i.contact)}),this.events.on("collisionend",e=>{const i=e;t.events.emit("collisionend",new Ti(i.self,i.other,i.side,i.lastContact)),t instanceof Ut&&t.onCollisionEnd(i.self,i.other,i.side,i.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,e,i=p.Half,s=p.Zero){const n=Dt.Box(t,e,i,s);return this.set(n)}usePolygonCollider(t,e=p.Zero){const i=Dt.Polygon(t,e);return this.set(i)}useCircleCollider(t,e=p.Zero){const i=Dt.Circle(t,e);return this.set(i)}useEdgeCollider(t,e){const i=Dt.Edge(t,e);return this.set(i)}useCompositeCollider(t){return this.set(new yt(t))}}var Ot;(function(r){r.Rotation="rotation",r.X="x",r.Y="y"})(Ot||(Ot={}));class V extends Qt{constructor(t){var e,i,s;super(),this.dependencies=[D,Z],this.id=Ye("body",V._ID++),this.events=new nt,this.oldTransform=new Pe,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=H.PreventCollision,this.group=Ae.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=p.Zero,this.oldVel=new p(0,0),this.oldAcc=p.Zero,this._impulseScratch=b(0,0),this._distanceFromCenterScratch=b(0,0),t?(this.collisionType=(e=t.type)!==null&&e!==void 0?e:this.collisionType,this.group=(i=t.group)!==null&&i!==void 0?i:this.group,this.useGravity=(s=t.useGravity)!==null&&s!==void 0?s:this.useGravity,this._bodyConfig={...Ce().bodies,...t.config}):this._bodyConfig={...Ce().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=V._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...Ce().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){V._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===H.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=p.Zero,this.acc=p.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),e=this._bodyConfig.sleepBias;this.sleepMotion=e*this.sleepMotion+(1-e)*t,this.sleepMotion=X(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(pt);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const e=t.get();if(e)return this._cachedInertia=e.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===H.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var e,i;this.transform=(e=this.owner)===null||e===void 0?void 0:e.get(D),this.motion=(i=this.owner)===null||i===void 0?void 0:i.get(Z)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,e){if(this.collisionType!==H.Active)return;const i=e.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(Ot.X)>-1&&(i.x=0),this.limitDegreeOfFreedom.indexOf(Ot.Y)>-1&&(i.y=0),this.vel.addEqual(i),!this.limitDegreeOfFreedom.includes(Ot.Rotation)){const s=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*s.cross(e)}}applyLinearImpulse(t){if(this.collisionType!==H.Active)return;const e=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(Ot.X)&&(e.x=0),this.limitDegreeOfFreedom.includes(Ot.Y)&&(e.y=0),this.vel=this.vel.add(e)}applyAngularImpulse(t,e){if(this.collisionType===H.Active&&!this.limitDegreeOfFreedom.includes(Ot.Rotation)){const i=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*i.cross(e)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}V._ID=0;V._DEFAULT_CONFIG={...Ce().bodies};class Xi extends gi{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new Xi({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Es extends gi{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var e,i,s;super(t),this._radius=0;const n=(e=t.lineWidth)!==null&&e!==void 0?e:t.strokeColor?1:0;this.padding=(i=t.padding)!==null&&i!==void 0?i:2+n/2,this.radius=t.radius,this.filtering=(s=t.filtering)!==null&&s!==void 0?s:gt.Blended,this.rasterize()}clone(){return new Es({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class De extends Qt{constructor(t){var e,i;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(e=t==null?void 0:t.useColliderShape)!==null&&e!==void 0?e:this.useColliderShape,this.useGraphicsBounds=(i=t==null?void 0:t.useGraphicsBounds)!==null&&i!==void 0?i:this.useGraphicsBounds,this.localBounds=t==null?void 0:t.localBounds}}class tt{static CreateReversibleEasingFunction(t){return(e,i,s,n)=>s<i?i-(t(e,s,i,n)-s):t(e,i,s,n)}static CreateVectorEasingFunction(t){return(e,i,s,n)=>new p(t(e,i.x,s.x,n),t(e,i.y,s.y,n))}}tt.Linear=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,e*r/i+t));tt.EaseInQuad=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i,e*r*r+t));tt.EaseOutQuad=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i,-e*r*(r-2)+t));tt.EaseInOutQuad=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i/2,r<1?e/2*r*r+t:(r--,-e/2*(r*(r-2)-1)+t)));tt.EaseInCubic=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i,e*r*r*r+t));tt.EaseOutCubic=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i,r--,e*(r*r*r+1)+t));tt.EaseInOutCubic=tt.CreateReversibleEasingFunction((r,t,e,i)=>(e=e-t,r/=i/2,r<1?e/2*r*r*r+t:(r-=2,e/2*(r*r*r+2)+t)));class go{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const e=this._actions.indexOf(t);this._actions.splice(e,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let e=0;e<t;e++)this._actions[e].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Zn(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new $n(this._currentAction,this._entity));const e=this._actions.shift();e&&this._completedActions.push(e)}}}let qh=0;function J(){return qh++}class mo{constructor(t,e,i){this.id=J(),this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new Yi(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=i,this._originalRepeat=i,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class vo{constructor(t,e){this.id=J(),this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new Yi(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function wo(r,t,e){return(1-e)*r+t*e}function rr(r,t,e,i){const s=(r-t+vt)%vt>=Math.PI,n=Math.abs(t-r),o=vt-n;let a=0,h=0;n>o?(a=o,h=n):(a=n,h=o);let l=0,c=1;switch(e){case at.ShortestPath:l=a,c=s?1:-1;break;case at.LongestPath:l=h,c=s?-1:1;break;case at.Clockwise:c=1,l=s?a:h;break;case at.CounterClockwise:c=-1,l=s?h:a;break}return r+c*(l*i)}function Vi(r,t,e){return r.scale(1-e).add(t.scale(e))}function xo(r,t,e){return(e-r)/(t-r)}function bo(r,t,e){const i=e.sub(r),s=t.sub(r),n=i.x/s.x,o=i.y/s.y;return Math.min(n,o)}function pe(r,t,e,i,s){const n=xo(r,t,s);return wo(e,i,n)}function Yh(r,t,e,i,s){const n=bo(r,t,s);return Vi(e,i,n)}function yo(r){return r.offset instanceof p&&typeof r.duration=="number"}class Co{constructor(t,e){var i;if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._easing=tt.Linear,this._offset=e.offset,this._easing=(i=e.easing)!==null&&i!==void 0?i:this._easing,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=this._tx.pos,s=this._easing(e,this._start.x,this._end.x,1),n=this._easing(e,this._start.y,this._end.y,1),o=(s-i.x)/(t/1e3),a=(n-i.y)/(t/1e3);this._motion.vel.x=o,this._motion.vel.y=a,this.isComplete(this.entity)&&(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=b(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class sn{constructor(t,e,i,s){if(this.id=J(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(D),this._motion=t.get(Z),this._speed=s,this._offset=new p(e,i),s<=0)throw k.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+s),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new p(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const e=t.get(D);return this._stopped||e.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=b(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Po(r){return r.pos instanceof p&&typeof r.duration=="number"}class Ao{constructor(t,e){var i;if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._easing=tt.Linear,this._end=e.pos,this._easing=(i=e.easing)!==null&&i!==void 0?i:this._easing,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=this._tx.pos,s=this._easing(e,this._start.x,this._end.x,1),n=this._easing(e,this._start.y,this._end.y,1),o=(s-i.x)/(t/1e3),a=(n-i.y)/(t/1e3);this._motion.vel.x=o,this._motion.vel.y=a,this.isComplete(this.entity)&&(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=b(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class nn{constructor(t,e,i,s){this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._end=new p(e,i),this._speed=s}update(t){this._started||(this._started=!0,this._start=new p(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const e=this._dir.scale(this._speed);this._motion.vel=b(e.x,e.y),this.isComplete(this.entity)&&(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0))}isComplete(t){const e=t.get(D);return this._stopped||new p(e.pos.x,e.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=b(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function jh(r){return typeof r.angle=="number"&&typeof r.duration=="number"}class To{constructor(t,e){var i;if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=e.angle,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._rotationType=(i=e.rotationType)!==null&&i!==void 0?i:at.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=rr(this._startAngle,this._endAngle,this._rotationType,e),s=this._tx.rotation,n=(i-s)/(t/1e3);this._motion.angularVelocity=n,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class So{constructor(t,e,i,s){this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._end=e,this._speed=i,this._rotationType=s||at.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const e=Math.abs(this._end-this._start),i=vt-e;switch(e>i?(this._shortDistance=i,this._longDistance=e):(this._shortDistance=e,this._longDistance=i),this._shortestPathIsPositive=(this._start-this._end+vt)%vt>=Math.PI,this._rotationType){case at.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case at.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case at.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case at.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Zh(r){return typeof r.angleRadiansOffset=="number"&&typeof r.duration=="number"}class Eo{constructor(t,e){var i;if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=e.angleRadiansOffset,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._rotationType=(i=e.rotationType)!==null&&i!==void 0?i:at.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=be(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=rr(this._startAngle,this._endAngle,this._rotationType,e),s=this._tx.rotation,n=(i-s)/(t/1e3);this._motion.angularVelocity=n,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Io{constructor(t,e,i,s){this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._speed=i,this._offset=e,this._rotationType=s||at.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const e=Math.abs(this._end-this._start),i=vt-e;switch(e>i?(this._shortDistance=i,this._longDistance=e):(this._shortDistance=e,this._longDistance=i),this._shortestPathIsPositive=(this._start-this._end+vt)%vt>=Math.PI,this._rotationType){case at.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case at.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case at.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case at.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function Ro(r){return typeof r.scale=="object"&&typeof r.duration=="number"}class Mo{constructor(t,e){if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._endScale=b(1,1),this._startScale=b(1,1),this._endScale=e.scale,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=Vi(this._startScale,this._endScale,e),s=this._tx.scale,n=i.sub(s).scale(1/(t/1e3));this._motion.scaleFactor=n,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=p.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Do{constructor(t,e,i,s,n){this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._endX=e,this._endY=i,this._speedX=s,this._speedY=n}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const e=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*e}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const e=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*e}this.isComplete()&&(this._tx.scale=b(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Fo(r){return typeof r.scaleOffset=="object"&&typeof r.duration=="number"}class Bo{constructor(t,e){if(this.entity=t,this.id=J(),this._started=!1,this._stopped=!1,this._endScale=b(1,1),this._scaleOffset=b(0,0),this._startScale=b(1,1),this._scaleOffset=e.scaleOffset,this._tx=t.get(D),this._motion=t.get(Z),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),i=Vi(this._startScale,this._endScale,e),s=this._tx.scale,n=i.sub(s).scale(1/(t/1e3));this._motion.scaleFactor=n,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=p.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ko{constructor(t,e,i,s){this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._offset=new p(e,i),this._speedX=this._speedY=s}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Nr{constructor(t){this.id=J(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class Lo{constructor(t,e,i,s,n){this.easingFcn=n,this.id=J(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new p(0,0),this._lerpEnd=new p(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._lerpDuration=s,this._lerpEnd=new p(e,i)}_initialize(){this._lerpStart=new p(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?e=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):e=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?i=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):i=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=b((e-this._tx.pos.x)/(t/1e3),(i-this._tx.pos.y)/(t/1e3))):(this._tx.pos=b(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=p.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=b(0,0),this._stopped=!0}}class zo{constructor(t,e,i,s,n){this.easingFcn=n,this.id=J(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new p(0,0),this._lerpEnd=new p(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._lerpDuration=s,this._offset=new p(e,i)}_initialize(){this._lerpStart=new p(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?e=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):e=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?i=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):i=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=b((e-this._tx.pos.x)/(t/1e3),(i-this._tx.pos.y)/(t/1e3))):(this._tx.pos=b(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=p.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=b(0,0),this._stopped=!0}}class Uo{constructor(t,e,i,s=1){this.id=J(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(lt),this._timeVisible=e,this._timeNotVisible=i,this._duration=(e+i)*s}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class Ho{constructor(t,e,i){this.id=J(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(lt),this._endOpacity=e,this._remainingTime=this._originalTime=i}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),k.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class Wo{constructor(t){this.id=J(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class Oo{constructor(t){this.id=J(),this._stopped=!1,this._entity=t}update(t){this._entity.get(si).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class rn{constructor(t,e,i){this.id=J(),this._started=!1,this._stopped=!1,this._tx=t.get(D),this._motion=t.get(Z),this._followTx=e.get(D),this._followMotion=e.get(Z),this._current=new p(this._tx.pos.x,this._tx.pos.y),this._end=new p(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=i!==void 0?i:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const e=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(e!==0&&(this._speed=e),this._current=b(this._tx.pos.x,this._tx.pos.y),this._end=b(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const i=this._dir.scale(this._speed);this._motion.vel=b(i.x,i.y)}else this._motion.vel=b(0,0);this.isComplete()&&(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0))}stop(){this._motion.vel=b(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class on{constructor(t,e,i){this.id=J(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(D),this._motion=t.get(Z),this._meetTx=e.get(D),this._meetMotion=e.get(Z),this._current=new p(this._tx.pos.x,this._tx.pos.y),this._end=new p(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=i||0,i!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const e=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));e!==0&&!this._speedWasSpecified&&(this._speed=e),this._current=b(this._tx.pos.x,this._tx.pos.y),this._end=b(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const i=this._dir.scale(this._speed);this._motion.vel=b(i.x,i.y),this.isComplete()&&(this._tx.pos=b(this._end.x,this._end.y),this._motion.vel=b(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=b(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class No{constructor(t,e,i=1e3){var s;this.id=J(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(lt),this._duration=i,this._entity=t,this._material=(s=t.scene)===null||s===void 0?void 0:s.engine.graphicsContext.createMaterial({name:"flash-material",color:e,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=i}update(t){var e;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((e=this._material)===null||e===void 0||e.update(i=>{i.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class qi{constructor(t){var e;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(e=t.quality)!==null&&e!==void 0?e:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,e){this._controlPoints[t]=e,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let e=this.controlPoints[0];const i=this.controlPoints.length*this.quality;for(let s=0;s<i;s++){const n=s/(i-1),o=this.getPoint(n),a=e.distance(o);t+=a,this._distLookup.push(t),e=o}this._arcLength=t}_getTimeGivenDistance(t){const e=this._distLookup.length,i=this.arcLength;if(t>=0&&t<i){for(let s=0;s<e-1;s++)if(this._distLookup[s]<=t&&t<this._distLookup[s+1])return pe(this._distLookup[s],this._distLookup[s+1],s/(e-1),(s+1)/(e-1),t)}return t/i}getPoint(t){const e=[...this.controlPoints];for(let i=1;i<e.length;i++)for(let s=0;s<e.length-i;s++)e[s]=Vi(e[s],e[s+1],t);return e[0]}getTangent(t){const e=t*t,i=this.controlPoints[0],s=this.controlPoints[1],n=this.controlPoints[2],o=this.controlPoints[3];return i.scale(-3*e+6*t-3).add(s.scale(9*e-12*t+3).add(n.scale(-9*e+6*t).add(o.scale(3*e)))).normalize()}getUniformTangent(t){const e=t*this.arcLength,i=this._getTimeGivenDistance(e);return this.getTangent(i)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const e=t*this.arcLength,i=this._getTimeGivenDistance(e);return this.getPoint(i)}clone(){return new qi({controlPoints:[...this.controlPoints],quality:this.quality})}}class Go{constructor(t,e){var i;if(this.id=J(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(D),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new qi({controlPoints:[b(0,0),...e.controlPoints],quality:e.quality}),this._durationMs=e.duration,this._mode=(i=e.mode)!==null&&i!==void 0?i:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(e):this._tx.pos=this._curve.getUniformPoint(e),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class Xo{constructor(t,e){var i;if(this.id=J(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(D),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new qi({controlPoints:[b(0,0),...e.controlPoints],quality:e.quality}),this._durationMs=e.duration,this._mode=(i=e.mode)!==null&&i!==void 0?i:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const e=X(pe(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(e):this._tx.pos=this._curve.getUniformPoint(e),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Yi{constructor(t){this._entity=t,this._queue=new go(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new Xo(this._entity,t)),this}curveTo(t){return this._queue.add(new Go(this._entity,t)),this}easeTo(...t){var e,i;let s=0,n=0,o=0,a=tt.Linear;return t[0]instanceof p?(s=t[0].x,n=t[0].y,o=t[1],a=(e=t[2])!==null&&e!==void 0?e:a):(s=t[0],n=t[1],o=t[2],a=(i=t[3])!==null&&i!==void 0?i:a),this._queue.add(new Lo(this._entity,s,n,o,a)),this}easeBy(...t){var e,i;let s=0,n=0,o=0,a=tt.Linear;return t[0]instanceof p?(s=t[0].x,n=t[0].y,o=t[1],a=(e=t[2])!==null&&e!==void 0?e:a):(s=t[0],n=t[1],o=t[2],a=(i=t[3])!==null&&i!==void 0?i:a),this._queue.add(new zo(this._entity,s,n,o,a)),this}moveTo(t,e,i){let s=0,n=0,o=0;return t instanceof p?(s=t.x,n=t.y,o=+(e??0),this._queue.add(new nn(this._entity,s,n,o))):typeof t=="number"&&typeof e=="number"&&typeof i=="number"?(s=t,n=e,o=i,this._queue.add(new nn(this._entity,s,n,o))):Po(t)&&this._queue.add(new Ao(this._entity,t)),this}moveBy(t,e,i){let s=0,n=0,o=0;return t instanceof p&&typeof e=="number"?(s=t.x,n=t.y,o=e,this._queue.add(new sn(this._entity,s,n,o))):typeof t=="number"&&typeof e=="number"&&typeof i=="number"?(s=t,n=e,o=i,this._queue.add(new sn(this._entity,s,n,o))):yo(t)&&this._queue.add(new Co(this._entity,t)),this}rotateTo(t,e,i){return typeof t=="number"&&typeof e=="number"?this._queue.add(new So(this._entity,t,e,i)):typeof t=="object"&&this._queue.add(new To(this._entity,t)),this}rotateBy(t,e,i){return typeof t=="object"?this._queue.add(new Eo(this._entity,t)):this._queue.add(new Io(this._entity,t,e,i)),this}scaleTo(t,e,i,s){let n=1,o=1,a=0,h=0;return Ro(t)?(this._queue.add(new Mo(this._entity,t)),this):(t instanceof p&&e instanceof p&&(n=t.x,o=t.y,a=e.x,h=e.y),typeof t=="number"&&typeof e=="number"&&(n=t,o=e,a=i,h=s),this._queue.add(new Do(this._entity,n,o,a,h)),this)}scaleBy(t,e,i){if(Fo(t))return this._queue.add(new Bo(this._entity,t)),this;let s=1,n=1;return t instanceof p&&(s=t.x,n=t.y,i=e),typeof t=="number"&&typeof e=="number"&&(s=t,n=e),this._queue.add(new ko(this._entity,s,n,i)),this}blink(t,e,i=1){return this._queue.add(new Uo(this._entity,t,e,i)),this}fade(t,e){return this._queue.add(new Ho(this._entity,t,e)),this}flash(t,e=1e3){return this._queue.add(new No(this._entity,t,e)),this}delay(t){return this._queue.add(new Wo(t)),this}die(){return this._queue.add(new Oo(this._entity)),this}callMethod(t){return this._queue.add(new Nr(t)),this}repeat(t,e){return e?(this._queue.add(new mo(this._entity,t,e)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new vo(this._entity,t)),this}follow(t,e){return e===void 0?this._queue.add(new rn(this._entity,t)):this._queue.add(new rn(this._entity,t,e)),this}meet(t,e){return e===void 0?this._queue.add(new on(this._entity,t)):this._queue.add(new on(this._entity,t,e)),this}toPromise(){return new Promise(e=>{this._queue.add(new Nr(()=>{e()}))})}}class si extends Qt{constructor(){super(...arguments),this.dependencies=[D,Z],this._ctx=null}onAdd(t){this._ctx=new Yi(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var e;return(e=this._ctx)===null||e===void 0?void 0:e.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,e,i){return this._getCtx().moveTo.apply(this._ctx,[t,e,i])}moveBy(t,e,i){return this._getCtx().moveBy.apply(this._ctx,[t,e,i])}rotateTo(t,e,i){return this._getCtx().rotateTo.apply(this._ctx,[t,e,i])}rotateBy(t,e,i){return this._getCtx().rotateBy.apply(this._ctx,[t,e,i])}scaleTo(t,e,i,s){return this._getCtx().scaleTo.apply(this._ctx,[t,e,i,s])}scaleBy(t,e,i){return this._getCtx().scaleBy.apply(this._ctx,[t,e,i])}blink(t,e,i){return this._getCtx().blink(t,e,i)}fade(t,e){return this._getCtx().fade(t,e)}flash(t,e=1e3){return this._getCtx().flash(t,e)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,e){return this._getCtx().repeat(t,e)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,e){return this._getCtx().follow(t,e)}meet(t,e){return this._getCtx().meet(t,e)}toPromise(){return this._getCtx().toPromise()}}function $h(r){return r instanceof Ut}const Qh={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Ut extends Bt{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(D).scale}set scale(t){this.get(D).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=ee(t,e=>this._handleAnchorChange(e)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=ee(t,e=>this._handleOffsetChange(e)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new nt,this._anchor=ee(p.Half,W=>this._handleAnchorChange(W)),this._offset=ee(p.Zero,W=>this._handleOffsetChange(W)),this.logger=k.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=W=>{this._dragging&&(this.pos=W.worldPos)},this._pointerDragLeaveHandler=W=>{this._dragging&&(this.pos=W.worldPos)};const{name:e,x:i,y:s,pos:n,coordPlane:o,scale:a,width:h,height:l,radius:c,collider:d,vel:f,acc:_,rotation:g,angularVelocity:v,z:C,color:m,visible:w,opacity:T,anchor:P,offset:S,collisionType:F,collisionGroup:A,silenceWarnings:L}={...t};this.name=e??this.name,this.anchor=P??Ut.defaults.anchor.clone(),this.offset=S??p.Zero,this.transform=new D,this.addComponent(this.transform),this.pos=n??b(i??0,s??0),this.rotation=g??0,this.scale=a??b(1,1),this.z=C??0,this.transform.coordPlane=o??Et.World,this._silenceWarnings=L??!1,this.pointer=new De,this.addComponent(this.pointer),this.graphics=new lt({anchor:this.anchor,offset:this.offset,opacity:T}),this.addComponent(this.graphics),this.motion=new Z,this.addComponent(this.motion),this.vel=f??p.Zero,this.acc=_??p.Zero,this.angularVelocity=v??0,this.actions=new si,this.addComponent(this.actions),this.body=new V,this.addComponent(this.body),this.body.collisionType=F??H.Passive,A&&(this.body.group=A),m&&(this.color=m),d?(this.collider=new pt(d),this.addComponent(this.collider)):c?(this.collider=new pt(Dt.Circle(c)),this.addComponent(this.collider),m&&this.graphics.add(new Es({color:m,radius:c}))):h>0&&l>0?(this.collider=new pt(Dt.Box(h,l,this.anchor)),this.addComponent(this.collider),m&&h&&l&&this.graphics.add(new Xi({color:m,width:h,height:l}))):(this.collider=new pt,this.addComponent(this.collider)),this.graphics.isVisible=w??!0}clone(){const t=new Ut({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const e=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],i=this.getComponents();for(const s of i)e.includes(s)||t.addComponent(s.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const e of this.children)e._initialize(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}_prekill(t){this.events.emit("prekill",new Sn(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new En(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Ps(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(D).z}set z(t){this.get(D).z=t}get center(){const t=this.getGlobalPos();return new p(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new p(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(D).globalRotation}get globalRotation(){return this.get(D).globalRotation}getGlobalPos(){return this.get(D).globalPos}get globalPos(){return this.get(D).globalPos}getGlobalScale(){return this.get(D).globalScale}get globalScale(){return this.get(D).globalScale}get globalZ(){return this.get(D).globalZ}contains(t,e,i=!1){const s=b(t,e),n=this.get(pt);n.update();const o=n.get();if(!o)return!1;const a=o.contains(s);return i?a||this.children.some(h=>h.contains(t,e,!0)):a}within(t,e){const i=this.get(pt),s=t.get(pt),n=i.get(),o=s.get();return n&&o?n.getClosestLineBetween(o).getLength()<=e:!1}update(t,e){this._initialize(t),this._add(t),this._preupdate(t,e),this._postupdate(t,e),this._remove(t)}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreCollisionResolve(t,e,i,s){}onPostCollisionResolve(t,e,i,s){}onCollisionStart(t,e,i,s){}onCollisionEnd(t,e,i,s){}_preupdate(t,e){this.events.emit("preupdate",new Be(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new ke(t,e,this)),this.onPostUpdate(t,e)}}Ut.defaults={anchor:p.Half};function Vo(r){return r instanceof or}class or extends Ut{constructor(t){var e,i;super({...t}),this.get(D).coordPlane=Et.Screen,this.anchor=(e=t==null?void 0:t.anchor)!==null&&e!==void 0?e:b(0,0),this.body.collisionType=(i=t==null?void 0:t.collisionType)!==null&&i!==void 0?i:H.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(t!=null&&t.collider)&&(t==null?void 0:t.width)>0&&(t==null?void 0:t.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,e,i=!0){if(i)return super.contains(t,e);const s=this._engine.worldToScreenCoordinates(new p(t,e));return super.contains(s.x,s.y)}}class Ve{get complete(){return this._complete}constructor(t){var e;this._logger=k.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const i=(e=t.action)!==null&&e!==void 0?e:t.fcn,s=t.interval,n=t.repeats,o=t.numberOfRepeats,a=t.randomRange,h=t.random;if(o&&o>=0&&(this.maxNumberOfRepeats=o,!n))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Ve._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=s,a){if(a[0]>a[1])throw new Error("min value must be lower than max value for range");this.random=h??new fi,this.randomRange=a,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=n||this.repeats,i&&this.on(i)}on(t){this._callbacks.push(t)}off(t){const e=this._callbacks.indexOf(t);this._callbacks.splice(e,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(e=>{e.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,e){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=e,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Ve._MAX_ID=0;class Is extends Qt{constructor(t){super(),this.parallaxFactor=b(1,1),this.parallaxFactor=t??this.parallaxFactor}}class Rs extends Qt{constructor(t,e=!0){super(),this.draw=t,this.useTransform=e}}function Gr(r){return r&&r._dispatchPointerEvents&&r._processPointerToObject}class Kh{get events(){return this.object.events}init(t,e,i){this.object=t,this.contains=e,this.active=i}}class ar{constructor(){this._proxyPool=new Ui(()=>new Kh,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,e,i){const s=this._proxyPool.rent(!1);s.init(t,e,i),this._proxies.push(s),this._objectToProxy.set(t,s)}_getProxy(t){const e=this._objectToProxy.get(t);if(e)return e;throw new Error("No PointerTargetProxy for object")}removeObject(t){const e=this._objectToProxy.get(t);if(e){const i=this._proxies.indexOf(e);i>-1&&this._proxies.splice(i,1),this._proxyPool.return(e)}}_objectCurrentlyUnderPointer(t,e){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(e))}_objectWasUnderPointer(t,e){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(e))}_entered(t,e){return this._objectCurrentlyUnderPointer(t,e)&&!this._lastFrameObjectToPointers.has(t)}_left(t,e){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,e)}addPointerToObject(t,e){const i=this._objectToProxy.get(t);i&&this._addPointerToProxy(i,e)}_addPointerToProxy(t,e){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[e]);return}const i=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,i.concat(e))}dispatchEvents(t,e){const i=new Set(this._lastFrameObjectToPointers.keys()),s=new Set(this._currentFrameObjectToPointers.keys());let n,o,a;for(let h=0;h<e.length;h++){const l=e[h],c=this._getProxy(l);if(Gr(l)&&l._dispatchPointerEvents(t),i.has(c)||s.has(c)){a=this._processDownAndEmit(t,c),o=this._processUpAndEmit(t,c),n=this._processMoveAndEmit(t,c);const d=[...n.values(),...a.values(),...o.values()];this._processEnterLeaveAndEmit(t,c,d),this._processCancelAndEmit(t,c),this._processWheelAndEmit(t,c)}}}processPointerToObject(t,e){for(let i=0;i<e.length;i++){const s=e[i],n=this._getProxy(s);Gr(s)&&s._processPointerToObject(t);for(const[o,a]of t.currentFramePointerCoords.entries())n.contains(a)&&this._addPointerToProxy(n,o)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,e){const i=new Map;for(const s of t.currentFrameDown)s.active&&this._objectCurrentlyUnderPointer(e,s.pointerId)&&(e.events.emit("pointerdown",s),t.isDragStart(s.pointerId)&&e.events.emit("pointerdragstart",s)),i.set(s.pointerId,s);return i}_processUpAndEmit(t,e){const i=new Map;for(const s of t.currentFrameUp)s.active&&this._objectCurrentlyUnderPointer(e,s.pointerId)&&(e.events.emit("pointerup",s),t.isDragEnd(s.pointerId)&&e.events.emit("pointerdragend",s)),i.set(s.pointerId,s);return i}_processMoveAndEmit(t,e){const i=new Map;for(const s of t.currentFrameMove)s.active&&e.active()&&this._objectCurrentlyUnderPointer(e,s.pointerId)&&(e.events.emit("pointermove",s),t.isDragging(s.pointerId)&&e.events.emit("pointerdragmove",s)),i.set(s.pointerId,s);return i}_processEnterLeaveAndEmit(t,e,i){for(const s of i){if(s.active&&e.active()&&this._entered(e,s.pointerId)){e.events.emit("pointerenter",s),t.isDragging(s.pointerId)&&e.events.emit("pointerdragenter",s);break}if(s.active&&e.active()&&(this._left(e,s.pointerId)||this._objectCurrentlyUnderPointer(e,s.pointerId)&&s.type==="up")){e.events.emit("pointerleave",s),t.isDragging(s.pointerId)&&e.events.emit("pointerdragleave",s);break}}}_processCancelAndEmit(t,e){for(const i of t.currentFrameCancel)i.active&&e.active()&&this._objectCurrentlyUnderPointer(e,i.pointerId)&&e.events.emit("pointercancel",i)}_processWheelAndEmit(t,e){for(const i of t.currentFrameWheel)i.active&&e.active()&&this._objectCurrentlyUnderPointer(e,0)&&e.events.emit("pointerwheel",i)}}const Jh={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class qo extends Bt{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var e;!((e=this.transform)===null||e===void 0)&&e.pos&&(this.get(D).pos=b(t,this.y))}get y(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&e!==void 0?e:0}set y(t){var e;!((e=this.transform)===null||e===void 0)&&e.pos&&(this.transform.pos=b(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&e!==void 0?e:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&e!==void 0?e:p.One}set scale(t){var e;!((e=this.transform)===null||e===void 0)&&e.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,i,s;super([],t.name),this.events=new nt,this._token=0,this.logger=k.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(e=t.meshingLookBehind)!==null&&e!==void 0?e:this.meshingLookBehind,this.addComponent(new D),this.addComponent(new Z),this.addComponent(new V({type:H.Fixed})),this.addComponent(new lt({onPostDraw:(o,a)=>this.draw(o,a)})),this.addComponent(new Rs((o,a)=>this.debug(o,a),!1)),this.addComponent(new pt),this.addComponent(new De),this.pointer=this.get(De),this._graphics=this.get(lt),this.transform=this.get(D),this._motion=this.get(Z),this.collider=this.get(pt),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(i=t.pos)!==null&&i!==void 0?i:p.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(s=t.renderFromTopOfGraphic)!==null&&s!==void 0?s:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new ar,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let n=[];for(let o=0;o<this.columns;o++){for(let a=0;a<this.rows;a++){const h=new Yo({x:o,y:a,map:this});h.map=this,this.tiles[o+a*this.columns]=h,this._pointerEventDispatcher.addObject(h,l=>h.bounds.contains(l.worldPos),()=>!0),n.push(h),this._rows[a]||(this._rows[a]=[]),this._rows[a].push(h)}this._cols[o]=n,n=[]}this._graphics.localBounds=new B({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var e;if(this._originalOffsets.has(t))return(e=this._originalOffsets.get(t))!==null&&e!==void 0?e:p.Zero;{const i=t.offset;return this._originalOffsets.set(t,i),i}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let e=null;const i=(n,o)=>n&&o?n.top===o.top&&n.bottom===o.bottom&&n.right===o.left:!1,s=(n,o,a=this.meshingLookBehind)=>{if(!n)return!1;for(let h=o.length-1;h>=0;h--){if(a--<0)return!1;const l=o[h];if(i(l,n))return o[h]=l.combine(n),!0}return!1};for(let n=0;n<this.columns;n++){for(let o=0;o<this.rows;o++){const a=this.tiles[n+o*this.columns];if(a.solid)if(a.getColliders().length>0){for(const h of a.getColliders()){const l=this._getOrSetColliderOriginalOffset(h);h.offset=b(a.x*this.tileWidth*this.scale.x,a.y*this.tileHeight*this.scale.y).add(l),h.owner=this,this._composite.addCollider(h)}e&&!s(e,t)&&t.push(e),e=null}else e?e=e.combine(a.defaultGeometry):e=a.defaultGeometry;else e&&!s(e,t)&&t.push(e),e=null}e&&!s(e,t)&&t.push(e),e=null}for(const n of t){const o=Dt.Box(n.width,n.height,p.Zero,b(n.left-this.pos.x,n.top-this.pos.y));o.owner=this,this._composite.addCollider(o)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var e;return(e=this.tiles[t])!==null&&e!==void 0?e:null}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){const{x:e,y:i}=this._getTileCoordinates(t),s=this.getTile(e,i);return e>=0&&i>=0&&e<this.columns&&i<this.rows&&s?s:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const e=Math.floor(t.x/this.tileWidth),i=Math.floor(t.y/this.tileHeight);return{x:e,y:i}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const e=this.get(Is);if(e&&this.isInitialized){let _=this.pos;const g=p.One.sub(e.parallaxFactor),v=this._engine.currentScene.camera.pos.scale(g);_=_.sub(v),t=t.translate(_)}const i=this.transform.coordPlane===Et.Screen?this._engine.screen.getScreenBounds():t,s=this._getTileCoordinates(i.topLeft),n=this._getTileCoordinates(i.topRight),o=this._getTileCoordinates(i.bottomRight),a=this._getTileCoordinates(i.bottomLeft),h=Math.min(X(s.x,0,this.columns-1),X(n.x,0,this.columns-1)),l=Math.min(X(s.y,0,this.rows-1),X(n.y,0,this.rows-1)),c=Math.max(X(o.x,0,this.columns-1),X(a.x,0,this.columns-1)),d=Math.max(X(o.y,0,this.rows-1),X(a.y,0,this.rows-1)),f=[];for(let _=h;_<=c;_++)for(let g=l;g<=d;g++)f.push(this.getTile(_,g));return f}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,e){this._initialize(t),this.onPreUpdate(t,e),this.emit("preupdate",new Be(t,e,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,e),this.emit("postupdate",new ke(t,e,this))}draw(t,e){if(!this.isInitialized)return;this.emit("predraw",new mi(t,e,this));let i,s,n;const o=this.getOnScreenTiles();for(let a=0;a<o.length;a++){const h=o[a],l=h.getGraphicsOffsets();for(i=h.getGraphics(),s=0,n=i.length;s<n;s++){const c=i[s],d=l[s];if(c){Tn(c)&&(c==null||c.tick(e,this._token));const f=this.renderFromTopOfGraphic?0:c.height-this.tileHeight;c.draw(t,h.x*this.tileWidth+d.x,h.y*this.tileHeight-f+d.y)}}}this.emit("postdraw",new vi(t,e,this))}debug(t,e){const{showAll:i,showGrid:s,gridColor:n,gridWidth:o,showSolidBounds:a,solidBoundsColor:h,showColliderGeometry:l}=e.tilemap,{geometryColor:c,geometryLineWidth:d,geometryPointSize:f}=e.collider,_=this.tileWidth*this.columns*this.scale.x,g=this.tileHeight*this.rows*this.scale.y,v=this.pos;if(s||i){for(let C=0;C<this.rows+1;C++){const m=b(0,C*this.tileHeight*this.scale.y);t.drawLine(v.add(m),v.add(b(_,m.y)),n,o)}for(let C=0;C<this.columns+1;C++){const m=b(C*this.tileWidth*this.scale.x,0);t.drawLine(v.add(m),v.add(b(m.x,g)),n,o)}}if(i||a||l){const C=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const m of C){const w=m.localBounds,T=m.worldPos.sub(this.pos);a&&t.drawRectangle(T,w.width,w.height,h)}if(t.restore(),l)for(const m of C)m.debug(t,c,{lineWidth:d,pointSize:f})}if(i||a){if(t.save(),t.z=999,a)for(let C=0;C<this.tiles.length;C++)this.tiles[C].bounds.draw(t);t.restore()}}}class Yo{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var e;(e=this.map)===null||e===void 0||e.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,e){this._graphics.push(t),e!=null&&e.offset?this._offsets.push(e.offset):this._offsets.push(p.Zero)}removeGraphic(t){const e=this._graphics.indexOf(t);e>-1&&(this._graphics.splice(e,1),this._offsets.splice(e,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var e,i;this._posDirty=!1,this.events=new nt,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(e=t.solid)!==null&&e!==void 0?e:this.solid,this._graphics=(i=t.graphics)!==null&&i!==void 0?i:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(b(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new B(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(b(this.x*this._width,this.y*this._height)),this._bounds=new B(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new p(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){e?this.events.off(t,e):this.events.off(t)}}class jo{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new Zo(t))}lockToActorAxis(t,e){this.camera.addStrategy(new $o(t,e))}elasticToActor(t,e,i){this.camera.addStrategy(new Qo(t,e,i))}radiusAroundActor(t,e){this.camera.addStrategy(new Ko(t,e))}limitCameraBounds(t){this.camera.addStrategy(new Jo(t))}}var vs;(function(r){r[r.X=0]="X",r[r.Y=1]="Y"})(vs||(vs={}));class Zo{constructor(t){this.target=t,this.action=(e,i,s,n)=>e.center}}class $o{constructor(t,e){this.target=t,this.axis=e,this.action=(i,s,n,o)=>{const a=i.center,h=s.getFocus();return this.axis===vs.X?new p(a.x,h.y):new p(h.x,a.y)}}}class Qo{constructor(t,e,i){this.target=t,this.cameraElasticity=e,this.cameraFriction=i,this.action=(s,n,o,a)=>{const h=s.center;let l=n.getFocus(),c=n.vel.clone();const d=h.sub(l).scale(this.cameraElasticity);c=c.add(d);const f=c.scale(-1).scale(this.cameraFriction);return c=c.add(f),l=l.add(c),l}}}class Ko{constructor(t,e){this.target=t,this.radius=e,this.action=(i,s,n,o)=>{const a=i.center,h=s.getFocus(),l=a.sub(h),c=l.magnitude;if(c>=this.radius){const d=c-this.radius;return h.add(l.normalize().scale(d))}return h}}}class Jo{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(e,i,s,n)=>{const o=i.getFocus();this.boundSizeChecked||((e.bottom-e.top<s.drawHeight||e.right-e.left<s.drawWidth)&&k.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let a=o.x,h=o.y;return o.x<e.left+s.halfDrawWidth?a=e.left+s.halfDrawWidth:o.x>e.right-s.halfDrawWidth&&(a=e.right-s.halfDrawWidth),o.y<e.top+s.halfDrawHeight?h=e.top+s.halfDrawHeight:o.y>e.bottom-s.halfDrawHeight&&(h=e.bottom-s.halfDrawHeight),b(a,h)}}}const tl={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class ta{constructor(){this.events=new nt,this.transform=_t.identity(),this.inverse=_t.identity(),this._cameraStrategies=[],this.strategy=new jo(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Ie(p.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=p.Zero,this.acc=p.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=tt.EaseInOutCubic,this._easing=tt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=b(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Ie(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=b(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=b(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=b(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=b(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=b(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=b(this.acc.x,t)}getFocus(){return this.pos}move(t,e,i=tt.EaseInOutCubic){if(typeof i!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(s=>{this._lerpResolve=s}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=e,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=i,this._lerpPromise)}shake(t,e,i){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=e,this._shakeDuration=i}zoomOverTime(t,e=0,i=tt.EaseInOutCubic){if(this._zoomPromise=new Promise(s=>{this._zoomResolve=s}),e)this._isZooming=!0,this._zoomEasing=i,this._currentZoomTime=0,this._zoomDuration=e,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new B(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){_i(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,e){this.events.emit("preupdate",new Be(t,e,this)),this.onPreUpdate(t,e)}onPreUpdate(t,e){}_postupdate(t,e){this.events.emit("postupdate",new ke(t,e,this)),this.onPostUpdate(t,e)}onPostUpdate(t,e){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const e=this._screen.contentArea;let i=b(e.width/2,e.height/2);if(!this._engine.loadingComplete){const s=this._screen.peekResolution();s&&(i=b(s.width/2,s.height/2))}this._halfWidth=i.x,this._halfHeight=i.y,this._posChanged||(this.pos=i),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new wi(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}runStrategies(t,e){for(const i of this._cameraStrategies)this.pos=i.action.call(i,i.target,this,t,e)}updateViewport(){this._viewport=new B(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,e){if(this._initialize(t),this._preupdate(t,e),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(e/1e3)),this.zoom+=this.dz*e/1e3,this.vel=this.vel.add(this.acc.scale(e/1e3)),this.dz+=this.az*e/1e3,this.rotation+=this.angularVelocity*e/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const i=this._zoomEasing,s=i(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=s,this._currentZoomTime+=e}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const s=tt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=s,this._currentLerpTime+=e}else{this.pos=this._lerpEnd;const i=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(i)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=e,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,e),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,e),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const e=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,i=this.pos.scale(e).add(this._oldPos.scale(1-e));i.clone(this.drawPos),this.updateTransform(i)}if(t.snapToPixel){const e=this.drawPos.clone(this._snapPos);e.x=~~(e.x+O*et(e.x)),e.y=~~(e.y+O*et(e.y)),e.clone(this.drawPos),this.updateTransform(e)}t.multiply(this.transform)}updateTransform(t){const e=this._screen.resolution.width/this.zoom,i=this._screen.resolution.height/this.zoom,s=b(-t.x+e/2+this._xShake,-t.y+i/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(e/2,i/2),this.transform.rotate(this.rotation),this.transform.translate(-e/2,-i/2),this.transform.translate(s.x,s.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const el={ExitTrigger:"exit",EnterTrigger:"enter"};class ea extends Ut{constructor(t){var e,i,s,n;super({...t}),this.events=new nt,this.filter=(e=t.filter)!==null&&e!==void 0?e:()=>!0,this.repeat=(i=t.repeat)!==null&&i!==void 0?i:-1,this.action=(s=t.action)!==null&&s!==void 0?s:()=>{},this.target=t.target,this.graphics.isVisible=(n=t.visible)!==null&&n!==void 0?n:!1,this.body.collisionType=H.Passive,this.events.on("collisionstart",({other:o})=>{this._matchesTarget(o.owner)&&(this.events.emit("enter",new Yn(this,o.owner)),this._dispatchAction(o.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:o})=>{this._matchesTarget(o.owner)&&this.events.emit("exit",new jn(this,o.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const ge={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var qt;(function(r){r.Update="update",r.Draw="draw"})(qt||(qt={}));class $t{}$t.priority=ge.Average;class ia{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>e=>{this.addEntity(e)},this._createChildRemovedHandler=()=>e=>{this.removeEntity(e,!1)},this._entitiesToRemove=[]}updateEntities(t,e){for(let i=0;i<this.entities.length;i++){const s=this.entities[i];s.update(t.engine,e),s.isActive||this.removeEntity(s)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const e=this.entities[t];e.isActive||this.removeEntity(e)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(s=>{s.scene=t.scene,this.addEntity(s)});const e=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,e);const i=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,i),t.childrenAdded$.subscribe(e),t.childrenRemoved$.subscribe(i)}}removeEntity(t,e=!0){var i,s;let n=0;t instanceof Bt?n=t.id:n=t;const o=this._entityIndex[n];if(o&&o.isActive&&(o.isActive=!1),o&&e){this._entitiesToRemove.push(o);return}if(delete this._entityIndex[n],o){o.scene=null,_i(o,this.entities),this._world.queryManager.removeEntity(o),o.children.forEach(l=>{l.scene=null,this.removeEntity(l,e)});const a=this._childAddedHandlerMap.get(o);a&&o.childrenAdded$.unsubscribe(a);const h=this._childRemovedHandlerMap.get(o);h&&o.childrenRemoved$.unsubscribe(h),!((s=(i=this._world)===null||i===void 0?void 0:i.scene)===null||s===void 0)&&s.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const e=this._entitiesToRemove[t];e.isActive||this.removeEntity(e,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(e=>e.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class Ri{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new Lt,this.entityRemoved$=new Lt,t.length===0)throw new Error("Cannot create query without components");for(const e of t)this.components.add(e);this.id=Ri.createId(t)}static createId(t){return t.slice().map(e=>e.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&(this.entities.splice(e,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Mi{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new Lt,this.entityRemoved$=new Lt,t.length===0)throw new Error("Cannot create tag query without tags");for(const e of t)this.tags.add(e);this.id=Mi.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&(this.entities.splice(e,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class sa{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=e=>i=>{this.addComponent(e,i)},this._createRemoveComponentHandler=e=>i=>{this.removeComponent(e,i)},this._createAddTagHandler=e=>i=>{this.addTag(e,i)},this._createRemoveTagHandler=e=>i=>{this.removeTag(e,i)}}createQuery(t){const e=Ri.createId(t);if(this._queries.has(e))return this._queries.get(e);const i=new Ri(t);this._queries.set(i.id,i);for(const s of t){const n=this._componentToQueriesIndex.get(s);n?n.push(i):this._componentToQueriesIndex.set(s,[i])}for(const s of this._world.entities)this.addEntity(s);return i}createTagQuery(t){const e=Mi.createId(t);if(this._tagQueries.has(e))return this._tagQueries.get(e);const i=new Mi(t);this._tagQueries.set(i.id,i);for(const s of t){const n=this._tagToQueriesIndex.get(s);n?n.push(i):this._tagToQueriesIndex.set(s,[i])}for(const s of this._world.entities)this.addEntity(s);return i}addEntity(t){const e=this._addComponentHandlers.get(t),i=this._removeComponentHandlers.get(t),s=e??this._createAddComponentHandler(t),n=i??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,s),this._removeComponentHandlers.set(t,n);const o=this._addTagHandlers.get(t),a=this._removeTagHandlers.get(t),h=o??this._createAddTagHandler(t),l=a??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,h),this._removeTagHandlers.set(t,l);for(const c of this._queries.values())c.checkAndAdd(t);for(const c of this._tagQueries.values())c.checkAndAdd(t);t.componentAdded$.subscribe(s),t.componentRemoved$.subscribe(n),t.tagAdded$.subscribe(h),t.tagRemoved$.subscribe(l)}removeEntity(t){const e=this._addComponentHandlers.get(t),i=this._removeComponentHandlers.get(t);for(const o of this._queries.values())o.removeEntity(t);e&&t.componentAdded$.unsubscribe(e),i&&t.componentRemoved$.unsubscribe(i);const s=this._addTagHandlers.get(t),n=this._removeTagHandlers.get(t);for(const o of this._tagQueries.values())o.removeEntity(t);s&&t.tagAdded$.unsubscribe(s),n&&t.tagRemoved$.unsubscribe(n)}addComponent(t,e){var i;const s=(i=this._componentToQueriesIndex.get(e.constructor))!==null&&i!==void 0?i:[];for(const n of s)n.checkAndAdd(t)}removeComponent(t,e){var i;const s=(i=this._componentToQueriesIndex.get(e.constructor))!==null&&i!==void 0?i:[];for(const n of s)n.removeEntity(t)}addTag(t,e){var i;const s=(i=this._tagToQueriesIndex.get(e))!==null&&i!==void 0?i:[];for(const n of s)n.checkAndAdd(t)}removeTag(t,e){var i;const s=(i=this._tagToQueriesIndex.get(e))!==null&&i!==void 0?i:[];for(const n of s)n.removeEntity(t)}}function na(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class ra{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(e=>e instanceof t)}addSystem(t){let e;t instanceof $t?e=t:e=new t(this._world),this.systems.push(e),this.systems.sort((i,s)=>i.constructor.priority-s.constructor.priority),this.initialized&&e.initialize&&e.initialize(this._world,this._world.scene)}removeSystem(t){_i(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,e,i){const s=this.systems.filter(n=>n.systemType===t);for(const n of s)n.preupdate&&n.preupdate(e,i);for(const n of s)n.update(i);for(const n of s)n.postupdate&&n.postupdate(e,i)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class oa{constructor(t){this.scene=t,this._logger=k.getInstance(),this.queryManager=new sa(this),this.entityManager=new ia(this),this.systemManager=new ra(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,e){t===qt.Update&&this.entityManager.updateEntities(this.scene,e),this.systemManager.updateSystems(t,this.scene,e),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof Bt){this.entityManager.addEntity(t);return}if(t instanceof $t||na(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,e=!0){if(t instanceof Bt){this.entityManager.removeEntity(t,e);return}if(t instanceof $t){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class Ms extends $t{constructor(t,e){super(),this.world=t,this.physics=e,this.systemType=qt.Update,this._physicsConfigDirty=!1,e.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([D,Z])}update(t){let e,i;const s=this.query.entities,n=this.physics.config.substep;for(let o=0;o<s.length;o++){e=s[o].get(D),i=s[o].get(Z);const a=s[o].get(V);if(this._physicsConfigDirty&&a&&a.updatePhysicsConfig(this.physics.config.bodies),a!=null&&a.isSleeping)continue;const h=i.acc.clone();(a==null?void 0:a.collisionType)===H.Active&&(a!=null&&a.useGravity)&&h.addEqual(this.physics.config.gravity),s[o].parent||this.captureOldTransformWithChildren(s[o]),kt.integrate(e,i,h,t/n)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var e;(e=t.get(V))===null||e===void 0||e.captureOldTransform();for(let i=0;i<t.children.length;i++)this.captureOldTransformWithChildren(t.children[i])}}Ms.priority=ge.Higher;class an{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(i=>!i.isCanceled());let e;switch(this.config.contactSolveBias){case Te.HorizontalFirst:{e=sr;break}case Te.VerticalFirst:{e=ir;break}default:e=nr}t.sort((i,s)=>{const n=this.directionMap.get(i.id),o=this.directionMap.get(s.id),a=this.distanceMap.get(i.id),h=this.distanceMap.get(s.id);return e[n]-e[o]||a-h});for(const i of t)this.solvePosition(i),this.solveVelocity(i);return this.postSolve(t),t}preSolve(t){for(let i=0;i<t.length;i++){const s=t[i];if(Math.abs(s.mtv.x)<1e-4&&Math.abs(s.mtv.y)<1e-4){s.cancel();continue}const n=K.fromDirection(s.mtv),o=s.mtv.negate(),a=Math.abs(s.info.separation);this.distanceMap.set(s.id,a),this.directionMap.set(s.id,n===K.Left||n===K.Right?"horizontal":"vertical"),s.colliderA.events.emit("precollision",new $e(s.colliderA,s.colliderB,n,o,s)),s.colliderB.events.emit("precollision",new $e(s.colliderB,s.colliderA,K.getOpposite(n),o.negate(),s))}}postSolve(t){var e,i;for(let s=0;s<t.length;s++){const n=t[s];if(n.isCanceled())continue;const o=n.colliderA,a=n.colliderB,h=(e=o.owner)===null||e===void 0?void 0:e.get(V),l=(i=a.owner)===null||i===void 0?void 0:i.get(V);if(h&&l&&(h.collisionType===H.Passive||l.collisionType===H.Passive))continue;const c=K.fromDirection(n.mtv),d=n.mtv.negate();n.colliderA.events.emit("postcollision",new Qe(n.colliderA,n.colliderB,c,d,n)),n.colliderB.events.emit("postcollision",new Qe(n.colliderB,n.colliderA,K.getOpposite(c),d.negate(),n))}}solvePosition(t){var e,i;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let n=t.mtv;const o=t.colliderA,a=t.colliderB,h=(e=o.owner)===null||e===void 0?void 0:e.get(V),l=(i=a.owner)===null||i===void 0?void 0:i.get(V);if(h&&l){if(h.collisionType===H.Passive||l.collisionType===H.Passive)return;h.collisionType===H.Active&&l.collisionType===H.Active&&(n=n.scale(.5)),h.collisionType===H.Active&&(h.globalPos.x-=n.x,h.globalPos.y-=n.y,o.update(h.transform.get())),l.collisionType===H.Active&&(l.globalPos.x+=n.x,l.globalPos.y+=n.y,a.update(l.transform.get()))}}solveVelocity(t){var e,i;if(t.isCanceled())return;const s=t.colliderA,n=t.colliderB,o=(e=s.owner)===null||e===void 0?void 0:e.get(V),a=(i=n.owner)===null||i===void 0?void 0:i.get(V);if(o&&a){if(o.collisionType===H.Passive||a.collisionType===H.Passive)return;const h=t.normal,l=h.negate();if(o.collisionType===H.Active&&o.vel.normalize().dot(l)<0){const c=h.scale(h.dot(o.vel.negate()));o.vel=o.vel.add(c)}if(a.collisionType===H.Active&&a.vel.normalize().dot(h)<0){const c=l.scale(l.dot(a.vel.negate()));a.vel=a.vel.add(c)}}}}class aa{constructor(t,e,i){this.point=t,this.local=e,this.contact=i,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new p(0,0),this.bToContact=new p(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,e=this.contact.colliderA,i=this.contact.bodyB,s=this.contact.colliderB;if(t&&i){const n=this.contact.normal,o=this.contact.tangent;this.aToContact=this.point.sub(e.center),this.bToContact=this.point.sub(s.center);const a=this.aToContact.cross(n),h=this.bToContact.cross(n);this.normalMass=t.inverseMass+i.inverseMass+t.inverseInertia*a*a+i.inverseInertia*h*h;const l=this.aToContact.cross(o),c=this.bToContact.cross(o);this.tangentMass=t.inverseMass+i.inverseMass+t.inverseInertia*l*l+i.inverseInertia*c*c}return this}getRelativeVelocity(){const t=this.contact.bodyA,e=this.contact.bodyB;if(t&&e){const i=t.vel.add(p.cross(t.angularVelocity,this.aToContact));return e.vel.add(p.cross(e.angularVelocity,this.bToContact)).sub(i)}return p.Zero}}class hn{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var e;return(e=this.idToContactConstraint.get(t))!==null&&e!==void 0?e:[]}solve(t){this.preSolve(t),t=t.filter(i=>!i.isCanceled());let e;switch(this.config.contactSolveBias){case Te.HorizontalFirst:{e=sr;break}case Te.VerticalFirst:{e=ir;break}default:e=nr}return t.sort((i,s)=>{const n=this.directionMap.get(i.id),o=this.directionMap.get(s.id),a=this.distanceMap.get(i.id),h=this.distanceMap.get(s.id);return e[n]-e[o]||a-h}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var e,i,s,n;for(let h=0;h<t.length;h++){const l=t[h];if(Math.abs(l.mtv.x)<1e-4&&Math.abs(l.mtv.y)<1e-4){l.cancel();continue}const c=K.fromDirection(l.mtv),d=Math.abs(((e=l==null?void 0:l.info)===null||e===void 0?void 0:e.separation)||0);this.distanceMap.set(l.id,d),this.directionMap.set(l.id,c===K.Left||c===K.Right?"horizontal":"vertical"),l.colliderA.events.emit("precollision",new $e(l.colliderA,l.colliderB,c,l.mtv,l)),l.colliderA.events.emit("beforecollisionresolve",new _s(l.colliderA,l.colliderB,c,l.mtv,l)),l.colliderB.events.emit("precollision",new $e(l.colliderB,l.colliderA,K.getOpposite(c),l.mtv.negate(),l)),l.colliderB.events.emit("beforecollisionresolve",new _s(l.colliderB,l.colliderA,K.getOpposite(c),l.mtv.negate(),l)),l.matchAwake()}const a=Array.from(this.idToContactConstraint.keys());for(let h=0;h<t.length;h++){const l=t[h],c=a.indexOf(l.id);c>-1&&a.splice(c,1);const d=(i=this.idToContactConstraint.get(l.id))!==null&&i!==void 0?i:[];let f=0;const _=l.bodyA,g=l.colliderA,v=l.bodyB,C=l.colliderB;if(_&&v)for(let m=0;m<l.points.length;m++){const w=l.points[m],T=l.normal,P=l.tangent,S=w.sub(g.center),F=w.sub(C.center),A=S.cross(T),L=F.cross(T),W=_.inverseMass+v.inverseMass+_.inverseInertia*A*A+v.inverseInertia*L*L,U=S.cross(P),q=F.cross(P),wt=_.inverseMass+v.inverseMass+_.inverseInertia*U*U+v.inverseInertia*q*q;d[f]&&((n=(s=d[f])===null||s===void 0?void 0:s.point)===null||n===void 0?void 0:n.squareDistance(w))<4?(d[f].point=w,d[f].local=l.localPoints[f]):d[f]=new aa(w,l.localPoints[f],l),d[f].aToContact=S,d[f].bToContact=F,d[f].normalMass=1/W,d[f].tangentMass=1/wt;const rt=_.bounciness>v.bounciness?_.bounciness:v.bounciness,$=l.normal.dot(d[f].getRelativeVelocity());d[f].originalVelocityAndRestitution=0,$<-.1&&(d[f].originalVelocityAndRestitution=-rt*$),f++}this.idToContactConstraint.set(l.id,d)}for(const h of a)this.idToContactConstraint.delete(h);if(this.config.warmStart)this.warmStart(t);else for(let h=0;h<t.length;h++){const l=t[h],c=this.getContactConstraints(l.id);for(const d of c)d.normalImpulse=0,d.tangentImpulse=0}}postSolve(t){for(let e=0;e<t.length;e++){const i=t[e],s=i.bodyA,n=i.bodyB;if(s&&n){if(s.collisionType===H.Passive||n.collisionType===H.Passive)continue;s.updateMotion(),n.updateMotion()}const o=K.fromDirection(i.mtv);i.colliderA.events.emit("postcollision",new Qe(i.colliderA,i.colliderB,o,i.mtv,i)),i.colliderA.events.emit("aftercollisionresolve",new ps(i.colliderA,i.colliderB,o,i.mtv,i)),i.colliderB.events.emit("postcollision",new Qe(i.colliderB,i.colliderA,K.getOpposite(o),i.mtv.negate(),i)),i.colliderB.events.emit("aftercollisionresolve",new ps(i.colliderB,i.colliderA,K.getOpposite(o),i.mtv.negate(),i))}this.lastFrameContacts.clear();for(let e=0;e<t.length;e++){const i=t[e];this.lastFrameContacts.set(i.id,i)}}warmStart(t){var e;for(let i=0;i<t.length;i++){const s=t[i],n=s.bodyA,o=s.bodyB;if(n&&o){const a=(e=this.idToContactConstraint.get(s.id))!==null&&e!==void 0?e:[];for(const h of a)if(this.config.warmStart){const l=s.normal.scale(h.normalImpulse),c=s.tangent.scale(h.tangentImpulse),d=l.add(c);n.applyImpulse(h.point,d.negate()),o.applyImpulse(h.point,d)}else h.normalImpulse=0,h.tangentImpulse=0}}}solvePosition(t){var e;for(let i=0;i<this.config.positionIterations;i++)for(let s=0;s<t.length;s++){const n=t[s],o=n.bodyA,a=n.bodyB;if(o&&a){if(o.collisionType===H.Passive||a.collisionType===H.Passive)continue;const h=(e=this.idToContactConstraint.get(n.id))!==null&&e!==void 0?e:[];for(const l of h){const c=n.normal,d=se.FindContactSeparation(n,l.local),f=this.config.steeringFactor,_=-5,g=this.config.slop,v=X(f*(d+g),_,0),C=c.scale(-v*l.normalMass);if(o.collisionType===H.Active){const m=C.negate().scale(o.inverseMass);o.limitDegreeOfFreedom.includes(Ot.X)&&(m.x=0),o.limitDegreeOfFreedom.includes(Ot.Y)&&(m.y=0),o.globalPos=o.globalPos.add(m),o.limitDegreeOfFreedom.includes(Ot.Rotation)||(o.rotation-=l.aToContact.cross(C)*o.inverseInertia)}if(a.collisionType===H.Active){const m=C.scale(a.inverseMass);a.limitDegreeOfFreedom.includes(Ot.X)&&(m.x=0),a.limitDegreeOfFreedom.includes(Ot.Y)&&(m.y=0),a.globalPos=a.globalPos.add(m),a.limitDegreeOfFreedom.includes(Ot.Rotation)||(a.rotation+=l.bToContact.cross(C)*a.inverseInertia)}}}}}solveVelocity(t){var e;for(let i=0;i<this.config.velocityIterations;i++)for(let s=0;s<t.length;s++){const n=t[s],o=n.bodyA,a=n.bodyB;if(o&&a){if(o.collisionType===H.Passive||a.collisionType===H.Passive)continue;const h=Math.min(o.friction,a.friction),l=(e=this.idToContactConstraint.get(n.id))!==null&&e!==void 0?e:[];for(const c of l){let _=-c.getRelativeVelocity().dot(n.tangent)*c.tangentMass;const g=h*c.normalImpulse,v=X(c.tangentImpulse+_,-g,g);_=v-c.tangentImpulse,c.tangentImpulse=v;const C=n.tangent.scale(_);o.applyImpulse(c.point,C.negate()),a.applyImpulse(c.point,C)}for(const c of l){const f=c.getRelativeVelocity().dot(n.normal);let _=-c.normalMass*(f-c.originalVelocityAndRestitution);const g=Math.max(c.normalImpulse+_,0);_=g-c.normalImpulse,c.normalImpulse=g;const v=n.normal.scale(_);o.applyImpulse(c.point,v.negate()),a.applyImpulse(c.point,v)}}}}}class Ds extends $t{get _processor(){return this._physics.collisionProcessor}constructor(t,e){super(),this._physics=e,this.systemType=qt.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new an(e.config.arcade),this._realisticSolver=new hn(e.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=i=>this._processor.track(i),this._untrackCollider=i=>this._processor.untrack(i),this.query=t.query([D,Z,pt]),this.query.entityAdded$.subscribe(i=>{const s=i.get(pt);s.$colliderAdded.subscribe(this._trackCollider),s.$colliderRemoved.subscribe(this._untrackCollider);const n=s.get();n&&this._processor.track(n)}),this.query.entityRemoved$.subscribe(i=>{const s=i.get(pt),n=s.get();s&&n&&this._processor.untrack(n)}),this._motionSystem=t.get(Ms)}initialize(t,e){this._engine=e.engine}update(t){var e,i,s,n;if(!this._physics.config.enabled)return;let o=[];for(let d=0;d<this.query.entities.length;d++){const _=this.query.entities[d].get(pt),g=_==null?void 0:_.get();if(_&&(!((e=_.owner)===null||e===void 0)&&e.isActive)&&g)if(_.update(),g instanceof yt){const v=g.getColliders();g.compositeStrategy||(g.compositeStrategy=this._physics.config.colliders.compositeStrategy),o=o.concat(v)}else o.push(g)}this._processor.update(o,t);let a=this._processor.broadphase(o,t);this._currentFrameContacts.clear();let h=[];const l=this.getSolver(),c=this._physics.config.substep;for(let d=0;d<c;d++)if(d>0&&this._motionSystem.update(t),h.length&&(a=h.map(f=>new zt(f.colliderA,f.colliderB))),a.length){h=this._processor.narrowphase(a,(n=(s=(i=this._engine)===null||i===void 0?void 0:i.debug)===null||s===void 0?void 0:s.stats)===null||n===void 0?void 0:n.currFrame),h=l.solve(h);for(const f of h){if(f.isCanceled())continue;const _=f.id.indexOf("|");if(_>0){const g=f.id.substring(_+1);this._currentFrameContacts.set(g,f)}else this._currentFrameContacts.set(f.id,f)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const d of this.query.entities){const f=d.get(pt);f&&f.processColliderRemoval()}}postupdate(){ft.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new an(this._physics.config.arcade),this._realisticSolver=new hn(this._physics.config.realistic)),this._physics.config.solver===Ii.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,e]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const i=e.colliderA,s=e.colliderB,n=K.fromDirection(e.mtv),o=K.getOpposite(n);i.events.emit("collisionstart",new Ai(i,s,n,e)),i.events.emit("contactstart",new us(i,s,n,e)),s.events.emit("collisionstart",new Ai(s,i,o,e)),s.events.emit("contactstart",new us(s,i,o,e))}for(const[t,e]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const i=e.colliderA,s=e.colliderB,n=K.fromDirection(e.mtv),o=K.getOpposite(n);i.events.emit("collisionend",new Ti(i,s,n,e)),i.events.emit("contactend",new fs(i,s,n,e)),s.events.emit("collisionend",new Ti(s,i,o,e)),s.events.emit("contactend",new fs(s,i,o,e))}}}Ds.priority=ge.Higher;function il(r,t,e,i){if(r.parent!==t.parent){const c=r.clone(),d=r.globalPos.clone(),f=r.globalScale.clone(),_=r.globalRotation;c.parent=t.parent,c.globalPos=d,c.globalScale=f,c.globalRotation=_,r=c}let s=t.pos,n=t.scale,o=t.rotation;s=t.pos.scale(e).add(r.pos.scale(1-e)),n=t.scale.scale(e).add(r.scale.scale(1-e));const a=(1-e)*Math.cos(r.rotation)+e*Math.cos(t.rotation),h=(1-e)*Math.sin(r.rotation)+e*Math.sin(t.rotation);o=Math.atan2(h,a);const l=i??new Pe;return l.setTransform(s,o,n),l}class hr extends $t{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=qt.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Pe,this.query=this.world.query([D,lt]),this.query.entityAdded$.subscribe(e=>{const i=e.get(D);this._sortedTransforms.push(i),i.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(e=>{const i=e.get(D);i.zIndexChanged$.unsubscribe(this._zIndexUpdate);const s=this._sortedTransforms.indexOf(i);s>-1&&this._sortedTransforms.splice(s,1)})}initialize(t,e){this._camera=e.camera,this._engine=e.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>t.globalZ-e.globalZ),this._zHasChanged=!1)}update(t){this._token++;let e;Q.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let i=0;i<this._sortedTransforms.length;i++){const s=this._sortedTransforms[i],n=s.owner;if(n.hasTag("ex.offscreen")||(e=n.get(lt),!e.isVisible))continue;e.onPreTransformDraw&&e.onPreTransformDraw(this._graphicsContext,t),n.events.emit("pretransformdraw",new Mn(this._graphicsContext,t,n)),s.coordPlane===Et.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),s.coordPlane===Et.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),e.update(t,this._token);const o=n.get(Is);if(o){const a=p.One.sub(o.parallaxFactor),h=this._camera.drawPos.scale(a);this._graphicsContext.translate(h.x,h.y)}this._applyTransform(n),e.material&&(this._graphicsContext.material=e.material),e.onPreDraw&&e.onPreDraw(this._graphicsContext,t),n.events.emit("predraw",new mi(this._graphicsContext,t,n)),this._applyOpacity(n),this._drawGraphicsComponent(e,s),e.onPostDraw&&e.onPostDraw(this._graphicsContext,t),n.events.emit("postdraw",new vi(this._graphicsContext,t,n)),this._graphicsContext.restore(),s.coordPlane===Et.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),e.onPostTransformDraw&&e.onPostTransformDraw(this._graphicsContext,t),n.events.emit("posttransformdraw",new Dn(this._graphicsContext,t,n))}this._graphicsContext.restore()}_drawGraphicsComponent(t,e){var i,s;if(t.isVisible){const n=t.flipHorizontal,o=t.flipVertical,a=t.current,h=(i=t.currentOptions)!==null&&i!==void 0?i:{};if(a){let l=t.anchor,c=t.offset,d=1,f=1;h!=null&&h.anchor&&(l=h.anchor),h!=null&&h.offset&&(c=h.offset);const _=e.globalScale;d*=a.scale.x*_.x,f*=a.scale.y*_.y;const g=-a.width*l.x+c.x*d,v=-a.height*l.y+c.y*f,C=a.flipHorizontal,m=a.flipVertical;if((n||o)&&(a.flipHorizontal=n?!C:C,a.flipVertical=o?!m:m),a==null||a.draw(this._graphicsContext,g,v),(n||o)&&(a.flipHorizontal=C,a.flipVertical=m),!((s=this._engine)===null||s===void 0)&&s.isDebug&&this._engine.debug.graphics.showBounds){const w=b(g,v);if(a instanceof oi)for(const T of a.members){let P,S=p.Zero;T instanceof ht?P=T:(P=T.graphic,S=T.offset),a.useAnchor?P==null||P.localBounds.translate(w.add(S)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):P==null||P.localBounds.translate(S).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else a==null||a.localBounds.translate(w).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const e=t.getAncestors();for(let i=0;i<e.length;i++){const s=e[i],n=s==null?void 0:s.get(D),o=s==null?void 0:s.get(V);if(n){let a=n.get();if(o&&this._engine.fixedUpdateTimestep&&o.__oldTransformCaptured&&o.enableFixedUpdateInterpolate){const h=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;a=il(o.oldTransform,n.get(),h,this._targetInterpolationTransform)}this._graphicsContext.z=n.globalZ,this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation)}}}_applyOpacity(t){var e;const i=t.getAncestors();for(let s=0;s<i.length;s++){const n=i[s],o=n==null?void 0:n.get(lt);this._graphicsContext.opacity*=(e=o==null?void 0:o.opacity)!==null&&e!==void 0?e:1}}}hr.priority=ge.Average;class lr extends $t{constructor(t){super(),this.world=t,this.systemType=qt.Draw,this.query=this.world.query([D])}initialize(t,e){this._graphicsContext=e.engine.graphicsContext,this._camera=e.camera,this._engine=e.engine,this._collisionSystem=t.systemManager.get(Ds)}update(){var t;if(!this._engine.isDebug)return;const e=this._engine.debug.filter;let i,s;const n=this._engine.debug.entity;let o;const a=this._engine.debug.transform;let h;const l=this._engine.debug.motion;let c;const d=this._engine.debug.collider,f=this._engine.debug.physics;let _;const g=this._engine.debug.graphics;let v,C;const m=this._engine.debug.body,w=this._engine.debug.camera;for(let T=0;T<this.query.entities.length;T++){const P=this.query.entities[T];if(P.hasTag("offscreen")||P instanceof As||e.useFilter&&(!(e.ids.length===0||e.ids.includes(P.id))||!(e.nameQuery===""||P.name.includes(e.nameQuery))))continue;let S=p.Zero;const F=b(0,16);if(i=P.id,s=P.name,o=P.get(D),this._pushCameraTransform(o),this._graphicsContext.save(),o.coordPlane===Et.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=a.debugZIndex,this._applyTransform(P),o&&((a.showAll||a.showPosition)&&this._graphicsContext.debug.drawPoint(p.Zero,{size:4,color:a.positionColor}),(a.showAll||a.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${o.pos.toString(2)}`,S),S=S.add(F)),(a.showAll||a.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${o.z.toFixed(1)})`,S),S=S.add(F)),(n.showAll||n.showId)&&(this._graphicsContext.debug.drawText(`id(${i}) ${P.parent?"child of id("+((t=P.parent)===null||t===void 0?void 0:t.id)+")":""}`,S),S=S.add(F)),(n.showAll||n.showName)&&(this._graphicsContext.debug.drawText(`name(${s})`,S),S=S.add(F)),(a.showAll||a.showRotation)&&(this._graphicsContext.drawLine(p.Zero,p.fromAngle(o.rotation).scale(50).add(p.Zero),a.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${$r(o.rotation).toFixed(2)})`,S),S=S.add(F)),(a.showAll||a.showScale)&&this._graphicsContext.drawLine(p.Zero,o.scale.add(p.Zero),a.scaleColor,2)),_=P.get(lt),_&&(g.showAll||g.showBounds)&&_.localBounds.draw(this._graphicsContext,g.boundsColor),v=P.get(Rs),v&&(v.useTransform||this._graphicsContext.restore(),v.draw(this._graphicsContext,this._engine.debug),v.useTransform||(this._graphicsContext.save(),this._applyTransform(P))),C=P.get(V),C&&((m.showAll||m.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${C.group.name})`,S),S=S.add(F)),(m.showAll||m.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${C.collisionType})`,S),S=S.add(F)),(m.showAll||m.showMass)&&(this._graphicsContext.debug.drawText(`mass(${C.mass})`,S),S=S.add(F)),(m.showAll||m.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${C.sleepMotion})`,S),S=S.add(F)),(m.showAll||m.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${C.canSleep?C.isSleeping:"cant sleep"})`,S),S=S.add(F))),this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===Et.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=a.debugZIndex,h=P.get(Z),h&&((l.showAll||l.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${h.vel.toString(2)}`,S.add(o.globalPos)),this._graphicsContext.drawLine(o.globalPos,o.globalPos.add(h.vel),l.velocityColor,2),S=S.add(F)),(l.showAll||l.showAcceleration)&&this._graphicsContext.drawLine(o.globalPos,o.globalPos.add(h.acc),l.accelerationColor,2)),c=P.get(pt),c){const A=c.get();if((d.showAll||d.showGeometry)&&A&&A.debug(this._graphicsContext,d.geometryColor,{lineWidth:d.geometryLineWidth,pointSize:d.geometryPointSize}),d.showAll||d.showBounds){if(A instanceof yt){const L=A.getColliders();for(const W of L){const U=W.bounds,q=b(U.left,U.top);this._graphicsContext.debug.drawRect(q.x,q.y,U.width,U.height,{color:d.boundsColor}),(d.showAll||d.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${W.owner.id})`,q)}c.bounds.draw(this._graphicsContext,d.boundsColor)}else if(A){const L=c.bounds,W=b(L.left,L.top);this._graphicsContext.debug.drawRect(W.x,W.y,L.width,L.height,{color:d.boundsColor}),(d.showAll||d.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${c.owner.id})`,W)}}}this._graphicsContext.restore(),this._popCameraTransform(o)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(f.showAll||f.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),f.showAll||f.showCollisionContacts||f.showCollisionNormals)for(const[T,P]of this._engine.debug.stats.currFrame.physics.contacts){if(f.showAll||f.showCollisionContacts)for(const S of P.points)this._graphicsContext.debug.drawPoint(S,{size:f.contactSize,color:f.collisionContactColor});if(f.showAll||f.showCollisionNormals)for(const S of P.points)this._graphicsContext.debug.drawLine(S,P.normal.scale(30).add(S),{color:f.collisionNormalColor})}this._graphicsContext.restore(),w&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(w.showAll||w.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,w.focusColor),(w.showAll||w.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,e){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),bt.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const e=t.getAncestors();for(const i of e){const s=i==null?void 0:i.get(D);s&&(this._graphicsContext.translate(s.pos.x,s.pos.y),this._graphicsContext.scale(s.scale.x,s.scale.y),this._graphicsContext.rotate(s.rotation))}}_pushCameraTransform(t){t.coordPlane===Et.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===Et.World&&this._graphicsContext.restore()}}lr.priority=ge.Lowest;class cr{constructor(t,e){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=e,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,e=Math.floor(t.left/this.gridSize),i=Math.floor(t.right/this.gridSize),s=Math.floor(t.bottom/this.gridSize),n=Math.floor(t.top/this.gridSize);return this.leftX!==e||this.rightX!==i||this.bottomY!==s||this.topY!==n}clear(){for(const t of this.cells){const e=t.proxies.indexOf(this);e>-1&&t.proxies.splice(e,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class le{constructor(){this.proxies=[]}configure(t,e){this.x=t,this.y=e,this.key=le.calculateHashKey(t,e)}static calculateHashKey(t,e){return`${t}+${e}`}}class dr{constructor(t){this.bounds=new B,this._hashGridCellPool=new Ui(()=>new le,e=>(e.configure(0,0),e.proxies.length=0,e),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=e=>t.proxyFactory(e,this.gridSize):this._buildProxy=e=>new cr(e,this.gridSize)}query(t){const e=new Set;if(t instanceof B){const i=t,s=Math.floor(i.left/this.gridSize),n=Math.floor(i.right/this.gridSize),o=Math.floor(i.bottom/this.gridSize),a=Math.floor(i.top/this.gridSize);for(let h=s;h<=n;h++)for(let l=a;l<=o;l++){const c=le.calculateHashKey(h,l),d=this.sparseHashGrid.get(c);if(d)for(let f=0;f<d.proxies.length;f++)d.proxies[f].updateBounds(),d.proxies[f].bounds.intersect(i)&&e.add(d.proxies[f].object)}}else{const i=t,s=le.calculateHashKey(Math.floor(i.x/this.gridSize),Math.floor(i.y/this.gridSize)),n=this.sparseHashGrid.get(s);if(n)for(let o=0;o<n.proxies.length;o++)n.proxies[o].updateBounds(),n.proxies[o].bounds.contains(i)&&e.add(n.proxies[o].object)}return Array.from(e)}get(t,e){const i=le.calculateHashKey(t,e);return this.sparseHashGrid.get(i)}_insert(t,e,i){const s=le.calculateHashKey(t,e);let n=this.sparseHashGrid.get(s);n||(n=this._hashGridCellPool.rent(),n.configure(t,e),this.sparseHashGrid.set(n.key,n)),n.proxies.push(i),i.cells.push(n),this.bounds.combine(i.bounds,this.bounds)}_remove(t,e,i){const s=le.calculateHashKey(t,e),n=this.sparseHashGrid.get(s);if(n){const o=n.proxies.indexOf(i);o>-1&&n.proxies.splice(o,1);const a=i.cells.indexOf(n);a>-1&&i.cells.splice(a,1),n.proxies.length===0&&(this._hashGridCellPool.return(n),this.sparseHashGrid.delete(s))}}track(t){const e=this._buildProxy(t);this.objectToProxy.set(t,e);for(let i=e.leftX;i<=e.rightX;i++)for(let s=e.topY;s<=e.bottomY;s++)this._insert(i,s,e)}untrack(t){const e=this.objectToProxy.get(t);e&&(e.clear(),this.objectToProxy.delete(t))}update(t){let e=0;for(const i of t){const s=this.objectToProxy.get(i);if(s&&s.hasChanged()){for(let n=s.leftX;n<=s.rightX;n++)for(let o=s.topY;o<=s.bottomY;o++)this._remove(n,o,s);s.update();for(let n=s.leftX;n<=s.rightX;n++)for(let o=s.topY;o<=s.bottomY;o++)this._insert(n,o,s);e++}}return e}debug(t,e){const i=E.Transparent,s=E.White;for(const n of this.sparseHashGrid.values())t.drawRectangle(b(n.x*this.gridSize,n.y*this.gridSize),this.gridSize,this.gridSize,i,s,2)}}class Fs extends $t{constructor(t){super(),this.world=t,this.systemType=qt.Update,this._graphicsHashGrid=new dr({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new ar,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([D,De]),this.query.entityAdded$.subscribe(e=>{const i=e.get(D),s=e.get(De);this._pointerEventDispatcher.addObject(e,o=>s&&s.localBounds?s.localBounds.transform(i.get().matrix).contains(i.coordPlane===Et.World?o.worldPos:o.screenPos):!1,()=>e.isActive),this._entityToPointer.set(e,s);const n=e.get(lt);n&&(this._graphics.push(n),this._graphicsHashGrid.track(n)),this._sortedTransforms.push(i),this._sortedEntities.push(i.owner),i.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(e=>{this._pointerEventDispatcher.removeObject(e);const i=e.get(D);this._entityToPointer.delete(e);const s=e.get(lt);if(s){const o=this._graphics.indexOf(s);o>-1&&this._graphics.splice(o,1),this._graphicsHashGrid.untrack(s)}i.zIndexChanged$.unsubscribe(this._zIndexUpdate);const n=this._sortedTransforms.indexOf(i);n>-1&&(this._sortedTransforms.splice(n,1),this._sortedEntities.splice(n,1))})}initialize(t,e){this._engine=e.engine,this._scene=e}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>e.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,e]of this._engineReceiver.currentFramePointerCoords.entries()){const i=this._scene.physics.query(e.worldPos);for(let n=0;n<i.length;n++){const o=i[n],a=this._entityToPointer.get(o.owner);a&&(a.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(o.owner,t)}const s=this._graphicsHashGrid.query(e.worldPos);for(let n=0;n<s.length;n++){const o=s[n],a=this._entityToPointer.get(o.owner);a&&(a.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(o.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}Fs.priority=ge.Higher;class ur extends $t{constructor(t){super(),this.world=t,this.systemType=qt.Update,this._actions=[],this.query=this.world.query([si]),this.query.entityAdded$.subscribe(e=>this._actions.push(e.get(si))),this.query.entityRemoved$.subscribe(e=>{const i=e.get(si),s=this._actions.indexOf(i);s>-1&&this._actions.splice(s,1)})}update(t){for(let e=0;e<this._actions.length;e++)this._actions[e].update(t)}}ur.priority=ge.Higher;class Di extends Qt{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class fr extends $t{constructor(t){super(),this.world=t,this.systemType=qt.Update,this.query=this.world.query([D,Di])}update(){let t,e;for(let i=0;i<this.query.entities.length;i++){const s=this.query.entities[i];t=s.get(D),e=s.get(Di);const o=Math.max(e.columns*e.tileWidth,e.rows*e.tileHeight)*e.elevation+t.pos.y;t.z=o}}}fr.priority=ge.Lower;class _r extends $t{constructor(t){super(),this.world=t,this.systemType=qt.Draw,this.query=this.world.query([D,lt])}initialize(t,e){this._camera=e.camera,this._screen=e.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,e,i;for(let s=0;s<this.query.entities.length;s++){const n=this.query.entities[s];e=n.get(lt),t=n.get(D),i=n.get(Is);let o;if(i){const h=p.One.sub(i.parallaxFactor);o=this._camera.pos.scale(h)}const a=this._isOffscreen(t,e,o);a&&!n.hasTag("ex.offscreen")&&(n.events.emit("exitviewport",new Vn(n)),n.addTag("ex.offscreen")),!a&&n.hasTag("ex.offscreen")&&(n.events.emit("enterviewport",new qn(n)),n.removeTag("ex.offscreen"))}}_isOffscreen(t,e,i){if(e.forceOnScreen)return!1;if(t.coordPlane===Et.World){let s=e.localBounds;i&&(s=s.translate(i));const n=s.transform(t.get().matrix);return!this._worldBounds.overlaps(n)}else return!1}}_r.priority=ge.Higher;class ha extends cr{constructor(t,e){var i,s;super(t,e),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=e;const n=t.bounds;this.hasZeroBounds=n.hasZeroDimensions(),this.leftX=Math.floor(n.left/this.gridSize),this.rightX=Math.floor(n.right/this.gridSize),this.bottomY=Math.floor(n.bottom/this.gridSize),this.topY=Math.floor(n.top/this.gridSize),this.owner=t.owner,this.body=(i=this.owner)===null||i===void 0?void 0:i.get(V),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:H.PreventCollision}update(){var t,e;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(V),this.collisionType=(e=this.body.collisionType)!==null&&e!==void 0?e:H.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class ln{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Cs(()=>new zt({id:Ye("collider",0)},{id:Ye("collider",0)}),e=>(e.colliderA=null,e.colliderB=null,e),200),this.gridSize=t.size,this.hashGrid=new dr({size:this.gridSize,proxyFactory:(e,i)=>new ha(e,i)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,e){var i,s,n;const o=[],a=(i=e==null?void 0:e.maxDistance)!==null&&i!==void 0?i:1/0,h=e==null?void 0:e.collisionGroup,l=h?h.category:(s=e==null?void 0:e.collisionMask)!==null&&s!==void 0?s:Ae.All.category,c=(n=e==null?void 0:e.searchAllColliders)!==null&&n!==void 0?n:!1,d=t.dir.normalize(),f=d.y/d.x,_=d.x/d.y,g=Math.sqrt(1+f*f)*this.gridSize,v=Math.sqrt(1+_*_)*this.gridSize,C=t.pos.x/this.gridSize,m=t.pos.y/this.gridSize,w=b(1,1);let T=~~C,P=~~m,S=0,F=0;d.x<0?(w.x=-1,S=(C-T)*g):(w.x=1,S=(T+1-C)*g),d.y<0?(w.y=-1,F=(m-P)*v):(w.y=1,F=(P+1-m)*v);const A=new Set;let L=!1,W=9999;for(;!L&&W>0&&(W--,!!this.hashGrid.bounds.contains(b(T*this.gridSize,P*this.gridSize)));){const U=le.calculateHashKey(T,P),q=this.hashGrid.sparseHashGrid.get(U);if(q){const wt=[];for(let rt=0;rt<q.proxies.length;rt++){const $=q.proxies[rt];if(!A.has($.collider.id.value)){if(A.add($.collider.id.value),e!=null&&e.ignoreCollisionGroupAll&&$.body.group===Ae.All)continue;const Rt=(l&$.body.group.category)!==0;if($.body.group&&!Rt)continue;const At=$.collider.rayCast(t,a);At&&wt.push(At)}}wt.sort((rt,$)=>rt.distance-$.distance);for(let rt=0;rt<wt.length;rt++){const $=wt[rt];if(e!=null&&e.filter){if(e.filter($)&&(o.push($),!c)){L=!0;break}}else if(o.push($),!c){L=!0;break}}}S<F?(T+=w.x,S+=g):(P+=w.y,F+=v)}return o.sort((U,q)=>U.distance-q.distance),!c&&o.length?[o[0]]:o}track(t){let e=[t];if(t instanceof yt){const i=t.getColliders();for(const s of i)s.owner=t.owner;e=i}for(const i of e)this.hashGrid.track(i)}untrack(t){let e=[t];t instanceof yt&&(e=t.getColliders());for(const i of e)this.hashGrid.untrack(i)}_canCollide(t,e){return!(t.collider.id===e.collider.id||t.owner&&e.owner&&t.owner.id===e.owner.id||t.hasZeroBounds||e.hasZeroBounds||!t.body.group.canCollide(e.body.group)||t.collisionType===H.Fixed&&e.collisionType===H.Fixed||t.collisionType===H.PreventCollision||e.collisionType===H.PreventCollision||!t.owner.isActive||!e.owner.isActive)}broadphase(t,e){const i=[];this._pairs.clear(),this._nonPairs.clear();let s=0;for(const n of this.hashGrid.objectToProxy.values())if(n.id=s++,!(!n.owner.isActive||n.collisionType===H.PreventCollision))for(let o=0;o<n.cells.length;o++){const a=n.cells[o];for(let h=0;h<a.proxies.length;h++){const l=a.proxies[h];if(l.id===n.id)continue;const c=zt.calculatePairHash(n.collider.id,l.collider.id);if(!this._nonPairs.has(c))if(!this._pairs.has(c)&&this._canCollide(n,l)&&n.object.bounds.overlaps(l.object.bounds)){const d=this._pairPool.get();d.colliderA=n.collider,d.colliderB=l.collider,d.id=c,this._pairs.add(c),i.push(d)}else this._nonPairs.add(c)}}return i}narrowphase(t,e){const i=[];for(let s=0;s<t.length;s++){const n=t[s].collide();for(let o=0;o<n.length;o++){const a=n[o];i.push(a),e&&e.physics.contacts.set(a.id,a)}}return this._pairPool.done(),e&&(e.physics.collisions+=i.length),i}update(t,e){return this.hashGrid.update(t)}debug(t,e){this.hashGrid.debug(t,e)}}class la{get config(){return $a(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===ai.SparseHashGrid?this._collisionProcessor=new ln(this._config.sparseHashGrid):this._collisionProcessor=new ms(this._config);for(const e of t)this._collisionProcessor.track(e)}return this._collisionProcessor}constructor(t){this.$configUpdate=new Lt,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(e=>{this._configDirty=!0,V.updateDefaultPhysicsConfig(e.bodies)}),this._config.spatialPartition===ai.SparseHashGrid?this._collisionProcessor=new ln(this._config.sparseHashGrid):this._collisionProcessor=new ms(this._config)}rayCast(t,e){return this.collisionProcessor.rayCast(t,e)}query(t){return this._collisionProcessor.query(t)}}class Bs{constructor(){this.events=new nt,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const e=t.axes.filter(s=>typeof s!==void 0).length,i=t.buttons.filter(s=>typeof s!==void 0).length;return e>=this._minimumConfiguration.axis&&i>=this._minimumConfiguration.buttons&&t.connected}emit(t,e){this.events.emit(t,e)}on(t,e){return this._enableAndUpdate(),this.events.on(t,e)}once(t,e){return this._enableAndUpdate(),this.events.once(t,e)}off(t,e){this._enableAndUpdate(),this.events.off(t,e)}update(){var t,e;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const i=this._navigator.getGamepads();for(let s=0;s<i.length;s++){if(i[s]){const o=this.at(s);!this.at(s).connected&&this._isGamepadValid(i[s])&&(o.events.pipe(this.events),this.events.emit("connect",new zn(s,this.at(s)))),this.at(s).connected=!0}else{const o=this.at(s);o.connected&&(this.events.emit("disconnect",new Un(s,o)),o.events.unpipe(this.events)),o.connected=!1;continue}if(this.at(s).update(),i[s].timestamp&&i[s].timestamp===this._gamePadTimeStamps[s])continue;this._gamePadTimeStamps[s]=i[s].timestamp,this.at(s).navigatorGamepad=i[s];const n=i[s];if(n){for(let o=0;o<n.buttons.length;o++){const a=n.buttons[o],h=a==null?void 0:a.value;h!==((t=this._oldPads[s])===null||t===void 0?void 0:t.getButton(o))&&(a!=null&&a.pressed?(this.at(s).updateButton(o,h),this.at(s).events.emit("button",new Hn(o in Fi?o:Fi.Unknown,o,h,this.at(s)))):this.at(s).updateButton(o,0))}for(let o=0;o<n.axes.length;o++){const a=n.axes[o];a!==((e=this._oldPads[s])===null||e===void 0?void 0:e.getAxes(o))&&(this.at(s).updateAxes(o,a),this.at(s).events.emit("axis",new Wn(o,a,this.at(s))))}}this._oldPads[s]=this._clonePad(i[s])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let e=this._pads.length-1,i=t;e<i;e++)this._pads.push(new es),this._oldPads.push(new es);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let e=0;e<this._pads.length;e++)this._isGamepadValid(this.at(e).navigatorGamepad)&&this.at(e).connected&&t.push(this.at(e));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const e=[];for(let i=0,s=t.length;i<s;i++)e.push(this._clonePad(t[i]));return e}_clonePad(t){let e,i;const s=new es;if(!t)return s;for(e=0,i=t.buttons.length;e<i;e++)t.buttons[e]&&s.updateButton(e,t.buttons[e].value);for(e=0,i=t.axes.length;e<i;e++)s.updateAxes(e,t.axes[e]);return s}}Bs.MinAxisMoveThreshold=.05;class es{constructor(){this.events=new nt,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,e=1){return this._buttons[t]>=e}isButtonHeld(t,e=1){return this._buttons[t]>=e}wasButtonPressed(t,e=1){return this._buttonsDown[t]>=e}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const e=this._axes[t];return Math.abs(e)<Bs.MinAxisMoveThreshold?0:e}updateButton(t,e){e===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=e,this._buttons[t]=e}updateAxes(t,e){this._axes[t]=e}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}var Fi;(function(r){r[r.Unknown=-1]="Unknown",r[r.Face1=0]="Face1",r[r.Face2=1]="Face2",r[r.Face3=2]="Face3",r[r.Face4=3]="Face4",r[r.LeftBumper=4]="LeftBumper",r[r.RightBumper=5]="RightBumper",r[r.LeftTrigger=6]="LeftTrigger",r[r.RightTrigger=7]="RightTrigger",r[r.Select=8]="Select",r[r.Start=9]="Start",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",r[r.DpadUp=12]="DpadUp",r[r.DpadDown=13]="DpadDown",r[r.DpadLeft=14]="DpadLeft",r[r.DpadRight=15]="DpadRight",r[r.CenterButton=16]="CenterButton",r[r.MiscButton1=17]="MiscButton1"})(Fi||(Fi={}));var cn;(function(r){r[r.LeftStickX=0]="LeftStickX",r[r.LeftStickY=1]="LeftStickY",r[r.RightStickX=2]="RightStickX",r[r.RightStickY=3]="RightStickY"})(cn||(cn={}));class ca{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,e]of this._handlers.entries()){const i=t(this.inputs);i&&e(i)}}on(t,e){this._handlers.set(t,e)}}function da(){try{const r=()=>{};window.top.addEventListener("blur",r),window.top.removeEventListener("blur",r)}catch{return!0}return!1}var Bi;(function(r){r.Backquote="Backquote",r.Backslash="Backslash",r.BracketLeft="BracketLeft",r.BracketRight="BracketRight",r.Comma="Comma",r.Key0="Digit0",r.Key1="Digit1",r.Key2="Digit2",r.Key3="Digit3",r.Key4="Digit4",r.Key5="Digit5",r.Key6="Digit6",r.Key7="Digit7",r.Key8="Digit8",r.Key9="Digit9",r.Digit0="Digit0",r.Digit1="Digit1",r.Digit2="Digit2",r.Digit3="Digit3",r.Digit4="Digit4",r.Digit5="Digit5",r.Digit6="Digit6",r.Digit7="Digit7",r.Digit8="Digit8",r.Digit9="Digit9",r.Equal="Equal",r.IntlBackslash="IntlBackslash",r.IntlRo="IntlRo",r.IntlYen="IntlYen",r.A="KeyA",r.B="KeyB",r.C="KeyC",r.D="KeyD",r.E="KeyE",r.F="KeyF",r.G="KeyG",r.H="KeyH",r.I="KeyI",r.J="KeyJ",r.K="KeyK",r.L="KeyL",r.M="KeyM",r.N="KeyN",r.O="KeyO",r.P="KeyP",r.Q="KeyQ",r.R="KeyR",r.S="KeyS",r.T="KeyT",r.U="KeyU",r.V="KeyV",r.W="KeyW",r.X="KeyX",r.Y="KeyY",r.Z="KeyZ",r.KeyA="KeyA",r.KeyB="KeyB",r.KeyC="KeyC",r.KeyD="KeyD",r.KeyE="KeyE",r.KeyF="KeyF",r.KeyG="KeyG",r.KeyH="KeyH",r.KeyI="KeyI",r.KeyJ="KeyJ",r.KeyK="KeyK",r.KeyL="KeyL",r.KeyM="KeyM",r.KeyN="KeyN",r.KeyO="KeyO",r.KeyP="KeyP",r.KeyQ="KeyQ",r.KeyR="KeyR",r.KeyS="KeyS",r.KeyT="KeyT",r.KeyU="KeyU",r.KeyV="KeyV",r.KeyW="KeyW",r.KeyX="KeyX",r.KeyY="KeyY",r.KeyZ="KeyZ",r.Minus="Minus",r.Period="Period",r.Quote="Quote",r.Semicolon="Semicolon",r.Slash="Slash",r.AltLeft="AltLeft",r.AltRight="AltRight",r.Alt="Alt",r.AltGraph="AltGraph",r.Backspace="Backspace",r.CapsLock="CapsLock",r.ContextMenu="ContextMenu",r.ControlLeft="ControlLeft",r.ControlRight="ControlRight",r.Enter="Enter",r.MetaLeft="MetaLeft",r.MetaRight="MetaRight",r.ShiftLeft="ShiftLeft",r.ShiftRight="ShiftRight",r.Space="Space",r.Tab="Tab",r.Convert="Convert",r.KanaMode="KanaMode",r.NonConvert="NonConvert",r.Delete="Delete",r.End="End",r.Help="Help",r.Home="Home",r.Insert="Insert",r.PageDown="PageDown",r.PageUp="PageUp",r.Up="ArrowUp",r.Down="ArrowDown",r.Left="ArrowLeft",r.Right="ArrowRight",r.ArrowUp="ArrowUp",r.ArrowDown="ArrowDown",r.ArrowLeft="ArrowLeft",r.ArrowRight="ArrowRight",r.NumLock="NumLock",r.Numpad0="Numpad0",r.Numpad1="Numpad1",r.Numpad2="Numpad2",r.Numpad3="Numpad3",r.Numpad4="Numpad4",r.Numpad5="Numpad5",r.Numpad6="Numpad6",r.Numpad7="Numpad7",r.Numpad8="Numpad8",r.Numpad9="Numpad9",r.Num0="Numpad0",r.Num1="Numpad1",r.Num2="Numpad2",r.Num3="Numpad3",r.Num4="Numpad4",r.Num5="Numpad5",r.Num6="Numpad6",r.Num7="Numpad7",r.Num8="Numpad8",r.Num9="Numpad9",r.NumAdd="NumpadAdd",r.NumpadAdd="NumpadAdd",r.NumDecimal="NumpadDecimal",r.NumpadDecimal="NumpadDecimal",r.NumDivide="NumpadDivide",r.NumpadDivide="NumpadDivide",r.NumEnter="NumpadEnter",r.NumpadEnter="NumpadEnter",r.NumMultiply="NumpadMultiply",r.NumpadMultiply="NumpadMultiply",r.NumSubtract="NumpadSubtract",r.NumpadSubtract="NumpadSubtract",r.Esc="Escape",r.Escape="Escape",r.F1="F1",r.F2="F2",r.F3="F3",r.F4="F4",r.F5="F5",r.F6="F6",r.F7="F7",r.F8="F8",r.F9="F9",r.F10="F10",r.F11="F11",r.F12="F12",r.F13="F13",r.F14="F14",r.F15="F15",r.F16="F16",r.F17="F17",r.F18="F18",r.F19="F19",r.F20="F20",r.PrintScreen="PrintScreen",r.ScrollLock="ScrollLock",r.Pause="Pause",r.Unidentified="Unidentified"})(Bi||(Bi={}));class yi extends N{constructor(t,e,i){super(),this.key=t,this.value=e,this.originalEvent=i}}class ua{constructor(){this.events=new nt,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const e of this._keys){const i=new yi(e,t.key,t);this.events.emit("up",i),this.events.emit("release",i)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(Bi.MetaLeft)||this._keys.includes(Bi.MetaRight))&&this._releaseAllKeys(t);const e=t.code;if(this._keys.indexOf(e)===-1){this._keys.push(e),this._keysDown.push(e);const i=new yi(e,t.key,t);this.events.emit("down",i),this.events.emit("press",i)}},this._handleKeyUp=t=>{if(!this._enabled)return;const e=t.code,i=this._keys.indexOf(e);this._keys.splice(i,1),this._keysUp.push(e);const s=new yi(e,t.key,t);this.events.emit("up",s),this.events.emit("release",s),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}init(t){let{global:e}=t;const{grabWindowFocus:i}=t;e||(da()?(e=window,i&&window.focus(),k.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):e=window.top),e.addEventListener("blur",()=>{this._keys.length=0}),e.addEventListener("keyup",this._handleKeyUp),e.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new yi(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,e,i){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:e,key:i??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:e,key:i??null}))}}class hi{static fromPagePosition(t,e,i){let s,n,o,a;arguments.length===3?(s=t,n=e,o=new p(s,n),a=i):(o=t,s=o.x,n=o.y,a=e);const h=a.screen.pageToScreenCoordinates(o),l=a.screen.screenToWorldCoordinates(h);return new hi(l,o,h)}constructor(t,e,i){this.worldPos=t,this.pagePos=e,this.screenPos=i}}class Ci{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,e,i,s,n,o){this.type=t,this.pointerId=e,this.button=i,this.pointerType=s,this.coordinates=n,this.nativeEvent=o,this.active=!0}}class fa{cancel(){this.active=!1}constructor(t,e,i,s,n,o,a,h,l,c,d,f){this.x=t,this.y=e,this.pageX=i,this.pageY=s,this.screenX=n,this.screenY=o,this.index=a,this.deltaX=h,this.deltaY=l,this.deltaZ=c,this.deltaMode=d,this.ev=f,this.active=!0}}class dn{constructor(){this.events=new nt,this.lastPagePos=p.Zero,this.lastScreenPos=p.Zero,this.lastWorldPos=p.Zero,this._onPointerMove=t=>{this.lastPagePos=new p(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new p(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new p(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new p(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new p(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new p(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}_updateWorldPosition(t){const e=hi.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=e.screenPos,this.lastWorldPos=e.worldPos}}var ni;(function(r){r.Pixel="Pixel",r.Line="Line",r.Page="Page"})(ni||(ni={}));var Ee;(function(r){r[r.NoButton=-1]="NoButton",r[r.Left=0]="Left",r[r.Middle=1]="Middle",r[r.Right=2]="Right",r[r.Unknown=3]="Unknown"})(Ee||(Ee={}));var me;(function(r){r.Left="Left",r.Middle="Middle",r.Right="Right",r.Unknown="Unknown",r.NoButton="NoButton"})(me||(me={}));var ve;(function(r){r.Touch="Touch",r.Mouse="Mouse",r.Pen="Pen",r.Unknown="Unknown"})(ve||(ve={}));function sl(r){return globalThis.TouchEvent&&r instanceof globalThis.TouchEvent}function nl(r){return globalThis.PointerEvent&&r instanceof globalThis.PointerEvent}class ks{constructor(t,e){this.target=t,this.engine=e,this.events=new nt,this.primary=new dn,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,e){const i=new ks(t,e);return i.primary=this.primary,i._pointers=this._pointers,i}at(t){if(t>=this._pointers.length)for(let e=this._pointers.length-1,i=t;e<i;e++)this._pointers.push(new dn);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var e;return this._enabled&&(e=this.currentFramePointerDown.get(t))!==null&&e!==void 0?e:!1}wasDown(t){var e;return this._enabled&&(e=this.lastFramePointerDown.get(t))!==null&&e!==void 0?e:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const e=this._activeNativePointerIdsToNormalized.entries();for(const[i,s]of e)s===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(i)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var e;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const i={passive:!(this.engine.pageScrollPreventionMode===Re.All||this.engine.pageScrollPreventionMode===Re.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,i):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,i):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,i),((e=t==null?void 0:t.grabWindowFocus)!==null&&e!==void 0?e:!0)&&da()){const n=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",n):(this.target.addEventListener("touchstart",n),this.target.addEventListener("mousedown",n))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const i=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((s,n)=>s-n).findIndex(s=>s===t);return this._activeNativePointerIdsToNormalized.set(t,i),i}_handle(t){if(!this._enabled)return;t.preventDefault();const e=new Map;let i,s;if(sl(t)){i=me.Unknown,s=ve.Touch;for(let n=0;n<t.changedTouches.length;n++){const o=t.changedTouches[n],a=hi.fromPagePosition(o.pageX,o.pageY,this.engine),h=n+1,l=this._normalizePointerId(h);this.currentFramePointerCoords.set(l,a),e.set(l,a)}}else{i=this._nativeButtonToPointerButton(t.button),s=ve.Mouse;const n=hi.fromPagePosition(t.pageX,t.pageY,this.engine);let o=1;nl(t)&&(o=t.pointerId,s=this._stringToPointerType(t.pointerType));const a=this._normalizePointerId(o);this.currentFramePointerCoords.set(a,n),e.set(a,n)}for(const[n,o]of e.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new Ci("down",n,i,s,o,t)),this.currentFramePointerDown.set(n,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new Ci("up",n,i,s,o,t)),this.currentFramePointerDown.set(n,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new Ci("move",n,i,s,o,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new Ci("cancel",n,i,s,o,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Re.All||this.engine.pageScrollPreventionMode===Re.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const e=this.engine.screen.pageToScreenCoordinates(b(t.pageX,t.pageY)),i=this.engine.screen.screenToWorldCoordinates(e),s=-1/40,n=t.deltaX||t.wheelDeltaX*s||0,o=t.deltaY||t.wheelDeltaY*s||t.wheelDelta*s||t.detail||0,a=t.deltaZ||0;let h=ni.Pixel;t.deltaMode&&(t.deltaMode===1?h=ni.Line:t.deltaMode===2&&(h=ni.Page));const l=new fa(i.x,i.y,t.pageX,t.pageY,e.x,e.y,0,n,o,a,h,t);this.currentFrameWheel.push(l)}triggerEvent(t,e){const i=this.engine.screen.worldToPageCoordinates(e);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:i.x,clientY:i.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:i.x,clientY:i.y}));const s=this.engine.currentScene.world.get(Fs);s.preupdate(this.engine.currentScene,1),s.update(1)}_nativeButtonToPointerButton(t){switch(t){case Ee.NoButton:return me.NoButton;case Ee.Left:return me.Left;case Ee.Middle:return me.Middle;case Ee.Right:return me.Right;case Ee.Unknown:return me.Unknown;default:return Jr(t)}}_stringToPointerType(t){switch(t){case"touch":return ve.Touch;case"mouse":return ve.Mouse;case"pen":return ve.Pen;default:return ve.Unknown}}}class pr{constructor(t){this._enabled=!0;const{pointerTarget:e,grabWindowFocus:i,engine:s}=t;this.keyboard=new ua,this.pointers=new ks(e,s),this.gamepads=new Bs,this.keyboard.init({grabWindowFocus:i}),this.pointers.init({grabWindowFocus:i}),this.gamepads.init(),this.inputMapper=new ca({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class rl{}const ol={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function ae(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class Yt{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof Ut)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof ea)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof qo)}get timers(){return this._timers}constructor(){this._logger=k.getInstance(),this.events=new nt,this.camera=new ta,this.world=new oa(this),this.physics=new la(Ce()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(ur),this.world.add(new Ms(this.world,this.physics)),this.world.add(new Ds(this.world,this.physics)),this.world.add(Fs),this.world.add(fr),this.world.add(_r),this.world.add(hr),this.world.add(lr)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreDraw(t,e){}onPostDraw(t,e){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var e;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new pr({pointerTarget:t.pointerScope===je.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new wi(t,this))}catch(i){throw this._logger.error(`Error during scene initialization for scene ${(e=t.director)===null||e===void 0?void 0:e.getSceneName(this)}!`),i}this._isInitialized=!0}}async _activate(t){var e,i;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(s){throw this._logger.error(`Error during scene activation for scene ${(i=(e=this.engine)===null||e===void 0?void 0:e.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),s}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,e){this.emit("preupdate",new Be(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.emit("postupdate",new ke(t,e,this)),this.onPostUpdate(t,e)}_predraw(t,e){this.emit("predraw",new mi(t,e,this)),this.onPreDraw(t,e)}_postdraw(t,e){this.emit("postdraw",new vi(t,e,this)),this.onPostDraw(t,e)}update(t,e){var i;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`);return}this._preupdate(t,e);let s,n;for(s=0,n=this._cancelQueue.length;s<n;s++)this.removeTimer(this._cancelQueue[s]);this._cancelQueue.length=0;for(const o of this._timers)o.update(e);this.world.update(qt.Update,e),this.camera&&this.camera.update(t,e),this._collectActorStats(t),this._postupdate(t,e),this.input.update()}draw(t,e){var i;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,e),this.world.update(qt.Draw,e),!((i=this.engine)===null||i===void 0)&&i.isDebug&&this.debugDraw(t),this._postdraw(t,e)}debugDraw(t){this.emit("predebugdraw",new Fn(t,this)),this.emit("postdebugdraw",new Bn(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof Ve){Kr(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let e;t instanceof Bt&&t.scene&&t.scene!==this&&(e=t.scene,t.scene.world.remove(t,!1)),t instanceof Ve&&t.scene&&(e=t.scene,t.scene.removeTimer(t)),e==null||e.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof Bt&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof Ve&&this.removeTimer(t)}clear(t=!0){for(let e=this.entities.length-1;e>=0;e--)this.world.remove(this.entities[e],t);for(let e=this.timers.length-1;e>=0;e--)this.removeTimer(this.timers[e])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const e=this._timers.indexOf(t);return e!==-1&&this._timers.splice(e,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const e=this.actors;for(let i=0;i<e.length;i++){const s=e[i];s instanceof or&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let n=0;n<s.children.length;n++){const o=s.children[n];Vo(o)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var qe;(function(r){r.Protanope="Protanope",r.Deuteranope="Deuteranope",r.Tritanope="Tritanope"})(qe||(qe={}));const al=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class _a{constructor(t,e){this._shader=new Nt({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:e}),this._shader.compile(),this._buffer=new _e({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Se({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class pa{constructor(t,e=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=e}initialize(t){this._shader=new _a(t,al),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const e=this._shader.getShader();e.use(),this._colorBlindnessMode===qe.Protanope?e.setUniformInt("u_type",0):this._colorBlindnessMode===qe.Deuteranope?e.setUniformInt("u_type",1):this._colorBlindnessMode===qe.Tritanope&&e.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const e=this._shader.getShader();e.use(),e.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class ga{constructor(t){this._engine=t,this._colorBlindPostProcessor=new pa(qe.Protanope)}correct(t){this._engine.graphicsContext instanceof ye&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof ye&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class ma{constructor(t){this.stats={currFrame:new ki,prevFrame:new ki},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:E.Yellow,showZIndex:!1,showScale:!1,scaleColor:E.Green,showRotation:!1,rotationColor:E.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:E.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:E.Blue,showOwner:!1,showGeometry:!0,geometryColor:E.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:E.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:E.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:E.Yellow,showAcceleration:!1,accelerationColor:E.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:E.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:E.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:E.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:E.Yellow,positionSize:1,showGrid:!1,gridColor:E.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new ga(this._engine)}useTestClock(){const t=this._engine.clock,e=t.isRunning();t.stop();const i=t.toTestClock();return e&&i.start(),this._engine.clock=i,i}useStandardClock(){const t=this._engine.clock,e=t.isRunning();t.stop();const i=t.toStandardClock();return e&&i.start(),this._engine.clock=i,i}}class ki{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Ls,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new ki;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Ls{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new Ls;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class un{on(t,e){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(e),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,e){e||(e=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,e),this._nativeHandlers[t]=null}_decorate(t){return e=>{this._paused||t(e)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class va{constructor(t,e){this._windowGlobal=t,this._documentGlobal=e,this._windowComponent=new un(this._windowGlobal),this._documentComponent=new un(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const wa={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:gt.Blended,canvasImageRendering:"auto"},xa={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:gt.Blended,canvasImageRendering:"auto"};class ba{constructor(t){var e;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(e=t.samplePeriod)!==null&&e!==void 0?e:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class gr{constructor(t){var e,i,s;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(e=this.now())!==null&&e!==void 0?e:0,this._maxFps=(i=t.maxFps)!==null&&i!==void 0?i:this._maxFps,this._onFatalException=(s=t.onFatalException)!==null&&s!==void 0?s:this._onFatalException,this.fpsSampler=new ba({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new ya({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new mr({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,e=0,i="preframe"){const s=this._totalElapsed+e;this._scheduledCbs.push([t,s,i])}__runScheduledCbs(t="preframe"){for(let e=this._scheduledCbs.length-1;e>-1;e--)t===this._scheduledCbs[e][2]&&this._scheduledCbs[e][1]<=this._totalElapsed&&(this._scheduledCbs[e][0](this._elapsed),this._scheduledCbs.splice(e,1))}update(t){try{this.fpsSampler.start();const e=this.now();let i=e-this._lastTime||1;const s=1e3/this._maxFps;if(i>=s){let n=0;s!==0&&(n=i%s,i=i-n),i>200&&(i=1),this._elapsed=t||i,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||i),this.__runScheduledCbs("postframe"),s!==0?this._lastTime=e-n:this._lastTime=e,this.fpsSampler.end()}}catch(e){this._onFatalException(e),this.stop()}}}class mr extends gr{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(e){throw window.cancelAnimationFrame(this._requestId),e}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class ya extends gr{constructor(t){super({...t}),this._logger=k.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const e=t??this._updateMs;this._running?(this.update(e),this._currentTime+=e):this._logger.warn("The clock is not running, no step will be performed")}run(t,e){for(let i=0;i<t;i++)this.step(e??this._updateMs)}}var hl=Ct(296);class Ca{constructor(){this._toasterCss=hl.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const e=document.createElement("span");return e.innerText=t,e}toast(t,e,i){this._initialize();const s=document.createElement("div");s.className="ex-toast-message";const n=t.split("[LINK]").map(c=>this._createFragment(c));if(e){const c=document.createElement("a");c.href=e,i?c.innerText=i:c.innerText=e,n.splice(1,0,c)}const o=document.createElement("div");n.forEach(c=>{o.appendChild(c)}),s.appendChild(o);const a=document.createElement("button");a.innerText="x",a.addEventListener("click",()=>{this._container.removeChild(s)}),s.appendChild(a);const h=c=>{if(c.key==="Escape")try{this._container.removeChild(s)}catch{}document.removeEventListener("keydown",h)};document.addEventListener("keydown",h);const l=this._container.firstChild;this._container.insertBefore(s,l)}}const ll={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Pa{get isTransitioning(){return this._isTransitioning}constructor(t,e){this._engine=t,this.events=new nt,this._logger=k.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new Yt,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const i in e){const s=e[i];this.add(i,s),i==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const e=this._deferredTransition;this._deferredTransition=void 0;const i=this.getSceneInstance(t);i&&e&&e._addToTargetScene(this._engine,i),await this.swapScene(t),i&&e&&await this.playTransition(e,i)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,e){const i=e==null?void 0:e.loader;i instanceof Ei?this.mainLoader=i:tn(i)?this.mainLoader=new i:this.mainLoader=new Ke;let s;if(e!=null&&e.inTransition){const{inTransition:n}=e;s=n}if(this.startScene=t,s){const n=this.getSceneInstance(this.startScene);n&&(s._addToTargetScene(this._engine,n),this.swapScene(this.startScene).then(()=>this.playTransition(s,n)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var e;const i=this.scenes[t];if(!(i instanceof Yt||ae(i)))return(e=i==null?void 0:i.transitions)===null||e===void 0?void 0:e.in}_getOutTransition(t){var e;const i=this.scenes[t];if(!(i instanceof Yt||ae(i)))return(e=i==null?void 0:i.transitions)===null||e===void 0?void 0:e.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const e=this.scenes[t];if(e instanceof Yt||ae(e))return e;if(e)return e.scene}getSceneName(t){for(const[e,i]of Object.entries(this.scenes))if(i instanceof Yt){if(t===i)return e}else if(!ae(i)&&t===i.scene)return e;for(const[e,i]of Object.entries(this.scenes))if(ae(i)){if(t.constructor===i)return e}else if(!(i instanceof Yt)&&t.constructor===i.scene)return e;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,e){if(!(e instanceof Yt)&&!ae(e)){const{loader:i,transitions:s}=e,{in:n,out:o}=s??{};this._sceneToTransition.set(t,{in:n,out:o}),tn(i)?this._sceneToLoader.set(t,new i):i&&this._sceneToLoader.set(t,i)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=e,this.assertAdded(t)}remove(t){if(t instanceof Yt||ae(t)){const e=t;for(const i in this.scenes)if(this.scenes.hasOwnProperty(i)){const s=this.scenes[i];let n;if(s instanceof Yt||ae(s)?n=s:n=s.scene,n===e){if(i===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${i}`);this._sceneToInstance.delete(i),this._sceneToTransition.delete(i),this._sceneToLoader.delete(i),delete this.scenes[i]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,e){var i,s,n,o,a,h;const l=this.getSceneInstance(t);if(!l){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const c=this.currentScene,d=this.currentSceneName,f=(s=(i=this._engine.input)===null||i===void 0?void 0:i.enabled)!==null&&s!==void 0?s:!0;this._isTransitioning=!0;const _=(n=this.getSceneInstance(d))===null||n===void 0?void 0:n.onTransition("out"),g=l==null?void 0:l.onTransition("in");e={sourceOut:(o=this._getOutTransition(this.currentSceneName))!==null&&o!==void 0?o:_,destinationIn:(a=this._getInTransition(t))!==null&&a!==void 0?a:g,...e};const{sourceOut:v,destinationIn:C,sceneActivationData:m}=e,w=v??this._getOutTransition(this.currentSceneName),T=C??this._getInTransition(t),P=(w==null?void 0:w.hideLoader)||(T==null?void 0:T.hideLoader);P&&this.maybeLoadScene(t,P),this._emitEvent("navigationstart",d,t),w&&await this.playTransition(w,c),await this.maybeLoadScene(t,P),T&&await T.onPreviousSceneDeactivate(this.currentScene),T&&T._addToTargetScene(this._engine,l),await this.swapScene(t,m),this._emitEvent("navigation",d,t),T&&await this.playTransition(T,l),this._emitEvent("navigationend",d,t),(h=this._engine.input)===null||h===void 0||h.toggleEnabled(f),this._isTransitioning=!1}getSceneInstance(t){const e=this.getSceneDefinition(t);if(!e)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(e instanceof Yt)return this._sceneToInstance.set(t,e),e;const i=new e;return this._sceneToInstance.set(t,i),i}async maybeLoadScene(t,e=!1){var i;const s=(i=this._getLoader(t))!==null&&i!==void 0?i:new Ei,n=this.getSceneDefinition(t),o=this.getSceneInstance(t);n&&o&&!this._loadedScenes.has(o)&&(o.onPreLoad(s),o.events.emit("preload",{loader:s}),e?this._engine.load(s,e):await this._engine.load(s),this._loadedScenes.add(o))}async playTransition(t,e){var i,s,n,o,a,h,l;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const c=(s=(i=e.input)===null||i===void 0?void 0:i.enabled)!==null&&s!==void 0?s:!0;(n=e.input)===null||n===void 0||n.toggleEnabled(!t.blockInput),(o=this._engine.input)===null||o===void 0||o.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,e),await this.currentTransition._play(),(a=e.input)===null||a===void 0||a.toggleEnabled(c)}(h=this.currentTransition)===null||h===void 0||h.kill(),(l=this.currentTransition)===null||l===void 0||l.reset(),this.currentTransition=void 0}async swapScene(t,e){const i=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const s=this.getSceneInstance(t);if(s){const n=this.currentScene,o=s;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const l={engine:i,previousScene:n,nextScene:o};await this.currentScene._deactivate(l),this.currentScene.events.emit("deactivate",new Xn(l,this.currentScene)),this.currentScene.input.clear()}const a=this._sceneToLoader.get(t);await(a==null?void 0:a.areResourcesLoaded()),this.currentScene=o,this.currentSceneName=t,i.screen.setCurrentCamera(o.camera),await this.currentScene._initialize(i);const h={engine:i,previousScene:n,nextScene:o,data:e};await this.currentScene._activate(h),this.currentScene.events.emit("activate",new Gn(h,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,e,i){const s=this.getSceneDefinition(e),n=this.getSceneDefinition(i);this.events.emit(t,{sourceScene:s,sourceName:e,destinationScene:n,destinationName:i})}}function Aa(){const r={scope:(t,e)=>{const i=r.value;r.value=t;try{return e()}catch(s){throw s}finally{r.value=i}},value:void 0};return r}function Ta(r){return r.value}const fn={textureCollectInterval:6e4};class Sa{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=e=>{if(this._running){for(const[i,[s,n]]of this._collectors.entries()){const o=this.options.getTimestamp();for(const[a,[h,l]]of this._collectionMap.entries()){if(i!==h||l+n>=o)continue;s(a)&&this._collectionMap.delete(a)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,e,i){this._collectors.set(t,[i,e])}addCollectableResource(t,e){this._collectionMap.set(e,[t,this.options.getTimestamp()])}touch(t){const e=this._collectionMap.get(t);e&&this._collectionMap.set(t,[e[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[e]]of this._collectors.entries())for(const[i]of this._collectionMap.entries())e(i)&&this._collectionMap.delete(i)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}jr();const cl={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Re;(function(r){r[r.None=0]="None",r[r.Canvas=1]="Canvas",r[r.All=2]="All"})(Re||(Re={}));class Wt{static useEngine(){const t=Ta(Wt.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,i,s,n,o,a,h,l,c;this.scope=P=>Wt.Context.scope(this,P),this.version=_n,this.events=new nt,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=P=>{k.getInstance().fatal(P,P.stack)},this._toaster=new Ca,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=P=>{var S;P.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",P);const F=document.createElement("div");F.id="ex-webgl-graphics-context-lost",F.style.position="absolute",F.style.zIndex="99",F.style.left="50%",F.style.top="50%",F.style.display="flex",F.style.flexDirection="column",F.style.transform="translate(-50%, -50%)",F.style.backgroundColor="white",F.style.padding="10px",F.style.borderStyle="solid 1px";const A=document.createElement("div");if(A.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,F.appendChild(A),!((S=this.canvas)===null||S===void 0)&&S.parentElement){this.canvas.parentElement.appendChild(F);const L=A.querySelector("#ex-webgl-graphics-reload");L==null||L.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new Zt,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...Wt._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Tt.freeze(),this.browser=new va(window,document);const d=new _o;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=d.test())){const P=document.createElement("div");if(P.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(P),d.failedTests.forEach(function(S){const F=document.createElement("div");F.innerText="Browser feature missing "+S,document.body.appendChild(F)}),t.canvasElementId){const S=document.getElementById(t.canvasElementId);S&&S.parentElement.removeChild(S)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${_n})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=k.getInstance(),this._logger.defaultLevel===mt.Debug&&d.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...fn}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...fn,...t.garbageCollection},this._garbageCollector=new Sa({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",P=>{P.preventDefault()});let f=(e=t.displayMode)!==null&&e!==void 0?e:xt.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(f=xt.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),f=xt.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=f;let _,g,v,C,m,w;typeof t.antialiasing=="object"?{pixelArtSampler:_,nativeContextAntialiasing:v,multiSampleAntialiasing:w,filtering:m,canvasImageRendering:C}={...t.pixelArt?xa:wa,...t.antialiasing}:(_=!!t.pixelArt,v=!1,w=t.antialiasing,C=t.antialiasing?"auto":"pixelated",m=t.antialiasing?gt.Blended:gt.Pixel),v&&w&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(g=.25),(!t.antialiasing||m===gt.Pixel)&&(g=0),g=(s=(i=t.uvPadding)!==null&&i!==void 0?i:g)!==null&&s!==void 0?s:.01;let T=Tt.isEnabled("use-canvas-context");if(!T)try{this.graphicsContext=new ye({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:_,antialiasing:v,multiSampleAntialiasing:w,uvPadding:g,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(n=t.handleContextLost)!==null&&n!==void 0?n:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(P){this._logger.warn(`Excalibur could not load webgl for some reason (${P.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),T=!0}T&&(this.graphicsContext=new gs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:v,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new Js({canvas:this.canvas,context:this.graphicsContext,antialiasing:v,canvasImageRendering:C,browser:this.browser,viewport:(o=t.viewport)!==null&&o!==void 0?o:t.width&&t.height?{width:t.width,height:t.height}:Ks.SVGA,resolution:t.resolution,displayMode:f,pixelRatio:t.suppressHiDPIScaling?1:(a=t.pixelRatio)!==null&&a!==void 0?a:null}),ot.filtering=m,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(h=t.maxFps)!==null&&h!==void 0?h:this.maxFps,this.fixedUpdateTimestep=(l=t.fixedUpdateTimestep)!==null&&l!==void 0?l:this.fixedUpdateTimestep,this.fixedUpdateFps=(c=t.fixedUpdateFps)!==null&&c!==void 0?c:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new mr({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:P=>this.onFatalException(P)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...Ce(),enabled:t.physics}:(this.physics={...Ce()},rs(this.physics,t.physics)),this.debug=new ma(this),this.director=new Pa(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,Wt.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:e,showPlayerMessage:i}=this._originalOptions.configurePerformanceCanvas2DFallback;if(e===void 0&&(e=Wt._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),i===void 0&&(i=Wt._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Tt.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===e.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let s=0;for(let o=0;o<this._fpsSamples.length;o++)s+=this._fpsSamples[o];const n=s/this._fpsSamples.length;this._fpsSamples.length===e.numberOfFrames&&n<=e.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),i&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,e,i;const s=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(s,this.canvas),this.canvas=s;const n={...this._originalOptions,antialiasing:this.screen.antialiasing},o=this._originalDisplayMode;this.graphicsContext=new gs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:n.antialiasing,backgroundColor:n.backgroundColor,snapToPixel:n.snapToPixel,useDrawSorting:n.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Js({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=n.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(e=n.viewport)!==null&&e!==void 0?e:n.width&&n.height?{width:n.width,height:n.height}:Ks.SVGA,resolution:n.resolution,displayMode:o,pixelRatio:n.suppressHiDPIScaling?1:(i=n.pixelRatio)!==null&&i!==void 0?i:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const a=n&&n.pointerScope===je.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(a,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,Wt.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){k.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,e){return this.director.add(t,e),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const e=this.director.getDeferredScene();e instanceof Yt?e.add(t):this.currentScene.add(t)}remove(t){t instanceof Bt&&this.currentScene.remove(t),(t instanceof Yt||ae(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,e){await this.scope(async()=>{await this.director.goToScene(t,e)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var e,i;this.pageScrollPreventionMode=t.scrollPreventionMode;const s=t&&t.pointerScope===je.Document?document:this.canvas,n=(i=(e=this._originalOptions)===null||e===void 0?void 0:e.grabWindowFocus)!==null&&i!==void 0?i:!0;this.input=new pr({pointerTarget:s,grabWindowFocus:n,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Nn(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new On(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new wi(t,this)),this._isInitialized=!0)}_update(t){var e;if(this._isLoading){(e=this._loader)===null||e===void 0||e.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new Be(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,e){}_postupdate(t){this.emit("postupdate",new ke(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,e){}_draw(t){var e,i;if(this.graphicsContext.backgroundColor=(e=this.currentScene.backgroundColor)!==null&&e!==void 0?e:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((i=this._loader)===null||i===void 0||i.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,e){this.emit("predraw",new mi(t,e,this)),this.onPreDraw(t,e)}onPreDraw(t,e){}_postdraw(t,e){this.emit("postdraw",new vi(t,e,this)),this.onPostDraw(t,e)}onPostDraw(t,e){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,e){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let i;return t instanceof Ei?i=t:typeof t=="string"&&(this.director.configureStart(t,e),i=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(i??new Ke),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new In(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new kn(this,this.stats.prevFrame));const e=t*this.timescale;this.currentFrameElapsedMs=e;const i=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=i,this.stats.currFrame.elapsedMs=e,this.stats.currFrame.fps=this.clock.fpsSampler.fps,st.clear();const s=this.clock.now(),n=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=e;this._lagMs>=n;)this._update(n),this._lagMs-=n;else this._update(e);const o=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(e);const a=this.clock.now();this.stats.currFrame.duration.update=o-s,this.stats.currFrame.duration.draw=a-o,this.stats.currFrame.graphics.drawnImages=st.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=st.DrawCallCount,this.emit("postframe",new Ln(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Rn(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(i=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:i})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const e=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,i=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,s=document.createElement("canvas");s.width=e,s.height=i;const n=s.getContext("2d");n.imageSmoothingEnabled=this.screen.antialiasing,n.drawImage(this.canvas,0,0,e,i);const o=new Image,a=s.toDataURL("image/png");o.onload=()=>{t.resolve(o)},o.src=a}this._screenShotRequests.length=0}async load(t,e=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=e,t instanceof Ke&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(i){this._logger.error("Error loading resources, things may not behave properly",i),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}Wt.Context=Aa();Wt.InstanceCount=0;Wt._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:je.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Re.Canvas,backgroundColor:E.fromHex("#2185d0")};class dl extends Ut{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new Ze,this._text=new Ni({text:"",font:this._font});const{text:e,pos:i,x:s,y:n,spriteFont:o,font:a,color:h,maxWidth:l}={text:"",...t};this.pos=i??(s&&n?b(s,n):this.pos),this.text=e??this.text,this.font=a??this.font,this.maxWidth=l??this.maxWidth,this.spriteFont=o??this.spriteFont,this._text.color=h??this.color;const c=this.get(lt);c.anchor=p.Zero,c.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Me;(function(r){r.Circle="circle",r.Rectangle="rectangle"})(Me||(Me={}));class ul extends Ut{constructor(t){var e,i;super({width:(e=t.width)!==null&&e!==void 0?e:0,height:(i=t.height)!==null&&i!==void 0?i:0}),this._particlesToEmit=0,this._particlePool=new Ui(()=>new As({}),g=>g,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Me.Rectangle,this.radius=0,this.particle={life:2e3,transform:oe.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:s,x:n,y:o,z:a,pos:h,isEmitting:l,emitRate:c,emitterType:d,radius:f,random:_}={...t};this.particle={...this.particle,...s},this.pos=h??b(n??0,o??0),this.z=a??0,this.isEmitting=l??this.isEmitting,this.emitRate=c??this.emitRate,this.emitterType=d??this.emitterType,this.radius=f??this.radius,this.body.collisionType=H.PreventCollision,this.random=_??new fi}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var e;if(!(t<=0)){t=t|0;for(let i=0;i<t;i++){const s=this._createParticle();!((e=this===null||this===void 0?void 0:this.scene)===null||e===void 0)&&e.world&&(this.particle.transform===oe.Global?this.scene.world.add(s):this.addChild(s)),this._activeParticles.push(s)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,e=0;const i=he(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),s=he(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),n=this.particle.startSize||he(this.particle.minSize||5,this.particle.maxSize||5,this.random),o=s*Math.cos(i),a=s*Math.sin(i);if(this.emitterType===Me.Rectangle)t=he(0,this.width,this.random),e=he(0,this.height,this.random);else if(this.emitterType===Me.Circle){const l=he(0,this.radius,this.random);t=l*Math.cos(i),e=l*Math.sin(i)}const h=this._particlePool.rent();return h.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:b(t,e),vel:b(o,a),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:n,graphic:this.particle.graphic,fade:this.particle.fade}),h.registerEmitter(this),this.particle.randomRotation&&(h.transform.rotation=he(0,Math.PI*2,this.random)),this.particle.focus&&(h.focus=this.particle.focus.add(b(this.pos.x,this.pos.y)),h.focusAccel=this.particle.focusAccel),h}update(t,e){var i;super.update(t,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let s=0;s<this.deadParticles.length;s++){!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.scene.world.remove(this.deadParticles[s],!1),this._particlePool.return(this.deadParticles[s]));const n=this._activeParticles.indexOf(this.deadParticles[s]);n>-1&&this._activeParticles.splice(n,1)}this.deadParticles.length=0}}function fl(r,t){}class ws{constructor(t,e,i){var s;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=i,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=e,this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,e){if(this._initialized)return;const i=this.emitter.maxParticles,s=this._numInputFloats,n=this._particleData,o=4,a=t.createBuffer(),h=t.createVertexArray();t.bindVertexArray(h),t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,i*s*o,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,n);let l=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,s*o,0),l+=o*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,s*o,l),l+=o*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,s*o,l),l+=o*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,s*o,l),l+=o*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,s*o,l),l+=o*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(h),this._buffers.push(a),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const c=t.createBuffer(),d=t.createVertexArray();t.bindVertexArray(d),t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,i*s*o,t.DYNAMIC_DRAW),l=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,s*o,0),l+=o*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,s*o,l),l+=o*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,s*o,l),l+=o*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,s*o,l),l+=o*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,s*o,l),l+=o*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(d),this._buffers.push(c),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const e=this._particleIndex,i=this.maxParticles*this._numInputFloats,s=t*this._numInputFloats+e;for(let n=e;n<s;n+=this._numInputFloats){const o=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||vt),a=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),h=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),l=a*Math.cos(o),c=h*Math.sin(o);let d=0,f=0;if(this.emitter.emitterType===Me.Rectangle)d=this._random.floating(-.5,.5)*this.emitter.width,f=this._random.floating(-.5,.5)*this.emitter.height;else{const v=this._random.floating(0,this.emitter.radius);d=v*Math.cos(o),f=v*Math.sin(o)}const _=this.emitter.transform.apply(b(d,f)),g=[this.particle.transform===oe.Local?d:_.x,this.particle.transform===oe.Local?f:_.y,l,c,this.particle.randomRotation?he(0,vt,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(g,n%this._particleData.length)}s>=i?(this._wrappedParticles+=(s-i)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=s%i,this._emitted.push([this._particleLife,e])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var e;if(this._particleLife=(e=this.particle.life)!==null&&e!==void 0?e:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let i=this._emitted.length-1;i>=0;i--){const s=this._emitted[i];s[0]-=t,s[0]<=0&&this._emitted.splice(i,1)}this._emitted.sort((i,s)=>i[0]-s[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const e=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-e)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,e,this.maxParticles-e),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,e),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}ws.GPU_MAX_PARTICLES=1e5;class _l extends Ut{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:oe.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new lt,this.isEmitting=!1,this.emitRate=1,this.emitterType=Me.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:e,maxParticles:i,x:s,y:n,z:o,pos:a,isEmitting:h,emitRate:l,emitterType:c,radius:d,random:f}={...t};this.maxParticles=X(i??this.maxParticles,0,ws.GPU_MAX_PARTICLES),this.pos=a??b(s??0,n??0),this.z=o??0,this.isEmitting=h??this.isEmitting,this.emitRate=l??this.emitRate,this.emitterType=c??this.emitterType,this.radius=d??this.radius,this.particle={...this.particle,...e},this.random=f??new fi,this.renderer=new ws(this,this.random,this.particle)}_initialize(t){super._initialize(t);const e=t.graphicsContext;this.renderer.initialize(e.__gl,e)}update(t,e){super.update(t,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(e)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,e){t.draw("ex.particle",this.renderer,e)}}class Ea extends Bt{getGraphics(){return this._graphics}addGraphic(t,e){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,e!=null&&e.offset&&(this._gfx.offset=e.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const e of this._graphics){const i=b(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:e.height-this.map.tileHeight));t=t.combine(e.localBounds.translate(i))}return t}removeGraphic(t){const e=this._graphics.indexOf(t);e>-1&&this._graphics.splice(e,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(b(this.x,this.y))}get center(){return this.pos.add(b(0,this.map.tileHeight/2))}constructor(t,e,i,s){super([new D,new lt({offset:i??p.Zero,onPostDraw:(f,_)=>this.draw(f,_)}),new Di(s)]),this.solid=!1,this.events=new nt,this._tileBounds=new B,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=e,this.map=s,this._transform=this.get(D),this._isometricEntityComponent=this.get(Di);const n=this.map.tileWidth/2,o=this.map.tileHeight/2,a=(this.x-this.y)*n,h=(this.x+this.y)*o;this._transform.pos=b(a,h),this._isometricEntityComponent.elevation=s.elevation,this._gfx=this.get(lt),this._gfx.isVisible=!1;const l=this.map.tileWidth,c=this.map.tileHeight,d=b(0,this.map.renderFromTopOfGraphic?c:0);this._gfx.localBounds=this._tileBounds=new B({left:-l/2,top:-c,right:l/2,bottom:c}).translate(d)}draw(t,e){const i=this.map.tileWidth/2;t.save(),t.translate(-i,0);for(const s of this._graphics)s.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));t.restore()}}class pl extends Bt{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new D,new V({type:H.Fixed}),new pt,new De,new Rs((c,d)=>this.debug(c,d),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=b(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:e,tileWidth:i,tileHeight:s,columns:n,rows:o,renderFromTopOfGraphic:a,graphicsOffset:h,elevation:l}=t;this.transform=this.get(D),e&&(this.transform.pos=e),this.collider=this.get(pt),this.collider&&this.collider.set(this._composite=new yt([])),this.pointer=this.get(De),this.renderFromTopOfGraphic=a??this.renderFromTopOfGraphic,this.graphicsOffset=h??this.graphicsOffset,this.elevation=l??this.elevation,this.tileWidth=i,this.tileHeight=s,this.columns=n,this.rows=o,this._pointerEventDispatcher=new ar,this.tiles=new Array(n*o);for(let c=0;c<o;c++)for(let d=0;d<n;d++){const f=new Ea(d,c,this.graphicsOffset,this);this.tiles[d+c*n]=f,this.addChild(f),this._pointerEventDispatcher.addObject(f,_=>this.getTileByPoint(_.worldPos)===f,()=>!0)}this.pointer.localBounds=B.fromDimension(i*n*this.transform.scale.x,s*o*this.transform.scale.y,b(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var e;if(this._originalOffsets.has(t))return(e=this._originalOffsets.get(t))!==null&&e!==void 0?e:p.Zero;{const i=t.offset;return this._originalOffsets.set(t,i),i}}updateColliders(){this._composite.clearColliders();const t=this.get(D).pos;for(const e of this.tiles)if(e.solid)for(const i of e.getColliders()){const s=this._getOrSetColliderOriginalOffset(i);i.offset=this.tileToWorld(b(e.x,e.y)).sub(t).add(s).sub(b(this.tileWidth/2,this.tileHeight)),i.owner=this,this._composite.addCollider(i)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const e=this.tileWidth/2,i=this.tileHeight/2;return b(~~((t.x/e+t.y/i)/2),~~((t.y/i-t.x/e)/2))}tileToWorld(t){const e=this.tileWidth/2,i=this.tileHeight/2,s=(t.x-t.y)*e,n=(t.x+t.y)*i;return b(s,n).add(this.transform.pos)}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){const e=this.worldToTile(t);return this.getTile(e.x,e.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const e of this.tiles){const i=e.get(D).z;i>t&&(t=i)}return t}debug(t,e){const{showAll:i,showPosition:s,positionColor:n,positionSize:o,showGrid:a,gridColor:h,gridWidth:l,showColliderGeometry:c}=e.isometric,{geometryColor:d,geometryLineWidth:f,geometryPointSize:_}=e.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,i||a){for(let g=0;g<this.rows+1;g++){const v=this.tileToWorld(b(0,g)),C=this.tileToWorld(b(this.columns,g));t.drawLine(v,C,h,l)}for(let g=0;g<this.columns+1;g++){const v=this.tileToWorld(b(g,0)),C=this.tileToWorld(b(g,this.rows));t.drawLine(v,C,h,l)}}if(i||s)for(const g of this.tiles)t.drawCircle(this.tileToWorld(b(g.x,g.y)),o,n);if(i||c){for(const g of this.tiles)if(g.solid)for(const v of g.getColliders())v.debug(t,d,{lineWidth:f,pointSize:_})}t.restore()}}class vr{constructor(t,e){this.id=J(),this._stopped=!1,this._sequenceBuilder=e,this._sequenceContext=new Yi(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new vr(t,this._sequenceBuilder)}}class gl{constructor(t){this.id=J(),this._actions=t}update(t){for(let e=0;e<this._actions.length;e++)this._actions[e].update(t)}isComplete(t){return this._actions.every(e=>e.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class ei{constructor(t,e){this.bounds=t,this.options=e,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...e},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new ei(new B({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new ei(new B({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new ei(new B({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new ei(new B({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var e,i,s,n;!((e=this.topLeft)===null||e===void 0)&&e.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((i=this.topRight)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((s=this.bottomLeft)===null||s===void 0)&&s.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((n=this.bottomRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const e of this.items)this._insertIntoSubNodes(e);this.items.length=0}}remove(t){var e,i,s,n;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const o=this.items.indexOf(t);o>-1&&this.items.splice(o,1);return}!((e=this.topLeft)===null||e===void 0)&&e.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((i=this.topRight)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((s=this.bottomLeft)===null||s===void 0)&&s.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((n=this.bottomRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let e=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(e=e.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(e=e.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(e=e.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(e=e.concat(this.bottomRight.query(t)))),e=e.filter((i,s)=>e.indexOf(i)>=s),e}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((e,i)=>t.indexOf(e)>=i),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,E.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,E.Yellow),this.topRight.bounds.draw(t,E.Yellow),this.bottomLeft.bounds.draw(t,E.Yellow),this.bottomRight.bounds.draw(t,E.Yellow))}}function ml(r){return!!r._initialize}function vl(r){return!!r.onAdd}function wl(r){return!!r.onRemove}function xl(r){return!!r.onInitialize}function bl(r){return!!r._preupdate}function yl(r){return!!r.onPreUpdate}function Cl(r){return!!r.onPostUpdate}function Pl(r){return!!r.onPostUpdate}function Al(r){return!!r.onAdd}function Tl(r){return!!r.onRemove}function Sl(r){return!!r.onPreDraw}function El(r){return!!r.onPostDraw}class Il{constructor(t,e=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Hi(t,"arraybuffer",e)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new Ia(t),this._gif=new Ra(this._stream);const e=this._gif.images.map(i=>new ce(i.src,!1));return await Promise.all(e.map(i=>i.load())),this.data=this._images=e,this._sprites=this._images.map(i=>i.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var e;return(e=this._sprites[t])!==null&&e!==void 0?e:null}toSpriteSheet(){const t=this._sprites;return t.length?new Ge({sprites:t}):null}toAnimation(t){var e;const i=(e=this._gif)===null||e===void 0?void 0:e.images;if(i!=null&&i.length){const s=i.map((n,o)=>{var a;return{graphic:this._sprites[o],duration:((a=this._gif)===null||a===void 0?void 0:a.frames[o].delayMs)||void 0}});return this._animation=new te({frames:s,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,e;return(e=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&e!==void 0?e:[]}}const Ki=r=>r.reduce(function(t,e){return t*2+e},0),qs=r=>{const t=[];for(let e=7;e>=0;e--)t.push(!!(r&1<<e));return t};class Ia{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=e=>{const i=[];for(let s=0;s<e;s++)i.push(this.readByte());return i},this.read=e=>{let i="";for(let s=0;s<e;s++)i+=String.fromCharCode(this.readByte());return i},this.readUnsigned=()=>{const e=this.readBytes(2);return(e[1]<<8)+e[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const Rl=function(r,t){let e=0;const i=function(f){let _=0;for(let g=0;g<f;g++)t.charCodeAt(e>>3)&1<<(e&7)&&(_|=1<<g),e++;return _},s=[],n=1<<r,o=n+1;let a=r+1,h=[];const l=function(){h=[],a=r+1;for(let f=0;f<n;f++)h[f]=[f];h[n]=[],h[o]=null};let c=0,d=0;for(;;){if(d=c,c=i(a),c===n){l();continue}if(c===o)break;if(c<h.length)d!==n&&h.push(h[d].concat(h[c][0]));else{if(c!==h.length)throw new Error("Invalid LZW code.");h.push(h[d].concat(h[d][0]))}s.push.apply(s,h[c]),h.length===1<<a&&a<12&&a++}return s};class Ra{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=e=>{const i=[];for(let s=0;s<e;s++){const n=this._st.readBytes(3);i.push(n)}return i},this.readSubBlocks=()=>{let e,i;i="";do e=this._st.readByte(),i+=this._st.read(e);while(e!==0);return i},this.parseHeader=()=>{const e={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(e.sig=this._st.read(3),e.ver=this._st.read(3),e.sig!=="GIF")throw new Error("Not a GIF file.");e.width=this._st.readUnsigned(),e.height=this._st.readUnsigned(),this._currentFrameCanvas.width=e.width,this._currentFrameCanvas.height=e.height;const i=qs(this._st.readByte());e.gctFlag=i.shift(),e.colorResolution=Ki(i.splice(0,3)),e.sortedFlag=i.shift(),e.globalColorTableSize=Ki(i.splice(0,3)),e.backgroundColorIndex=this._st.readByte(),e.pixelAspectRatio=this._st.readByte(),e.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<e.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(e)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=e=>{const i=h=>{this.checkBytes.push(this._st.readByte());const l=qs(this._st.readByte());return h.reserved=l.splice(0,3),h.disposalMethod=Ki(l.splice(0,3)),h.userInputFlag=l.shift(),h.transparentColorFlag=l.shift(),h.delayTime=this._st.readUnsigned(),h.transparentColorIndex=this._st.readByte(),h.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(h)&&this.checkBytes.push(this._handler.gce),h},s=h=>{h.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(h)&&this.checkBytes.push(this._handler.com)},n=h=>{this.checkBytes.push(this._st.readByte()),h.ptHeader=this._st.readBytes(12),h.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(h)&&this.checkBytes.push(this._handler.pte)},o=h=>{const l=d=>{this.checkBytes.push(this._st.readByte()),d.unknown=this._st.readByte(),d.iterations=this._st.readUnsigned(),d.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(d)&&this.checkBytes.push(this._handler.app)},c=d=>{d.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[d.identifier]&&this._handler.app[d.identifier](d)&&this.checkBytes.push(this._handler.app[d.identifier])};switch(this.checkBytes.push(this._st.readByte()),h.identifier=this._st.read(8),h.authCode=this._st.read(3),h.identifier){case"NETSCAPE":l(h);break;default:c(h);break}},a=h=>{h.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(h)&&this.checkBytes.push(this._handler.unknown)};switch(e.label=this._st.readByte(),e.label){case 249:e.extType="gce",this._gce=i(e);break;case 254:e.extType="com",s(e);break;case 1:e.extType="pte",n(e);break;case 255:e.extType="app",o(e);break;default:e.extType="unknown",a(e);break}},this.parseImg=e=>{var i;const s=(a,h)=>{const l=new Array(a.length),c=a.length/h,d=(v,C)=>{const m=a.slice(C*h,(C+1)*h);l.splice.apply(l,[v*h,h].concat(m))},f=[0,4,2,1],_=[8,8,4,2];let g=0;for(let v=0;v<4;v++)for(let C=f[v];C<c;C+=_[v])d(C,g),g++;return l};e.leftPos=this._st.readUnsigned(),e.topPos=this._st.readUnsigned(),e.width=this._st.readUnsigned(),e.height=this._st.readUnsigned();const n=qs(this._st.readByte());e.lctFlag=n.shift(),e.interlaced=n.shift(),e.sorted=n.shift(),e.reserved=n.splice(0,2),e.lctSize=Ki(n.splice(0,3)),e.lctFlag&&(e.lctBytes=this.parseColorTableBytes(1<<e.lctSize+1)),e.lzwMinCodeSize=this._st.readByte();const o=this.readSubBlocks();e.pixels=Rl(e.lzwMinCodeSize,o),e.interlaced&&(e.pixels=s(e.pixels,e.width)),!((i=this._gce)===null||i===void 0)&&i.delayTime&&(e.delayMs=this._gce.delayTime*10),this.frames.push(e),this.arrayToImage(e,e.lctFlag?e.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(e)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const e={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(e.sentinel)){case"!":e.type="ext",this.parseExt(e);break;case",":e.type="img",this.parseImg(e);break;case";":e.type="eof",this._handler.eof&&this._handler.eof(e)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}e.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(e,i)=>{var s,n,o,a;const h=document.createElement("canvas");h.width=e.width,h.height=e.height;const l=h.getContext("2d"),c=l.getImageData(0,0,h.width,h.height);let d=-1;!((s=this._gce)===null||s===void 0)&&s.transparentColorFlag&&(d=this._gce.transparentColorIndex);for(let _=0;_<e.pixels.length;_++){const g=e.pixels[_],v=i[g];g===d?c.data.set([0,0,0,0],_*4):c.data.set([...v,255],_*4)}if(l.putImageData(c,0,0),((n=this._gce)===null||n===void 0?void 0:n.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((o=this._gce)===null||o===void 0?void 0:o.disposalMethod)===2&&(!((a=this._hdr)===null||a===void 0)&&a.gctFlag)){const _=i[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${_[0]}, ${_[1]}, ${_[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(h,e.leftPos,e.topPos,e.width,e.height);const f=new Image;f.src=this._currentFrameCanvas.toDataURL(),this.images.push(f)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class Ml{constructor(t,e,{bustCache:i,...s}={}){this.path=t,this.family=e,this._isLoaded=!1,this._resource=new Hi(t,"blob",i),this._options=s}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),e=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${e})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new Ze({family:this.family,...this._options,...t})}}const Xr=Aa(),Dl=/^\s*(?:function)?\*/;function Vr(r){return typeof r!="function"?!1:Dl.test(Function.prototype.toString.call(r))?!0:Object.getPrototypeOf?Object.getPrototypeOf(r)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function Ma(...r){var t;const e=k.getInstance();let i,s,n,o;Vr(r[0])&&(s=globalThis,i=r[0],n=r[1]),Vr(r[1])&&(s=r[0],i=r[1],n=r[2]),r[1]instanceof Wt&&(s=r[0],o=r[1],i=r[2],n=r[3]),r[0]instanceof Wt&&(s=globalThis,o=r[0],i=r[1],n=r[2]);const a=Ta(Xr),h=n==null?void 0:n.timing,l=a?!1:(t=n==null?void 0:n.autostart)!==null&&t!==void 0?t:!0;let c;try{c=o??Wt.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let d=!1,f=!1,_=!1;const g=i.bind(s),v=g();let C;const m=new Promise((T,P)=>{C=S=>{try{if(_){f=!0,T();return}const{done:F,value:A}=Xr.scope(!0,()=>v.next(S));if(F||_){f=!0,T();return}A instanceof Promise?A.then(()=>{c.clock.schedule(C,0,h)}):A===void 0||A===void 0?c.clock.schedule(C,0,h):c.clock.schedule(C,A||0,h)}catch(F){P(F);return}},l&&(d=!0,C(c.clock.elapsed()))}),w={isRunning:()=>d&&!_&&!f,isComplete:()=>f,cancel:()=>{_=!0},start:()=>(d?e.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(g)):(d=!0,C(c.clock.elapsed())),w),generator:v,done:m,then:m.then.bind(m),[Symbol.iterator]:()=>v};return w}class zs extends Bt{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var e,i,s,n;super(),this._logger=k.getInstance(),this.transform=new D,this.graphics=new lt,this._completeFuture=new Zt,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(e=t.easing)!==null&&e!==void 0?e:tt.Linear,this.direction=(i=t.direction)!==null&&i!==void 0?i:"out",this.hideLoader=(s=t.hideLoader)!==null&&s!==void 0?s:!1,this.blockInput=(n=t.blockInput)!==null&&n!==void 0?n:!1,this.transform.coordPlane=Et.Screen,this.transform.pos=p.Zero,this.transform.z=1/0,this.graphics.anchor=p.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,e){this.complete||(this._currentDistance+=X(e/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=X(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=X(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new Zt,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,e){const i=e;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),i.world.entityManager.getById(this.id))return this._co;this._engine=t,i.add(this);const s=this;return this._co=Ma(t,function*(){for(;!s.complete;){const n=yield;s.updateTransition(s._engine,n),s._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class Fl extends zs{constructor(t){var e,i;super({...t,duration:(e=t.duration)!==null&&e!==void 0?e:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(i=t.color)!==null&&i!==void 0?i:E.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new Xi({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class Bl extends zs{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=ce.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=b(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class kl extends zs{constructor(t){var e;super({direction:"in",...t}),this._easing=tt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=Et.World,this.graphics.forceOnScreen=!0,this._easing=(e=t.easingFunction)!==null&&e!==void 0?e:this._easing,this._vectorEasing=tt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=ce.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=b(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=b(0,t.screen.resolution.height);break}case"left":{this._directionOffset=b(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=b(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=b(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class wr extends ht{constructor(t){super(),this.color=E.Black,this.thickness=1;const{start:e,end:i,color:s,thickness:n}=t;this.start=e,this.end=i,this.color=s??this.color,this.thickness=n??this.thickness,this._localBounds=this._calculateBounds();const{width:o,height:a}=this._localBounds;this.width=o,this.height=a}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),e=this.thickness/2,i=[this.start.add(t.scale(e)),this.end.add(t.scale(e)),this.end.add(t.scale(-e)),this.start.add(t.scale(-e))];return B.fromPoints(i)}_drawImage(t,e,i){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new wr({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class xr extends gi{get points(){return this._points}set points(t){this._points=t;const e=this.minPoint;this.width=this._points.reduce((i,s)=>Math.max(s.x,i),0)-e.x,this.height=this._points.reduce((i,s)=>Math.max(s.y,i),0)-e.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((i,s)=>Math.min(s.x,i),1/0),e=this._points.reduce((i,s)=>Math.min(s.y,i),1/0);return b(t,e)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=gt.Blended,this.rasterize()}clone(){return new xr({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const e=this.minPoint.negate(),i=this.points[0].add(e);t.moveTo(i.x,i.y),this.points.forEach(s=>{t.lineTo(s.x+e.x,s.y+e.y)}),t.lineTo(i.x,i.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var we;(function(r){r.Stretch="stretch",r.Tile="tile",r.TileFit="tile-fit"})(we||(we={}));class br extends ht{constructor(t){super(t),this._logger=k.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,e=!1){this._config.width=t,e&&this._initialize()}setTargetHeight(t,e=!1){this._config.height=t,e&&this._initialize()}setMargins(t,e,i,s,n=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=e,this._config.sourceConfig.rightMargin=i,this._config.sourceConfig.bottomMargin=s,n&&this._initialize()}setStretch(t,e,i=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=e:t==="vertical"?this._config.destinationConfig.verticalStretch=e:(this._config.destinationConfig.horizontalStretch=e,this._config.destinationConfig.verticalStretch=e),i&&this._initialize()}getConfig(){return this._config}_drawTile(t,e,i,s,n,o,a){const h=o||0,l=a||0;let c,d,f,_;const g=this._getNumberOfTiles(e.width,i.x,s),v=this._getNumberOfTiles(e.height,i.y,n);for(let C=0;C<g;C++)for(let m=0;m<v;m++){let{tempSize:w,tempPosition:T}=this._calculateParams(C,g,e.width,i.x,this._config.destinationConfig.horizontalStretch);c=w,d=T,{tempSize:w,tempPosition:T}=this._calculateParams(m,v,e.height,i.y,this._config.destinationConfig.verticalStretch),f=w,_=T,t.drawImage(e,0,0,e.width,e.height,h+d,l+_,c,f)}}_drawImage(t,e,i){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new p(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new p(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new p(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new p(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new p(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new p(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new p(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new p(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new p(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t==null||t.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const e=this._canvasB.getContext("2d");e==null||e.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const i=this._canvasC.getContext("2d");i==null||i.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const s=this._canvasD.getContext("2d");s==null||s.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const n=this._canvasE.getContext("2d");n==null||n.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasF.getContext("2d");o==null||o.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const a=this._canvasG.getContext("2d");a==null||a.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const h=this._canvasH.getContext("2d");h==null||h.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const l=this._canvasI.getContext("2d");l==null||l.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new br(this._config)}_getNumberOfTiles(t,e,i){switch(i){case we.Stretch:return 1;case we.Tile:return Math.ceil(e/t);case we.TileFit:return Math.ceil(e/t)}}_calculateParams(t,e,i,s,n){switch(n){case we.Stretch:return{tempPosition:0,tempSize:s};case we.Tile:return t===e-1?{tempPosition:t*i,tempSize:i-(e*i-s)}:{tempPosition:t*i,tempSize:i};case we.TileFit:const o=s/e;return{tempPosition:t*o,tempSize:o}}}}class yr extends te{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new Zt,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const e=[];for(let i=0;i<this.frames.length;i++){const s=this.frames[i].graphic;if(s&&s instanceof ie){const n=new Wi({image:s.image,width:t.width,height:t.height,sourceView:{...s.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[i].graphic=n,n.ready.then(()=>{n.sourceView={...n.sourceView,...this._sourceView}}),e.push(n.ready)}}Promise.all(e).then(()=>this._ready.resolve())}static fromAnimation(t,e){return new yr({width:t.width,height:t.height,...e,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const e=this.frames[t].graphic;e&&e instanceof ie&&(e.sourceView={...e.sourceView,...this._sourceView})}}get sourceView(){return ee(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=ee(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const e=this.frames[t].graphic;e&&e instanceof ie&&(e.sourceView.height=this._tiledHeight||e.height,e.destSize.height=this._tiledHeight||e.height,e.sourceView.width=this._tiledWidth||e.width,e.destSize.width=this._tiledWidth||e.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const Da=5,li={},Ll=()=>{for(const r in li)li[r]=0},Ji=(r,t)=>{const e=Tt.isEnabled("suppress-obsolete-message");li[r]<Da&&!e&&(k.getInstance().warn(r),console.trace&&t.showStackTrace&&console.trace()),li[r]++};function zl(r){return r={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...r},function(t,e,i){if(i&&!(typeof i.value=="function"||typeof i.get=="function"||typeof i.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const n=`${`${t.name||""}${t.name&&e?".":""}${e||""}`} is marked obsolete: ${r.message}`+(r.alternateMethod?` Use ${r.alternateMethod} instead`:"");li[n]||(li[n]=0);const o=i?{...i}:t;if(!i){class a extends o{constructor(...l){Ji(n,r),super(...l)}}return a}return i&&i.value?(o.value=function(){return Ji(n,r),i.value.apply(this,arguments)},o):(i&&i.get&&(o.get=function(){return Ji(n,r),i.get.apply(this,arguments)}),i&&i.set&&(o.set=function(){return Ji(n,r),i.set.apply(this,arguments)}),o)}}class Ul{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new Zt;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class Hl{constructor(t){this._count=t,this._waitQueue=new Ul}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const _n="0.30.3";jr();u.eKr;u.yVm;u.a7j;u.U_w;u.JF2;u.htg;u.HXL;u.mcg;var j=u.Agj;u.J3_;u.Wgv;u.u6S;u.x7M;u.X55;u.m3M;u.aE5;u.YJU;u.eZi;u.GNv;var ci=u.Y56;u._0v;u.vhs;u.vrQ;u.Z8b;u.Yfw;u.IcQ;u.kgJ;u.GTT;var jt=u.ypY;u.i7d;u.fQ3;u.HlI;u.jlt;u.VQc;u.zD7;u.AUF;u.JoF;u.MlA;u.PZh;u.qA;u.CrD;var Cr=u.dQK;u.D3r;u.Qpo;u.D9n;u.b6v;u.mvh;var Pt=u.Bpo,xs=u.Q1f;u.IKv;u.fcV;u.Glf;u.uAl;var Fa=u.ElT;u.Z8r;u.QSL;u.sPV;u.nAn;u.zCU;u.QrV;u.fF9;u.Jqv;u.d_u;u.xI8;u.yar;u.SP7;u.oRy;u.f5X;u.V1c;u.Mlx;u.ZiM;u.ZCo;u.J5p;var Us=u.mL_;u.Guw;u.N5j;u.pgY;u.OP3;u.rl5;u.eod;var Wl=u.q5Z;u.YUC;u.saR;u.hvr;u.Qol;u.Wf4;u.JCs;u.gJV;u.fWD;u.Va_;var Ol=u.N$8;u._jQ;u.rxj;u.rhv;u.wCu;u.HAp;u.Zy1;u.bkB;u.wfL;u.sVA;u.$Gs;u.CJ0;u.NWh;u.tWi;u.xAj;u.zWh;var qr=u.i_4;u.iIx;u.Hxo;u.c9e;var Nl=u.KQV;u.weH;u.jXp;u.zzY;var Gl=u.yRQ;u.MtE;u.rPj;u.KLc;u.Fir;u.V5f;u.Xj7;u.Wud;u.FVg;u.g5Y;u.YQB;u.KPb;u.nHK;u.Jrb;u.TX_;u.Olt;u.r3n;u.Fvk;u.gpR;u.vYh;u.hnk;u.D2R;u.n1o;u.h9O;u.X5j;u.p3P;u.RLG;u.fBU;u.Adb;var G=u.bEs;u.wCy;u.CbD;u.x_C;u.pGf;u.ibQ;u.shR;u.Yjk;u._u1;u.OBI;u.klh;u.s3S;var dt=u.D$R;u.xth;var Xl=u.JU7;u.h9x;u.N1A;u.e_k;var Vl=u.aHM;u.tlv;u.Vi9;u.ieR;u.$bb;u.VyI;u.imn;u.uqu;u.QnL;u.vnc;u.wk_;u.GH0;u._1r;u.l0X;u.bT;u.HHX;u.jtW;u.tjk;u.rWe;u.j9l;u.l0$;u.sGJ;u.NVp;u.cPK;u.XoL;u.RmF;u.DXI;u.tCD;u.J3D;u.vCJ;u.e6k;u.f9l;u.v9m;u.yRJ;u.EU6;u.m3O;u.Ryz;u.OxP;u.LEs;u.Ec;u.Pi5;u.gmH;u.tS;u.XxX;u.bCz;u.nYS;u.yiT;u.NHl;u.mO8;u.PXI;u.bn5;u.Ywr;u.cMd;u.Bs6;u.G0k;u.pyn;u.QeM;u.aPX;u.ITP;u.BY0;u.MFw;u.sBn;u.S3L;u.XKQ;u.ESI;u.uxz;u.o8N;u.u_r;u.RlV;u.gVA;u.M_G;u.BpG;u.GRB;u.kM6;u.dO8;u.jgM;u.FWq;u.s3j;u.hlw;u.L0q;u.B7e;u.PGN;u.H_X;u.S_d;u._Tq;u.U7E;u.IOH;var Hs=u.Z58;u.yh2;u.ff$;u.cWi;u.NBt;u.oNz;u.QlU;u.Xey;u.jft;u._r8;u.bTC;u.Mtr;var is=u.ypk;u.mnM;u.q7S;var ql=u.bAZ;u.ABN;u.VK6;u.Hj2;u.Df8;u.oOx;u.kxk;u.DT1;u.FLG;u.qN_;u.Z37;u.FtL;u.Z6X;u.iQT;u.ziO;u.OEF;u.uuE;u.tiv;u.T$Y;u.EYj;var Yl=u.nOB;u.Tap;u.FAs;u.B_P;u.aA5;u.J3s;u.Y0Q;var Ba=u.M4G;u.l$l;u.dLy;u.WZP;u.eB6;u.nFK;u.l9z;u.YOF;u.yhB;u.J0N;var I=u.Miz;u.Bj4;u.Rcs;u.vJ4;u.TqC;u.nM0;u.X1u;u.SpZ;u.DX8;u.Yx$;u.HK4;u.yt5;u.vAR;u.SE$;var Yr=u.qE8;u.Pz7;u.sX_;u.JuI;u.pxT;u.Nl$;u.zDr;u.OwT;u.P$G;u.mHV;u.kEA;u.Fx_;u.WFC;u.vKu;u.aDq;u.jIg;u.UH3;u.AJO;u.U4;u.xAc;u._3Y;u.K6X;u.C1Y;u.Aw1;u.tm8;u.LBV;u.A8$;u.F5e;u.ran;u.c8L;u.o6M;u.hsx;u.l9E;u.aSf;u.CcK;u.nU8;u.td6;u.Zex;u.bkJ;u.mXP;u.vt$;u.hCA;u.pjR;u.U43;u.pSZ;u.y17;u.Ew7;u.hG1;u.jVr;u._SZ;u.xWn;u.ehJ;var jl=u.t6s;u.Eyn;class di extends j{constructor(t,e){super({x:t,y:e,width:R.Ramp.width,height:R.Ramp.height,collisionType:Pt.Fixed}),this.scale=new I(.1,.1),this.graphics.use(R.Ramp.toSprite())}onInitialize(){let t=new Fa([is.Edge(new I(-R.Ramp.width/2,R.Ramp.height/2),new I(R.Ramp.width/2-300,-R.Ramp.height/2)),is.Edge(new I(R.Ramp.width/2-300,-R.Ramp.height/2),new I(R.Ramp.width/2,-R.Ramp.height/2)),is.Edge(new I(R.Ramp.width/2,-R.Ramp.height/2),new I(R.Ramp.width/2,R.Ramp.height/2))]);this.body.bounciness=0,this.body.friction=.5,this.collider.set(t)}}const R={Cryptographer:new G("images/Cryptographer.png"),Terminal:new G("images/Terminal.png"),TerminalRed:new G("images/TerminalRed.png"),TerminalGreen:new G("images/TerminalGreen.png"),ControlPlatform:new G("images/AutoElevator.png"),Platform:new G("images/Platform.png"),ContinuousPlatform:new G("images/Continuous platform.png"),Spikes:new G("images/Spikes.png"),Stone:new G("images/projectile.png"),HookPoint:new G("images/GrapplePoint.png"),Secret:new G("images/SecretHoleWall.png"),PressurePlate:new G("images/PressurePlate.png"),Door:new G("images/LockedDoor.png"),Crate:new G("images/Crate.png"),Border:new G("images/Border.png"),Wall:new G("images/Wall.png"),Background:new G("images/Background.png"),Adventurer:new G("images/Adventurer.png"),MenuBackground:new G("images/MenuBackground.png"),StartButton:new G("images/StartGame.png"),Artifact:new G("images/Artifact.png"),Exit:new G("images/LevelExit.png"),Key:new G("images/Key.png"),Lever:new G("images/Lever.png"),Checkpoint:new G("images/Checkpoint.png"),ActiveCheckpoint:new G("images/ActiveCheckpoint.png"),Dart:new G("images/Dart.png"),DartShooter:new G("images/DartLauncher.png"),Button:new G("images/Target.png"),Ramp:new G("images/Ramp.png"),ControllableDoor:new G("images/ControllableDoor.png"),Elevator:new G("images/Ceiling.png"),CrackedWall:new G("images/CrackedWall.png"),SecretHoleWall:new G("images/SecretHoleWall.png"),BlueBorder:new G("images/BlueBorder.png"),GlowingBlueBorder:new G("images/GlowingBlueBorder.png"),FlatPlatform:new G("images/FlatPlatform.png"),UIArtifact:new G("images/UIArtifact.png"),UIKey:new G("images/UIKey.png")},pn=new Vl;for(let r of Object.values(R))pn.addResource(r);const ka=Cr.create("friends"),gn=Cr.create("platformP"),mn=Cr.create("pressure");class Ws extends j{constructor(t,e,i,s,n){super({width:500,height:500,collisionType:Pt.Fixed,anchor:I.Half}),this.pos=new I(t,e),this.linkedDoor=i,this.gameInstance=s,this.exists=!0,this.scale=new I(.05,.05),this.graphics.use(R.Button.toSprite()),this.scale=new I(.1,.1),this.isActive=!1,this.flipped=n||!1,this.flipped&&(this.graphics.flipHorizontal=!0)}onInitialize(){this.on("collisionstart",t=>{t.other.owner instanceof La&&this.activate()})}activate(){this.linkedDoor.kill()}}class xi extends j{constructor(t,e,i,s){super({x:t,y:e,width:R.Wall.width,height:R.Wall.height,rotation:i,collisionType:Pt.Fixed}),this.scale=new I(s,s),this.graphics.use(R.Wall.toSprite())}}class Je extends j{constructor(t,e){super({x:t,y:e,width:R.Platform.width,height:R.Platform.height,collisionType:Pt.Fixed}),this.z=-1,this.scale=new I(.1,.1),this.graphics.use(R.Platform.toSprite())}}class Ht extends j{constructor(t,e,i){super({pos:new I(t,e),width:R.Door.width,height:R.Door.height,anchor:I.Half,collisionType:Pt.Fixed}),this.graphics.use(R.Door.toSprite()),this.scale=i||new I(.22,.22),this.doorX=t,this.doorY=e,this.z=-1,this.linkedPlates=[]}addLinkedPlate(t){this.linkedPlates.push(t)}shouldReset(){return this.linkedPlates.every(t=>t.exists)}resetDoor(t){const e=new Ht(this.doorX,this.doorY,this.scale);return e.linkedPlates=[...this.linkedPlates],e.linkedPlates.forEach(i=>{i.linkedDoor=e}),t.add(e),e}}class ji extends j{constructor(t,e,i,s,n,o,a,h){super({width:1e3,height:500,collisionType:Pt.Fixed,anchor:I.Half,collisionGroup:mn}),this.pos=new I(t,e),this.graphics.use(R.PressurePlate.toSprite()),this.linkedDoor=i,this.gameInstance=s,this.exists=!0,this.delete=h||!1,this.type=o||!1,this.time=a||0,this.scale=new I(.05,.05),this.rotation=n||0,mn.canCollide(gn),this.linkedDoor&&this.linkedDoor.addLinkedPlate(this)}onInitialize(){this.on("collisionstart",t=>{(t.other.owner instanceof Ft||t.other.owner instanceof It||t.other.owner instanceof fe||t.other.owner instanceof ne)&&this.linkedDoor&&(console.log("Pressure plate activated"),this.linkedDoor.kill(),this.exists=!1),t.other.owner instanceof It&&(t.other.owner.graphics.flipHorizontal?t.other.owner.pos.x-=10:t.other.owner.pos.x+=10),this.on("collisionend",e=>{e.other.owner instanceof Ft||e.other.owner instanceof It||e.other.owner instanceof fe||e.other.owner instanceof ne})}),this.on("collisionend",t=>{if((t.other.owner instanceof Ft||t.other.owner instanceof It||t.other.owner instanceof fe||t.other.owner instanceof ne)&&this.linkedDoor&&!this.exists){if(this.delete)return;if(this.type){const e=new Ba({fcn:()=>{console.log("Timer expired - resetting door"),this.exists=!0,this.linkedDoor.isKilled()&&this.linkedDoor.shouldReset()&&(this.linkedDoor=this.linkedDoor.resetDoor(this.gameInstance))},interval:this.time,repeats:!1});this.gameInstance.add(e),e.start()}else this.exists=!0,this.linkedDoor.isKilled()&&this.linkedDoor.shouldReset()&&(this.linkedDoor=this.linkedDoor.resetDoor(this.gameInstance))}})}}class Fe extends j{constructor(e,i,s,n,o){super({width:R.Spikes.width,height:R.Spikes.height,collisionType:Pt.Fixed});z(this,"respawnX");z(this,"respawnY");this.scale=new I(s,s),this.graphics.use(R.Spikes.toSprite()),this.pos=new I(e,i),this.respawnX=n,this.respawnY=o}}class Vt extends j{constructor(t,e,i){super({x:t,y:e,width:R.ContinuousPlatform.width,height:R.ContinuousPlatform.height,rotation:i,collisionType:Pt.Fixed}),this.z=1,this.scale=new I(.1,.1),this.graphics.use(R.ContinuousPlatform.toSprite())}}class fe extends j{constructor(t,e){super({pos:new I(t,e),width:800,height:600,collisionType:Pt.Active,anchor:I.Half,mass:15}),this.body.limitDegreeOfFreedom.push(Us.Rotation),this.graphics.use(R.Crate.toSprite()),this.scale=new I(.055,.05),this.gravity=7e3,this.isGrounded=!1,this.pushForce=120,this.friction=.85}onInitialize(){this.on("precollision",t=>this.handlePush(t)),this.on("collisionstart",t=>this.handleCollision(t)),this.on("collisionend",t=>this.handleCollision(t)),this.on("exitviewport",t=>this.handleRespawn(t))}handlePush(t){if(t.other.owner instanceof Ft||t.other.owner instanceof It||t.other.owner instanceof ne){const e=t.other.owner,i=e.pos.x-this.pos.x,s=e.pos.y-this.pos.y;if(Math.abs(i)>Math.abs(s)*1.5&&Math.abs(e.vel.x)>50){const n=e.vel.x>0?1:-1;this.vel.x+=n*this.pushForce}}}handleCollision(t){(t.other.owner instanceof Je||t.other.owner instanceof ji||t.other.owner instanceof Fe||t.other.owner instanceof Vt)&&(this.isGrounded=!0,this.vel.y=0)}handleRespawn(t){this.pos=new I(x,y)}onPreUpdate(t,e){super.onPreUpdate(t,e),this.isGrounded||(this.vel.y+=this.gravity*(e/2e3)),this.isGrounded&&(this.vel.x*=this.friction,Math.abs(this.vel.x)<5&&(this.vel.x=0))}}class Os extends j{constructor(t,e){super({x:t,y:e,width:R.Platform.width-450,height:R.Platform.height,collisionType:Pt.Fixed}),this.z=1,this.rotation=.5*Math.PI,this.scale=new I(.15,.15),this.graphics.use(R.CrackedWall.toSprite())}gone(){this.kill()}}var ri;class La extends j{constructor(e,i,s){super({width:500,height:500});$i(this,ri);Gs(this,ri,R.Stone.toSprite()),s===-1&&(Zi(this,ri).flipHorizontal=!0),this.graphics.use(Zi(this,ri)),this.pos=new I(e+(s===1?40:-40),i+15),this.vel=new I(300*s,0),this.scale=new I(.02,.02),this.on("collisionstart",n=>this.hitSomething(n))}hitSomething(e){e.other.owner&&e.other.owner.constructor.name==="Button"&&(e.other.owner.activate(),this.kill()),e.other.owner instanceof Os&&(console.log("hallo"),e.other.owner.kill(),this.kill()),(e.other.owner instanceof xi||e.other.owner instanceof Je||e.other.owner instanceof di||e.other.owner instanceof Ht||e.other.owner instanceof ne||e.other.owner instanceof fe||e.other.owner instanceof Vt&&!(e.other.owner instanceof Ws))&&this.kill()}}ri=new WeakMap;class Li extends j{constructor(t,e,i){super({pos:new I(t,e),width:500,height:500,rotation:i,anchor:I.full}),this.scale=new I(.05,.05),this.grappleRadius=150,this.z=-2}isPlayerInRange(t){return this.pos.distance(t)<=this.grappleRadius}onInitialize(){this.graphics.use(R.HookPoint.toSprite())}}class ui extends j{constructor(e,i,s,n,o,a,h){super({width:1e3,height:500,collisionType:Pt.Fixed});z(this,"x");z(this,"y");z(this,"platform");z(this,"platformX");z(this,"platformY");z(this,"minX");z(this,"maxX");z(this,"minY");z(this,"maxY");z(this,"inverted");this.scale=new I(.05,.05),this.pos=new I(e,i),this.z=2,this.platform=null,this.platformX=s,this.platformY=n,this.minX=0,this.maxX=0,this.minY=o,this.maxY=a,this.onPlatform=!1,this.inverted=h,this.graphics.use(R.PressurePlate.toSprite())}onInitialize(){console.log("inv",this.inverted),this.on("collisionstart",e=>this.handleCollision(e)),this.on("collisionend",e=>this.handleCollisionEnd(e)),this.platform=new ne(this.platformX,this.platformY,this.minX,this.maxX,this.minY,this.maxY),this.platform.graphics.use(R.Elevator.toSprite()),this.platform.collider.useBoxCollider(R.Elevator.width,R.Elevator.height),this.scene.add(this.platform)}onPreUpdate(e){this.onPlatform?this.inverted?this.platform.vel=new I(0,100):this.platform.vel=new I(0,-100):this.inverted?this.platform.vel=new I(0,-100):this.platform.vel=new I(0,100)}handleCollision(e){(e.other.owner instanceof It||e.other.owner instanceof Ft||e.other.owner instanceof fe)&&(this.onPlatform=!0,console.log("onPlatform",this.onPlatform))}handleCollisionEnd(e){(e.other.owner instanceof It||e.other.owner instanceof Ft||e.other.owner instanceof fe)&&(this.onPlatform=!1,console.log("onPlatform",this.onPlatform))}}var bs,za;class Ft extends j{constructor(e,i){super({width:400,height:900,collisionType:Pt.Active,anchor:I.Half,collisionGroup:ka});$i(this,bs);z(this,"sprite");z(this,"controller");this.pos=new I(e,i),this.scale=new I(.08,.08),this.grappling=!1,this.grapplePoint=null,this.grappleSpeed=5,this.grappleCooldown=0,this.grappleMaxCooldown=60,this.jumpForce=-400,this.isGrounded=!1,this.gravity=800,this.body.friction=0,this.controller=null,this.onPlatform=!1,this.recentPlatform=null,this.sprite=R.Adventurer.toSprite(),this.graphics.use(this.sprite),this.body.limitDegreeOfFreedom.push(Us.Rotation),this.showGrappleLine=!1}onInitialize(e){this.on("collisionstart",i=>this.handleCollision(i)),this.on("collisionend",i=>this.collisionEnd(i))}Jump(){this.isGrounded===!0&&!this.grappling&&(this.vel.y=this.jumpForce,this.isGrounded=!1)}handleCollision(e){const s=e.contact.normal;e.other.owner instanceof Fe&&(this.pos.x=e.other.owner.respawnX,this.pos.y=e.other.owner.respawnY),s.y>.5&&((e.other.owner instanceof Je||e.other.owner instanceof ui||e.other.owner instanceof Li||e.other.owner instanceof ji||e.other.owner instanceof fe||e.other.owner instanceof Vt||e.other.owner instanceof ne||e.other.owner instanceof di||e.other.owner instanceof xi||e.other.owner instanceof ui)&&(this.isGrounded=!0,this.vel.y=0),console.log("Hit from above - landing on platform")),e.other.owner instanceof ne?(this.onPlatform=!0,this.recentPlatform=e.other.owner):s.y<-.5?console.log("Hit from below - hitting ceiling"):Math.abs(s.x)>.5&&console.log("Hit from side - wall collision")}collisionEnd(e){e.other.owner instanceof ne&&(this.onPlatform=!1)}activateGrapple(e){this.grappleCooldown<=0&&!this.grappling&&(this.grappling=!0,this.grapplePoint=e.pos.clone(),console.log(`Grappling to: ${this.grapplePoint.toString()}`),this.vel=new I(0,0))}updateGrapple(){if(this.grappling&&this.grapplePoint){const e=this.grapplePoint.sub(this.pos),i=Math.sqrt(e.x*e.x+e.y*e.y);if(i<20){this.grappling=!1,this.grappleCooldown=this.grappleMaxCooldown,this.vel=new I(0,0),this.pos=new I(this.grapplePoint.x,this.grapplePoint.y-50);return}const s=new I(e.x/i,e.y/i),n=Math.min(this.grappleSpeed,i);this.pos=this.pos.add(s.scale(n)),this.vel=new I(0,0)}else this.grappleCooldown>0&&this.grappleCooldown--}updateControlller(e){this.controller={};let i=e.controllers[0];e.controllers[0]===null||e.controllers[0]===void 0?(this.controller.x=0,this.controller.y=0,this.controller.button1=!1,this.controller.button2=!1,this.controller.button3=!1):(this.controller.x=i.getAxes(ci.LeftStickX),this.controller.y=i.getAxes(ci.LeftStickY),this.controller.button1=i.wasButtonPressed(jt.Face1),this.controller.button2=i.wasButtonPressed(jt.Face2),this.controller.button3=i.wasButtonPressed(jt.Face3))}onPreUpdate(e,i){if(super.onPreUpdate(e,i),this.updateGrapple(),this.updateControlller(e),e.input.keyboard.wasPressed(dt.F)||this.controller.button2){const n=this.scene.actors.filter(h=>h instanceof Li);let o=null,a=1/0;n.forEach(h=>{const l=this.pos.distance(h.pos);l<=h.grappleRadius&&l<a&&(a=l,o=h)}),o&&(o.pos.y<this.pos.y?(this.activateGrapple(o),console.log(`Grappling to point at ${o.pos.toString()}, distance: ${a}`)):console.log("Grapple point is below player"))}let s=0;if(this.grappling||((e.input.keyboard.isHeld(dt.Left)||this.controller.x<-.5)&&(s=-100,this.sprite.flipHorizontal=!0),(e.input.keyboard.isHeld(dt.Right)||this.controller.x>.5)&&(s=100,this.sprite.flipHorizontal=!1),(e.input.keyboard.wasPressed(dt.Space)||this.controller.button1)&&this.Jump()),this.recentPlatform&&this.onPlatform&&this.recentPlatform.pos.x<=this.recentPlatform.minX&&(s-=this.recentPlatform.vel.x),this.recentPlatform&&this.onPlatform&&this.recentPlatform.pos.x>=this.recentPlatform.maxX&&(s-=this.recentPlatform.vel.x),this.grappling||(this.vel.y+=this.gravity*(i/1e3)),this.grappling||(this.vel.x=s),(e.input.keyboard.wasPressed(dt.Q)||this.controller.button3)&&Ur(this,bs,za).call(this),this.recentPlatform&&this.recentPlatform.vel.clone(),this.onPlatform&&(!e.input.keyboard.wasPressed(dt.Space)&&!this.controller.button1&&(this.vel.y=0),!e.input.keyboard.isHeld(dt.Left)&&!e.input.keyboard.isHeld(dt.Right)&&this.controller.x===0)){const n=this.recentPlatform.vel.clone().add(this.vel.clone());this.vel=n}}}bs=new WeakSet,za=function(){const e=this.sprite.flipHorizontal?-1:1;this.scene.add(new La(this.pos.x,this.pos.y,e))};class ne extends j{constructor(e,i,s,n,o,a){super({width:R.ControlPlatform.width,height:R.ControlPlatform.height,collisionGroup:gn});z(this,"minX");z(this,"maxX");z(this,"minY");z(this,"maxY");this.pos=new I(e,i),this.scale=new I(.1,.1),this.graphics.use(R.ControlPlatform.toSprite()),this.minX=e-s,this.maxX=e+n,this.minY=i-o,this.maxY=i+a,this.body.useGravity=!1,this.body.mass=1e3,this.body.limitDegreeOfFreedom.push(Us.Rotation),this.body.collisionType=Pt.Active,gn.canCollide(mn)}onPreUpdate(){this.pos.x=Yr(this.pos.x,this.minX,this.maxX),this.pos.y=Yr(this.pos.y,this.minY,this.maxY),this.playerOnPlatform&&(this.playerOnPlatform.pos.x=this.pos.x,this.playerOnPlatform.pos.y=this.pos.y)}}class ss extends Xl{constructor(t,e,i,s,n,o){super({text:i,font:new Nl({family:"Arial",bold:!0,size:s,scale:new I(n,n),unit:Gl.Px,color:xs[o],textAlign:Yl.Center,shadow:{color:xs.Black,blur:5,offset:new I(10,10)}})}),this.pos.x=t,this.pos.y=e,this.z=1e3}}class xe extends j{constructor(e,i,s,n,o,a,h,l,c,d){super({width:R.Terminal.width,height:R.Terminal.height});z(this,"doorMode");z(this,"door");z(this,"platform");z(this,"objectX");z(this,"objectY");z(this,"minX");z(this,"maxX");z(this,"minY");z(this,"maxY");z(this,"border");z(this,"interactionLabel");z(this,"interacting");z(this,"hacked");z(this,"cryptographer",null);z(this,"isGreen",!1);z(this,"minigameTimer",0);z(this,"nextSwitchTime",0);z(this,"onCooldown",!1);z(this,"cooldownTimer");z(this,"pendingScaleX");z(this,"pendingScaleY");this.pos=new I(e,i),this.scale=new I(s,s),this.graphics.use(R.Terminal.toSprite()),this.body.collisionType=Pt.Passive,this.initScale=s,this.doorMode=a,this.door=null,this.objectX=n,this.objectY=o,this.minX=h,this.maxX=l,this.minY=c,this.maxY=d,this.hacked=!1,this.interactionLabel=null,this.interacting=!1,this.cooldownTimer=120,this.onCooldown=!1,this.z=-2}onInitialize(e){this.on("collisionstart",i=>this.hitSomething(i)),this.on("collisionend",i=>this.leftSomething(i)),this.doorMode?this.createDoor():this.createPlatform(),this.setNextSwitchTime()}hitSomething(e){e.other.owner instanceof It&&(this.cryptographer=e.other.owner,this.interactionLabel||(this.interactionLabel=new ss(0,-1e3,'Press "E" to use terminal',50,5,"White"),this.addChild(this.interactionLabel)))}leftSomething(e){e.other.owner instanceof It&&(this.interactionLabel&&(this.interactionLabel.kill(),this.interactionLabel=null),this.graphics.use(R.Terminal.toSprite()),this.graphics.flipHorizontal=!1,this.isGreen=!1,this.minigameTimer=0,this.onCooldown=!1,this.interacting=!1,this.hacked=!1)}createPlatform(){let e=(this.maxX-this.minX)/2,i=(this.maxY-this.minY)/2,s=new j({pos:new I(this.objectX+e,this.objectY+i),collisionType:Pt.Fixed});s.scale=new I((this.minX+this.maxX)/R.Border.width,(this.minY+this.maxY)/R.Border.width),s.graphics.use(R.Border.toSprite()),this.platform=new ne(this.objectX,this.objectY,this.minX,this.maxX,this.minY,this.maxY),this.pendingScaleX!==void 0&&this.pendingScaleY!==void 0&&(this.platform.scale=new I(this.pendingScaleX,this.pendingScaleY),this.pendingScaleX=void 0,this.pendingScaleY=void 0),s.z=-1,this.scene.add(s),this.border=s,this.border.graphics.opacity=0,this.scene.add(this.platform)}createDoor(){this.door=new Ht(this.objectX,this.objectY),this.door.scale=new I(.15,.15),this.door.graphics.use(R.ControllableDoor.toSprite()),this.scene.add(this.door)}setNextSwitchTime(){this.nextSwitchTime=Math.random()*30+30}setPlatformScale(e,i){this.platform?this.platform.scale=new I(e,i):(this.pendingScaleX=e,this.pendingScaleY=i)}movePlatform(e,i){e&&i&&(e*=.7071,i*=.7071),this.platform.vel=new I(e*100,i*100)}onPreUpdate(e){let i=null,s=0,n=0,o=!1;if(e.controllers[1]!==null&&e.controllers[1]!==void 0&&(i=e.controllers[1],s=i.getAxes(ci.LeftStickX),n=i.getAxes(ci.LeftStickY),i.wasButtonPressed(jt.Face2)&&(o=!0)),this.onCooldown&&(this.cooldownTimer--,this.cooldownTimer<=0&&(this.onCooldown=!1,this.interactionLabel&&(this.interactionLabel.text='Press "E" to use terminal'))),this.interacting&&!this.hacked&&!this.onCooldown)this.minigameTimer++,this.interactionLabel.text='When green, press "W" to hack.',this.minigameTimer>this.nextSwitchTime&&(this.isGreen=!this.isGreen,this.minigameTimer=0,this.setNextSwitchTime()),this.isGreen?(this.graphics.use(R.TerminalGreen.toSprite()),this.graphics.flipHorizontal=!0):(this.graphics.use(R.TerminalRed.toSprite()),this.graphics.flipHorizontal=!0),(e.input.keyboard.wasPressed(dt.W)||o)&&(this.isGreen?(this.hacked=!0,this.interactionLabel.text='Hacked! Press "E" to exit'):(this.onCooldown=!0,this.cooldownTimer=120,this.interactionLabel.text="Failed! Cooldown...",this.graphics.use(R.Terminal.toSprite()),this.graphics.flipHorizontal=!1));else if(this.interacting&&this.hacked)if(this.border&&(this.border.graphics.opacity=1),this.doorMode&&this.door)this.door.kill();else{let a=0,h=0;(e.input.keyboard.isHeld(dt.W)||n<-.5)&&(h=-1),(e.input.keyboard.isHeld(dt.S)||n>.5)&&(h=1),(e.input.keyboard.isHeld(dt.A)||s<-.5)&&(a=-1),(e.input.keyboard.isHeld(dt.D)||s>.5)&&(a=1),this.movePlatform(a,h)}}}class It extends j{constructor(e,i){super({collisionType:Pt.Active,collisionGroup:ka});z(this,"interacting");z(this,"nearTerminal");z(this,"hitbox");this.pos=new I(e,i),this.scale=new I(.08,.08),this.graphics.use(R.Cryptographer.toSprite()),this.body.limitDegreeOfFreedom.push(Us.Rotation),this.interacting=!1,this.nearTerminal=null}onInitialize(e){this.hitbox=new Fa([is.Box(R.Cryptographer.width-300,R.Cryptographer.height)]),this.collider.set(this.hitbox),this.on("collisionstart",i=>this.hitSomething(i)),this.on("collisionend",i=>this.leftSomething(i))}onPreUpdate(e,i){this.move(e,i),this.checkInteraction(e)}move(e,i){const s=e.input.keyboard;let n=null,o=0,a=0,h=0;const l={Left:dt.A,Right:dt.D,Up:dt.W,Down:dt.S};e.controllers[1]===null||e.controllers[1]===void 0||(n=e.controllers[1],o=n.getAxes(ci.LeftStickX),a=n.getAxes(ci.LeftStickY)),(s.isHeld(l.Left)||o<-.5)&&(h=-1,this.interacting||(this.graphics.flipHorizontal=!0)),(s.isHeld(l.Right)||o>.5)&&(h=1,this.interacting||(this.graphics.flipHorizontal=!1)),s.isHeld(l.Up)||a<-.5,s.isHeld(l.Down)||a>.5,this.interacting||(h*=120,this.vel.x=h)}checkInteraction(e){let i=null,s=!1;e.controllers[1]!==null&&e.controllers[1]!==void 0&&(i=e.controllers[1],i.wasButtonPressed(jt.Face1)&&(s=!0)),(e.input.keyboard.wasPressed(dt.E)||s)&&this.nearTerminal&&this.interactWithTerminal(this.nearTerminal)}interactWithTerminal(e){this.interacting?(this.interacting=!1,this.nearTerminal.interacting=!1,this.nearTerminal.interactionLabel.text='Press "E" to use terminal',this.nearTerminal.doorMode||this.nearTerminal.movePlatform(0,0)):(this.interacting=!0,this.nearTerminal.interacting=!0,this.nearTerminal.interactionLabel.text='Press "E" to stop using terminal',this.vel=new I(0,0))}hitSomething(e){e.other.owner instanceof xe&&(this.nearTerminal=e.other.owner),e.other.owner instanceof Fe&&(console.log("You hit the spikes!"),this.pos.x=e.other.owner.respawnX,this.pos.y=e.other.owner.respawnY),e.other.owner instanceof di}leftSomething(e){e.other.owner instanceof xe&&(this.interacting&&(this.interacting=!1,this.nearTerminal.interacting=!1,this.nearTerminal.movePlatform(0,0)),this.nearTerminal=null)}}var zi;class Pr extends j{constructor(){super({pos:new I(0,0),anchor:new I(0,0),width:1280,height:720});$i(this,zi);Gs(this,zi,R.Background.toSprite()),this.graphics.use(Zi(this,zi)),this.scale=new I(1,1),this.z=-1e3}}zi=new WeakMap;class Zl extends Hs{constructor(){super()}onInitialize(t){const e=new j({x:t.halfDrawWidth,y:t.halfDrawHeight,width:t.drawWidth,height:t.drawHeight}),i=R.MenuBackground.toSprite();i.scale=new I(t.drawWidth/i.width,t.drawHeight/i.height),e.graphics.use(i),this.add(e);const s=new j({x:t.halfDrawWidth,y:t.halfDrawHeight+160,width:R.StartButton.width,height:R.StartButton.height}),n=R.StartButton.toSprite();n.scale=new I(.35,.35),s.graphics.use(n),this.add(s),t.input.keyboard.on("press",o=>{o.key===dt.Space&&t.goToScene("level1")})}onPreUpdate(t){let e=!1,i=!1;t.controllers[0]?e=t.controllers[0].wasButtonPressed(jt.Face1):t.controllers[1]&&(i=t.controllers[1].wasButtonPressed(jt.Face1)),(e||i)&&t.goToScene("level1")}onDeactivate(){console.log("Deactivating Main Menu"),this.actors.forEach(t=>{t.kill()}),this.engine.input.keyboard.off("press")}}class $l{constructor(t){this.levelInstance=t,this.gameUI=document.querySelector(".game-ui"),this.levelElement=document.querySelector(".LevelName"),this.collectibleElement1=document.querySelector(".Collectible1"),this.collectibleElement2=document.querySelector(".Collectible2"),this.collectibleElement3=document.querySelector(".Collectible3"),this.keyElement=document.querySelector(".UIKey"),this.LevelUI=document.querySelector(".TopUI"),this.levelCutOff=document.querySelector(".LevelCutOff"),this.LevelCompletedUI=document.querySelector(".LevelCompletedUI"),this.completedCollectible1=document.querySelector(".CompletedCollectible1"),this.completedCollectible2=document.querySelector(".CompletedCollectible2"),this.completedCollectible3=document.querySelector(".CompletedCollectible3"),this.nextLevelButton=document.querySelector("#NextLevelButton"),this.currentLevel=1,this.nextLevelButton.addEventListener("click",e=>this.nextLevelButtonPressed(e)),this.levelCutOff.style.display="none",this.hide(),this.LevelCompletedUI.style.display="none"}show(){this.gameUI&&(this.gameUI.style.display="block")}hide(){this.gameUI&&(this.gameUI.style.display="none")}updateLevel(t){this.levelElement&&(this.levelElement.textContent=`${t}`)}updateCollectibles(t){t==0?(this.collectibleElement1&&(this.collectibleElement1.src="./images/UIArtifact.png"),this.collectibleElement2&&(this.collectibleElement2.src="./images/UIArtifact.png"),this.collectibleElement3&&(this.collectibleElement3.src="./images/UIArtifact.png")):t==1?(this.collectibleElement1&&(this.collectibleElement1.src="./images/Artifact.png"),this.collectibleElement2&&(this.collectibleElement2.src="./images/UIArtifact.png"),this.collectibleElement3&&(this.collectibleElement3.src="./images/UIArtifact.png")):t==2?(this.collectibleElement1&&(this.collectibleElement1.src="./images/Artifact.png"),this.collectibleElement2&&(this.collectibleElement2.src="./images/Artifact.png"),this.collectibleElement3&&(this.collectibleElement3.src="./images/UIArtifact.png")):t==3&&(this.collectibleElement1&&(this.collectibleElement1.src="./images/Artifact.png"),this.collectibleElement2&&(this.collectibleElement2.src="./images/Artifact.png"),this.collectibleElement3&&(this.collectibleElement3.src="./images/Artifact.png"))}updateKeyStatus(t){t?this.keyElement&&(this.keyElement.src="./images/Key.png"):this.keyElement&&(this.keyElement.src="./images/UIKey.png")}hideLevelUI(){this.LevelUI.style.display="none"}showLevelCompletedUI(){this.LevelCompletedUI.style.display="block",this.completedCollectible1&&(this.completedCollectible1.src=this.collectibleElement1.src),this.completedCollectible2&&(this.completedCollectible2.src=this.collectibleElement2.src),this.completedCollectible3&&(this.completedCollectible3.src=this.collectibleElement3.src)}nextLevelButtonPressed(){const t=window.game;this.currentLevel<=2?(this.LevelCompletedUI.style.display="none",this.levelCutOff.style.display="none",this.LevelUI.style.display="block",this.hide(),t.goToScene("level2"),this.currentLevel=2):this.currentLevel==2?(t.goToScene("level3"),this.currentLevel=3):this.currentLevel==3&&(t.goToScene("level4"),this.currentLevel=4)}}class Ar extends j{constructor(t){super(),this.z=1e3,this.levelName="",this.levelCompleted=!1,this.collectibles=1,this.ui=new $l(t),this.uiVisible=!0}onInitialize(t){this.ui.show(),this.setupPixelConversion(t)}onPreUpdate(t){let e=!1,i=!1,s=!1,n=!1;t.controllers[0]&&(e=t.controllers[0].wasButtonPressed(jt.LeftBumper),s=t.controllers[0].wasButtonPressed(jt.RightBumper)),t.controllers[1]&&(i=t.controllers[1].wasButtonPressed(jt.LeftBumper),n=t.controllers[1].wasButtonPressed(jt.RightBumper)),(t.input.keyboard.wasPressed(dt.P)||s||n)&&(this.uiVisible=!this.uiVisible,this.uiVisible?this.ui.show():this.ui.hide()),(e||i)&&this.levelCompleted&&(this.levelCompleted=!1,this.ui.nextLevelButtonPressed())}setupPixelConversion(t){const e=i=>{const s=i.worldToPageCoordinates(I.Zero),o=i.worldToPageCoordinates(jl(1,0)).sub(s).x;document.documentElement.style.setProperty("--pixel-conversion",o.toString())};t.screen.events.on("resize",()=>e(t.screen)),t.start().then(()=>{e(t.screen)})}updateLevelName(t){this.levelName=t,this.ui.updateLevel(this.levelName)}updateCollectibles(t){this.collectibles=t,this.ui.updateCollectibles(this.collectibles)}updateKeyStatus(t){this.hasKey=t,this.ui.updateKeyStatus(this.hasKey)}FinishLevel(){this.ui.hideLevelUI(),this.ui.showLevelCompletedUI(),this.levelCompleted=!0}onDeinitialize(t){this.ui.hide()}}class Ql extends j{constructor(t,e,i,s){super({width:R.Dart.width,height:R.Dart.height}),this.pos=new I(t,e),this.graphics.use(R.Dart.toSprite()),this.scale=new I(.03,.03),this.on("collisionstart",n=>{n.other.owner instanceof Ft&&(n.other.owner.pos.x=this.respawnX,n.other.owner.pos.y=this.respawnY),(n.other.owner instanceof xi||n.other.owner instanceof Je||n.other.owner instanceof Vt||n.other.owner instanceof ne)&&this.kill()}),this.vel=new I(0,200),this.respawnX=i,this.respawnY=s}}class vn extends j{constructor(t,e,i,s,n){super({width:R.DartShooter.width,height:R.DartShooter.height}),this.pos=new I(t,e),this.graphics.use(R.DartShooter.toSprite()),this.scale=new I(.03,.03),this.instance=i,this.respawnX=s,this.respawnY=n}onInitialize(t){this.engine=t;const e=new Ba({fcn:()=>{this.shootDart()},interval:700,repeats:!0});this.engine.add(e),e.start()}shootDart(){let t=new Ql(this.pos.x,this.pos.y+10,this.respawnX,this.respawnY);this.instance.add(t),t.scale=new I(.04,.04)}}class Tr extends j{constructor(t,e,i,s,n){super({x:t,y:e,width:R.Wall.width,height:R.Wall.height,rotation:i,collisionType:Pt.Passive}),this.rotation=.5*Math.PI,s||(s=.125),n||(n=.125),this.scale=new I(s,n),this.graphics.use(R.Wall.toSprite()),this.graphics.opacity=1,this.on("collisionstart",o=>this.onPlayerCollisionStart(o)),this.on("collisionend",o=>this.onPlayerCollisionEnd(o))}onPlayerCollisionStart(t){(t.other.owner instanceof Ft||t.other.onwer instanceof It)&&(this.graphics.opacity=.5)}onPlayerCollisionEnd(t){(t.other.owner instanceof Ft||t.other.onwer instanceof It)&&(this.graphics.opacity=1)}}class Sr extends j{constructor(t,e){super({x:t,y:e,width:R.Platform.width-800,height:R.Platform.height+500,collisionType:Pt.Passive}),this.z=-1,this.rotation=1*Math.PI,this.scale=new I(.15,.15),this.graphics.use(R.SecretHoleWall.toSprite())}}class Er extends j{constructor(t,e,i){super({width:R.Exit.width,height:R.Exit.height}),this.pos=new I(t,e),this.graphics.use(R.Exit.toSprite()),this.scale=new I(.15,.15),this.z=-1,this.PlayerNearExit=!1,this.CryptographerNearExit=!1,this.AllNearExit=!1,this.gameInstance=i}onInitialize(t){this.on("collisionstart",e=>this.onCollision(e)),this.on("collisionend",e=>this.CollisionEnd(e))}onCollision(t){t.other.owner instanceof Ft&&(this.PlayerNearExit=!0,console.log("Player near exit")),t.other.owner instanceof It&&(this.CryptographerNearExit=!0,console.log("Cryptographer near exit")),this.PlayerNearExit&&this.CryptographerNearExit&&(console.log("Player and Cryptographer near exit, level can be completed"),this.AllNearExit=!0)}onPreUpdate(t,e){let i=!1,s=!1;t.controllers[0]?i=t.controllers[0].wasButtonPressed(jt.Face4):t.controllers[1]&&(s=t.controllers[1].wasButtonPressed(jt.Face4)),this.AllNearExit&&(t.input.keyboard.wasPressed(dt.I)||i||s)&&this.gameInstance.hasKey&&(this.gameInstance.levelCompleted=!0,console.log("Level completed: "+this.gameInstance.levelCompleted),this.gameInstance.levelUI.FinishLevel()),(t.input.keyboard.wasPressed(dt.I)||i||s)&&(this.gameInstance.hasKey||console.log("No key"))}CollisionEnd(t){t.other.owner instanceof Ft&&(this.PlayerNearExit=!1,this.AllNearExit=!1),t.other.owner instanceof It&&(this.CryptographerNearExit=!1,this.AllNearExit=!1)}}class Ir extends j{constructor(t,e,i){super({width:R.Key.width,height:R.Key.height}),this.pos=new I(t,e),this.graphics.use(R.Key.toSprite()),this.scale=new I(.05,.05),this.on("collisionstart",s=>this.handleCollision(s)),this.gameInstance=i}handleCollision(t){(t.other.owner instanceof Ft||t.other.owner instanceof It)&&(console.log("Key collected"),this.kill(),this.gameInstance.hasKey=!0,this.gameInstance.levelUI.updateKeyStatus(!0))}}class Rr extends j{constructor(t,e,i){super({width:R.Artifact.width,height:R.Artifact.height}),this.z=-2,this.pos=new I(t,e),this.scale=new I(.05,.05),this.on("collisionstart",s=>this.handleCollision(s)),this.gameInstance=i}onInitialize(t){this.graphics.use(R.Artifact.toSprite())}handleCollision(t){(t.other.owner instanceof Ft||t.other.owner instanceof It)&&(this.kill(),this.gameInstance.collectibleCount++,console.log(this.gameInstance.collectibleCount),this.gameInstance.levelUI.updateCollectibles(this.gameInstance.collectibleCount))}}class Kl extends Hs{constructor(){super();z(this,"collectibleCount",0);z(this,"hasKey",!1);z(this,"levelCompleted",!1);z(this,"currentCheckPointX",110);z(this,"currentCheckPointY",445)}onPreUpdate(e,i){}onActivate(){this.showLevelUI(),this.onStartLevel()}updateCheckPoint(e,i){this.currentCheckPointX=e,this.currentCheckPointY=i,console.log(this.currentCheckPointX+" "+this.currentCheckPointY),this.actors.forEach(s=>{s instanceof Fe&&(s.respawnX=this.currentCheckPointX,s.respawnY=this.currentCheckPointY),s instanceof vn&&(s.respawnX=this.currentCheckPointX,s.respawnY=this.currentCheckPointY)})}onStartLevel(){console.log("onStartLevel");let e=new It(100,650),i=new Ft(100,430),s=new xe(930,640,.065,750,550,!1,5,5,100,100),n=new Pr;e.z=1001,i.z=1001,this.add(s),this.add(e),this.add(i),this.add(n);let o=0,a=0;o=50;for(let l=0;l<5;l++){let c=new Vt(10,o,.5*Math.PI);this.add(c),o+=150}o=50;for(let l=0;l<5;l++){let c=new Vt(1260,o,1.5*Math.PI);this.add(c),o+=150}a=110;for(let l=0;l<8;l++){let c=new Vt(a,325,Math.PI);this.add(c),a+=150}this.addPlatform(85,550),this.addPlatform(270,550),this.addCryptographerInteractionLabel(270,630,"You may not be able to jump, but you control the level"),this.addCryptographerInteractionLabel(920,530,"Hack terminals to control platforms"),this.addInteractionLabel(270,380,"You may notice some people have some trouble jumping."),this.addInteractionLabel(270,400,"Thats why you will have to help each other reach certain places"),this.addInteractionLabel(870,430,"Stand on pressure plates to open doors"),this.addInteractionLabel(1160,550,"Press I to open the door"),this.addPlayerInteractionLabel(600,590,"Some heights are too great to jump."),this.addPlayerInteractionLabel(600,620,"Press F to grapple to the hook point."),this.addInteractionLabel(780,355,"You will need the key to open the exit"),this.addWall(450,550,.5*Math.PI,.125),this.addWall(480,550,.5*Math.PI,.125),this.addWall(640,450,0,.125),this.addWall(640,400,0,.125),this.addWall(1030,450,0,.125),this.addWall(1030,400,0,.125),this.addPlatform(950,490),this.addPlatform(80,700),this.addPlatform(170,700),this.addPlatform(260,700),this.addPlatform(350,700),this.addPlatform(440,700),this.addPlatform(510,700),this.addPlatform(700,700),this.addPlatform(770,700),this.addPlatform(860,700),this.addPlatform(950,700),this.addPlatform(1040,700),this.addPlatform(1130,700),this.addPlatform(1220,700),this.addSpikes(605,720,.05,100,650),this.addHookpoint(550,535,1.5*Math.PI);let h=this.addDoor(1030,590);this.addPlate(950,470,h),this.addPlate(1100,680,h),this.exit=new Er(1200,630,this),this.exit.scale=new I(.12,.12),this.add(this.exit),this.key=new Ir(730,390,this),this.key.scale=new I(.05,.05),this.add(this.key),this.addArtifact(270,500),this.addArtifact(950,410),this.addArtifact(1100,630),this.addCrate(500,480)}onInitialize(e){}addPlayerInteractionLabel(e,i,s){const n=new ss(e,i,s,10,1.2,"Green");this.add(n),n.z=3}addCryptographerInteractionLabel(e,i,s){const n=new ss(e,i,s,10,1.2,"Pink");this.add(n),n.z=3}addInteractionLabel(e,i,s){const n=new ss(e,i,s,10,1.2,"White");this.add(n),n.z=3}addArtifact(e,i){const s=new Rr(e,i,this);this.add(s)}addWall(e,i,s,n){const o=new xi(e,i,s,n);this.add(o)}addSpikes(e,i,s,n,o){const a=new Fe(e,i,s,n,o);this.add(a)}addCrate(e,i){const s=new fe(e,i);this.add(s)}addPlatform(e,i){const s=new Je(e,i);this.add(s)}addDoor(e,i){const s=new Ht(e,i);return this.add(s),s}addPlate(e,i,s){const n=new ji(e,i,s,this);return this.add(n),n}addButton(e,i,s){const n=new Ws(e,i,s,this);this.add(n)}addElevator(e,i,s,n,o,a,h){const l=new ui(e,i,s,n,o,a,h);return this.add(l),l}addSecretWall(e,i){const s=new Tr(e,i);this.add(s)}addCrackedWall(e,i){const s=new Os(e,i);this.add(s)}addSecretWallHole(e,i){const s=new Sr(e,i);this.add(s)}addHookpoint(e,i,s){const n=new Li(e,i,s);this.add(n)}showLevelUI(){console.log("showLevelUI");const e=new Ar(this);this.levelUI=e,this.add(e),this.collectibleCount=0,e.updateLevelName("Level 1"),e.updateCollectibles(0)}onDeactivate(){this.actors.forEach(e=>{this.remove(e),e.kill()}),this.engine.input.keyboard.off("press")}}class Jl extends Hs{constructor(){super();z(this,"collectibleCount",0);z(this,"hasKey",!1);z(this,"levelCompleted",!1)}onActivate(){this.showLevelUI()}showLevelUI(){const e=new Ar(this);this.levelUI=e,this.add(this.levelUI),console.log("level2 showLevelUI"),this.levelUI.updateLevelName("Level 2"),console.log("level2 updateLevelName"),this.levelUI.updateCollectibles(0),this.levelUI.updateKeyStatus(!1)}onDeactivate(){this.actors.forEach(e=>{this.remove(e),e.kill()}),this.engine.input.keyboard.off("press")}onInitialize(e){let i=new It(100,500),s=new Ft(100,500);this.add(i),this.add(s);let n=new Pr;n.z=-20;let o=new di(870,678);this.add(n),this.add(o),o=new di(985,302),this.add(o);let a=new xe(90,438,.045,240,325,!1,130,490,60,200);this.add(a),this.addHookpoint(493,480,1.5*Math.PI),this.addHookpoint(223,140,1.5*Math.PI),this.addWall(983,677,.5*Math.PI,.125),this.addWall(1093,677,.5*Math.PI,.125),this.addWall(1183,677,.5*Math.PI,.125),this.addWall(1194,484,.5*Math.PI,.1),this.addWall(967,484,.5*Math.PI,.1),this.addWall(879,484,.5*Math.PI,.1),this.addWall(791,484,.5*Math.PI,.1),this.addWall(725,461,0,.1),this.addWall(725,373,0,.1),this.addWall(912,348,.5*Math.PI,.1),this.addWall(1e3,348,.5*Math.PI,.1),this.addWall(1100,300,.5*Math.PI,.125),this.addWall(1183,300,.5*Math.PI,.125),this.addWall(77,490,.5*Math.PI,.1),this.addWall(77,150,.5*Math.PI,.1),this.addWall(165,150,.5*Math.PI,.1),this.addWall(470,67,0,.1),this.addWall(470,117,0,.1),this.addWall(890,178,.5*Math.PI,.1),this.addWall(802,178,.5*Math.PI,.1),this.addWall(714,178,.5*Math.PI,.1),this.addPlatform(360,490),this.addPlatform(410,490),this.addPlatform(360,320),this.addPlatform(410,320),this.addPlatform(84,340),this.addSecretWall(85,120,.5*Math.PI),this.addSecretWall(85,80,.5*Math.PI),this.addSecretWall(85,40,.5*Math.PI),this.addCrackedWall(155,85),this.addSecretWallHole(155,85);let h=this.addDoor(900,270);this.addPlate(75,310,h,!0,0,15e3),this.addElevator(850,150,1085,600,125,100,!0),this.addElevator(750,150,800,440,100,100,!0);let l=this.addDoor(980,580);this.addButton(1230,200,l,!0),this.addTerminal(1175,600,.075,900,90,!0),this.addTerminal(1185,410,.075,800,90,!0),this.addHookpoint(950,170,1.5*Math.PI),this.addPlate(520,120,h,!1,0,0,!0),this.addWall(535,150,.5*Math.PI,.1),this.addWall(625,150,1.5*Math.PI,.1),this.exit=new Er(1100,225,this),this.exit.scale=new I(.12,.12),this.add(this.exit),this.key=new Ir(900,425,this),this.key.scale=new I(.05,.05),this.add(this.key),this.addArtifact(375,250),this.addArtifact(80,80),this.addArtifact(800,425);let c=0,d=0;c=50;for(let f=0;f<5;f++){let _=new Vt(10,c,.5*Math.PI);this.add(_),c+=150}this.addPlatform(0,725),this.addPlatform(125,725),this.addPlatform(250,725),this.addPlatform(375,725),this.addPlatform(500,725),this.addPlatform(625,725),this.addPlatform(750,725),this.addPlatform(875,725),this.addPlatform(1e3,725),this.addPlatform(1125,725),this.addPlatform(1250,725),c=50;for(let f=0;f<5;f++){let _=new Vt(1260,c,1.5*Math.PI);this.add(_),c+=150}d=110;for(let f=0;f<8;f++){let _=new Vt(d,0,Math.PI);this.add(_),d+=150}this.addElevator(390,470,200,650,175,100,!1)}addArtifact(e,i){const s=new Rr(e,i,this);this.add(s)}addTerminal(e,i,s,n,o,a,h,l,c,d){let f=new xe(e,i,s,n,o,a,h,l,c,d);this.add(f)}addWall(e,i,s,n){const o=new xi(e,i,s,n);this.add(o)}addSpikes(e,i,s,n,o){const a=new Fe(e,i,s,n,o);this.add(a)}addCrate(e,i){const s=new fe(e,i);this.add(s)}addPlatform(e,i){const s=new Je(e,i);this.add(s)}addDoor(e,i){const s=new Ht(e,i);return this.add(s),s}addPlate(e,i,s,n=!1,o=0,a=0,h){const l=new ji(e,i,s,this,o,n,a,h);return this.add(l),l}addButton(e,i,s,n){const o=new Ws(e,i,s,this,n);this.add(o)}addElevator(e,i,s,n,o,a,h){const l=new ui(e,i,s,n,o,a,h);return this.add(l),l}addSecretWall(e,i){const s=new Tr(e,i);this.add(s)}addCrackedWall(e,i){const s=new Os(e,i);this.add(s)}addSecretWallHole(e,i){const s=new Sr(e,i);s.scale.x=.1,this.add(s)}addHookpoint(e,i,s){const n=new Li(e,i,s);this.add(n)}}class Mr extends j{constructor(t,e,i){super({width:R.Checkpoint.width,height:R.Checkpoint.height}),this.pos=new I(t,e),this.graphics.use(R.Checkpoint.toSprite()),this.scale=new I(.05,.05),this.on("collisionstart",s=>{s.other.owner instanceof Ft&&(console.log("Player hit checkpoint"),i.actors.forEach(n=>{n instanceof Mr&&n.CheckpointOff()}),this.CheckpointActive(i),i.updateCheckPoint(this.pos.x,this.pos.y))})}CheckpointActive(t){this.graphics.use(R.ActiveCheckpoint.toSprite()),t.currentCheckPoint=this.pos}CheckpointOff(){this.graphics.use(R.Checkpoint.toSprite())}onInitialize(t){}}class tc extends j{constructor(t,e){super({x:t,y:e,width:R.FlatPlatform.width,height:R.FlatPlatform.height,collisionType:Pt.Fixed}),this.z=-1,this.scale=new I(.1,.1),this.graphics.use(R.FlatPlatform.toSprite())}}class ec extends Hs{constructor(){super();z(this,"collectibleCount",0);z(this,"hasKey",!1);z(this,"levelCompleted",!1);z(this,"respawnX",325);z(this,"respawnY",650)}onActivate(){this.showLevelUI()}addElevator(e,i,s,n,o,a,h){const l=new ui(e,i,s,n,o,a,h);return this.add(l),l}addSecretWall(e,i){const s=new Tr(e,i);this.add(s),s.scale=.1,s.z=100}addCrackedWall(e,i){const s=new Os(e,i);this.add(s)}addSecretWallHole(e,i){const s=new Sr(e,i);this.add(s),s.graphics.flipHorizontal=!0,s.scale.x=.1}addWall(e,i,s,n){const o=new xi(e,i,s,n);this.add(o)}addHookpoint(e,i,s){const n=new Li(e,i,s);this.add(n)}addSpikes(e,i,s){const n=new Fe(e,i,s,this.respawnX,this.respawnY);this.add(n)}addCrate(e,i){const s=new fe(e,i);this.add(s)}addPlatform(e,i){const s=new Je(e,i);this.add(s)}addDoor(e,i){const s=new Ht(e,i);return s.scale=new I(.15,.15),this.add(s),s}addPlate(e,i,s,n=!1,o=0,a=0){const h=new ji(e,i,s,this,o,n,a);return this.add(h),h}addButton(e,i,s,n){const o=new Ws(e,i,s,this,n);o.scale=new I(.07,.07),this.add(o)}addElevator(e,i,s,n,o,a,h){const l=new ui(e,i,s,n,o,a,h);return this.add(l),l}addDartShooter(e,i,s,n){const o=new vn(e,i,this,s,n);this.add(o)}addCheckPoint(e,i){const s=new Mr(e,i,this);this.add(s)}addArtifact(e,i){const s=new Rr(e,i,this);this.add(s)}showLevelUI(){const e=new Ar(this);this.levelUI=e,this.add(this.levelUI),console.log("level3 showLevelUI"),this.levelUI.updateLevelName("Level 3"),console.log("level3 updateLevelName"),this.levelUI.updateCollectibles(0),this.levelUI.updateKeyStatus(!1)}onDeactivate(){this.actors.forEach(e=>{this.remove(e),e.kill()}),this.engine.input.keyboard.off("press")}updateCheckPoint(e,i){this.currentCheckPointX=e,this.currentCheckPointY=i,console.log(this.currentCheckPointX+" "+this.currentCheckPointY),this.actors.forEach(s=>{s instanceof Fe&&(s.respawnX=this.currentCheckPointX,s.respawnY=this.currentCheckPointY),s instanceof vn&&(s.respawnX=this.currentCheckPointX,s.respawnY=this.currentCheckPointY)})}onInitialize(e){let i=new Pr;i.z=-20,this.add(i);let s=new It(300,650);this.add(s);let n=new Ft(400,60);this.add(n);let o=new di(1055,673);this.add(o);let a=new xe(1200,603,.06,1030,530,!1,130,140,270,50);this.add(a);let h=new xe(490,663,.05,550,370,!1,190,50,12,60);this.add(h),h.setPlatformScale(.05,.1);let l=new xe(650,663,.05,100,240,!1,50,50,180,180);this.add(l);let c=new xe(800,663,.05,780,200,!1,400,550,10,10);this.add(c);let d=400;for(let U=0;U<8;U++)this.addDartShooter(d,300,this.respawnX,this.respawnY),d+=30;let f=new Ir(1178,60);this.add(f),f.rotation=.5*Math.PI,this.addCheckPoint(260,348),this.addCheckPoint(670,435),this.addCheckPoint(410,83),this.addElevator(250,245,340,240,125,0,!1),this.addHookpoint(1102,525,.5*Math.PI),this.addHookpoint(1100,108,.5*Math.PI),this.addHookpoint(437,587,.5*Math.PI),this.addHookpoint(787,470,1.5*Math.PI),this.addHookpoint(787,470,1.5*Math.PI),this.addWall(710,300,0,.1),this.addWall(900,300,0,.1),this.addArtifact(720,75),this.addArtifact(1210,460),this.addArtifact(190,415);let _=new Ht(180,640);this.add(_),_.scale=new I(.135,.135),this.addPlate(1235,320,_,!1,1.5*Math.PI);let g=new Ht(900,400,new I(.15,.15));this.add(g),this.addButton(1233,65,g,!0);let v=new Ht(900,660,new I(.15,.15));this.add(v),this.addPlate(730,455,v,!1,0);let C=new Ht(580,660,new I(.15,.15));this.add(C),this.addButton(685,325,C,!0);let m=new Ht(1135,600,new I(.15,.15));this.add(m),this.addButton(250,435,m,!1);let w=new Ht(900,100,new I(.15,.15));this.add(w),this.addButton(560,75,w,!1);let T=new Ht(1140,60,new I(.13,.13));this.add(T),this.addButton(40,85,T,!1),this.addCrate(221,30);let P=new tc(720,115);this.add(P);let S=new Ht(300,435,new I(.1,.1));this.add(S),this.addPlate(1235,200,S,!1,1.5*Math.PI);let F=new Er(90,650,this);F.scale=new I(.12,.12),this.add(F);let A=464;for(let U=0;U<12;U++)this.addSpikes(A,233,.05),A+=59;A=61;for(let U=0;U<3;U++)this.addSpikes(A,447,.05),A+=59;this.addWall(900,156,.5*Math.PI,.1),this.addWall(900,38,.5*Math.PI,.1),this.addWall(1169,673,.5*Math.PI,.125),this.addWall(1184,673,.5*Math.PI,.125),this.addWall(1159,533,.5*Math.PI,.1),this.addWall(1196,533,.5*Math.PI,.1),this.addWall(1159,383,.5*Math.PI,.1),this.addWall(1196,383,.5*Math.PI,.1),this.addWall(890,595,.5*Math.PI,.1),this.addWall(802,595,.5*Math.PI,.1),this.addWall(714,595,.5*Math.PI,.1),this.addWall(626,595,.5*Math.PI,.1),this.addWall(538,595,.5*Math.PI,.1),this.addWall(494,595,.5*Math.PI,.1),this.addWall(75,480,.5*Math.PI,.1),this.addWall(180,530,0,.125),this.addWall(913,530,0,.1),this.addWall(890,480,.5*Math.PI,.1),this.addWall(270,393,.5*Math.PI,.1),this.addWall(230,415,0,.1),this.addWall(1169,250,.5*Math.PI,.125),this.addWall(1184,250,.5*Math.PI,.125),this.addWall(221,266,.5*Math.PI,.1),this.addWall(1169,150,.5*Math.PI,.125),this.addWall(1184,150,.5*Math.PI,.125),this.addWall(1169,120,.5*Math.PI,.125),this.addWall(1184,120,.5*Math.PI,.125),this.addWall(210,116,1.5*Math.PI,.07),this.addWall(86,40,.5*Math.PI,.125),this.addWall(117,40,.5*Math.PI,.125),this.addWall(410,189,0,.125),this.addWall(410,159,0,.125),this.addWall(535,59,0,.1);let L=710;for(let U=0;U<8;U++)this.addWall(L,480,.5*Math.PI,.1),L-=88;this.addWall(730,480,.5*Math.PI,.1),L=1069;for(let U=0;U<10;U++)this.addWall(L,266,.5*Math.PI,.1),L-=88;let W=0;L=0,W=50;for(let U=0;U<5;U++){let q=new Vt(10,W,.5*Math.PI);this.add(q),W+=150}L=110;for(let U=0;U<8;U++){let q=new Vt(L,720,0);this.add(q),L+=150}W=50;for(let U=0;U<5;U++){let q=new Vt(1260,W,1.5*Math.PI);this.add(q),W+=150}L=110;for(let U=0;U<8;U++){let q=new Vt(L,-7,Math.PI);this.add(q),L+=150}}}class ic extends Ol{constructor(){super({width:1280,height:720,maxFps:60,displayMode:Wl.FitScreen,physics:{solver:ql.Realistic,gravity:new I(0,500)},suppressPlayButton:!0}),this.start(pn).then(()=>this.startGame()),window.game=this,this.controllers=[];const t={in:new qr({duration:400,direction:"in",color:xs.Black}),out:new qr({duration:400,direction:"out",color:xs.Black})};this.add("menu",{scene:new Zl,transitions:t}),this.add("level1",{scene:new Kl,transitions:t}),this.add("level2",{scene:new Jl,transitions:t}),this.add("level3",{scene:new ec,transitions:t})}onInitialize(){this.start(pn).then(()=>{console.log("Resources loaded")})}startGame(){this.initGamepads(),this.goToScene("menu")}initGamepads(){this.input.gamepads.enabled=!0,this.input.gamepads.on("connect",t=>{this.controllers.push(t.gamepad),console.log("gamepad connected",this.controllers)})}}new ic;
